(function(){"use strict";var Pt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};(function(_,It,co){var De=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof Pt<"u"?Pt:typeof self<"u"?self:{};function Re(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}function ho(){this.__data__=[],this.size=0}var uo=ho;function po(o,e){return o===e||o!==o&&e!==e}var ot=po,fo=ot;function yo(o,e){for(var t=o.length;t--;)if(fo(o[t][0],e))return t;return-1}var Fe=yo,wo=Fe,vo=Array.prototype,mo=vo.splice;function go(o){var e=this.__data__,t=wo(e,o);if(t<0)return!1;var r=e.length-1;return t==r?e.pop():mo.call(e,t,1),--this.size,!0}var bo=go,ko=Fe;function So(o){var e=this.__data__,t=ko(e,o);return t<0?void 0:e[t][1]}var Po=So,Io=Fe;function To(o){return Io(this.__data__,o)>-1}var xo=To,Oo=Fe;function Co(o,e){var t=this.__data__,r=Oo(t,o);return r<0?(++this.size,t.push([o,e])):t[r][1]=e,this}var No=Co,Lo=uo,Wo=bo,Ro=Po,Mo=xo,jo=No;function ge(o){var e=-1,t=o==null?0:o.length;for(this.clear();++e<t;){var r=o[e];this.set(r[0],r[1])}}ge.prototype.clear=Lo,ge.prototype.delete=Wo,ge.prototype.get=Ro,ge.prototype.has=Mo,ge.prototype.set=jo;var Ee=ge,Ao=Ee;function Bo(){this.__data__=new Ao,this.size=0}var Do=Bo;function Fo(o){var e=this.__data__,t=e.delete(o);return this.size=e.size,t}var Eo=Fo;function zo(o){return this.__data__.get(o)}var Uo=zo;function _o(o){return this.__data__.has(o)}var Yo=_o,Xo=typeof De=="object"&&De&&De.Object===Object&&De,Tt=Xo,$o=Tt,Go=typeof self=="object"&&self&&self.Object===Object&&self,Vo=$o||Go||Function("return this")(),ie=Vo,Ho=ie,qo=Ho.Symbol,ze=qo,xt=ze,Ot=Object.prototype,Zo=Ot.hasOwnProperty,Qo=Ot.toString,Me=xt?xt.toStringTag:void 0;function Jo(o){var e=Zo.call(o,Me),t=o[Me];try{o[Me]=void 0;var r=!0}catch{}var s=Qo.call(o);return r&&(e?o[Me]=t:delete o[Me]),s}var Ko=Jo,es=Object.prototype,ts=es.toString;function rs(o){return ts.call(o)}var os=rs,Ct=ze,ss=Ko,is=os,ns="[object Null]",as="[object Undefined]",Nt=Ct?Ct.toStringTag:void 0;function ls(o){return o==null?o===void 0?as:ns:Nt&&Nt in Object(o)?ss(o):is(o)}var ye=ls;function cs(o){var e=typeof o;return o!=null&&(e=="object"||e=="function")}var he=cs,hs=ye,us=he,ds="[object AsyncFunction]",ps="[object Function]",fs="[object GeneratorFunction]",ys="[object Proxy]";function ws(o){if(!us(o))return!1;var e=hs(o);return e==ps||e==fs||e==ds||e==ys}var Lt=ws,vs=ie,ms=vs["__core-js_shared__"],gs=ms,st=gs,Wt=function(){var o=/[^.]+$/.exec(st&&st.keys&&st.keys.IE_PROTO||"");return o?"Symbol(src)_1."+o:""}();function bs(o){return!!Wt&&Wt in o}var ks=bs,Ss=Function.prototype,Ps=Ss.toString;function Is(o){if(o!=null){try{return Ps.call(o)}catch{}try{return o+""}catch{}}return""}var Rt=Is,Ts=Lt,xs=ks,Os=he,Cs=Rt,Ns=/[\\^$.*+?()[\]{}|]/g,Ls=/^\[object .+?Constructor\]$/,Ws=Function.prototype,Rs=Object.prototype,Ms=Ws.toString,js=Rs.hasOwnProperty,As=RegExp("^"+Ms.call(js).replace(Ns,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function Bs(o){if(!Os(o)||xs(o))return!1;var e=Ts(o)?As:Ls;return e.test(Cs(o))}var Ds=Bs;function Fs(o,e){return o==null?void 0:o[e]}var Es=Fs,zs=Ds,Us=Es;function _s(o,e){var t=Us(o,e);return zs(t)?t:void 0}var we=_s,Ys=we,Xs=ie,$s=Ys(Xs,"Map"),it=$s,Gs=we,Vs=Gs(Object,"create"),Ue=Vs,Mt=Ue;function Hs(){this.__data__=Mt?Mt(null):{},this.size=0}var qs=Hs;function Zs(o){var e=this.has(o)&&delete this.__data__[o];return this.size-=e?1:0,e}var Qs=Zs,Js=Ue,Ks="__lodash_hash_undefined__",ei=Object.prototype,ti=ei.hasOwnProperty;function ri(o){var e=this.__data__;if(Js){var t=e[o];return t===Ks?void 0:t}return ti.call(e,o)?e[o]:void 0}var oi=ri,si=Ue,ii=Object.prototype,ni=ii.hasOwnProperty;function ai(o){var e=this.__data__;return si?e[o]!==void 0:ni.call(e,o)}var li=ai,ci=Ue,hi="__lodash_hash_undefined__";function ui(o,e){var t=this.__data__;return this.size+=this.has(o)?0:1,t[o]=ci&&e===void 0?hi:e,this}var di=ui,pi=qs,fi=Qs,yi=oi,wi=li,vi=di;function be(o){var e=-1,t=o==null?0:o.length;for(this.clear();++e<t;){var r=o[e];this.set(r[0],r[1])}}be.prototype.clear=pi,be.prototype.delete=fi,be.prototype.get=yi,be.prototype.has=wi,be.prototype.set=vi;var mi=be,jt=mi,gi=Ee,bi=it;function ki(){this.size=0,this.__data__={hash:new jt,map:new(bi||gi),string:new jt}}var Si=ki;function Pi(o){var e=typeof o;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?o!=="__proto__":o===null}var Ii=Pi,Ti=Ii;function xi(o,e){var t=o.__data__;return Ti(e)?t[typeof e=="string"?"string":"hash"]:t.map}var _e=xi,Oi=_e;function Ci(o){var e=Oi(this,o).delete(o);return this.size-=e?1:0,e}var Ni=Ci,Li=_e;function Wi(o){return Li(this,o).get(o)}var Ri=Wi,Mi=_e;function ji(o){return Mi(this,o).has(o)}var Ai=ji,Bi=_e;function Di(o,e){var t=Bi(this,o),r=t.size;return t.set(o,e),this.size+=t.size==r?0:1,this}var Fi=Di,Ei=Si,zi=Ni,Ui=Ri,_i=Ai,Yi=Fi;function ke(o){var e=-1,t=o==null?0:o.length;for(this.clear();++e<t;){var r=o[e];this.set(r[0],r[1])}}ke.prototype.clear=Ei,ke.prototype.delete=zi,ke.prototype.get=Ui,ke.prototype.has=_i,ke.prototype.set=Yi;var At=ke,Xi=Ee,$i=it,Gi=At,Vi=200;function Hi(o,e){var t=this.__data__;if(t instanceof Xi){var r=t.__data__;if(!$i||r.length<Vi-1)return r.push([o,e]),this.size=++t.size,this;t=this.__data__=new Gi(r)}return t.set(o,e),this.size=t.size,this}var qi=Hi,Zi=Ee,Qi=Do,Ji=Eo,Ki=Uo,en=Yo,tn=qi;function Se(o){var e=this.__data__=new Zi(o);this.size=e.size}Se.prototype.clear=Qi,Se.prototype.delete=Ji,Se.prototype.get=Ki,Se.prototype.has=en,Se.prototype.set=tn;var Bt=Se;function rn(o,e){for(var t=-1,r=o==null?0:o.length;++t<r&&e(o[t],t,o)!==!1;);return o}var on=rn,sn=we,nn=function(){try{var o=sn(Object,"defineProperty");return o({},"",{}),o}catch{}}(),an=nn,Dt=an;function ln(o,e,t){e=="__proto__"&&Dt?Dt(o,e,{configurable:!0,enumerable:!0,value:t,writable:!0}):o[e]=t}var Ft=ln,cn=Ft,hn=ot,un=Object.prototype,dn=un.hasOwnProperty;function pn(o,e,t){var r=o[e];(!(dn.call(o,e)&&hn(r,t))||t===void 0&&!(e in o))&&cn(o,e,t)}var Et=pn,fn=Et,yn=Ft;function wn(o,e,t,r){var s=!t;t||(t={});for(var i=-1,n=e.length;++i<n;){var a=e[i],l=r?r(t[a],o[a],a,t,o):void 0;l===void 0&&(l=o[a]),s?yn(t,a,l):fn(t,a,l)}return t}var Ye=wn;function vn(o,e){for(var t=-1,r=Array(o);++t<o;)r[t]=e(t);return r}var mn=vn;function gn(o){return o!=null&&typeof o=="object"}var ce=gn,bn=ye,kn=ce,Sn="[object Arguments]";function Pn(o){return kn(o)&&bn(o)==Sn}var In=Pn,zt=In,Tn=ce,Ut=Object.prototype,xn=Ut.hasOwnProperty,On=Ut.propertyIsEnumerable,Cn=zt(function(){return arguments}())?zt:function(o){return Tn(o)&&xn.call(o,"callee")&&!On.call(o,"callee")},Nn=Cn,Ln=Array.isArray,Xe=Ln,$e={exports:{}};function Wn(){return!1}var Rn=Wn;$e.exports,function(o,e){var t=ie,r=Rn,s=e&&!e.nodeType&&e,i=s&&!0&&o&&!o.nodeType&&o,n=i&&i.exports===s,a=n?t.Buffer:void 0,l=a?a.isBuffer:void 0,c=l||r;o.exports=c}($e,$e.exports);var nt=$e.exports,Mn=9007199254740991,jn=/^(?:0|[1-9]\d*)$/;function An(o,e){var t=typeof o;return e=e??Mn,!!e&&(t=="number"||t!="symbol"&&jn.test(o))&&o>-1&&o%1==0&&o<e}var Bn=An,Dn=9007199254740991;function Fn(o){return typeof o=="number"&&o>-1&&o%1==0&&o<=Dn}var _t=Fn,En=ye,zn=_t,Un=ce,_n="[object Arguments]",Yn="[object Array]",Xn="[object Boolean]",$n="[object Date]",Gn="[object Error]",Vn="[object Function]",Hn="[object Map]",qn="[object Number]",Zn="[object Object]",Qn="[object RegExp]",Jn="[object Set]",Kn="[object String]",ea="[object WeakMap]",ta="[object ArrayBuffer]",ra="[object DataView]",oa="[object Float32Array]",sa="[object Float64Array]",ia="[object Int8Array]",na="[object Int16Array]",aa="[object Int32Array]",la="[object Uint8Array]",ca="[object Uint8ClampedArray]",ha="[object Uint16Array]",ua="[object Uint32Array]",$={};$[oa]=$[sa]=$[ia]=$[na]=$[aa]=$[la]=$[ca]=$[ha]=$[ua]=!0,$[_n]=$[Yn]=$[ta]=$[Xn]=$[ra]=$[$n]=$[Gn]=$[Vn]=$[Hn]=$[qn]=$[Zn]=$[Qn]=$[Jn]=$[Kn]=$[ea]=!1;function da(o){return Un(o)&&zn(o.length)&&!!$[En(o)]}var pa=da;function fa(o){return function(e){return o(e)}}var at=fa,Ge={exports:{}};Ge.exports,function(o,e){var t=Tt,r=e&&!e.nodeType&&e,s=r&&!0&&o&&!o.nodeType&&o,i=s&&s.exports===r,n=i&&t.process,a=function(){try{var l=s&&s.require&&s.require("util").types;return l||n&&n.binding&&n.binding("util")}catch{}}();o.exports=a}(Ge,Ge.exports);var lt=Ge.exports,ya=pa,wa=at,Yt=lt,Xt=Yt&&Yt.isTypedArray,va=Xt?wa(Xt):ya,$t=va,ma=mn,ga=Nn,ba=Xe,ka=nt,Sa=Bn,Pa=$t,Ia=Object.prototype,Ta=Ia.hasOwnProperty;function xa(o,e){var t=ba(o),r=!t&&ga(o),s=!t&&!r&&ka(o),i=!t&&!r&&!s&&Pa(o),n=t||r||s||i,a=n?ma(o.length,String):[],l=a.length;for(var c in o)(e||Ta.call(o,c))&&!(n&&(c=="length"||s&&(c=="offset"||c=="parent")||i&&(c=="buffer"||c=="byteLength"||c=="byteOffset")||Sa(c,l)))&&a.push(c);return a}var Gt=xa,Oa=Object.prototype;function Ca(o){var e=o&&o.constructor,t=typeof e=="function"&&e.prototype||Oa;return o===t}var ct=Ca;function Na(o,e){return function(t){return o(e(t))}}var Vt=Na,La=Vt,Wa=La(Object.keys,Object),Ra=Wa,Ma=ct,ja=Ra,Aa=Object.prototype,Ba=Aa.hasOwnProperty;function Da(o){if(!Ma(o))return ja(o);var e=[];for(var t in Object(o))Ba.call(o,t)&&t!="constructor"&&e.push(t);return e}var Fa=Da,Ea=Lt,za=_t;function Ua(o){return o!=null&&za(o.length)&&!Ea(o)}var Ht=Ua,_a=Gt,Ya=Fa,Xa=Ht;function $a(o){return Xa(o)?_a(o):Ya(o)}var ht=$a,Ga=Ye,Va=ht;function Ha(o,e){return o&&Ga(e,Va(e),o)}var qa=Ha;function Za(o){var e=[];if(o!=null)for(var t in Object(o))e.push(t);return e}var Qa=Za,Ja=he,Ka=ct,el=Qa,tl=Object.prototype,rl=tl.hasOwnProperty;function ol(o){if(!Ja(o))return el(o);var e=Ka(o),t=[];for(var r in o)r=="constructor"&&(e||!rl.call(o,r))||t.push(r);return t}var sl=ol,il=Gt,nl=sl,al=Ht;function ll(o){return al(o)?il(o,!0):nl(o)}var ut=ll,cl=Ye,hl=ut;function ul(o,e){return o&&cl(e,hl(e),o)}var dl=ul,Ve={exports:{}};Ve.exports,function(o,e){var t=ie,r=e&&!e.nodeType&&e,s=r&&!0&&o&&!o.nodeType&&o,i=s&&s.exports===r,n=i?t.Buffer:void 0,a=n?n.allocUnsafe:void 0;function l(c,h){if(h)return c.slice();var d=c.length,u=a?a(d):new c.constructor(d);return c.copy(u),u}o.exports=l}(Ve,Ve.exports);var pl=Ve.exports;function fl(o,e){var t=-1,r=o.length;for(e||(e=Array(r));++t<r;)e[t]=o[t];return e}var yl=fl;function wl(o,e){for(var t=-1,r=o==null?0:o.length,s=0,i=[];++t<r;){var n=o[t];e(n,t,o)&&(i[s++]=n)}return i}var vl=wl;function ml(){return[]}var qt=ml,gl=vl,bl=qt,kl=Object.prototype,Sl=kl.propertyIsEnumerable,Zt=Object.getOwnPropertySymbols,Pl=Zt?function(o){return o==null?[]:(o=Object(o),gl(Zt(o),function(e){return Sl.call(o,e)}))}:bl,dt=Pl,Il=Ye,Tl=dt;function xl(o,e){return Il(o,Tl(o),e)}var Ol=xl;function Cl(o,e){for(var t=-1,r=e.length,s=o.length;++t<r;)o[s+t]=e[t];return o}var Qt=Cl,Nl=Vt,Ll=Nl(Object.getPrototypeOf,Object),Jt=Ll,Wl=Qt,Rl=Jt,Ml=dt,jl=qt,Al=Object.getOwnPropertySymbols,Bl=Al?function(o){for(var e=[];o;)Wl(e,Ml(o)),o=Rl(o);return e}:jl,Kt=Bl,Dl=Ye,Fl=Kt;function El(o,e){return Dl(o,Fl(o),e)}var zl=El,Ul=Qt,_l=Xe;function Yl(o,e,t){var r=e(o);return _l(o)?r:Ul(r,t(o))}var er=Yl,Xl=er,$l=dt,Gl=ht;function Vl(o){return Xl(o,Gl,$l)}var tr=Vl,Hl=er,ql=Kt,Zl=ut;function Ql(o){return Hl(o,Zl,ql)}var Jl=Ql,Kl=we,ec=ie,tc=Kl(ec,"DataView"),rc=tc,oc=we,sc=ie,ic=oc(sc,"Promise"),nc=ic,ac=we,lc=ie,cc=ac(lc,"Set"),hc=cc,uc=we,dc=ie,pc=uc(dc,"WeakMap"),fc=pc,pt=rc,ft=it,yt=nc,wt=hc,vt=fc,rr=ye,Pe=Rt,or="[object Map]",yc="[object Object]",sr="[object Promise]",ir="[object Set]",nr="[object WeakMap]",ar="[object DataView]",wc=Pe(pt),vc=Pe(ft),mc=Pe(yt),gc=Pe(wt),bc=Pe(vt),ve=rr;(pt&&ve(new pt(new ArrayBuffer(1)))!=ar||ft&&ve(new ft)!=or||yt&&ve(yt.resolve())!=sr||wt&&ve(new wt)!=ir||vt&&ve(new vt)!=nr)&&(ve=function(o){var e=rr(o),t=e==yc?o.constructor:void 0,r=t?Pe(t):"";if(r)switch(r){case wc:return ar;case vc:return or;case mc:return sr;case gc:return ir;case bc:return nr}return e});var He=ve,kc=Object.prototype,Sc=kc.hasOwnProperty;function Pc(o){var e=o.length,t=new o.constructor(e);return e&&typeof o[0]=="string"&&Sc.call(o,"index")&&(t.index=o.index,t.input=o.input),t}var Ic=Pc,Tc=ie,xc=Tc.Uint8Array,lr=xc,cr=lr;function Oc(o){var e=new o.constructor(o.byteLength);return new cr(e).set(new cr(o)),e}var mt=Oc,Cc=mt;function Nc(o,e){var t=e?Cc(o.buffer):o.buffer;return new o.constructor(t,o.byteOffset,o.byteLength)}var Lc=Nc,Wc=/\w*$/;function Rc(o){var e=new o.constructor(o.source,Wc.exec(o));return e.lastIndex=o.lastIndex,e}var Mc=Rc,hr=ze,ur=hr?hr.prototype:void 0,dr=ur?ur.valueOf:void 0;function jc(o){return dr?Object(dr.call(o)):{}}var Ac=jc,Bc=mt;function Dc(o,e){var t=e?Bc(o.buffer):o.buffer;return new o.constructor(t,o.byteOffset,o.length)}var Fc=Dc,Ec=mt,zc=Lc,Uc=Mc,_c=Ac,Yc=Fc,Xc="[object Boolean]",$c="[object Date]",Gc="[object Map]",Vc="[object Number]",Hc="[object RegExp]",qc="[object Set]",Zc="[object String]",Qc="[object Symbol]",Jc="[object ArrayBuffer]",Kc="[object DataView]",eh="[object Float32Array]",th="[object Float64Array]",rh="[object Int8Array]",oh="[object Int16Array]",sh="[object Int32Array]",ih="[object Uint8Array]",nh="[object Uint8ClampedArray]",ah="[object Uint16Array]",lh="[object Uint32Array]";function ch(o,e,t){var r=o.constructor;switch(e){case Jc:return Ec(o);case Xc:case $c:return new r(+o);case Kc:return zc(o,t);case eh:case th:case rh:case oh:case sh:case ih:case nh:case ah:case lh:return Yc(o,t);case Gc:return new r;case Vc:case Zc:return new r(o);case Hc:return Uc(o);case qc:return new r;case Qc:return _c(o)}}var hh=ch,uh=he,pr=Object.create,dh=function(){function o(){}return function(e){if(!uh(e))return{};if(pr)return pr(e);o.prototype=e;var t=new o;return o.prototype=void 0,t}}(),ph=dh,fh=ph,yh=Jt,wh=ct;function vh(o){return typeof o.constructor=="function"&&!wh(o)?fh(yh(o)):{}}var mh=vh,gh=He,bh=ce,kh="[object Map]";function Sh(o){return bh(o)&&gh(o)==kh}var Ph=Sh,Ih=Ph,Th=at,fr=lt,yr=fr&&fr.isMap,xh=yr?Th(yr):Ih,Oh=xh,Ch=He,Nh=ce,Lh="[object Set]";function Wh(o){return Nh(o)&&Ch(o)==Lh}var Rh=Wh,Mh=Rh,jh=at,wr=lt,vr=wr&&wr.isSet,Ah=vr?jh(vr):Mh,Bh=Ah,Dh=Bt,Fh=on,Eh=Et,zh=qa,Uh=dl,_h=pl,Yh=yl,Xh=Ol,$h=zl,Gh=tr,Vh=Jl,Hh=He,qh=Ic,Zh=hh,Qh=mh,Jh=Xe,Kh=nt,eu=Oh,tu=he,ru=Bh,ou=ht,su=ut,iu=1,nu=2,au=4,mr="[object Arguments]",lu="[object Array]",cu="[object Boolean]",hu="[object Date]",uu="[object Error]",gr="[object Function]",du="[object GeneratorFunction]",pu="[object Map]",fu="[object Number]",br="[object Object]",yu="[object RegExp]",wu="[object Set]",vu="[object String]",mu="[object Symbol]",gu="[object WeakMap]",bu="[object ArrayBuffer]",ku="[object DataView]",Su="[object Float32Array]",Pu="[object Float64Array]",Iu="[object Int8Array]",Tu="[object Int16Array]",xu="[object Int32Array]",Ou="[object Uint8Array]",Cu="[object Uint8ClampedArray]",Nu="[object Uint16Array]",Lu="[object Uint32Array]",Y={};Y[mr]=Y[lu]=Y[bu]=Y[ku]=Y[cu]=Y[hu]=Y[Su]=Y[Pu]=Y[Iu]=Y[Tu]=Y[xu]=Y[pu]=Y[fu]=Y[br]=Y[yu]=Y[wu]=Y[vu]=Y[mu]=Y[Ou]=Y[Cu]=Y[Nu]=Y[Lu]=!0,Y[uu]=Y[gr]=Y[gu]=!1;function qe(o,e,t,r,s,i){var n,a=e&iu,l=e&nu,c=e&au;if(t&&(n=s?t(o,r,s,i):t(o)),n!==void 0)return n;if(!tu(o))return o;var h=Jh(o);if(h){if(n=qh(o),!a)return Yh(o,n)}else{var d=Hh(o),u=d==gr||d==du;if(Kh(o))return _h(o,a);if(d==br||d==mr||u&&!s){if(n=l||u?{}:Qh(o),!a)return l?$h(o,Uh(n,o)):Xh(o,zh(n,o))}else{if(!Y[d])return s?o:{};n=Zh(o,d,a)}}i||(i=new Dh);var f=i.get(o);if(f)return f;i.set(o,n),ru(o)?o.forEach(function(m){n.add(qe(m,e,t,m,o,i))}):eu(o)&&o.forEach(function(m,S){n.set(S,qe(m,e,t,S,o,i))});var w=c?l?Vh:Gh:l?su:ou,y=h?void 0:w(o);return Fh(y||o,function(m,S){y&&(S=m,m=o[S]),Eh(n,S,qe(m,e,t,S,o,i))}),n}var Wu=qe,Ru=Wu,Mu=1,ju=4;function Au(o){return Ru(o,Mu|ju)}var Bu=Au,te=Re(Bu),kr;(function(o){o[o.pedding=0]="pedding",o[o.mounted=1]="mounted",o[o.update=2]="update",o[o.unmounted=3]="unmounted"})(kr||(kr={}));var q;(function(o){o[o.Normal=0]="Normal",o[o.Stroke=1]="Stroke",o[o.Dotted=2]="Dotted",o[o.LongDotted=3]="LongDotted"})(q||(q={}));var Sr;(function(o){o.Triangle="triangle",o.Rhombus="rhombus",o.Pentagram="pentagram",o.SpeechBalloon="speechBalloon",o.Star="star",o.Polygon="polygon"})(Sr||(Sr={}));var z;(function(o){o.None="None",o.ShowFloatBar="ShowFloatBar",o.ZIndexFloatBar="ZIndexFloatBar",o.DeleteNode="DeleteNode",o.CopyNode="CopyNode",o.ZIndexActive="ZIndexActive",o.ZIndexNode="ZIndexNode",o.RotateNode="RotateNode",o.SetColorNode="SetColorNode",o.TranslateNode="TranslateNode",o.ScaleNode="ScaleNode",o.OriginalEvent="OriginalEvent",o.CreateScene="CreateScene",o.ActiveCursor="ActiveCursor",o.MoveCursor="MoveCursor",o.CommandEditor="CommandEditor",o.SetEditorData="SetEditorData",o.SetFontStyle="SetFontStyle",o.SetPoint="SetPoint",o.SetLock="SetLock",o.SetShapeOpt="SetShapeOpt"})(z||(z={}));var Pr;(function(o){o.DisplayState="DisplayState",o.FloatBar="FloatBar",o.CanvasSelector="CanvasSelector",o.MainEngine="MainEngine",o.DisplayContainer="DisplayContainer",o.Cursor="Cursor",o.TextEditor="TextEditor",o.BindMainView="BindMainView",o.MountMainView="MountMainView",o.MountAppView="MountAppView"})(Pr||(Pr={}));var Ir;(function(o){o[o.MainView=0]="MainView",o[o.Plugin=1]="Plugin",o[o.Both=2]="Both"})(Ir||(Ir={}));var g;(function(o){o[o.Pencil=1]="Pencil",o[o.Eraser=2]="Eraser",o[o.Selector=3]="Selector",o[o.Clicker=4]="Clicker",o[o.Arrow=5]="Arrow",o[o.Hand=6]="Hand",o[o.LaserPen=7]="LaserPen",o[o.Text=8]="Text",o[o.Straight=9]="Straight",o[o.Rectangle=10]="Rectangle",o[o.Ellipse=11]="Ellipse",o[o.Star=12]="Star",o[o.Triangle=13]="Triangle",o[o.Rhombus=14]="Rhombus",o[o.Polygon=15]="Polygon",o[o.SpeechBalloon=16]="SpeechBalloon",o[o.Image=17]="Image"})(g||(g={}));var M;(function(o){o[o.Local=1]="Local",o[o.Service=2]="Service",o[o.Worker=3]="Worker"})(M||(M={}));var E;(function(o){o[o.Pending=0]="Pending",o[o.Start=1]="Start",o[o.Doing=2]="Doing",o[o.Done=3]="Done",o[o.Freeze=4]="Freeze",o[o.Unwritable=5]="Unwritable"})(E||(E={}));var v;(function(o){o[o.None=0]="None",o[o.Init=1]="Init",o[o.UpdateCamera=2]="UpdateCamera",o[o.UpdateTools=3]="UpdateTools",o[o.CreateWork=4]="CreateWork",o[o.DrawWork=5]="DrawWork",o[o.FullWork=6]="FullWork",o[o.UpdateNode=7]="UpdateNode",o[o.RemoveNode=8]="RemoveNode",o[o.Clear=9]="Clear",o[o.Select=10]="Select",o[o.Destroy=11]="Destroy",o[o.Snapshot=12]="Snapshot",o[o.BoundingBox=13]="BoundingBox",o[o.Cursor=14]="Cursor",o[o.TextUpdate=15]="TextUpdate",o[o.GetTextActive=16]="GetTextActive",o[o.TasksQueue=17]="TasksQueue",o[o.CursorHover=18]="CursorHover"})(v||(v={}));var Tr;(function(o){o.Webgl2="webgl2",o.Webgl="webgl",o.Canvas2d="2d"})(Tr||(Tr={}));var N;(function(o){o[o.Float=1]="Float",o[o.Bg=2]="Bg",o[o.Selector=3]="Selector",o[o.None=4]="None"})(N||(N={}));var xr;(function(o){o[o.Cursor=1]="Cursor",o[o.TextCreate=2]="TextCreate"})(xr||(xr={}));var Or;(function(o){o[o.Top=1]="Top",o[o.Bottom=2]="Bottom"})(Or||(Or={}));var V;(function(o){o[o.none=1]="none",o[o.all=2]="all",o[o.both=3]="both",o[o.proportional=4]="proportional"})(V||(V={}));class se{constructor(){Object.defineProperty(this,"localWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serviceWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"scene",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}registerForWorker(e,t,r){return this.localWork=e,this.serviceWork=t,this.scene=r,this}}const Du={linear:o=>o,easeInQuad:o=>o*o,easeOutQuad:o=>o*(2-o),easeInOutQuad:o=>o<.5?2*o*o:-1+(4-2*o)*o,easeInCubic:o=>o*o*o,easeOutCubic:o=>--o*o*o+1,easeInOutCubic:o=>o<.5?4*o*o*o:(o-1)*(2*o-2)*(2*o-2)+1,easeInQuart:o=>o*o*o*o,easeOutQuart:o=>1- --o*o*o*o,easeInOutQuart:o=>o<.5?8*o*o*o*o:1-8*--o*o*o*o,easeInQuint:o=>o*o*o*o*o,easeOutQuint:o=>1+--o*o*o*o*o,easeInOutQuint:o=>o<.5?16*o*o*o*o*o:1+16*--o*o*o*o*o,easeInSine:o=>1-Math.cos(o*Math.PI/2),easeOutSine:o=>Math.sin(o*Math.PI/2),easeInOutSine:o=>-(Math.cos(Math.PI*o)-1)/2,easeInExpo:o=>o<=0?0:Math.pow(2,10*o-10),easeOutExpo:o=>o>=1?1:1-Math.pow(2,-10*o),easeInOutExpo:o=>o<=0?0:o>=1?1:o<.5?Math.pow(2,20*o-10)/2:(2-Math.pow(2,-20*o+10))/2};class p{constructor(e=0,t=0,r=1){Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"z",{enumerable:!0,configurable:!0,writable:!0,value:r})}get XY(){return[this.x,this.y]}setz(e){return this.z=e,this}setXY(e=this.x,t=this.y){return this.x=e,this.y=t,this}set(e=this.x,t=this.y,r=this.z){return this.x=e,this.y=t,this.z=r,this}setTo({x:e=0,y:t=0,z:r=1}){return this.x=e,this.y=t,this.z=r,this}rot(e){if(e===0)return this;const{x:t,y:r}=this,s=Math.sin(e),i=Math.cos(e);return this.x=t*i-r*s,this.y=t*s+r*i,this}rotWith(e,t){if(t===0)return this;const r=this.x-e.x,s=this.y-e.y,i=Math.sin(t),n=Math.cos(t);return this.x=e.x+(r*n-s*i),this.y=e.y+(r*i+s*n),this}clone(){const{x:e,y:t,z:r}=this;return new p(e,t,r)}sub(e){return this.x-=e.x,this.y-=e.y,this}subXY(e,t){return this.x-=e,this.y-=t,this}subScalar(e){return this.x-=e,this.y-=e,this}add(e){return this.x+=e.x,this.y+=e.y,this}addXY(e,t){return this.x+=e,this.y+=t,this}addScalar(e){return this.x+=e,this.y+=e,this}clamp(e,t){return this.x=Math.max(this.x,e),this.y=Math.max(this.y,e),t!==void 0&&(this.x=Math.min(this.x,t),this.y=Math.min(this.y,t)),this}div(e){return this.x/=e,this.y/=e,this}divV(e){return this.x/=e.x,this.y/=e.y,this}mul(e){return this.x*=e,this.y*=e,this}mulV(e){return this.x*=e.x,this.y*=e.y,this}abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this}nudge(e,t){const r=p.Tan(e,this);return this.add(r.mul(t))}neg(){return this.x*=-1,this.y*=-1,this}cross(e){return this.x=this.y*e.z-this.z*e.y,this.y=this.z*e.x-this.x*e.z,this}dpr(e){return p.Dpr(this,e)}cpr(e){return p.Cpr(this,e)}len2(){return p.Len2(this)}len(){return p.Len(this)}pry(e){return p.Pry(this,e)}per(){const{x:e,y:t}=this;return this.x=t,this.y=-e,this}uni(){return p.Uni(this)}tan(e){return p.Tan(this,e)}dist(e){return p.Dist(this,e)}distanceToLineSegment(e,t){return p.DistanceToLineSegment(e,t,this)}slope(e){return p.Slope(this,e)}snapToGrid(e){return this.x=Math.round(this.x/e)*e,this.y=Math.round(this.y/e)*e,this}angle(e){return p.Angle(this,e)}toAngle(){return p.ToAngle(this)}lrp(e,t){return this.x=this.x+(e.x-this.x)*t,this.y=this.y+(e.y-this.y)*t,this}equals(e,t){return p.Equals(this,e,t)}equalsXY(e,t){return p.EqualsXY(this,e,t)}norm(){const e=this.len();return this.x=e===0?0:this.x/e,this.y=e===0?0:this.y/e,this}toFixed(){return p.ToFixed(this)}toString(){return p.ToString(p.ToFixed(this))}toJson(){return p.ToJson(this)}toArray(){return p.ToArray(this)}static Add(e,t){return new p(e.x+t.x,e.y+t.y)}static AddXY(e,t,r){return new p(e.x+t,e.y+r)}static Sub(e,t){return new p(e.x-t.x,e.y-t.y)}static SubXY(e,t,r){return new p(e.x-t,e.y-r)}static AddScalar(e,t){return new p(e.x+t,e.y+t)}static SubScalar(e,t){return new p(e.x-t,e.y-t)}static Div(e,t){return new p(e.x/t,e.y/t)}static Mul(e,t){return new p(e.x*t,e.y*t)}static DivV(e,t){return new p(e.x/t.x,e.y/t.y)}static MulV(e,t){return new p(e.x*t.x,e.y*t.y)}static Neg(e){return new p(-e.x,-e.y)}static Per(e){return new p(e.y,-e.x)}static Dist2(e,t){return p.Sub(e,t).len2()}static Abs(e){return new p(Math.abs(e.x),Math.abs(e.y))}static Dist(e,t){return Math.hypot(e.y-t.y,e.x-t.x)}static Dpr(e,t){return e.x*t.x+e.y*t.y}static Cross(e,t){return new p(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z)}static Cpr(e,t){return e.x*t.y-t.x*e.y}static Len2(e){return e.x*e.x+e.y*e.y}static Len(e){return Math.hypot(e.x,e.y)}static Pry(e,t){return p.Dpr(e,t)/p.Len(t)}static Uni(e){return p.Div(e,p.Len(e))}static Tan(e,t){return p.Uni(p.Sub(e,t))}static Min(e,t){return new p(Math.min(e.x,t.x),Math.min(e.y,t.y))}static Max(e,t){return new p(Math.max(e.x,t.x),Math.max(e.y,t.y))}static From(e){return new p().add(e)}static FromArray(e){return new p(e[0],e[1])}static Rot(e,t=0){const r=Math.sin(t),s=Math.cos(t);return new p(e.x*s-e.y*r,e.x*r+e.y*s)}static RotWith(e,t,r){const s=e.x-t.x,i=e.y-t.y,n=Math.sin(r),a=Math.cos(r);return new p(t.x+(s*a-i*n),t.y+(s*n+i*a))}static NearestPointOnLineThroughPoint(e,t,r){return p.Mul(t,p.Sub(r,e).pry(t)).add(e)}static NearestPointOnLineSegment(e,t,r,s=!0){const i=p.Tan(t,e),n=p.Add(e,p.Mul(i,p.Sub(r,e).pry(i)));if(s){if(n.x<Math.min(e.x,t.x))return p.Cast(e.x<t.x?e:t);if(n.x>Math.max(e.x,t.x))return p.Cast(e.x>t.x?e:t);if(n.y<Math.min(e.y,t.y))return p.Cast(e.y<t.y?e:t);if(n.y>Math.max(e.y,t.y))return p.Cast(e.y>t.y?e:t)}return n}static DistanceToLineThroughPoint(e,t,r){return p.Dist(r,p.NearestPointOnLineThroughPoint(e,t,r))}static DistanceToLineSegment(e,t,r,s=!0){return p.Dist(r,p.NearestPointOnLineSegment(e,t,r,s))}static Snap(e,t=1){return new p(Math.round(e.x/t)*t,Math.round(e.y/t)*t)}static Cast(e){return e instanceof p?e:p.From(e)}static Slope(e,t){return e.x===t.y?NaN:(e.y-t.y)/(e.x-t.x)}static Angle(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}static Lrp(e,t,r){return p.Sub(t,e).mul(r).add(e)}static Med(e,t){return new p((e.x+t.x)/2,(e.y+t.y)/2)}static Equals(e,t,r=1e-4){return Math.abs(e.x-t.x)<r&&Math.abs(e.y-t.y)<r}static EqualsXY(e,t,r){return e.x===t&&e.y===r}static EqualsXYZ(e,t,r=1e-4){return p.Equals(e,t,r)&&Math.abs((e.z||0)-(t.z||0))<r}static Clockwise(e,t,r){return(r.x-e.x)*(t.y-e.y)-(t.x-e.x)*(r.y-e.y)<0}static Rescale(e,t){const r=p.Len(e);return new p(t*e.x/r,t*e.y/r)}static ScaleWithOrigin(e,t,r){return p.Sub(e,r).mul(t).add(r)}static ScaleWOrigin(e,t,r){return p.Sub(e,r).mulV(t).add(r)}static ToFixed(e,t=2){return new p(+e.x.toFixed(t),+e.y.toFixed(t),+e.z.toFixed(t))}static Nudge(e,t,r){return p.Add(e,p.Tan(t,e).mul(r))}static ToString(e){return`${e.x}, ${e.y}`}static ToAngle(e){let t=Math.atan2(e.y,e.x);return t<0&&(t+=Math.PI*2),t}static FromAngle(e,t=1){return new p(Math.cos(e)*t,Math.sin(e)*t)}static ToArray(e){return[e.x,e.y,e.z]}static ToJson(e){const{x:t,y:r,z:s}=e;return{x:t,y:r,z:s}}static Average(e){const t=e.length,r=new p(0,0);for(let s=0;s<t;s++)r.add(e[s]);return r.div(t)}static Clamp(e,t,r){return r===void 0?new p(Math.min(Math.max(e.x,t)),Math.min(Math.max(e.y,t))):new p(Math.min(Math.max(e.x,t),r),Math.min(Math.max(e.y,t),r))}static PointsBetween(e,t,r=6){const s=[];for(let i=0;i<r;i++){const n=Du.easeInQuad(i/(r-1)),a=p.Lrp(e,t,n);a.z=Math.min(1,.5+Math.abs(.5-Fu(n))*.65),s.push(a)}return s}static SnapToGrid(e,t=8){return new p(Math.round(e.x/t)*t,Math.round(e.y/t)*t)}}const Fu=o=>o<.5?2*o*o:-1+(4-2*o)*o;class W extends p{constructor(e=0,t=0,r=0,s={x:0,y:0},i=0,n=0){super(e,t,r),Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"z",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"v",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"t",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"a",{enumerable:!0,configurable:!0,writable:!0,value:n})}get timestamp(){return this.t}get pressure(){return this.z}get angleNum(){return this.a}get XY(){return[this.x,this.y]}setA(e){this.a=e}setT(e){this.t=e}setv(e){return this.v={x:e.x,y:e.y},this}set(e=this.x,t=this.y,r=this.z,s=this.v,i=this.t,n=this.a){return this.x=e,this.y=t,this.z=r,this.v=s,this.t=i,this.a=n,this}clone(){const{x:e,y:t,z:r,v:s,t:i,a:n}=this,a={x:s.x,y:s.y};return new W(e,t,r,a,i,n)}distance(e){return W.GetDistance(this,e)}isNear(e,t){return W.IsNear(this,e,t)}getAngleByPoints(e,t){return W.GetAngleByPoints(e,this,t)}static Sub(e,t){return new W(e.x-t.x,e.y-t.y)}static Add(e,t){return new W(e.x+t.x,e.y+t.y)}static GetDistance(e,t){return W.Len(e.clone().sub(t))}static GetAngleByPoints(e,t,r){const s=t.x-e.x,i=r.x-t.x,n=t.y-e.y,a=r.y-t.y;let l=0;const c=Math.sqrt(s*s+n*n),h=Math.sqrt(i*i+a*a);if(c&&h){const d=s*i+n*a;l=Math.acos(d/(c*h)),l=l/Math.PI*180;let u=s*a-n*i;u=u>0?1:-1,l=180+u*l}return l}static IsNear(e,t,r){return W.Len(e.clone().sub(t))<r}static RotWith(e,t,r,s=2){const i=e.x-t.x,n=e.y-t.y,a=Math.sin(r),l=Math.cos(r),c=Math.pow(10,s),h=Math.floor((t.x+(i*l-n*a))*c)/c,d=Math.floor((t.y+(i*a+n*l))*c)/c;return new W(h,d)}static GetDotStroke(e,t,r=16){const s=new p(1,1),i=Math.PI+.001,n=W.Add(e,W.Sub(e,s).uni().per().mul(-t)),a=[];for(let l=1/r,c=l;c<=1;c+=l)a.push(W.RotWith(n,e,i*2*c));return a}static GetSemicircleStroke(e,t,r=-1,s=8){const i=r*(Math.PI+.001),n=[];for(let a=1/s,l=a;l<=1;l+=a)n.push(W.RotWith(t,e,i*l));return n}}function j(o,e){if(o&&e){const t=Math.min(o.x,e.x),r=Math.min(o.y,e.y),s=Math.max(o.x+o.w,e.x+e.w),i=Math.max(o.y+o.h,e.y+e.h),n=s-t,a=i-r;return{x:t,y:r,w:n,h:a}}return e||o}function X(o,e=0){const t={x:0,y:0,w:0,h:0};let r=1/0,s=1/0,i=-1/0,n=-1/0;return o.forEach(a=>{const[l,c]=a.XY;r=Math.min(r,l-e),s=Math.min(s,c-e),i=Math.max(i,l+e),n=Math.max(n,c+e)}),t.x=r,t.y=s,t.w=i-r,t.h=n-s,t}function Ie(o,e){return!(o.x+o.w<e.x||o.x>e.x+e.w||o.y+o.h<e.y||o.y>e.y+e.h)}function Eu(o,e){return o.length===e.length&&o.sort().toString()===e.sort().toString()}function J(o,e=10){return{x:Math.floor(o.x-e),y:Math.floor(o.y-e),w:Math.floor(o.w+e*2),h:Math.floor(o.h+e*2)}}function je(o,e){return{x:o.x+e[0],y:o.y+e[1],w:o.w,h:o.h}}function Cr(o,e){const t=new p(o.x,o.y),r=new p(o.x+o.w,o.y),s=new p(o.x+o.w,o.y+o.h),i=new p(o.x,o.y+o.h),n=new p(o.x+o.w/2,o.y+o.h/2),a=Math.PI*e/180,l=p.RotWith(t,n,a),c=p.RotWith(r,n,a),h=p.RotWith(s,n,a),d=p.RotWith(i,n,a);return X([l,c,h,d])}function Nr(o,e){const t=new p(o.x,o.y),r=new p(o.x+o.w,o.y),s=new p(o.x+o.w,o.y+o.h),i=new p(o.x,o.y+o.h),n=new p(o.x+o.w/2,o.y+o.h/2),a=new p(e[0],e[1]),l=p.ScaleWOrigin(t,a,n),c=p.ScaleWOrigin(r,a,n),h=p.ScaleWOrigin(s,a,n),d=p.ScaleWOrigin(i,a,n);return X([l,c,h,d])}function zu(o,e,t){const r=new p(e[0],e[1]);for(let s=0;s<o.length;s+=3){const i=new p(o[s],o[s+1]),n=Math.PI*t/180,a=p.RotWith(i,r,n);o[s]=a.x,o[s+1]=a.y}}function Uu(o,e,t){const r=new p(e[0],e[1]);for(let s=0;s<o.length;s+=3){const i=new p(o[s],o[s+1]),n=new p(t[0],t[1]);if(s<o.length-3){const l=new p(o[s+3],o[s+4]),c=p.Tan(l,i).per().mul(o[s+2]).mulV(n).len();o[s+2]=c}else if(s===o.length-3){const l=new p(o[s-3],o[s-2]),c=p.Tan(i,l).per().mul(o[s+2]).mulV(n).len();o[s+2]=c}const a=p.ScaleWOrigin(i,n,r);o[s]=a.x,o[s+1]=a.y}}function _u(o,e){return o[0]>=e.x&&o[0]<=e.x+e.w&&o[1]>=e.y&&o[1]<=e.y+e.h}function Lr(o,e){const t=o<=e?1:o/e,r=e<=o?1:e/o;return[t,r]}const Ze=o=>{if(o.tagName==="GROUP"){const e=Object.getOwnPropertySymbols(o).find(t=>t.toString()==="Symbol(sealed)");if(e&&o[e])return!0}return!1},Wr=o=>o!==g.Text;function Te(o){return`${Qe(o.x)},${Qe(o.y)} `}function xe(o,e){return`${Qe((o.x+e.x)/2)},${Qe((o.y+e.y)/2)} `}function Qe(o){return+o.toFixed(4)}var Yu=ye,Xu=ce,$u="[object Number]";function Gu(o){return typeof o=="number"||Xu(o)&&Yu(o)==$u}var Vu=Gu,ue=Re(Vu);class k{constructor(e){Object.defineProperty(this,"syncUnitTime",{enumerable:!0,configurable:!0,writable:!0,value:1e3}),Object.defineProperty(this,"vNodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workId",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{vNodes:t,fullLayer:r,drawLayer:s}=e;this.vNodes=t,this.fullLayer=r,this.drawLayer=s}setWorkId(e){this.workId=e}getWorkId(){return this.workId}getWorkOptions(){return this.workOptions}setWorkOptions(e){var t;this.workOptions=e,this.syncUnitTime=e.syncUnitTime||this.syncUnitTime;const r=(t=this.workId)==null?void 0:t.toString(),s=r&&this.vNodes.get(r)||void 0;r&&s&&(s.opt=e,this.vNodes.setInfo(r,s))}updataOptService(e){var t;let r;const s=(t=this.workId)==null?void 0:t.toString();if(s&&e){const i=this.fullLayer.getElementsByName(s)||this.drawLayer&&this.drawLayer.getElementsByName(s)||[];if(i.length!==1)return;const n=i[0],{pos:a,zIndex:l,scale:c,angle:h,translate:d}=e,u={};ue(l)&&(u.zIndex=l),a&&(u.pos=[a[0],a[1]]),c&&(u.scale=c),h&&(u.rotate=h),d&&(u.translate=d),n.attr(u);const f=n==null?void 0:n.getBoundingClientRect();return f&&(r=j(r,{x:Math.floor(f.x-k.SafeBorderPadding),y:Math.floor(f.y-k.SafeBorderPadding),w:Math.floor(f.width+k.SafeBorderPadding*2),h:Math.floor(f.height+k.SafeBorderPadding*2)})),this.vNodes.setInfo(s,{rect:r,centerPos:a}),r}}static updateNodeOpt(e){const{node:t,opt:r,vNodes:s,willSerializeData:i,targetNode:n}=e,{zIndex:a,translate:l,angle:c,box:h,boxScale:d,boxTranslate:u,pointMap:f}=r;let w;const y=n&&te(n)||s.get(t.name);if(!y)return;ue(a)&&(t.setAttribute("zIndex",a),y.opt.zIndex=a);const m=t.parent;if(m){if(h&&u&&d){const{rect:S}=y,P=[];for(let B=0;B<y.op.length;B+=3)P.push(new W(y.op[B],y.op[B+1],y.op[B+2]));const T=X(P),I=[T.w*m.worldScaling[0],T.h*m.worldScaling[0]],b=[S.w-I[0],S.h-I[1]],C=[(S.w*d[0]-b[0])/I[0],(S.h*d[1]-b[1])/I[1]],L=[u[0]/m.worldScaling[0],u[1]/m.worldScaling[1]],O=y.op.map((B,G)=>{const K=G%3;return K===0?B+L[0]:K===1?B+L[1]:B}),R=[y.centerPos[0]+L[0],y.centerPos[1]+L[1]];Uu(O,R,C);const A=[];for(let B=0;B<O.length;B+=3)A.push(new W(O[B],O[B+1],O[B+2]));y.op=O,y.centerPos=R}else if(l){const S=[l[0]/m.worldScaling[0],l[1]/m.worldScaling[1]];t.setAttribute("translate",S),y.opt.translate=S,n&&(w=je(y.rect,l),y.rect=w)}else ue(c)&&(t.setAttribute("rotate",c),y.opt.rotate=c,n&&(w=Cr(y.rect,c),y.rect=w));if(f){const S=f.get(t.name);if(S)for(let P=0,T=0;P<y.op.length;P+=3,T++)y.op[P]=S[T][0],y.op[P+1]=S[T][1]}if(i){if(l){const S=[l[0]/m.worldScaling[0],l[1]/m.worldScaling[1]],P=y.op.map((T,I)=>{const b=I%3;return b===0?T+S[0]:b===1?T+S[1]:T});y.op=P,y.centerPos=[y.centerPos[0]+S[0],y.centerPos[1]+S[1]],y!=null&&y.opt&&(y.opt.translate=void 0)}else if(ue(c)){const S=y.op;zu(S,y.centerPos,c),y.op=S,y!=null&&y.opt&&(y.opt.rotate=void 0)}}y&&s.setInfo(t.name,y)}}static getCenterPos(e,t){const{worldPosition:r,worldScaling:s}=t;return[(e.x+e.w/2-r[0])/s[0],(e.y+e.h/2-r[1])/s[1]]}static getRectFromLayer(e,t){const r=e.getElementsByName(t)[0];if(r){const s=r.getBoundingClientRect();return{x:Math.floor(s.x-k.SafeBorderPadding),y:Math.floor(s.y-k.SafeBorderPadding),w:Math.floor(s.width+k.SafeBorderPadding*2),h:Math.floor(s.height+k.SafeBorderPadding*2)}}}}Object.defineProperty(k,"SafeBorderPadding",{enumerable:!0,configurable:!0,writable:!0,value:10});function Oe(o,e=!0){const t=o.length;if(t<2)return"";let r=o[0],s=o[1];if(t===2)return`M${Te(r)}L${Te(s)}`;let i="";for(let n=2,a=t-1;n<a;n++)r=o[n],s=o[n+1],i+=xe(r,s);return e?`M${xe(o[0],o[1])}Q${Te(o[1])}${xe(o[1],o[2])}T${i}${xe(o[t-1],o[0])}${xe(o[0],o[1])}Z`:`M${Te(o[0])}Q${Te(o[1])}${xe(o[1],o[2])}${o.length>3?"T":""}${i}L${Te(o[t-1])}`}function Je(o){return JSON.parse(It.decompress(o))}function le(o){return It.compress(JSON.stringify(o))}class Rr extends k{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.Pencil}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"MAX_REPEAR",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"uniThickness",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"centerPos",{enumerable:!0,configurable:!0,writable:!0,value:[0,0]}),this.workOptions=e.toolsOpt,this.uniThickness=this.MAX_REPEAR/this.workOptions.thickness/10,this.syncTimestamp=0}combineConsume(){var e;const t=(e=this.workId)==null?void 0:e.toString(),r=this.transformDataAll(!0),s={name:t};let i;const n=this.drawLayer||this.fullLayer;return r.length&&(i=this.draw({attrs:s,tasks:r,replaceId:t,layer:n,isClearAll:!0})),{rect:i,type:v.DrawWork,dataType:M.Local}}setWorkOptions(e){super.setWorkOptions(e),this.syncTimestamp=Date.now()}consume(e){var t;const{data:r,isFullWork:s,isClearAll:i,isSubWorker:n}=e;if(((t=r.op)==null?void 0:t.length)===0)return{type:v.None};const{workId:a}=r,{tasks:l,effects:c,consumeIndex:h}=this.transformData(r,!1);this.syncIndex=Math.min(this.syncIndex,h,Math.max(0,this.tmpPoints.length-2));const d={name:a==null?void 0:a.toString()};let u,f=!1;const w=this.syncIndex;if(this.syncTimestamp===0&&(this.syncTimestamp=Date.now()),l.length&&(l[0].taskId-this.syncTimestamp>this.syncUnitTime&&(f=!0,this.syncTimestamp=l[0].taskId,this.syncIndex=this.tmpPoints.length),n)){const m=s?this.fullLayer:this.drawLayer||this.fullLayer;u=this.draw({attrs:d,tasks:l,effects:c,layer:m,isClearAll:i})}if(n)return h>10&&this.tmpPoints.splice(0,h-10),{rect:u,type:v.DrawWork,dataType:M.Local};const y=[];return this.tmpPoints.slice(w).forEach(m=>{y.push(m.x,m.y,this.computRadius(m.z,this.workOptions.thickness))}),{rect:u,type:v.DrawWork,dataType:M.Local,workId:f?a:void 0,op:f?y:void 0,index:f?w*3:void 0}}consumeAll(e){var t,r;if(e.data){const{op:d,workState:u}=e.data;d!=null&&d.length&&u===E.Done&&this.workOptions.strokeType===q.Stroke&&this.updateTempPointsWithPressureWhenDone(d)}const s=(t=this.workId)==null?void 0:t.toString();if(!s)return{type:v.None};const i=this.transformDataAll(!0),n={name:s};let a;const l=this.fullLayer;i.length&&(a=this.draw({attrs:n,tasks:i,replaceId:s,layer:l,isClearAll:!1}));const c=[];this.tmpPoints.map(d=>{c.push(d.x,d.y,this.computRadius(d.z,this.workOptions.thickness))}),this.syncTimestamp=0,delete this.workOptions.syncUnitTime;const h=le(c);return this.vNodes.setInfo(s,{rect:a,op:c,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:a&&k.getCenterPos(a,l)}),{rect:a,type:v.FullWork,dataType:M.Local,workId:s,ops:h,updateNodeOpt:{pos:this.centerPos,useAnimation:!0},opt:this.workOptions,undoTickerId:(r=e.data)==null?void 0:r.undoTickerId}}clearTmpPoints(){this.tmpPoints.length=0,this.syncTimestamp=0,this.syncIndex=0}consumeService(e){var t;const{op:r,isFullWork:s,replaceId:i,isClearAll:n}=e;this.tmpPoints.length=0;for(let d=0;d<r.length;d+=3){const u=new W(r[d],r[d+1],r[d+2]);if(this.tmpPoints.length>0){const f=this.tmpPoints[this.tmpPoints.length-1],w=p.Sub(u,f).uni();u.setv(w)}this.tmpPoints.push(u)}const a=this.transformDataAll(!1),l=(t=this.workId)==null?void 0:t.toString(),c={name:l};let h;if(l&&a.length){const d=s?this.fullLayer:this.drawLayer||this.fullLayer;h=this.draw({attrs:c,tasks:a,replaceId:i,layer:d,isClearAll:n}),this.vNodes.setInfo(l,{rect:h,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:h&&k.getCenterPos(h,d)})}return h}transformDataAll(e=!0){return this.getTaskPoints(this.tmpPoints,e&&this.workOptions.thickness||void 0)}draw(e){var t;const{attrs:r,tasks:s,replaceId:i,effects:n,layer:a,isClearAll:l}=e,{strokeColor:c,strokeType:h,thickness:d,zIndex:u,scale:f,rotate:w,translate:y}=this.workOptions;l&&a.removeAllChildren(),i&&(this.fullLayer.getElementsByName(i+"").map(b=>b.remove()),(t=this.drawLayer)==null||t.getElementsByName(i+"").map(b=>b.remove())),n!=null&&n.size&&(n.forEach(b=>{var C;(C=a.getElementById(b+""))==null||C.remove()}),n.clear());let m;const S=[],P=a.worldPosition,T=a.worldScaling;for(let b=0;b<s.length;b++){const{pos:C,points:L,taskId:O}=s[b];r.id=O.toString();const{ps:R,rect:A}=this.computDrawPoints(L);let B;const G=L.length===1;h===q.Stroke||G?B=Oe(R,!0):B=Oe(R,!1);const K={pos:C,d:B,fillColor:h===q.Stroke||G?c:void 0,lineDash:h===q.Dotted&&!G?[1,d*2]:h===q.LongDotted&&!G?[d,d*2]:void 0,strokeColor:c,lineCap:h===q.Stroke||G?void 0:"round",lineWidth:h===q.Stroke||G?0:d};m=j(m,{x:Math.floor((A.x+C[0])*T[0]+P[0]-k.SafeBorderPadding),y:Math.floor((A.y+C[1])*T[1]+P[1]-k.SafeBorderPadding),w:Math.floor(A.w*T[0]+2*k.SafeBorderPadding),h:Math.floor(A.h*T[1]+2*k.SafeBorderPadding)}),S.push(K)}f&&(r.scale=f),w&&(r.rotate=w),y&&(r.translate=y);const I=new _.Group;if(m){this.centerPos=k.getCenterPos(m,a),I.attr({...r,normalize:!0,id:r.name,anchor:[.5,.5],bgcolor:h===q.Stroke?c:void 0,pos:this.centerPos,size:[(m.w-2*k.SafeBorderPadding)/T[0],(m.h-2*k.SafeBorderPadding)/T[1]],zIndex:u});const b=S.map(C=>(C.pos=[C.pos[0]-this.centerPos[0],C.pos[1]-this.centerPos[1]],new _.Path(C)));I.append(...b),h===q.Stroke&&I.seal(),a.append(I)}if(f||w||y){const b=I==null?void 0:I.getBoundingClientRect();if(b)return{x:Math.floor(b.x-k.SafeBorderPadding),y:Math.floor(b.y-k.SafeBorderPadding),w:Math.floor(b.width+k.SafeBorderPadding*2),h:Math.floor(b.height+k.SafeBorderPadding*2)}}return m}computDrawPoints(e){return this.workOptions.strokeType===q.Stroke||e.length===1?this.computStroke(e):this.computNomal(e)}computNomal(e){let t=this.workOptions.thickness;const r=e.map(s=>(t=Math.max(t,s.radius),s.point));return{ps:r,rect:X(r,t)}}computStroke(e){return e.length===1?this.computDotStroke(e[0]):this.computLineStroke(e)}computLineStroke(e){const t=[],r=[];for(let l=0;l<e.length;l++){const{point:c,radius:h}=e[l];let d=c.v;l===0&&e.length>1&&(d=e[l+1].point.v);const u=p.Per(d).mul(h);t.push(W.Sub(c,u)),r.push(W.Add(c,u))}const s=e[e.length-1],i=W.GetSemicircleStroke(s.point,t[t.length-1],-1,8),n=W.GetSemicircleStroke(e[0].point,r[0],-1,8),a=t.concat(i,r.reverse(),n);return{ps:a,rect:X(a)}}computDotStroke(e){const{point:t,radius:r}=e,s={x:t.x-r,y:t.y-r,w:r*2,h:r*2};return{ps:W.GetDotStroke(t,r,8),rect:s}}transformData(e,t){const{op:r,workState:s}=e;let i=this.tmpPoints.length-1,n=[];if(r!=null&&r.length&&s){const{strokeType:a,thickness:l}=this.workOptions,c=new Set;i=a===q.Stroke?this.updateTempPointsWithPressure(r,l,c):this.updateTempPoints(r,l,c);const h=t?this.tmpPoints:this.tmpPoints.slice(i);return n=this.getTaskPoints(h,l),{tasks:n,effects:c,consumeIndex:i}}return{tasks:n,consumeIndex:i}}computRadius(e,t){return e*.03*t+t*.5}getMinZ(e,t){return((t||Math.max(1,Math.floor(e*.3)))-e*.5)*100/e/3}getTaskPoints(e,t){var r;const s=[];if(e.length===0)return[];let i=0,n=e[0].x,a=e[0].y,l=[n,a],c=[],h=e[0].t;for(;i<e.length;){const d=e[i],u=d.x-n,f=d.y-a,w=d.z,y=t?this.computRadius(w,t):w;if(c.push({point:new W(u,f,w,e[i].v),radius:y}),i>0&&i<e.length-1){const m=e[i].getAngleByPoints(e[i-1],e[i+1]);if(m<90||m>270){const S=(r=c.pop())==null?void 0:r.point.clone();S&&s.push({taskId:h,pos:l,points:[...c,{point:S,radius:y}]}),n=e[i].x,a=e[i].y,l=[n,a];const P=d.x-n,T=d.y-a;c=[{point:new W(P,T,w),radius:y}],h=Date.now()}}i++}return s.push({taskId:h,pos:l,points:c}),s}updateTempPointsWithPressure(e,t,r){const s=Date.now(),i=this.tmpPoints.length;let n=i;for(let l=0;l<e.length;l+=2){n=Math.min(n,i);const c=this.tmpPoints.length,h=new W(e[l],e[l+1]);if(c===0){this.tmpPoints.push(h);continue}const d=c-1,u=this.tmpPoints[d],f=p.Sub(h,u).uni();if(h.isNear(u,t)){if(u.z<this.MAX_REPEAR){if(u.setz(Math.min(u.z+1,this.MAX_REPEAR)),n=Math.min(n,d),c>1){let m=c-1;for(;m>0;){const S=this.tmpPoints[m].distance(this.tmpPoints[m-1]),P=Math.max(this.tmpPoints[m].z-this.uniThickness*S,0);if(this.tmpPoints[m-1].z>=P)break;this.tmpPoints[m-1].setz(P),n=Math.min(n,m-1),m--}}}else n=1/0;continue}h.setv(f);const w=h.distance(u),y=Math.max(u.z-this.uniThickness*w,0);c>1&&p.Equals(f,u.v,.02)&&(y>0||u.z<=0)&&(r&&u.t&&r.add(u.t),this.tmpPoints.pop(),n=Math.min(d,n)),h.setz(y),this.tmpPoints.push(h)}if(n===1/0)return this.tmpPoints.length;let a=i;if(n===i){a=Math.max(a-1,0);const l=this.tmpPoints[a].t;l&&(r==null||r.add(l))}else{let l=i-1;for(a=n;l>=0;){const c=this.tmpPoints[l].t;if(c&&(r==null||r.add(c),l<=n)){a=l,l=-1;break}l--}}return this.tmpPoints[a].setT(s),a}updateTempPoints(e,t,r){var s;const i=Date.now(),n=this.tmpPoints.length;let a=n;for(let c=0;c<e.length;c+=2){const h=this.tmpPoints.length,d=new W(e[c],e[c+1]);if(h===0){this.tmpPoints.push(d);continue}const u=h-1,f=this.tmpPoints[u],w=p.Sub(d,f).uni();if(d.isNear(f,t/2)){a=Math.min(u,a);continue}p.Equals(w,f.v,.02)&&(r&&f.t&&r.add(f.t),this.tmpPoints.pop(),a=Math.min(u,a)),d.setv(w),this.tmpPoints.push(d)}let l=n;if(a===n){l=Math.max(l-1,0);const c=this.tmpPoints[l].t;c&&(r==null||r.add(c))}else{let c=Math.min(n-1,a);for(l=a;c>=0;){const h=(s=this.tmpPoints[c])==null?void 0:s.t;if(h&&(r==null||r.add(h),c<=a)){l=c,c=-1;break}c--}}return this.tmpPoints[l].setT(i),l}updateTempPointsWithPressureWhenDone(e){const{thickness:t}=this.workOptions,r=e.length,s=this.getMinZ(t);for(let i=0;i<r;i+=2){const n=this.tmpPoints.length,a=new W(e[i],e[i+1]);if(n===0){this.tmpPoints.push(a);continue}const l=n-1,c=this.tmpPoints[l],h=p.Sub(a,c).uni(),d=a.distance(c);if(n>1&&c.z===s)break;if(a.isNear(c,t/2)){if(r<3&&c.z<this.MAX_REPEAR&&(c.setz(Math.min(c.z+1,this.MAX_REPEAR)),n>1)){let f=n-1;for(;f>0;){const w=this.tmpPoints[f].distance(this.tmpPoints[f-1]),y=Math.max(this.tmpPoints[f].z-this.uniThickness*w,-t/4);if(this.tmpPoints[f-1].z>=y)break;this.tmpPoints[f-1].setz(y),f--}}continue}a.setv(h);const u=Math.max(c.z-this.uniThickness*d,s);n>1&&p.Equals(h,c.v,.02)&&c.z<=0&&this.tmpPoints.pop(),a.setz(u),this.tmpPoints.push(a)}}static updateNodeOpt(e){var t;const{node:r,opt:s,vNodes:i}=e,{strokeColor:n}=s,a=i.get(r.name);return n&&(r.tagName==="GROUP"?Ze(r)?r.setAttribute("bgcolor",n):r.children.forEach(l=>{l.setAttribute("strokeColor",n),l.getAttribute("fillColor")&&l.setAttribute("fillColor",n)}):(r.setAttribute("strokeColor",n),r.setAttribute("fillColor",n)),(t=a==null?void 0:a.opt)!=null&&t.strokeColor&&(a.opt.strokeColor=n)),a&&i.setInfo(r.name,a),k.updateNodeOpt(e)}static getRectFromLayer(e,t){const r=e.getElementsByName(t)[0];if(r){const s=r.getBoundingClientRect();return{x:Math.floor(s.x-k.SafeBorderPadding),y:Math.floor(s.y-k.SafeBorderPadding),w:Math.floor(s.width+k.SafeBorderPadding*2),h:Math.floor(s.height+k.SafeBorderPadding*2)}}}}class Mr extends k{constructor(e){super(e),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.LaserPen}),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.none}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"consumeIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.workOptions=e.toolsOpt,this.syncTimestamp=0}combineConsume(){}setWorkOptions(e){super.setWorkOptions(e),this.syncTimestamp=Date.now()}consume(e){const{data:t,isSubWorker:r}=e,{workId:s,op:i}=t;if((i==null?void 0:i.length)===0)return{type:v.None};if(this.updateTempPoints(i||[]),this.consumeIndex>this.tmpPoints.length-4)return{type:v.None};const{strokeColor:n,thickness:a,strokeType:l}=this.workOptions,c=X(this.tmpPoints,a);let h=!1;const d=this.syncIndex,u=this.tmpPoints.slice(this.consumeIndex);this.consumeIndex=this.tmpPoints.length-1,this.syncTimestamp===0&&(this.syncTimestamp=Date.now());const f={name:s==null?void 0:s.toString(),opacity:1,lineDash:l===q.Dotted?[1,a*2]:l===q.LongDotted?[a,a*2]:void 0,strokeColor:n,lineCap:"round",lineWidth:a,anchor:[.5,.5]},w=this.getTaskPoints(u);if(w.length){const m=Date.now();m-this.syncTimestamp>this.syncUnitTime&&(h=!0,this.syncTimestamp=m,this.syncIndex=this.tmpPoints.length),r&&this.draw({attrs:f,tasks:w,isDot:!1,layer:this.drawLayer||this.fullLayer})}const y=[];return this.tmpPoints.slice(d).forEach(m=>{y.push(m.x,m.y)}),{rect:{x:c.x*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],y:c.y*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1],w:c.w*this.fullLayer.worldScaling[0],h:c.h*this.fullLayer.worldScaling[1]},type:v.DrawWork,dataType:M.Local,workId:h?s:void 0,op:h?y:void 0,index:h?d*2:void 0}}consumeAll(){var e;const t=(e=this.workId)==null?void 0:e.toString();let r;if(this.tmpPoints.length-1>this.consumeIndex){let i=this.tmpPoints.slice(this.consumeIndex);const n=i.length===1,{strokeColor:a,thickness:l,strokeType:c}=this.workOptions;if(n){const u=this.computDotStroke({point:i[0],radius:l/2});i=u.ps,r=u.rect}else r=X(this.tmpPoints,l);const h={name:t==null?void 0:t.toString(),fillColor:n?a:void 0,opacity:1,lineDash:c===q.Dotted&&!n?[1,l*2]:c===q.LongDotted&&!n?[l,l*2]:void 0,strokeColor:a,lineCap:n?void 0:"round",lineWidth:n?0:l,anchor:[.5,.5]},d=this.getTaskPoints(i);d.length&&this.draw({attrs:h,tasks:d,isDot:n,layer:this.drawLayer||this.fullLayer})}const s=[];return this.tmpPoints.slice(this.syncIndex).forEach(i=>{s.push(i.x,i.y)}),{rect:r&&{x:r.x*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],y:r.y*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1],w:r.w*this.fullLayer.worldScaling[0],h:r.h*this.fullLayer.worldScaling[1]},type:v.DrawWork,dataType:M.Local,workId:t,op:s,index:this.syncIndex*2}}clearTmpPoints(){this.tmpPoints.length=0,this.syncTimestamp=0,this.syncIndex=0}consumeService(e){var t;const{op:r,replaceId:s,isFullWork:i}=e,{strokeColor:n,thickness:a,strokeType:l}=this.workOptions;if(!r.length){const y=X(this.tmpPoints,a);return{x:y.x*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],y:y.y*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1],w:y.w*this.fullLayer.worldScaling[0],h:y.h*this.fullLayer.worldScaling[1]}}const c=Math.max(0,this.tmpPoints.length-1);this.updateTempPoints(r||[]);let h,d=this.tmpPoints.slice(c);const u=d.length===1;if(u){const y=this.computDotStroke({point:d[0],radius:a/2});d=y.ps,h=y.rect}else h=X(this.tmpPoints,a);const f={name:(t=this.workId)==null?void 0:t.toString(),fillColor:u?n:void 0,opacity:1,lineDash:l===q.Dotted&&!u?[1,a*2]:l===q.LongDotted&&!u?[a,a*2]:void 0,strokeColor:n,lineCap:u?void 0:"round",lineWidth:u?0:a,anchor:[.5,.5]},w=this.getTaskPoints(d);if(w.length){const y=i?this.fullLayer:this.drawLayer||this.fullLayer;this.draw({attrs:f,tasks:w,isDot:u,replaceId:s,layer:y})}return{x:h.x*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],y:h.y*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1],w:h.w*this.fullLayer.worldScaling[0],h:h.h*this.fullLayer.worldScaling[1]}}computDotStroke(e){const{point:t,radius:r}=e,s={x:t.x-r,y:t.y-r,w:r*2,h:r*2};return{ps:W.GetDotStroke(t,r,8),rect:s}}updateTempPoints(e){const t=this.tmpPoints.length;for(let r=0;r<e.length;r+=2){if(t){const s=this.tmpPoints.slice(-1)[0];s&&s.x===e[r]&&s.y===e[r+1]&&this.tmpPoints.pop()}this.tmpPoints.push(new W(e[r],e[r+1]))}}async draw(e){const{attrs:t,tasks:r,isDot:s,layer:i}=e,{duration:n}=this.workOptions;for(const a of r){const l=new _.Path,{pos:c,points:h}=a;let d;s?d=Oe(h,!0):d=Oe(h,!1),l.attr({...t,pos:c,d});const{vertex:u,fragment:f}=this.workOptions;if(u&&f){const w=i.renderer.createProgram({vertex:u,fragment:f}),{width:y,height:m}=i.getResolution();l.setUniforms({u_time:0,u_resolution:[y,m]}),l.setProgram(w)}i.appendChild(l),l.transition(n).attr({scale:s?[.1,.1]:[1,1],lineWidth:s?0:1}).then(()=>{l.remove()})}}getTaskPoints(e){var t;const r=[];if(e.length===0)return[];let s=0,i=e[0].x,n=e[0].y,a=[i,n],l=[];for(;s<e.length;){const c=e[s],h=c.x-i,d=c.y-n;if(l.push(new W(h,d)),s>0&&s<e.length-1){const u=e[s].getAngleByPoints(e[s-1],e[s+1]);if(u<90||u>270){const f=(t=l.pop())==null?void 0:t.clone();f&&r.push({pos:a,points:[...l,f]}),i=e[s].x,n=e[s].y,a=[i,n];const w=c.x-i,y=c.y-n;l=[new W(w,y)]}}s++}return r.push({pos:a,points:l}),r}removeLocal(){}removeService(e){let t;const r=[];return this.fullLayer.getElementsByName(e).forEach(s=>{if(s.name===e){const i=s.getBoundingClientRect();t=j(t,{x:i.x,y:i.y,w:i.width,h:i.height}),r.push(s)}}),r.length&&r.forEach(s=>s.remove()),t}}class ne extends k{constructor(e,t){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.none}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.Eraser}),Object.defineProperty(this,"serviceWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"worldPosition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"worldScaling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"eraserRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"eraserPolyline",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.serviceWork=t,this.workOptions=e.toolsOpt,this.worldPosition=this.fullLayer.worldPosition,this.worldScaling=this.fullLayer.worldScaling}combineConsume(){}consumeService(){}setWorkOptions(e){super.setWorkOptions(e)}createEraserRect(e){const t=e[0]*this.worldScaling[0]+this.worldPosition[0],r=e[1]*this.worldScaling[1]+this.worldPosition[1],{width:s,height:i}=ne.eraserSizes[this.workOptions.thickness];this.eraserRect={x:t-s*.5,y:r-i*.5,w:s,h:i},this.eraserPolyline=[this.eraserRect.x,this.eraserRect.y,this.eraserRect.x+this.eraserRect.w,this.eraserRect.y+this.eraserRect.h]}computRectCenterPoints(){const e=this.tmpPoints.slice(-2);if(this.tmpPoints.length===4){const t=new p(this.tmpPoints[0],this.tmpPoints[1]),r=new p(this.tmpPoints[2],this.tmpPoints[3]),s=p.Sub(r,t).uni(),i=p.Dist(t,r),{width:n,height:a}=ne.eraserSizes[this.workOptions.thickness],l=Math.min(n,a),c=Math.round(i/l);if(c>1){const h=[];for(let d=0;d<c;d++){const u=p.Mul(s,d*l);h.push(this.tmpPoints[0]+u.x,this.tmpPoints[1]+u.y)}return h.concat(e)}}return e}isNear(e,t){const r=new p(e[0],e[1]),s=new p(t[0],t[1]),{width:i,height:n}=ne.eraserSizes[this.workOptions.thickness];return p.Dist(r,s)<Math.hypot(i,n)*.5}cutPolyline(e,t){let r=[t],s=0;for(;s<e.length;){const a=e[s];if(a.length<2)break;r=i(r,a),s++}return r;function i(a,l){const c=a;for(let h=0;h<a.length;h++){const d=a[h],u=d.findIndex((f,w)=>w<d.length-1?n([f,d[w+1]],[l[0],l[1]]):!1);if(u!==-1&&u>-1){const f=[],w=d.slice(0,u+1);if(p.Equals(d[u],l[0])||w.push(l[0].clone().setz(d[u].z)),w.length>1&&f.push(w),u+l.length-1<d.length-1){const y=u+l.length-1,m=d.slice(y),S=l[l.length-1];p.Equals(d[y],S)||m.unshift(S.clone().setz(d[y].z)),m.length>1&&f.push(m)}return c.splice(h,1,...f),c}}return c}function n(a,l){const c=p.Sub(a[1],a[0]),h=p.Sub(l[1],l[0]),d=p.Sub(l[0],a[0]);return Math.abs(p.Cpr(c,h))<.1&&Math.abs(p.Cpr(c,d))<.1}}isSamePoint(e,t){return e[0]===t[0]&&e[1]===t[1]}translateIntersect(e){const t=[];for(let r=0;r<e.length;r++){const s=e[r].filter((a,l,c)=>!(l>0&&this.isSamePoint(a,c[l-1]))),i=[];let n=0;for(;n<s.length;){const a=s[n],l=new p(a[0],a[1]);i.push(l),n++}t.push(i)}return t}isLineEraser(e,t){return!(e===g.Pencil&&!t)}remove(e){const{curNodeMap:t,removeIds:r,newWorkDatas:s}=e,{isLine:i}=this.workOptions;let n;for(const[a,l]of t.entries())if(l.rect&&this.eraserRect&&this.eraserPolyline&&Ie(this.eraserRect,l.rect)){const{op:c,toolsType:h}=l,d=this.isLineEraser(h,i),u=[],f=[];for(let y=0;y<c.length;y+=3){const m=new p(c[y]*this.worldScaling[0]+this.worldPosition[0],c[y+1]*this.worldScaling[1]+this.worldPosition[1],c[y+2]);f.push(m),u.push(new W(m.x,m.y))}const w=u.length&&X(u)||l.rect;if(Ie(w,this.eraserRect)){if(f.length>1){const y=co.polyline(f.map(m=>m.XY),this.eraserPolyline);if(y.length&&(r.add(l.name),!d)){const m=this.translateIntersect(y),S=this.cutPolyline(m,f);for(let P=0;P<S.length;P++){const T=`${a}_s_${P}`,I=[];S[P].forEach(b=>{I.push((b.x-this.worldPosition[0])/this.worldScaling[0],(b.y-this.worldPosition[1])/this.worldScaling[1],b.z)}),l.opt&&l.toolsType&&this.vNodes&&(this.vNodes.setInfo(T,{rect:w,op:I,opt:l.opt,canRotate:l.canRotate,scaleType:l.scaleType,toolsType:l.toolsType}),s.set(T,{workId:T,op:I,opt:l.opt,toolsType:l.toolsType}))}}}else r.add(l.name);n=j(n,w)}}return r.forEach(a=>{var l;return(l=this.vNodes)==null?void 0:l.delete(a)}),n&&(n.x-=k.SafeBorderPadding,n.y-=k.SafeBorderPadding,n.w+=k.SafeBorderPadding*2,n.h+=k.SafeBorderPadding*2),n}consume(e){const{op:t}=e.data;if(!t||t.length===0)return{type:v.None};const r=this.tmpPoints.length;if(r>1&&this.isNear([t[0],t[1]],[this.tmpPoints[r-2],this.tmpPoints[r-1]]))return{type:v.None};r===4&&(this.tmpPoints.shift(),this.tmpPoints.shift()),this.tmpPoints.push(t[0],t[1]);const s=this.computRectCenterPoints();let i;const n=new Set,a=new Map;this.vNodes.setTarget();const l=this.getUnLockNodeMap(this.vNodes.getLastTarget());for(let c=0;c<s.length-1;c+=2){this.createEraserRect(s.slice(c,c+2));const h=this.remove({curNodeMap:l,removeIds:n,newWorkDatas:a});i=j(i,h)}if(this.vNodes.deleteLastTarget(),i&&n.size){for(const c of a.keys())n.has(c)&&a.delete(c);return{type:v.RemoveNode,dataType:M.Local,rect:i,removeIds:[...n],newWorkDatas:a}}return{type:v.None}}consumeAll(e){return this.consume(e)}clearTmpPoints(){this.tmpPoints.length=0}getUnLockNodeMap(e){var t;if(this.serviceWork){const r=te(e),s=this.serviceWork.selectorWorkShapes,i=this.serviceWork.workShapes;for(const n of s.values())if((t=n.selectIds)!=null&&t.length)for(const a of n.selectIds)r.delete(a);for(const n of i.keys())r.delete(n);return r}return e}}Object.defineProperty(ne,"eraserSizes",{enumerable:!0,configurable:!0,writable:!0,value:Object.freeze([Object.freeze({width:18,height:26}),Object.freeze({width:26,height:34}),Object.freeze({width:34,height:50})])});const Hu="++",qu="selector",Zu="all";var Qu="__lodash_hash_undefined__";function Ju(o){return this.__data__.set(o,Qu),this}var Ku=Ju;function ed(o){return this.__data__.has(o)}var td=ed,rd=At,od=Ku,sd=td;function Ke(o){var e=-1,t=o==null?0:o.length;for(this.__data__=new rd;++e<t;)this.add(o[e])}Ke.prototype.add=Ke.prototype.push=od,Ke.prototype.has=sd;var id=Ke;function nd(o,e){for(var t=-1,r=o==null?0:o.length;++t<r;)if(e(o[t],t,o))return!0;return!1}var ad=nd;function ld(o,e){return o.has(e)}var cd=ld,hd=id,ud=ad,dd=cd,pd=1,fd=2;function yd(o,e,t,r,s,i){var n=t&pd,a=o.length,l=e.length;if(a!=l&&!(n&&l>a))return!1;var c=i.get(o),h=i.get(e);if(c&&h)return c==e&&h==o;var d=-1,u=!0,f=t&fd?new hd:void 0;for(i.set(o,e),i.set(e,o);++d<a;){var w=o[d],y=e[d];if(r)var m=n?r(y,w,d,e,o,i):r(w,y,d,o,e,i);if(m!==void 0){if(m)continue;u=!1;break}if(f){if(!ud(e,function(S,P){if(!dd(f,P)&&(w===S||s(w,S,t,r,i)))return f.push(P)})){u=!1;break}}else if(!(w===y||s(w,y,t,r,i))){u=!1;break}}return i.delete(o),i.delete(e),u}var jr=yd;function wd(o){var e=-1,t=Array(o.size);return o.forEach(function(r,s){t[++e]=[s,r]}),t}var vd=wd;function md(o){var e=-1,t=Array(o.size);return o.forEach(function(r){t[++e]=r}),t}var gd=md,Ar=ze,Br=lr,bd=ot,kd=jr,Sd=vd,Pd=gd,Id=1,Td=2,xd="[object Boolean]",Od="[object Date]",Cd="[object Error]",Nd="[object Map]",Ld="[object Number]",Wd="[object RegExp]",Rd="[object Set]",Md="[object String]",jd="[object Symbol]",Ad="[object ArrayBuffer]",Bd="[object DataView]",Dr=Ar?Ar.prototype:void 0,gt=Dr?Dr.valueOf:void 0;function Dd(o,e,t,r,s,i,n){switch(t){case Bd:if(o.byteLength!=e.byteLength||o.byteOffset!=e.byteOffset)return!1;o=o.buffer,e=e.buffer;case Ad:return!(o.byteLength!=e.byteLength||!i(new Br(o),new Br(e)));case xd:case Od:case Ld:return bd(+o,+e);case Cd:return o.name==e.name&&o.message==e.message;case Wd:case Md:return o==e+"";case Nd:var a=Sd;case Rd:var l=r&Id;if(a||(a=Pd),o.size!=e.size&&!l)return!1;var c=n.get(o);if(c)return c==e;r|=Td,n.set(o,e);var h=kd(a(o),a(e),r,s,i,n);return n.delete(o),h;case jd:if(gt)return gt.call(o)==gt.call(e)}return!1}var Fd=Dd,Fr=tr,Ed=1,zd=Object.prototype,Ud=zd.hasOwnProperty;function _d(o,e,t,r,s,i){var n=t&Ed,a=Fr(o),l=a.length,c=Fr(e),h=c.length;if(l!=h&&!n)return!1;for(var d=l;d--;){var u=a[d];if(!(n?u in e:Ud.call(e,u)))return!1}var f=i.get(o),w=i.get(e);if(f&&w)return f==e&&w==o;var y=!0;i.set(o,e),i.set(e,o);for(var m=n;++d<l;){u=a[d];var S=o[u],P=e[u];if(r)var T=n?r(P,S,u,e,o,i):r(S,P,u,o,e,i);if(!(T===void 0?S===P||s(S,P,t,r,i):T)){y=!1;break}m||(m=u=="constructor")}if(y&&!m){var I=o.constructor,b=e.constructor;I!=b&&"constructor"in o&&"constructor"in e&&!(typeof I=="function"&&I instanceof I&&typeof b=="function"&&b instanceof b)&&(y=!1)}return i.delete(o),i.delete(e),y}var Yd=_d,bt=Bt,Xd=jr,$d=Fd,Gd=Yd,Er=He,zr=Xe,Ur=nt,Vd=$t,Hd=1,_r="[object Arguments]",Yr="[object Array]",et="[object Object]",qd=Object.prototype,Xr=qd.hasOwnProperty;function Zd(o,e,t,r,s,i){var n=zr(o),a=zr(e),l=n?Yr:Er(o),c=a?Yr:Er(e);l=l==_r?et:l,c=c==_r?et:c;var h=l==et,d=c==et,u=l==c;if(u&&Ur(o)){if(!Ur(e))return!1;n=!0,h=!1}if(u&&!h)return i||(i=new bt),n||Vd(o)?Xd(o,e,t,r,s,i):$d(o,e,l,t,r,s,i);if(!(t&Hd)){var f=h&&Xr.call(o,"__wrapped__"),w=d&&Xr.call(e,"__wrapped__");if(f||w){var y=f?o.value():o,m=w?e.value():e;return i||(i=new bt),s(y,m,t,r,i)}}return u?(i||(i=new bt),Gd(o,e,t,r,s,i)):!1}var Qd=Zd,Jd=Qd,$r=ce;function Gr(o,e,t,r,s){return o===e?!0:o==null||e==null||!$r(o)&&!$r(e)?o!==o&&e!==e:Jd(o,e,t,r,Gr,s)}var Kd=Gr,ep=Kd;function tp(o,e){return ep(o,e)}var rp=tp,Vr=Re(rp);class U extends k{constructor(e){super(e),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.Selector}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"selectIds",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"selectorColor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"strokeColor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fillColor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldSelectRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"canTextEdit",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"canLock",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shapeOpt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"textOpt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isLocked",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt}computSelector(e=!0){const t=X(this.tmpPoints);if(t.w===0||t.h===0)return{selectIds:[],intersectRect:void 0,subNodeMap:new Map};const{rectRange:r,nodeRange:s}=this.vNodes.getRectIntersectRange(t,e);return{selectIds:[...s.keys()],intersectRect:r,subNodeMap:s}}updateTempPoints(e){const t=this.tmpPoints.length,r=e.length;if(r>1){const s=new W(e[r-2]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],e[r-1]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[1]);t===2?this.tmpPoints.splice(1,1,s):this.tmpPoints.push(s)}}drawSelector(e){const{drawRect:t,subNodeMap:r,selectorId:s,layer:i,isService:n}=e,a=new _.Group({pos:[t.x,t.y],anchor:[0,0],size:[t.w,t.h],id:s,name:s,zIndex:1e3}),l=[];if(n){const c=new _.Rect({normalize:!0,pos:[t.w/2,t.h/2],lineWidth:1,strokeColor:this.selectorColor||this.workOptions.strokeColor,width:t.w,height:t.h,name:U.selectorBorderId});l.push(c)}r.forEach((c,h)=>{const d=[c.rect.x+c.rect.w/2-t.x,c.rect.y+c.rect.h/2-t.y],u=new _.Rect({normalize:!0,pos:d,lineWidth:1,strokeColor:r.size>1?this.selectorColor||this.workOptions.strokeColor:void 0,width:c.rect.w,height:c.rect.h,id:`selector-${h}`,name:`selector-${h}`});l.push(u)}),l&&a.append(...l),(i==null?void 0:i.parent).appendChild(a)}draw(e,t,r,s=!1){var i,n;const{intersectRect:a,subNodeMap:l}=r;(n=(i=t.parent)==null?void 0:i.getElementById(e))==null||n.remove(),a&&this.drawSelector({drawRect:a,subNodeMap:l,selectorId:e,layer:t,isService:s})}getSelecteorInfo(e){this.scaleType=V.all,this.canRotate=!1,this.textOpt=void 0,this.strokeColor=void 0,this.fillColor=void 0,this.canTextEdit=!1,this.canLock=!1,this.isLocked=!1,this.toolsTypes=void 0,this.shapeOpt=void 0;const t=new Set;let r;for(const s of e.values()){const{opt:i,canRotate:n,scaleType:a,toolsType:l}=s;this.selectorColor=this.workOptions.strokeColor,i.strokeColor&&(this.strokeColor=i.strokeColor),i.fillColor&&(this.fillColor=i.fillColor),i.textOpt&&(this.textOpt=i.textOpt),l===g.SpeechBalloon&&(t.add(l),this.shapeOpt||(this.shapeOpt={}),this.shapeOpt.placement=i.placement),l===g.Polygon&&(t.add(l),this.shapeOpt||(this.shapeOpt={}),this.shapeOpt.vertices=i.vertices),l===g.Star&&(t.add(l),this.shapeOpt||(this.shapeOpt={}),this.shapeOpt.vertices=i.vertices,this.shapeOpt.innerRatio=i.innerRatio,this.shapeOpt.innerVerticeStep=i.innerVerticeStep),l===g.Text&&(this.textOpt=i),e.size===1&&(this.textOpt&&(this.canTextEdit=!0),this.canRotate=n,this.scaleType=a),a===V.none&&(this.scaleType=a),l===g.Image&&(r=s)}t.size&&(this.toolsTypes=[...t]),r&&(e.size===1?(this.canLock=!0,r.opt.locked&&(this.isLocked=!0,this.scaleType=V.none,this.canRotate=!1,this.textOpt=void 0,this.fillColor=void 0,this.selectorColor="rgb(177,177,177)",this.strokeColor=void 0,this.canTextEdit=!1)):e.size>1&&!r.opt.locked&&(this.canLock=!1,this.canRotate=!1))}getChildrenPoints(){var e;if(this.scaleType===V.both&&this.selectIds){const t=this.selectIds[0],r=(e=this.vNodes.get(t))==null?void 0:e.op;if(r){const s=[];for(let i=0;i<r.length;i+=3)s.push([r[i],r[i+1]]);return s}}}consume(e){const{op:t,workState:r}=e.data;let s=this.oldSelectRect;if(r===E.Start&&(s=this.backToFullLayer()),!(t!=null&&t.length)||!this.vNodes.curNodeMap.size)return{type:v.None};this.updateTempPoints(t);const i=this.computSelector();if(this.selectIds&&Eu(this.selectIds,i.selectIds))return{type:v.None};this.selectIds=i.selectIds;const n=i.intersectRect;this.getSelecteorInfo(i.subNodeMap),this.draw(U.selectorId,this.drawLayer||this.fullLayer,i),this.oldSelectRect=n;const a=this.getChildrenPoints();return{type:v.Select,dataType:M.Local,rect:j(n,s),selectIds:i.selectIds,opt:this.workOptions,selectRect:n,selectorColor:this.selectorColor,strokeColor:this.strokeColor,fillColor:this.fillColor,textOpt:this.textOpt,canTextEdit:this.canTextEdit,canRotate:this.canRotate,canLock:this.canLock,scaleType:this.scaleType,willSyncService:!0,points:a,isLocked:this.isLocked,toolsTypes:this.toolsTypes,shapeOpt:this.shapeOpt}}consumeAll(e){var t,r;if(!((t=this.selectIds)!=null&&t.length)&&this.tmpPoints[0]&&this.selectSingleTool(this.tmpPoints[0].XY,U.selectorId,!1,e==null?void 0:e.hoverId),(r=this.selectIds)!=null&&r.length&&this.sealToDrawLayer(this.selectIds),this.oldSelectRect){const s=this.getChildrenPoints();return{type:v.Select,dataType:M.Local,rect:this.oldSelectRect,selectIds:this.selectIds,opt:this.workOptions,selectorColor:this.selectorColor,selectRect:this.oldSelectRect,strokeColor:this.strokeColor,fillColor:this.fillColor,textOpt:this.textOpt,canTextEdit:this.canTextEdit,canRotate:this.canRotate,canLock:this.canLock,scaleType:this.scaleType,willSyncService:!0,points:s,isLocked:this.isLocked,toolsTypes:this.toolsTypes,shapeOpt:this.shapeOpt}}return{type:v.None}}consumeService(){}clearTmpPoints(){this.tmpPoints.length=0}clearSelectData(){this.selectIds=void 0,this.oldSelectRect=void 0}selectSingleTool(e,t=U.selectorId,r=!1,s){if(e.length===2){const i=e[0],n=e[1];let a;for(const l of this.fullLayer.children){const c=oo([l]);let h=!1;if(s&&s===l.name&&c.find(d=>d.isPointCollision(i,n))){a=l;break}for(const d of c)if(h=d.isPointCollision(i,n),h){if(!a)a=l;else{const u=this.vNodes.get(l.name),f=this.vNodes.get(a.name);if((u==null?void 0:u.toolsType)!==g.Text&&(f==null?void 0:f.toolsType)===g.Text)break;if((u==null?void 0:u.toolsType)===g.Text&&(f==null?void 0:f.toolsType)!==g.Text)a=l;else{const w=(u==null?void 0:u.opt.zIndex)||0,y=(f==null?void 0:f.opt.zIndex)||0;Number(w)>=Number(y)&&(a=l)}}break}}if(a){const l=a.name,c=this.vNodes.get(l);if(c){if(!Vr(this.oldSelectRect,c.rect)){const h=new Map([[l,c]]);this.getSelecteorInfo(h),this.draw(t,this.drawLayer||this.fullLayer,{intersectRect:c.rect,subNodeMap:h,selectIds:this.selectIds||[]},r)}this.selectIds=[l],this.oldSelectRect=c.rect}}}}backToFullLayer(e){var t,r;let s;const i=[],n=[];for(const a of((t=this.drawLayer)==null?void 0:t.children)||[])if(!(e!=null&&e.length&&!e.includes(a.id))&&a.id!==U.selectorId){const l=a.cloneNode(!0);Ze(a)&&l.seal(),this.fullLayer.getElementsByName(a.name).length||i.push(l),n.push(a);const c=(r=this.vNodes.get(a.name))==null?void 0:r.rect;c&&(s=j(s,c))}return n.forEach(a=>a.remove()),i.length&&this.fullLayer.append(...i),s}sealToDrawLayer(e){var t;const r=[],s=[];e.forEach(i=>{this.fullLayer.getElementsByName(i.toString()).forEach(n=>{var a;const l=n.cloneNode(!0);Ze(n)&&l.seal(),(a=this.drawLayer)!=null&&a.getElementsByName(n.name).length||r.push(l),s.push(n)})}),s.forEach(i=>i.remove()),r&&((t=this.drawLayer)==null||t.append(...r))}getSelectorRect(e,t){var r;let s;const i=(r=e.parent)==null?void 0:r.getElementById(t),n=i==null?void 0:i.getBoundingClientRect();return n&&(s=j(s,{x:Math.floor(n.x),y:Math.floor(n.y),w:Math.round(n.width),h:Math.round(n.height)})),s}isCanFillColor(e){return e===g.Ellipse||e===g.Triangle||e===g.Rectangle||e===g.Polygon||e===g.Star||e===g.SpeechBalloon}async updateSelector(e){const{updateSelectorOpt:t,selectIds:r,vNodes:s,willSerializeData:i,worker:n,offset:a,scene:l}=e,c=this.drawLayer;if(!c)return;let h;const d=new Map,{box:u,workState:f,angle:w,translate:y}=t;let m=[0,0],S=[1,1],P=[0,0],T,I;if(u||y||ue(w)){if(f===E.Start)return s.setTarget(),{type:v.Select,dataType:M.Local,selectRect:this.oldSelectRect,rect:this.oldSelectRect};if(T=s.getLastTarget(),T&&u){let L;r==null||r.forEach(O=>{const R=T==null?void 0:T.get(O);L=j(L,R==null?void 0:R.rect)}),L&&(S=[u.w/L.w,u.h/L.h],m=[u.x+u.w/2-(L.x+L.w/2),u.y+u.h/2-(L.y+L.h/2)],P=[L.x+L.w/2,L.y+L.h/2]),I=L}}if(r)for(const L of r){const O=s.get(L);if(O){const{toolsType:R}=O;let A=(c==null?void 0:c.getElementsByName(L))[0];if(A){const B={...t};let G;if(R){if(T&&(G=T.get(L),G&&u)){B.boxScale=S;const re=[G.rect.x+G.rect.w/2,G.rect.y+G.rect.h/2],oe=[re[0]-P[0],re[1]-P[1]];B.boxTranslate=[oe[0]*(S[0]-1)+m[0]+(a&&a[0]||0),oe[1]*(S[1]-1)+m[1]+(a&&a[1]||0)]}const K=ro(R);if(K==null||K.updateNodeOpt({node:A,opt:B,vNodes:s,willSerializeData:i,targetNode:G}),O&&n&&(i&&(B.angle||B.translate)||B.box&&B.workState!==E.Start||B.pointMap&&B.pointMap.has(L)||R===g.Text&&(B.fontSize||B.translate||B.textInfos&&B.textInfos.get(L))||R===g.Image&&(B.angle||B.translate||B.boxScale)||R===B.toolsType&&B.willRefresh)){const re=n.createWorkShapeNode({toolsType:R,toolsOpt:O.opt});re==null||re.setWorkId(L);let oe;R===g.Image&&l?oe=await re.consumeServiceAsync({isFullWork:!1,replaceId:L,scene:l}):oe=re==null?void 0:re.consumeService({op:O.op,isFullWork:!1,replaceId:L,isClearAll:!1}),oe&&(O.rect=oe,s.setInfo(L,O)),A=(c==null?void 0:c.getElementsByName(L))[0]}O&&(d.set(L,O),h=j(h,O.rect))}}}}T&&f===E.Done&&s.deleteLastTarget();const b=h;if(I&&t.dir&&b){let L=[0,0];switch(t.dir){case"topLeft":case"left":{const O=[I.x+I.w,I.y+I.h];L=[O[0]-(b.x+b.w),O[1]-(b.y+b.h)];break}case"bottomLeft":case"bottom":{const O=[I.x+I.w,I.y];L=[O[0]-(b.x+b.w),O[1]-b.y];break}case"topRight":case"top":{const O=[I.x,I.y+I.h];L=[O[0]-b.x,O[1]-(b.y+b.h)];break}case"right":case"bottomRight":{const O=[I.x,I.y];L=[O[0]-b.x,O[1]-b.y];break}}if(L[0]||L[1])return b.x=b.x+L[0],b.y=b.y+L[1],await this.updateSelector({...e,offset:L})}this.getSelecteorInfo(d),this.draw(U.selectorId,c,{selectIds:r||[],subNodeMap:d,intersectRect:b});const C=j(this.oldSelectRect,h);return this.oldSelectRect=h,{type:v.Select,dataType:M.Local,selectRect:b,renderRect:h,rect:j(C,b)}}blurSelector(){const e=this.backToFullLayer();return{type:v.Select,dataType:M.Local,rect:e,selectIds:[],willSyncService:!0}}getRightServiceId(e){return e.replace("++","-")}selectServiceNode(e,t,r){const{selectIds:s}=t,i=this.getRightServiceId(e),n=this.getSelectorRect(this.fullLayer,i);let a;const l=new Map;return s==null||s.forEach(c=>{const h=this.vNodes.get(c),d=this.fullLayer.getElementsByName(c)[0];h&&d&&(a=j(a,h.rect),l.set(c,h))}),this.getSelecteorInfo(l),this.draw(i,this.fullLayer,{intersectRect:a,selectIds:s||[],subNodeMap:l},r),j(a,n)}reRenderSelector(){var e;let t;const r=new Map;return(e=this.selectIds)==null||e.forEach(s=>{const i=this.vNodes.get(s);i&&(t=j(t,i.rect),r.set(s,i))},this),this.getSelecteorInfo(r),this.draw(U.selectorId,this.drawLayer||this.fullLayer,{intersectRect:t,subNodeMap:r,selectIds:this.selectIds||[]}),this.oldSelectRect=t,t}updateSelectIds(e){var t,r;let s;const i=(t=this.selectIds)==null?void 0:t.filter(l=>!e.includes(l)),n=e.filter(l=>{var c;return!((c=this.selectIds)!=null&&c.includes(l))});if(i!=null&&i.length&&(s=this.backToFullLayer(i)),n.length){this.sealToDrawLayer(n);for(const l of n){const c=(r=this.vNodes.get(l))==null?void 0:r.rect;c&&(s=j(s,c))}}this.selectIds=e;const a=this.reRenderSelector();return{bgRect:s,selectRect:a}}cursorHover(e){var t,r;const s=this.oldSelectRect;this.selectIds=[];const i=(t=this.workId)==null?void 0:t.toString(),n=[e[0]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],e[1]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[1]];if(this.selectSingleTool(n,i,!0),this.oldSelectRect&&!Vr(s,this.oldSelectRect))return{type:v.CursorHover,dataType:M.Local,rect:j(s,this.oldSelectRect),selectorColor:this.selectorColor,willSyncService:!1};if((r=this.selectIds)!=null&&r.length||(this.oldSelectRect=void 0),s&&!this.oldSelectRect)return this.cursorBlur(),{type:v.CursorHover,dataType:M.Local,rect:s,selectorColor:this.selectorColor,willSyncService:!1}}cursorBlur(){var e,t;this.selectIds=[];const r=(e=this.workId)==null?void 0:e.toString();((t=this.fullLayer)==null?void 0:t.parent).children.forEach(s=>{s.name===r&&s.remove()})}}Object.defineProperty(U,"selectorId",{enumerable:!0,configurable:!0,writable:!0,value:qu}),Object.defineProperty(U,"selectorBorderId",{enumerable:!0,configurable:!0,writable:!0,value:"selector-border"});class Hr extends k{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.both}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.Arrow}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"arrowTipWidth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.arrowTipWidth=this.workOptions.thickness*4,this.syncTimestamp=0,this.syncUnitTime=50}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:v.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:v.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:v.None};if(!i){const w=Date.now();return w-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=w,{type:v.DrawWork,dataType:M.Local,workId:n,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0}):{type:v.None}}const d=s?this.fullLayer:this.drawLayer||this.fullLayer,u=this.draw({workId:n,layer:d}),f=j(u,this.oldRect);return this.oldRect=u,{rect:f,type:v.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:v.None};if(this.tmpPoints.length<2)return{type:v.RemoveNode,removeIds:[s]};const i=this.fullLayer,n=this.draw({workId:s,layer:i});this.oldRect=n;const a=this.tmpPoints.map(c=>[...c.XY,0]).flat(1),l=le(a);return this.vNodes.setInfo(s,{rect:n,op:a,opt:this.workOptions,toolsType:this.toolsType,canRotate:this.canRotate,scaleType:this.scaleType,centerPos:k.getCenterPos(n,i)}),{rect:n,type:v.FullWork,dataType:M.Local,workId:s,ops:l,isSync:!0,opt:this.workOptions}}draw(e){var t;const{workId:r,layer:s}=e;this.fullLayer.getElementsByName(r).map(S=>S.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(S=>S.remove());const{strokeColor:i,thickness:n,zIndex:a,scale:l,rotate:c,translate:h}=this.workOptions,d=s.worldPosition,u=s.worldScaling,{points:f,rect:w}=this.computDrawPoints(n),y={pos:[w.x+w.w/2,w.y+w.h/2],name:r,id:r,close:!0,points:f,fillColor:i,strokeColor:i,lineWidth:0,normalize:!0,zIndex:a};l&&(y.scale=l),c&&(y.rotate=c),h&&(y.translate=h);const m=new _.Polyline(y);if(s.append(m),l||c||h){const S=m.getBoundingClientRect();return{x:Math.floor(S.x-k.SafeBorderPadding),y:Math.floor(S.y-k.SafeBorderPadding),w:Math.floor(S.width+k.SafeBorderPadding*2),h:Math.floor(S.height+k.SafeBorderPadding*2)}}return{x:Math.floor(w.x*u[0]+d[0]-k.SafeBorderPadding),y:Math.floor(w.y*u[1]+d[1]-k.SafeBorderPadding),w:Math.floor(w.w*u[0]+2*k.SafeBorderPadding),h:Math.floor(w.h*u[1]+2*k.SafeBorderPadding)}}computDrawPoints(e){return this.tmpPoints[1].distance(this.tmpPoints[0])>this.arrowTipWidth?this.computFullArrowPoints(e):this.computTrianglePoints()}computFullArrowPoints(e){const t=p.Sub(this.tmpPoints[1],this.tmpPoints[0]).uni(),r=p.Per(t).mul(e/2),s=W.Sub(this.tmpPoints[0],r),i=W.Add(this.tmpPoints[0],r),n=p.Mul(t,this.arrowTipWidth),a=p.Sub(this.tmpPoints[1],n),l=W.Sub(a,r),c=W.Add(a,r),h=p.Per(t).mul(e*1.5),d=W.Sub(a,h),u=W.Add(a,h),f=[s,l,d,this.tmpPoints[1],u,c,i];return{points:f.map(w=>W.Sub(w,this.tmpPoints[0]).XY).flat(1),rect:X(f),isTriangle:!1,pos:this.tmpPoints[0].XY}}computTrianglePoints(){const e=p.Sub(this.tmpPoints[1],this.tmpPoints[0]).uni(),t=this.tmpPoints[1].distance(this.tmpPoints[0]),r=p.Per(e).mul(Math.floor(t*3/8)),s=W.Sub(this.tmpPoints[0],r),i=W.Add(this.tmpPoints[0],r),n=[s,this.tmpPoints[1],i];return{points:n.map(a=>W.Sub(a,this.tmpPoints[0]).XY).flat(1),rect:X(n),isTriangle:!0,pos:this.tmpPoints[0].XY}}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s}=e,i=(t=this.workId)==null?void 0:t.toString();if(!i)return;this.tmpPoints.length=0;for(let l=0;l<r.length;l+=3)this.tmpPoints.push(new W(r[l],r[l+1],r[l+2]));const n=s?this.fullLayer:this.drawLayer||this.fullLayer,a=this.draw({workId:i,layer:n});return this.oldRect=a,this.vNodes.setInfo(i,{rect:a,op:r,opt:this.workOptions,toolsType:this.toolsType,canRotate:this.canRotate,scaleType:this.scaleType,centerPos:k.getCenterPos(a,n)}),a}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){var t;const{node:r,opt:s,vNodes:i}=e,{strokeColor:n}=s,a=i.get(r.name);return n&&(r.setAttribute("strokeColor",n),r.setAttribute("fillColor",n),(t=a==null?void 0:a.opt)!=null&&t.strokeColor&&(a.opt.strokeColor=n),a&&i.setInfo(r.name,a)),k.updateNodeOpt(e)}}class qr extends k{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.Ellipse}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:v.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:v.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:v.None};if(!i){const w=Date.now();return w-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=w,{type:v.DrawWork,dataType:M.Local,workId:n,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0}):{type:v.None}}const d=s?this.fullLayer:this.drawLayer||this.fullLayer,u=this.draw({workId:n,layer:d,isDrawing:!0}),f=j(u,this.oldRect);return this.oldRect=u,{rect:f,type:v.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:v.None};if(this.tmpPoints.length<2)return{type:v.RemoveNode,removeIds:[s]};const i=this.fullLayer,n=this.draw({workId:s,layer:i,isDrawing:!1});this.oldRect=n;const a=this.tmpPoints.map(c=>[...c.XY,0]).flat(1),l=le(a);return this.vNodes.setInfo(s,{rect:n,op:a,opt:this.workOptions,toolsType:this.toolsType,canRotate:this.canRotate,scaleType:this.scaleType,centerPos:n&&k.getCenterPos(n,i)}),{rect:n,type:v.FullWork,dataType:M.Local,workId:s,ops:l,isSync:!0,opt:this.workOptions}}draw(e){var t;const{workId:r,layer:s,isDrawing:i}=e;this.fullLayer.getElementsByName(r).map(b=>b.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(b=>b.remove());const{strokeColor:n,fillColor:a,thickness:l,zIndex:c,scale:h,rotate:d,translate:u}=this.workOptions,f=s.worldPosition,w=s.worldScaling,{radius:y,rect:m,pos:S}=this.computDrawPoints(l),P={pos:S,name:r,id:r,radius:y,lineWidth:l,fillColor:a!=="transparent"&&a||void 0,strokeColor:n,normalize:!0,zIndex:c},T={x:Math.floor(m.x*w[0]+f[0]-k.SafeBorderPadding),y:Math.floor(m.y*w[1]+f[1]-k.SafeBorderPadding),w:Math.floor(m.w*w[0]+2*k.SafeBorderPadding),h:Math.floor(m.h*w[1]+2*k.SafeBorderPadding)};if(i){const{name:b,id:C,zIndex:L,strokeColor:O}=P,R=k.getCenterPos(T,s),A=new _.Group({name:b,id:C,zIndex:L,pos:R,anchor:[.5,.5],size:[T.w,T.h]}),B=new _.Ellipse({...P,pos:[0,0]}),G=new _.Path({d:"M-4,0H4M0,-4V4",normalize:!0,pos:[0,0],strokeColor:O,lineWidth:1,scale:[1/w[0],1/w[1]]});return A.append(B,G),s.append(A),T}h&&(P.scale=h),d&&(P.rotate=d),u&&(P.translate=u);const I=new _.Ellipse(P);if(s.append(I),d||h||u){const b=I.getBoundingClientRect();return{x:Math.floor(b.x-k.SafeBorderPadding),y:Math.floor(b.y-k.SafeBorderPadding),w:Math.floor(b.width+k.SafeBorderPadding*2),h:Math.floor(b.height+k.SafeBorderPadding*2)}}return T}computDrawPoints(e){const t=X(this.tmpPoints),r=X(this.tmpPoints,e),s=[Math.floor(t.x+t.w/2),Math.floor(t.y+t.h/2)];return{rect:r,pos:s,radius:[Math.floor(t.w/2),Math.floor(t.h/2)]}}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s}=e,i=(t=this.workId)==null?void 0:t.toString();if(!i)return;this.tmpPoints.length=0;for(let l=0;l<r.length;l+=3)this.tmpPoints.push(new W(r[l],r[l+1],r[l+2]));const n=s?this.fullLayer:this.drawLayer||this.fullLayer,a=this.draw({workId:i,layer:n,isDrawing:!1});return this.oldRect=a,this.vNodes.setInfo(i,{rect:a,op:r,opt:this.workOptions,toolsType:this.toolsType,canRotate:this.canRotate,scaleType:this.scaleType,centerPos:k.getCenterPos(a,n)}),a}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){var t,r;const{node:s,opt:i,vNodes:n}=e,{strokeColor:a,fillColor:l}=i,c=n.get(s.name);let h=s;return s.tagName==="GROUP"&&(h=s.children[0]),a&&(h.setAttribute("strokeColor",a),(t=c==null?void 0:c.opt)!=null&&t.strokeColor&&(c.opt.strokeColor=a)),l&&(l==="transparent"?h.setAttribute("fillColor","rgba(0,0,0,0)"):h.setAttribute("fillColor",l),(r=c==null?void 0:c.opt)!=null&&r.fillColor&&(c.opt.fillColor=l)),c&&n.setInfo(s.name,c),k.updateNodeOpt(e)}}var op=ye,sp=ce,ip="[object Boolean]";function np(o){return o===!0||o===!1||sp(o)&&op(o)==ip}var ap=np,me=Re(ap);class Zr extends k{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.Rectangle}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}transformData(){const e=X(this.tmpPoints);return[[e.x,e.y,0],[e.x+e.w,e.y,0],[e.x+e.w,e.y+e.h,0],[e.x,e.y+e.h,0]]}computDrawPoints(e){const{thickness:t}=this.workOptions,r=[];for(const n of e)r.push(new p(...n));const s=X(r,t),i=[s.x+s.w/2,s.y+s.h/2];return{rect:s,pos:i,points:r.map(n=>n.XY).flat(1)}}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:v.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:v.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:v.None};const d=this.transformData();if(!i){const y=Date.now();return y-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=y,{type:v.DrawWork,dataType:M.Local,workId:n,op:d.flat(1),isSync:!0,index:0}):{type:v.None}}const u=s?this.fullLayer:this.drawLayer||this.fullLayer,f=this.draw({ps:d,workId:n,layer:u,isDrawing:!0}),w=j(f,this.oldRect);return this.oldRect=f,{rect:w,type:v.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:v.None};if(this.tmpPoints.length<2)return{type:v.RemoveNode,removeIds:[s]};const i=this.transformData(),n=this.fullLayer,a=this.draw({ps:i,workId:s,layer:n,isDrawing:!1});this.oldRect=a;const l=i.flat(1),c=le(l);return this.vNodes.setInfo(s,{rect:a,op:l,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:a&&k.getCenterPos(a,n)}),{rect:a,type:v.FullWork,dataType:M.Local,workId:s,ops:c,opt:this.workOptions,isSync:!0}}draw(e){var t;const{workId:r,layer:s,isDrawing:i,ps:n,replaceId:a}=e;this.fullLayer.getElementsByName(a||r).map(R=>R.remove()),(t=this.drawLayer)==null||t.getElementsByName(a||r).map(R=>R.remove());const{strokeColor:l,fillColor:c,thickness:h,zIndex:d,scale:u,rotate:f,translate:w,textOpt:y}=this.workOptions,m=s.worldPosition,S=s.worldScaling,{points:P,rect:T,pos:I}=this.computDrawPoints(n),b={close:!0,normalize:!0,points:P,lineWidth:h,fillColor:c!=="transparent"&&c||void 0,strokeColor:l,lineJoin:"round"},C={x:Math.floor(T.x*S[0]+m[0]-k.SafeBorderPadding),y:Math.floor(T.y*S[1]+m[1]-k.SafeBorderPadding),w:Math.floor(T.w*S[0]+2*k.SafeBorderPadding),h:Math.floor(T.h*S[0]+2*k.SafeBorderPadding)},L=new _.Group({name:r,id:r,zIndex:d,pos:I,anchor:[.5,.5],size:[T.w,T.h],scale:u,rotate:f,translate:w}),O=new _.Polyline({...b,pos:[0,0]});if(L.appendChild(O),i){const R=new _.Path({d:"M-4,0H4M0,-4V4",normalize:!0,pos:[0,0],strokeColor:l,lineWidth:1,scale:[1/S[0],1/S[1]]});L.appendChild(R)}if(s.append(L),u||f||w){const R=L.getBoundingClientRect();return{x:Math.floor(R.x-k.SafeBorderPadding),y:Math.floor(R.y-k.SafeBorderPadding),w:Math.floor(R.width+2*k.SafeBorderPadding),h:Math.floor(R.height+2*k.SafeBorderPadding)}}return C}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s,replaceId:i}=e,n=(t=this.workId)==null?void 0:t.toString();if(!n)return;const a=[];for(let h=0;h<r.length;h+=3)a.push([r[h],r[h+1],r[h+2]]);const l=s?this.fullLayer:this.drawLayer||this.fullLayer,c=this.draw({ps:a,workId:n,layer:l,isDrawing:!1,replaceId:i});return this.oldRect=c,this.vNodes.setInfo(n,{rect:c,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:c&&k.getCenterPos(c,l)}),c}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){var t,r;const{node:s,opt:i,vNodes:n}=e,{strokeColor:a,fillColor:l,fontColor:c,fontBgColor:h,bold:d,italic:u,lineThrough:f,underline:w,fontSize:y}=i,m=n.get(s.name);let S=s;if(s.tagName==="GROUP"&&(S=s.children[0]),a&&(S.setAttribute("strokeColor",a),(t=m==null?void 0:m.opt)!=null&&t.strokeColor&&(m.opt.strokeColor=a)),l&&(l==="transparent"?S.setAttribute("fillColor","rgba(0,0,0,0)"):S.setAttribute("fillColor",l),(r=m==null?void 0:m.opt)!=null&&r.fillColor&&(m.opt.fillColor=l)),m!=null&&m.opt.textOpt){const P=m.opt.textOpt;c&&P.fontColor&&(P.fontColor=c),h&&P.fontBgColor&&(P.fontBgColor=h),d&&(P.bold=d),u&&(P.italic=u),me(f)&&(P.lineThrough=f),me(w)&&(P.underline=w),y&&(P.fontSize=y)}return m&&n.setInfo(s.name,m),k.updateNodeOpt(e)}}class Qr extends k{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.Star}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:v.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:v.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:v.None};if(!i){const w=Date.now();return w-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=w,{type:v.DrawWork,dataType:M.Local,workId:n,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0}):{type:v.None}}const d=s?this.fullLayer:this.drawLayer||this.fullLayer,u=this.draw({workId:n,layer:d,isDrawing:!0}),f=j(u,this.oldRect);return this.oldRect=u,{rect:f,type:v.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:v.None};if(this.tmpPoints.length<2)return{type:v.RemoveNode,removeIds:[s]};const i=this.fullLayer,n=this.draw({workId:s,layer:i,isDrawing:!1});this.oldRect=n;const a=this.tmpPoints.map(c=>[...c.XY,0]).flat(1),l=le(a);return this.vNodes.setInfo(s,{rect:n,op:a,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:n&&k.getCenterPos(n,i)}),{rect:n,type:v.FullWork,dataType:M.Local,workId:s,ops:l,isSync:!0,opt:this.workOptions}}draw(e){var t;const{workId:r,layer:s,isDrawing:i}=e;this.fullLayer.getElementsByName(r).map(O=>O.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(O=>O.remove());const{strokeColor:n,fillColor:a,thickness:l,zIndex:c,vertices:h,innerVerticeStep:d,innerRatio:u,scale:f,rotate:w,translate:y}=this.workOptions,m=s.worldPosition,S=s.worldScaling,{rect:P,pos:T,points:I}=this.computDrawPoints(l,h,d,u),b={pos:T,close:!0,name:r,id:r,points:I,lineWidth:l,fillColor:a!=="transparent"&&a||void 0,strokeColor:n,className:`${T[0]},${T[1]}`,normalize:!0,zIndex:c,lineJoin:"round"},C={x:Math.floor(P.x*S[0]+m[0]-k.SafeBorderPadding*S[0]),y:Math.floor(P.y*S[1]+m[1]-k.SafeBorderPadding*S[1]),w:Math.floor(P.w*S[0]+2*k.SafeBorderPadding*S[0]),h:Math.floor(P.h*S[1]+2*k.SafeBorderPadding*S[1])};if(i){const{name:O,id:R,zIndex:A,strokeColor:B}=b,G=[(C.x+C.w/2-m[0])/S[0],(C.y+C.h/2-m[1])/S[1]],K=new _.Group({name:O,id:R,zIndex:A,pos:G,anchor:[.5,.5],size:[C.w,C.h]}),re=new _.Polyline({...b,pos:[0,0]}),oe=new _.Path({d:"M-4,0H4M0,-4V4",normalize:!0,pos:[0,0],strokeColor:B,lineWidth:1,scale:[1/S[0],1/S[1]]});return K.append(re,oe),s.append(K),C}f&&(b.scale=f),w&&(b.rotate=w),y&&(b.translate=y);const L=new _.Polyline(b);if(s.append(L),f||w||y){const O=L.getBoundingClientRect();return{x:Math.floor(O.x-k.SafeBorderPadding),y:Math.floor(O.y-k.SafeBorderPadding),w:Math.floor(O.width+k.SafeBorderPadding*2),h:Math.floor(O.height+k.SafeBorderPadding*2)}}return C}computDrawPoints(e,t,r,s){const i=X(this.tmpPoints),n=[Math.floor(i.x+i.w/2),Math.floor(i.y+i.h/2)],a=Lr(i.w,i.h),l=Math.floor(Math.min(i.w,i.h)/2),c=s*l,h=[],d=2*Math.PI/t;for(let u=0;u<t;u++){const f=u*d-.5*Math.PI;let w,y;u%r===1?(w=c*a[0]*Math.cos(f),y=c*a[1]*Math.sin(f)):(w=l*a[0]*Math.cos(f),y=l*a[1]*Math.sin(f),h.push(w,y)),h.push(w,y)}return{rect:X(this.tmpPoints,e),pos:n,points:h}}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i)||W.Sub(s,r).XY.includes(0))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s}=e,i=(t=this.workId)==null?void 0:t.toString();if(!i)return;this.tmpPoints.length=0;for(let l=0;l<r.length;l+=3)this.tmpPoints.push(new W(r[l],r[l+1],r[l+2]));const n=s?this.fullLayer:this.drawLayer||this.fullLayer,a=this.draw({workId:i,layer:n,isDrawing:!1});return this.oldRect=a,this.vNodes.setInfo(i,{rect:a,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:a&&k.getCenterPos(a,n)}),a}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){const{node:t,opt:r,vNodes:s}=e,{strokeColor:i,fillColor:n,toolsType:a,vertices:l,innerVerticeStep:c,innerRatio:h}=r,d=s.get(t.name),u=d==null?void 0:d.opt;let f=t;return t.tagName==="GROUP"&&(f=t.children[0]),i&&(f.setAttribute("strokeColor",i),u!=null&&u.strokeColor&&(u.strokeColor=i)),n&&(n==="transparent"?f.setAttribute("fillColor","rgba(0,0,0,0)"):f.setAttribute("fillColor",n),u!=null&&u.fillColor&&(u.fillColor=n)),a===g.Star&&(l&&(u.vertices=l),c&&(u.innerVerticeStep=c),h&&(u.innerRatio=h)),d&&s.setInfo(t.name,{...d,opt:u}),k.updateNodeOpt(e)}}class Jr extends k{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.Polygon}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:v.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:v.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:v.None};if(!i){const w=Date.now();return w-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=w,{type:v.DrawWork,dataType:M.Local,workId:n,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0}):{type:v.None}}const d=s?this.fullLayer:this.drawLayer||this.fullLayer,u=this.draw({workId:n,layer:d,isDrawing:!0}),f=j(u,this.oldRect);return this.oldRect=u,{rect:f,type:v.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:v.None};if(this.tmpPoints.length<2)return{type:v.RemoveNode,removeIds:[s]};const i=this.fullLayer,n=this.draw({workId:s,layer:i,isDrawing:!1});this.oldRect=n;const a=this.tmpPoints.map(c=>[...c.XY,0]).flat(1),l=le(a);return this.vNodes.setInfo(s,{rect:n,op:a,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:n&&k.getCenterPos(n,i)}),{rect:n,type:v.FullWork,dataType:M.Local,workId:s,ops:l,isSync:!0,opt:this.workOptions}}draw(e){var t;const{workId:r,layer:s,isDrawing:i}=e;this.fullLayer.getElementsByName(r).map(C=>C.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(C=>C.remove());const{strokeColor:n,fillColor:a,thickness:l,zIndex:c,vertices:h,scale:d,rotate:u,translate:f}=this.workOptions,w=s.worldPosition,y=s.worldScaling,{rect:m,pos:S,points:P}=this.computDrawPoints(l,h),T={pos:S,close:!0,name:r,id:r,points:P,lineWidth:l,fillColor:a!=="transparent"&&a||void 0,strokeColor:n,normalize:!0,zIndex:c,lineJoin:"round"},I={x:Math.floor(m.x*y[0]+w[0]-k.SafeBorderPadding*y[0]),y:Math.floor(m.y*y[1]+w[1]-k.SafeBorderPadding*y[1]),w:Math.floor(m.w*y[0]+2*k.SafeBorderPadding*y[0]),h:Math.floor(m.h*y[1]+2*k.SafeBorderPadding*y[1])};if(i){const{name:C,id:L,zIndex:O,strokeColor:R}=T,A=[(I.x+I.w/2-w[0])/y[0],(I.y+I.h/2-w[1])/y[1]],B=new _.Group({name:C,id:L,zIndex:O,pos:A,anchor:[.5,.5],size:[I.w,I.h]}),G=new _.Polyline({...T,pos:[0,0]}),K=new _.Path({d:"M-4,0H4M0,-4V4",normalize:!0,pos:[0,0],strokeColor:R,lineWidth:1,scale:[1/y[0],1/y[1]]});return B.append(G,K),s.append(B),I}d&&(T.scale=d),u&&(T.rotate=u),f&&(T.translate=f);const b=new _.Polyline(T);if(s.append(b),d||u||f){const C=b.getBoundingClientRect();return{x:Math.floor(C.x-k.SafeBorderPadding),y:Math.floor(C.y-k.SafeBorderPadding),w:Math.floor(C.width+k.SafeBorderPadding*2),h:Math.floor(C.height+k.SafeBorderPadding*2)}}return I}computDrawPoints(e,t){const r=X(this.tmpPoints),s=[Math.floor(r.x+r.w/2),Math.floor(r.y+r.h/2)],i=Lr(r.w,r.h),n=Math.floor(Math.min(r.w,r.h)/2),a=[],l=2*Math.PI/t;for(let c=0;c<t;c++){const h=c*l-.5*Math.PI,d=n*i[0]*Math.cos(h),u=n*i[1]*Math.sin(h);a.push(d,u)}return{rect:X(this.tmpPoints,e),pos:s,points:a}}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i)||W.Sub(s,r).XY.includes(0))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s}=e,i=(t=this.workId)==null?void 0:t.toString();if(!i)return;this.tmpPoints.length=0;for(let l=0;l<r.length;l+=3)this.tmpPoints.push(new W(r[l],r[l+1],r[l+2]));const n=s?this.fullLayer:this.drawLayer||this.fullLayer,a=this.draw({workId:i,layer:n,isDrawing:!1});return this.oldRect=a,this.vNodes.setInfo(i,{rect:a,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:a&&k.getCenterPos(a,n)}),a}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){const{node:t,opt:r,vNodes:s}=e,{strokeColor:i,fillColor:n,toolsType:a,vertices:l}=r,c=s.get(t.name),h=c==null?void 0:c.opt;let d=t;return t.tagName==="GROUP"&&(d=t.children[0]),i&&(d.setAttribute("strokeColor",i),h!=null&&h.strokeColor&&(h.strokeColor=i)),n&&(n==="transparent"?d.setAttribute("fillColor","rgba(0,0,0,0)"):d.setAttribute("fillColor",n),h!=null&&h.fillColor&&(h.fillColor=n)),a===g.Polygon&&l&&(h.vertices=l),c&&s.setInfo(t.name,{...c,opt:h}),k.updateNodeOpt(e)}}class ae{static bezier(e,t){const r=[];for(let s=0;s<t.length;s+=4){const i=t[s],n=t[s+1],a=t[s+2],l=t[s+3];i&&n&&a&&l?r.push(...ae.getBezierPoints(e,i,n,a,l)):i&&n&&a?r.push(...ae.getBezierPoints(e,i,n,a)):i&&n?r.push(...ae.getBezierPoints(e,i,n)):i&&r.push(i)}return r}static getBezierPoints(e=10,t,r,s,i){let n=null;const a=[];!s&&!i?n=ae.oneBezier:s&&!i?n=ae.twoBezier:s&&i&&(n=ae.threeBezier);for(let l=0;l<e;l++)n&&a.push(n(l/e,t,r,s,i));return i?a.push(i):s&&a.push(s),a}static oneBezier(e,t,r){const s=t.x+(r.x-t.x)*e,i=t.y+(r.y-t.y)*e;return new p(s,i)}static twoBezier(e,t,r,s){const i=(1-e)*(1-e)*t.x+2*e*(1-e)*r.x+e*e*s.x,n=(1-e)*(1-e)*t.y+2*e*(1-e)*r.y+e*e*s.y;return new p(i,n)}static threeBezier(e,t,r,s,i){const n=t.x*(1-e)*(1-e)*(1-e)+3*r.x*e*(1-e)*(1-e)+3*s.x*e*e*(1-e)+i.x*e*e*e,a=t.y*(1-e)*(1-e)*(1-e)+3*r.y*e*(1-e)*(1-e)+3*s.y*e*e*(1-e)+i.y*e*e*e;return new p(n,a)}}class Kr extends k{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.SpeechBalloon}),Object.defineProperty(this,"ratio",{enumerable:!0,configurable:!0,writable:!0,value:.8}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:v.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:v.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:v.None};if(!i){const w=Date.now();return w-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=w,{type:v.DrawWork,dataType:M.Local,workId:n,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0}):{type:v.None}}const d=s?this.fullLayer:this.drawLayer||this.fullLayer,u=this.draw({workId:n,layer:d,isDrawing:!0}),f=j(u,this.oldRect);return this.oldRect=u,{rect:f,type:v.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:v.None};if(this.tmpPoints.length<2)return{type:v.RemoveNode,removeIds:[s]};const i=this.fullLayer,n=this.draw({workId:s,layer:i,isDrawing:!1});this.oldRect=n;const a=this.tmpPoints.map(c=>[...c.XY,0]).flat(1),l=le(a);return this.vNodes.setInfo(s,{rect:n,op:a,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:n&&k.getCenterPos(n,i)}),{rect:n,type:v.FullWork,dataType:M.Local,workId:s,ops:l,isSync:!0,opt:this.workOptions}}draw(e){var t;const{workId:r,layer:s}=e;this.fullLayer.getElementsByName(r).map(b=>b.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(b=>b.remove());const{strokeColor:i,fillColor:n,thickness:a,zIndex:l,placement:c,scale:h,rotate:d,translate:u}=this.workOptions,f=s.worldPosition,w=s.worldScaling,{rect:y,pos:m,points:S}=this.computDrawPoints(a,c),P={pos:m,name:r,id:r,points:S.map(b=>b.XY),lineWidth:a,fillColor:n!=="transparent"&&n||void 0,strokeColor:i,normalize:!0,className:`${m[0]},${m[1]}`,zIndex:l,lineJoin:"round",close:!0},T={x:Math.floor(y.x*w[0]+f[0]-k.SafeBorderPadding*w[0]),y:Math.floor(y.y*w[1]+f[1]-k.SafeBorderPadding*w[1]),w:Math.floor(y.w*w[0]+2*k.SafeBorderPadding*w[0]),h:Math.floor(y.h*w[1]+2*k.SafeBorderPadding*w[1])};h&&(P.scale=h),d&&(P.rotate=d),u&&(P.translate=u);const I=new _.Polyline(P);if(s.append(I),h||d||u){const b=I.getBoundingClientRect();return{x:Math.floor(b.x-k.SafeBorderPadding),y:Math.floor(b.y-k.SafeBorderPadding),w:Math.floor(b.width+k.SafeBorderPadding*2),h:Math.floor(b.height+k.SafeBorderPadding*2)}}return T}transformControlPoints(e){const t=X(this.tmpPoints);switch(e){case"bottom":case"bottomLeft":case"bottomRight":{const r=t.y+t.h*this.ratio;return[new p(t.x,t.y,0),new p(t.x+t.w,t.y,0),new p(t.x+t.w,r,0),new p(t.x,r,0)]}case"top":case"topLeft":case"topRight":{const r=t.y+t.h*(1-this.ratio);return[new p(t.x,r,0),new p(t.x+t.w,r,0),new p(t.x+t.w,t.y+t.h,0),new p(t.x,t.y+t.h,0)]}case"left":case"leftBottom":case"leftTop":{const r=t.x+t.w*(1-this.ratio);return[new p(r,t.y,0),new p(t.x+t.w,t.y,0),new p(t.x+t.w,t.y+t.h,0),new p(r,t.y+t.h,0)]}case"right":case"rightBottom":case"rightTop":{const r=t.x+t.w*this.ratio;return[new p(t.x,t.y,0),new p(r,t.y,0),new p(r,t.y+t.h,0),new p(t.x,t.y+t.h,0)]}}}computDrawPoints(e,t){const r=X(this.tmpPoints),s=this.transformControlPoints(t),i=Math.floor(r.w*.1),n=Math.floor(r.h*.1),a=[],l=p.Add(s[0],new p(0,n,0)),c=p.Add(s[0],new p(i,0,0)),h=ae.getBezierPoints(10,l,s[0],c),d=p.Sub(s[1],new p(i,0,0)),u=p.Add(s[1],new p(0,n,0)),f=ae.getBezierPoints(10,d,s[1],u),w=p.Sub(s[2],new p(0,n,0)),y=p.Sub(s[2],new p(i,0,0)),m=ae.getBezierPoints(10,w,s[2],y),S=p.Add(s[3],new p(i,0,0)),P=p.Sub(s[3],new p(0,n,0)),T=ae.getBezierPoints(10,S,s[3],P),I=i*(1-this.ratio)*10,b=n*(1-this.ratio)*10;switch(t){case"bottom":{const O=p.Sub(s[2],new p(i*5-I/2,0,0)),R=p.Sub(s[2],new p(i*5,-b,0)),A=p.Sub(s[2],new p(i*5+I/2,0,0));a.push(R,A,...T,...h,...f,...m,O);break}case"bottomRight":{const O=p.Sub(s[2],new p(i*1.1,0,0)),R=p.Sub(s[2],new p(i*1.1+I/2,-b,0)),A=p.Sub(s[2],new p(i*1.1+I,0,0));a.push(R,A,...T,...h,...f,...m,O);break}case"bottomLeft":{const O=p.Add(s[3],new p(i*1.1+I,0,0)),R=p.Add(s[3],new p(i*1.1+I/2,b,0)),A=p.Add(s[3],new p(i*1.1,0,0));a.push(R,A,...T,...h,...f,...m,O);break}case"top":{const O=p.Sub(s[1],new p(i*5-I/2,0,0)),R=p.Sub(s[1],new p(i*5,b,0)),A=p.Sub(s[1],new p(i*5+I/2,0,0));a.push(R,O,...f,...m,...T,...h,A);break}case"topRight":{const O=p.Sub(s[1],new p(i*1.1,0,0)),R=p.Sub(s[1],new p(i*1.1+I/2,b,0)),A=p.Sub(s[1],new p(i*1.1+I,0,0));a.push(R,O,...f,...m,...T,...h,A);break}case"topLeft":{const O=p.Add(s[0],new p(i*1.1+I,0,0)),R=p.Add(s[0],new p(i*1.1+I/2,-b,0)),A=p.Add(s[0],new p(i*1.1,0,0));a.push(R,O,...f,...m,...T,...h,A);break}case"left":{const O=p.Add(s[0],new p(0,n*5-b/2,0)),R=p.Add(s[0],new p(-I,n*5,0)),A=p.Add(s[0],new p(0,n*5+b/2,0));a.push(R,O,...h,...f,...m,...T,A);break}case"leftTop":{const O=p.Add(s[0],new p(0,n*1.1,0)),R=p.Add(s[0],new p(-I,n*1.1+b/2,0)),A=p.Add(s[0],new p(0,n*1.1+b,0));a.push(R,O,...h,...f,...m,...T,A);break}case"leftBottom":{const O=p.Sub(s[3],new p(0,n*1.1+b,0)),R=p.Sub(s[3],new p(I,n*1.1+b/2,0)),A=p.Sub(s[3],new p(0,n*1.1,0));a.push(R,O,...h,...f,...m,...T,A);break}case"right":{const O=p.Add(s[1],new p(0,n*5-b/2,0)),R=p.Add(s[1],new p(I,n*5,0)),A=p.Add(s[1],new p(0,n*5+b/2,0));a.push(R,A,...m,...T,...h,...f,O);break}case"rightTop":{const O=p.Add(s[1],new p(0,n*1.1,0)),R=p.Add(s[1],new p(I,n*1.1+b/2,0)),A=p.Add(s[1],new p(0,n*1.1+b,0));a.push(R,A,...m,...T,...h,...f,O);break}case"rightBottom":{const O=p.Sub(s[2],new p(0,n*1.1+b,0)),R=p.Sub(s[2],new p(-I,n*1.1+b/2,0)),A=p.Sub(s[2],new p(0,n*1.1,0));a.push(R,A,...m,...T,...h,...f,O);break}}const C=X(this.tmpPoints,e),L=[Math.floor(C.x+C.w/2),Math.floor(C.y+C.h/2)];return{rect:C,pos:L,points:a}}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i)||W.Sub(s,r).XY.includes(0))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s}=e,i=(t=this.workId)==null?void 0:t.toString();if(!i)return;this.tmpPoints.length=0;for(let l=0;l<r.length;l+=3)this.tmpPoints.push(new W(r[l],r[l+1],r[l+2]));const n=s?this.fullLayer:this.drawLayer||this.fullLayer,a=this.draw({workId:i,layer:n,isDrawing:!1});return this.oldRect=a,this.vNodes.setInfo(i,{rect:a,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:a&&k.getCenterPos(a,n)}),a}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){const{node:t,opt:r,vNodes:s}=e,{strokeColor:i,fillColor:n,toolsType:a,placement:l}=r,c=s.get(t.name),h=c==null?void 0:c.opt;let d=t;return t.tagName==="GROUP"&&(d=t.children[0]),i&&(d.setAttribute("strokeColor",i),h!=null&&h.strokeColor&&(h.strokeColor=i)),n&&(n==="transparent"?d.setAttribute("fillColor","rgba(0,0,0,0)"):d.setAttribute("fillColor",n),h!=null&&h.fillColor&&(h.fillColor=n)),a===g.SpeechBalloon&&l&&(h.placement=l),c&&s.setInfo(t.name,{...c,opt:h}),k.updateNodeOpt(e)}}class eo extends k{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.Image}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.scaleType=this.workOptions.uniformScale?V.proportional:V.all}consume(){return{type:v.None}}consumeAll(){return{type:v.None}}draw(e){var t;const{layer:r,workId:s,replaceId:i,imageBitmap:n}=e,{centerX:a,centerY:l,width:c,height:h,scale:d,rotate:u,translate:f,zIndex:w}=this.workOptions;this.fullLayer.getElementsByName(i||s).map(T=>T.remove()),(t=this.drawLayer)==null||t.getElementsByName(i||s).map(T=>T.remove());const y={anchor:[.5,.5],pos:[a,l],name:s,size:[c,h],zIndex:w};if(d)if(this.scaleType===V.proportional){const T=Math.min(d[0],d[1]);y.scale=[T,T]}else y.scale=d;f&&(y.translate=f),u&&(y.rotate=u);const m=new _.Group(y),S=new _.Sprite({anchor:[.5,.5],pos:[0,0],size:[c,h],texture:n,rotate:180});m.append(S),r.append(m);const P=m.getBoundingClientRect();if(P)return{x:Math.floor(P.x-k.SafeBorderPadding),y:Math.floor(P.y-k.SafeBorderPadding),w:Math.floor(P.width+k.SafeBorderPadding*2),h:Math.floor(P.height+k.SafeBorderPadding*2)}}consumeService(){}async consumeServiceAsync(e){var t,r;const{isFullWork:s,replaceId:i,scene:n}=e,{src:a,uuid:l}=this.workOptions,c=((t=this.workId)==null?void 0:t.toString())||l,h=s?this.fullLayer:this.drawLayer||this.fullLayer;if(a){const d=await n.preload({id:l,src:this.workOptions.src}),u=this.draw({workId:c,layer:h,replaceId:i,imageBitmap:d[0]});return this.oldRect=c&&((r=this.vNodes.get(c))==null?void 0:r.rect)||void 0,this.vNodes.setInfo(c,{rect:u,op:[],opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:u&&k.getCenterPos(u,h)}),u}}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){const{node:t,opt:r,vNodes:s,targetNode:i}=e,{translate:n,box:a,boxScale:l,boxTranslate:c,angle:h,isLocked:d,zIndex:u}=r,f=i&&te(i)||s.get(t.name);if(!f)return;const w=t.parent;if(w){if(ue(u)&&(t.setAttribute("zIndex",u),f.opt.zIndex=u),me(d)&&(f.opt.locked=d),a&&c&&l){const{centerX:y,centerY:m,width:S,height:P,uniformScale:T}=f.opt;if(T){const C=Math.min(l[0],l[1]);f.opt.scale=[C,C]}else f.opt.scale=l;f.opt.width=Math.floor(S*l[0]),f.opt.height=Math.floor(P*l[1]);const I=[c[0]/w.worldScaling[0],c[1]/w.worldScaling[1]];f.opt.centerX=y+I[0],f.opt.centerY=m+I[1];const b=[f.centerPos[0]+I[0],f.centerPos[1]+I[1]];if(f.centerPos=b,i){let C=Nr(f.rect,l);C=je(C,I),f.rect=C}}else if(n){const y=[n[0]/w.worldScaling[0],n[1]/w.worldScaling[1]];if(f.opt.centerX=f.opt.centerX+y[0],f.opt.centerY=f.opt.centerY+y[1],f.centerPos=[f.centerPos[0]+y[0],f.centerPos[1]+y[1]],i){const m=je(f.rect,y);f.rect=m}}else if(ue(h)&&(t.setAttribute("rotate",h),f.opt.rotate=h,i)){const y=Cr(f.rect,h);f.rect=y}return f&&s.setInfo(t.name,f),f==null?void 0:f.rect}}}class to extends k{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.both}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.Straight}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"straightTipWidth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.straightTipWidth=this.workOptions.thickness/2,this.syncTimestamp=0,this.syncUnitTime=50}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:v.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:v.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:v.None};if(!i){const w=Date.now();return w-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=w,{type:v.DrawWork,dataType:M.Local,workId:n,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0}):{type:v.None}}const d=s?this.fullLayer:this.drawLayer||this.fullLayer,u=this.draw({workId:n,layer:d}),f=j(u,this.oldRect);return this.oldRect=u,{rect:f,type:v.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:v.None};if(this.tmpPoints.length<2)return{type:v.RemoveNode,removeIds:[s]};const i=this.fullLayer,n=this.draw({workId:s,layer:i});this.oldRect=n;const a=this.tmpPoints.map(c=>[...c.XY,0]).flat(1),l=le(a);return this.vNodes.setInfo(s,{rect:n,op:a,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:n&&k.getCenterPos(n,i)}),{rect:n,type:v.FullWork,dataType:M.Local,workId:s,ops:l,isSync:!0,opt:this.workOptions}}draw(e){var t;const{workId:r,layer:s}=e;this.fullLayer.getElementsByName(r).map(P=>P.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(P=>P.remove());const{strokeColor:i,thickness:n,zIndex:a,scale:l,rotate:c,translate:h}=this.workOptions,d=s.worldPosition,u=s.worldScaling,{d:f,rect:w}=this.computDrawPoints(n),y=[w.x+w.w/2,w.y+w.h/2],m={pos:y,name:r,id:r,d:f,fillColor:i,strokeColor:i,lineWidth:0,className:`${y[0]},${y[1]}`,normalize:!0,zIndex:a};l&&(m.scale=l),c&&(m.rotate=c),h&&(m.translate=h);const S=new _.Path(m);if(s.append(S),c||l||h){const P=S.getBoundingClientRect();return{x:Math.floor(P.x-k.SafeBorderPadding),y:Math.floor(P.y-k.SafeBorderPadding),w:Math.floor(P.width+k.SafeBorderPadding*2),h:Math.floor(P.height+k.SafeBorderPadding*2)}}return{x:Math.floor(w.x*u[0]+d[0]-k.SafeBorderPadding),y:Math.floor(w.y*u[1]+d[1]-k.SafeBorderPadding),w:Math.floor(w.w*u[0]+2*k.SafeBorderPadding),h:Math.floor(w.h*u[1]+2*k.SafeBorderPadding)}}computDrawPoints(e){return this.tmpPoints[1].distance(this.tmpPoints[0])>this.straightTipWidth?this.computFullPoints(e):this.computDotPoints(e)}computFullPoints(e){const t=p.Sub(this.tmpPoints[1],this.tmpPoints[0]).uni(),r=p.Per(t).mul(e/2),s=W.Sub(this.tmpPoints[0],r),i=W.Add(this.tmpPoints[0],r),n=W.Sub(this.tmpPoints[1],r),a=W.Add(this.tmpPoints[1],r),l=W.GetSemicircleStroke(this.tmpPoints[1],n,-1,8),c=W.GetSemicircleStroke(this.tmpPoints[0],i,-1,8),h=[s,n,...l,a,i,...c];return{d:Oe(h,!0),rect:X(h),isDot:!1,pos:this.tmpPoints[0].XY}}computDotPoints(e){const t=W.GetDotStroke(this.tmpPoints[0],e/2,8);return{d:Oe(t,!0),rect:X(t),isDot:!0,pos:this.tmpPoints[0].XY}}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s}=e,i=(t=this.workId)==null?void 0:t.toString();if(!i)return;this.tmpPoints.length=0;for(let l=0;l<r.length;l+=3)this.tmpPoints.push(new W(r[l],r[l+1],r[l+2]));const n=s?this.fullLayer:this.drawLayer||this.fullLayer,a=this.draw({workId:i,layer:n});return this.oldRect=a,this.vNodes.setInfo(i,{rect:a,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:a&&k.getCenterPos(a,n)}),a}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){var t;const{node:r,opt:s,vNodes:i}=e,{strokeColor:n}=s,a=i.get(r.name);return n&&(r.setAttribute("strokeColor",n),r.setAttribute("fillColor",n),(t=a==null?void 0:a.opt)!=null&&t.strokeColor&&(a.opt.strokeColor=n)),a&&i.setInfo(r.name,a),k.updateNodeOpt(e)}}class Ae extends k{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:g.Text}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt}consume(){return{type:v.None}}consumeAll(){return{type:v.None}}draw(e){var t;const{workId:r,layer:s,isDrawLabel:i}=e;this.fullLayer.getElementsByName(r).map(y=>y.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(y=>y.remove());const{boxSize:n,boxPoint:a,zIndex:l}=this.workOptions,c=s.worldPosition,h=s.worldScaling;if(!a||!n)return;const d=new _.Group({name:r,id:r,pos:[a[0]+n[0]/2,a[1]+n[1]/2],anchor:[.5,.5],size:n,zIndex:l}),u={x:a[0],y:a[1],w:n[0],h:n[1]},f=new _.Rect({normalize:!0,pos:[0,0],size:n}),w=i&&Ae.createLabels(this.workOptions,s)||[];return d.append(...w,f),s.append(d),{x:Math.floor(u.x*h[0]+c[0]),y:Math.floor(u.y*h[1]+c[1]),w:Math.floor(u.w*h[0]),h:Math.floor(u.h*h[1])}}consumeService(e){var t,r;const s=(t=this.workId)==null?void 0:t.toString();if(!s)return;const{isFullWork:i,replaceId:n,isDrawLabel:a}=e;this.oldRect=n&&((r=this.vNodes.get(n))==null?void 0:r.rect)||void 0;const l=i?this.fullLayer:this.drawLayer||this.fullLayer,c=this.draw({workId:s,layer:l,isDrawLabel:a});return this.vNodes.setInfo(s,{rect:c,op:[],opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:c&&k.getCenterPos(c,l)}),c}updataOptService(e){if(!this.workId)return;const t=this.workId.toString(),{fontColor:r,fontBgColor:s,bold:i,italic:n,lineThrough:a,underline:l,zIndex:c}=e,h=this.vNodes.get(t);if(!h)return;r&&(h.opt.fontColor=r),s&&(h.opt.fontBgColor=s),i&&(h.opt.bold=i),n&&(h.opt.italic=n),me(a)&&(h.opt.lineThrough=a),me(l)&&(h.opt.underline=l),s&&(h.opt.fontBgColor=s),ue(c)&&(h.opt.zIndex=c),this.oldRect=h.rect;const d=this.draw({workId:t,layer:this.fullLayer,isDrawLabel:!1});return this.vNodes.setInfo(t,{rect:d,op:[],opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:d&&k.getCenterPos(d,this.fullLayer)}),d}clearTmpPoints(){this.tmpPoints.length=0}static getFontWidth(e){const{ctx:t,opt:r,text:s}=e,{bold:i,italic:n,fontSize:a,fontFamily:l}=r;return t.font=`${i} ${n} ${a}px ${l}`,t.measureText(s).width}static createLabels(e,t){const r=[],s=e.text.split(","),i=s.length;for(let n=0;n<i;n++){const a=s[n],{fontSize:l,lineHeight:c,bold:h,textAlign:d,italic:u,boxSize:f,fontFamily:w,verticalAlign:y,fontColor:m,underline:S,lineThrough:P}=e,T=c||l*1.2,I=t&&t.parent.canvas.getContext("2d"),b=I&&Ae.getFontWidth({text:a,opt:e,ctx:I,worldScaling:t.worldScaling});if(b){const C={anchor:[0,.5],text:a,fontSize:l,lineHeight:T,fontFamily:w,fontWeight:h,fillColor:m,textAlign:d,fontStyle:u,name:n.toString(),className:"label"},L=[0,0];if(y==="middle"){const R=(i-1)/2;L[1]=(n-R)*T}d==="left"&&(L[0]=f&&-f[0]/2+5||0),C.pos=L;const O=new _.Label(C);if(r.push(O),S){const R={normalize:!1,pos:[C.pos[0],C.pos[1]+l/2],lineWidth:2*t.worldScaling[0],points:[0,0,b,0],strokeColor:m,name:`${n}_underline`,className:"underline"},A=new _.Polyline(R);r.push(A)}if(P){const R={normalize:!1,pos:C.pos,lineWidth:2*t.worldScaling[0],points:[0,0,b,0],strokeColor:m,name:`${n}_lineThrough`,className:"lineThrough"},A=new _.Polyline(R);r.push(A)}}}return r}static updateNodeOpt(e){const{node:t,opt:r,vNodes:s,targetNode:i}=e,{fontBgColor:n,fontColor:a,translate:l,box:c,boxScale:h,boxTranslate:d,bold:u,italic:f,lineThrough:w,underline:y,fontSize:m,textInfos:S}=r,P=i&&te(i)||s.get(t.name);if(!P)return;const T=t.parent;if(!T)return;const I=P.opt;if(a&&I.fontColor&&(I.fontColor=a),n&&I.fontBgColor&&(I.fontBgColor=n),u&&(I.bold=u),f&&(I.italic=f),me(w)&&(I.lineThrough=w),me(y)&&(I.underline=y),m&&(I.fontSize=m),c&&d&&h){const b=S==null?void 0:S.get(t.name);if(b){const{fontSize:O,boxSize:R}=b;I.boxSize=R||I.boxSize,I.fontSize=O||I.fontSize}const C=P.rect,L=je(Nr(C,h),d);I.boxPoint=L&&[(L.x-T.worldPosition[0])/T.worldScaling[0],(L.y-T.worldPosition[1])/T.worldScaling[1]]}else if(l&&I.boxPoint){const b=[l[0]/T.worldScaling[0],l[1]/T.worldScaling[1]];I.boxPoint=[I.boxPoint[0]+b[0],I.boxPoint[1]+b[1]],P.centerPos=[P.centerPos[0]+b[0],P.centerPos[1]+b[1]],P.rect=je(P.rect,b)}return P&&s.setInfo(t.name,P),P==null?void 0:P.rect}static getRectFromLayer(e,t){const r=e.getElementsByName(t)[0];if(r){const s=r.getBoundingClientRect();return{x:Math.floor(s.x),y:Math.floor(s.y),w:Math.floor(s.width),h:Math.floor(s.height)}}}}function ro(o){switch(o){case g.Arrow:return Hr;case g.Pencil:return Rr;case g.Straight:return to;case g.Ellipse:return qr;case g.Polygon:case g.Triangle:return Jr;case g.Star:case g.Rhombus:return Qr;case g.Rectangle:return Zr;case g.SpeechBalloon:return Kr;case g.Text:return Ae;case g.LaserPen:return Mr;case g.Eraser:return ne;case g.Selector:return U;case g.Image:return eo}}function kt(o,e){const{toolsType:t,...r}=o;switch(t){case g.Arrow:return new Hr(r);case g.Pencil:return new Rr(r);case g.Straight:return new to(r);case g.Ellipse:return new qr(r);case g.Polygon:case g.Triangle:return new Jr(r);case g.Star:case g.Rhombus:return new Qr(r);case g.Rectangle:return new Zr(r);case g.SpeechBalloon:return new Kr(r);case g.Text:return new Ae(r);case g.LaserPen:return new Mr(r);case g.Eraser:return new ne(r,e);case g.Selector:return new U(r);case g.Image:return new eo(r);default:return}}function oo(o){const e=[],t=["PATH","SPRITE","POLYLINE","RECT","ELLIPSE"];for(const r of o){if(r.tagName==="GROUP"&&r.children.length)return oo(r.children);r.tagName&&t.includes(r.tagName)&&e.push(r)}return e}class lp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.ZIndexActive})}consume(e){const{msgType:t,dataType:r,emitEventType:s}=e;if(t===v.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e),!0}consumeForLocalWorker(e){var t,r,s,i,n;const{workId:a,isActiveZIndex:l,willRefreshSelector:c}=e;if(a!==U.selectorId)return;const h=(t=this.localWork)==null?void 0:t.workShapes.get(U.selectorId);if(!h)return;const d=h.oldSelectRect;if(l&&d&&this.localWork){const u=new Set;if(this.localWork.vNodes.curNodeMap.forEach((f,w)=>{Ie(d,f.rect)&&u.add(w)}),u.size){const f=[];u.forEach(w=>{var y;(y=this.localWork)==null||y.fullLayer.getElementsByName(w).forEach(m=>{var S,P;const T=m.cloneNode(!0);Ze(m)&&T.seal(),(P=(S=this.localWork)==null?void 0:S.drawLayer)!=null&&P.getElementsByName(w).length||f.push(T)})}),f.length&&((r=this.localWork.drawLayer)==null||r.append(...f))}}else(i=(s=this.localWork)==null?void 0:s.drawLayer)==null||i.children.filter(u=>{var f;return!((f=h.selectIds)!=null&&f.includes(u.name))}).forEach(u=>u.remove());c&&((n=this.localWork)==null||n._post({render:[{rect:d,drawCanvas:N.Selector,clearCanvas:N.Selector,isClear:!0,isFullWork:!1,viewId:this.localWork.viewId}],sp:[{type:v.Select,selectIds:h.selectIds,opt:h.getWorkOptions(),selectRect:d,strokeColor:h.strokeColor,fillColor:h.fillColor,willSyncService:!1,isSync:!0}]}))}}class cp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.CopyNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===v.FullWork&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:v.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r}=e;r&&await((t=this.localWork)==null?void 0:t.consumeFull(e,this.scene))}}class hp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.SetColorNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===v.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:v.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,textUpdateForWoker:l}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s}=e,{willSyncService:i,isSync:n,textUpdateForWoker:a}=t,l=r.render||[],c=r.sp||[];if(i)for(const[h,d]of s.entries())a&&d.toolsType===g.Text?c.push({...d,workId:h,type:v.TextUpdate,dataType:M.Local,willSyncService:!0}):c.push({...d,workId:h,type:v.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n});return{render:l,sp:c}}}class up extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.ZIndexNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s}=e;if(t===v.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s}=e,{willSyncService:i,isSync:n}=t,a=r.render||[],l=r.sp||[];if(i&&l)for(const[c,h]of s.entries())l.push({...h,workId:c,type:v.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n});return{render:a,sp:l}}}class dp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.TranslateNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===v.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:v.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t,r;const{workId:s,updateNodeOpt:i,willRefreshSelector:n,willSyncService:a,willSerializeData:l,textUpdateForWoker:c,emitEventType:h}=e;s===U.selectorId&&i&&(i.workState===E.Done&&i!=null&&i.translate&&(i.translate[0]||i.translate[1])||i.workState!==E.Done?await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:i,willRefreshSelector:n,willSyncService:a,willSerializeData:l,isSync:!0,textUpdateForWoker:c,emitEventType:h,scene:this.scene,callback:this.updateSelectorCallback})):i.workState===E.Done&&((r=this.localWork)==null||r.vNodes.deleteLastTarget()))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s,workShapeNode:i,res:n}=e,{willSyncService:a,isSync:l,updateSelectorOpt:c,willSerializeData:h,textUpdateForWoker:d}=t,u=c.workState,f=r.render||[],w=r.sp||[];if(u===E.Start)return{sp:[],render:[]};const y=n==null?void 0:n.selectRect;if(a){if(h){const m=i.getChildrenPoints();m&&w.push({type:v.Select,selectIds:i.selectIds,selectRect:y,willSyncService:!1,isSync:l,points:m})}for(const[m,S]of s.entries())d&&S.toolsType===g.Text?w.push({...S,workId:m,type:v.TextUpdate,dataType:M.Local,willSyncService:!0}):w.push({...S,workId:m,type:v.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l})}return{render:f,sp:w}}}class pp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.DeleteNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s}=e;if(t===v.RemoveNode){if(r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e),!0;if(r===M.Service&&s===this.emitEventType)return this.consumeForServiceWorker(e),!0}}consumeForLocalWorker(e){if(!this.localWork)return;const{removeIds:t,willRefresh:r,willSyncService:s,viewId:i}=e;if(!(t!=null&&t.length))return;let n;const a=[],l=[],c=[];for(const h of t){if(h===U.selectorId){const u=this.localWork.workShapes.get(U.selectorId);if(!u)return;const f=u.selectIds&&[...u.selectIds]||[];for(const y of f){if(this.localWork.vNodes.get(y)){const m=this.commandDeleteText(y);m&&a.push(m)}n=j(n,this.localWork.removeNode(y)),c.push(y)}const w=u==null?void 0:u.updateSelectIds([]);n=j(n,w.bgRect),this.localWork.clearWorkShapeNodeCache(U.selectorId),this.localWork.workShapes.delete(U.selectorId),a.push({type:v.Select,selectIds:[],willSyncService:s});continue}const d=this.commandDeleteText(h);d&&a.push(d),n=j(n,this.localWork.removeNode(h)),c.push(h)}s&&a.push({type:v.RemoveNode,removeIds:c,undoTickerId:e.undoTickerId}),n&&r&&l.push({rect:n,drawCanvas:N.Bg,clearCanvas:N.Bg,isClear:!0,isFullWork:!0,viewId:i}),(l.length||a.length)&&this.localWork._post({render:l,sp:a})}consumeForServiceWorker(e){this.serviceWork&&this.serviceWork.removeSelectWork(e)}commandDeleteText(e){var t;const r=(t=this.localWork)==null?void 0:t.vNodes.get(e);if(r&&r.toolsType===g.Text)return{type:v.TextUpdate,toolsType:g.Text,workId:e,dataType:M.Local}}}class fp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.ScaleNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===v.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:v.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willSyncService:i,willSerializeData:n}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willSyncService:i,willSerializeData:n,isSync:!0,scene:this.scene,callback:this.updateSelectorCallback.bind(this)}))}updateSelectorCallback(e){const{param:t,postData:r,workShapeNode:s,res:i,newServiceStore:n}=e,{updateSelectorOpt:a,willSyncService:l,willSerializeData:c}=t,h=a.workState,d=r.render||[],u=r.sp||[],f=i==null?void 0:i.selectRect,w=i==null?void 0:i.renderRect;if(h===E.Start)return{sp:[],render:[]};if(this.localWork){d.push({isClearAll:!0,isFullWork:!1,clearCanvas:N.Selector,viewId:this.localWork.viewId});const y={rect:w,isFullWork:!1,drawCanvas:N.Selector,viewId:this.localWork.viewId};d.push(y)}if(l){h===E.Doing&&u.push({type:v.Select,selectIds:s.selectIds,selectRect:f,willSyncService:!0,isSync:!0,points:s.getChildrenPoints(),textOpt:s.textOpt}),c&&h===E.Done&&u.push({type:v.Select,selectIds:s.selectIds,selectRect:f,willSyncService:!1,isSync:!0,points:s.getChildrenPoints(),textOpt:s.textOpt});for(const[y,m]of n.entries())m.toolsType===g.Text?u.push({...m,workId:y,type:v.TextUpdate,dataType:M.Local,willSyncService:!0}):u.push({...m,workId:y,type:v.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:!0})}return{render:d,sp:u}}}class yp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.RotateNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===v.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:v.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,emitEventType:l}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,emitEventType:l,isSync:!0,scene:this.scene,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,workShapeNode:s,res:i,newServiceStore:n}=e,{updateSelectorOpt:a,willSyncService:l,willSerializeData:c,isSync:h}=t,d=a.workState,u=r.render||[],f=r.sp||[],w=i==null?void 0:i.selectRect;if(l){c&&d===E.Done&&f.push({type:v.Select,selectIds:s.selectIds,selectRect:w,willSyncService:!0,isSync:h,points:s.getChildrenPoints()});for(const[y,m]of n.entries())f.push({...m,workId:y,type:v.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:h})}return{render:u,sp:f}}}class wp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.SetFontStyle})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===v.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:v.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,textUpdateForWoker:l}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s,workShapeNode:i,res:n}=e,{willSyncService:a,isSync:l,updateSelectorOpt:c,textUpdateForWoker:h}=t,d=r.render||[],u=r.sp||[],f=n==null?void 0:n.selectRect;if(a&&u){c.fontSize&&u.push({type:v.Select,selectIds:i.selectIds,selectRect:f,willSyncService:a,isSync:l,points:i.getChildrenPoints()});for(const[w,y]of s.entries())h&&y.toolsType===g.Text?u.push({...y,workId:w,type:v.TextUpdate,dataType:M.Local,willSyncService:!0}):u.push({...y,workId:w,type:v.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l})}return{render:d,sp:u}}}class vp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.SetPoint})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===v.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:v.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,textUpdateForWoker:l}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,emitEventType:this.emitEventType,willSerializeData:a,isSync:!0,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s,workShapeNode:i,res:n}=e,{willSyncService:a,isSync:l}=t,c=r.render||[],h=r.sp||[],d=n==null?void 0:n.selectRect;if(a&&h){for(const[u,f]of s.entries())h.push({...f,workId:u,type:v.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l});h.push({type:v.Select,selectIds:i.selectIds,selectRect:d,willSyncService:a,isSync:l,points:i.getChildrenPoints()})}return{render:c,sp:h}}}class mp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.SetLock})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===v.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:v.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s,workShapeNode:i,res:n}=e,{willSyncService:a,isSync:l,updateSelectorOpt:c}=t,h=r.render||[],d=r.sp||[],u=n==null?void 0:n.selectRect;if(a&&d){for(const[f,w]of s.entries())d.push({...w,workId:f,type:v.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l});d.push({isLocked:c.isLocked,selectorColor:i.selectorColor,scaleType:i.scaleType,canRotate:i.canRotate,type:v.Select,selectIds:i.selectIds,selectRect:u,willSyncService:a,isSync:l})}return{render:h,sp:d}}}class gp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.SetShapeOpt})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===v.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:v.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s}=e,{willSyncService:i,isSync:n}=t,a=r.render||[],l=r.sp||[];if(i&&l)for(const[c,h]of s.entries())l.push({...h,workId:c,type:v.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n});return{render:a,sp:l}}}class bp{constructor(e){Object.defineProperty(this,"builders",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),this.builders=new Map(e.map(t=>[t,this.build(t)]))}build(e){switch(e){case z.TranslateNode:return new dp;case z.ZIndexNode:return new up;case z.ZIndexActive:return new lp;case z.CopyNode:return new cp;case z.SetColorNode:return new hp;case z.DeleteNode:return new pp;case z.ScaleNode:return new fp;case z.RotateNode:return new yp;case z.SetFontStyle:return new wp;case z.SetPoint:return new vp;case z.SetLock:return new mp;case z.SetShapeOpt:return new gp}}registerForWorker(e,t,r){return this.builders.forEach(s=>{s&&s.registerForWorker(e,t,r)}),this}consumeForWorker(e){for(const t of this.builders.values())if(t!=null&&t.consume(e))return!0;return!1}}const tt="cursorhover";class kp{constructor(e,t){Object.defineProperty(this,"viewId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"scene",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"scenePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"curNodeMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"targetNodeMap",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.viewId=e,this.scene=t}init(e,t){this.fullLayer=e,this.drawLayer=t}get(e){return this.curNodeMap.get(e)}hasRenderNodes(){let e=!1;for(const t of this.curNodeMap.values())Wr(t.toolsType)&&(e=!0);return e}has(e){this.curNodeMap.has(e)}setInfo(e,t){const r=this.curNodeMap.get(e)||{name:e,rect:t.rect};t.rect&&(r.rect=te(t.rect)),t.op&&(r.op=te(t.op)),t.canRotate&&(r.canRotate=t.canRotate),t.scaleType&&(r.scaleType=t.scaleType),t.opt&&(r.opt=te(t.opt)),t.toolsType&&(r.toolsType=t.toolsType),t.centerPos&&(r.centerPos=te(t.centerPos)),r.rect?this.curNodeMap.set(e,r):this.curNodeMap.delete(e)}delete(e){this.curNodeMap.delete(e)}clear(){this.curNodeMap.clear(),this.targetNodeMap.length=0}hasRectIntersectRange(e,t=!0){for(const r of this.curNodeMap.values())if(Ie(e,r.rect)){if(t&&r.toolsType===g.Image&&r.opt.locked||t&&r.toolsType===g.Text&&(r.opt.workState===E.Doing||r.opt.workState===E.Start))continue;return!0}return!1}getRectIntersectRange(e,t=!0){let r;const s=new Map;for(const[i,n]of this.curNodeMap.entries())if(Ie(e,n.rect)){if(t&&n.toolsType===g.Image&&n.opt.locked||t&&n.toolsType===g.Text&&(n.opt.workState===E.Doing||n.opt.workState===E.Start))continue;r=j(r,n.rect),s.set(i,n)}return{rectRange:r,nodeRange:s}}getNodeRectFormShape(e,t){const r=ro(t.toolsType);let s=this.fullLayer&&(r==null?void 0:r.getRectFromLayer(this.fullLayer,e));return!s&&this.drawLayer&&(s=r==null?void 0:r.getRectFromLayer(this.drawLayer,e)),s}updateNodesRect(){this.curNodeMap.forEach((e,t)=>{const r=this.getNodeRectFormShape(t,e);r?(e.rect=r,this.curNodeMap.set(t,e)):this.curNodeMap.delete(t)})}combineIntersectRect(e){let t=e;return this.curNodeMap.forEach(r=>{Ie(t,r.rect)&&(t=j(t,r.rect))}),t}setTarget(){return this.targetNodeMap.push(te(this.curNodeMap)),this.targetNodeMap.length-1}getLastTarget(){return this.targetNodeMap[this.targetNodeMap.length-1]}deleteLastTarget(){this.targetNodeMap.length=this.targetNodeMap.length-1}getTarget(e){return this.targetNodeMap[e]}deleteTarget(e){this.targetNodeMap.length=e}}class so{constructor(e,t){Object.defineProperty(this,"viewId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vNodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dpr",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"opt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cameraOpt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"scene",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isSafari",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.viewId=e,this.opt=t,this.dpr=t.dpr,this.scene=this.createScene(t.offscreenCanvasOpt),this.fullLayer=this.createLayer("fullLayer",this.scene,{...t.layerOpt,bufferSize:this.viewId==="mainView"?6e3:3e3}),this.vNodes=new kp(e,this.scene)}setIsSafari(e){this.isSafari=e}on(e){const{msgType:t,toolsType:r,opt:s,workId:i,workState:n,dataType:a}=e;switch(t){case v.Destroy:this.destroy();break;case v.Clear:this.clearAll();break;case v.UpdateTools:if(r&&s){const l={toolsType:r,toolsOpt:s};this.localWork.setToolsOpt(l)}break;case v.CreateWork:i&&s&&(!this.localWork.getTmpWorkShapeNode()&&r&&this.setToolsOpt({toolsType:r,toolsOpt:s}),this.setWorkOpt({workId:i,toolsOpt:s}));break;case v.DrawWork:n===E.Done&&a===M.Local?this.consumeDrawAll(a,e):this.consumeDraw(a,e);break}}updateScene(e){this.scene.attr({...e});const{width:t,height:r}=e;this.scene.container.width=t,this.scene.container.height=r,this.scene.width=t,this.scene.height=r,this.updateLayer({width:t,height:r})}updateLayer(e){const{width:t,height:r}=e;this.fullLayer&&(this.fullLayer.parent.setAttribute("width",t),this.fullLayer.parent.setAttribute("height",r),this.fullLayer.setAttribute("size",[t,r]),this.fullLayer.setAttribute("pos",[t*.5,r*.5])),this.drawLayer&&(this.drawLayer.parent.setAttribute("width",t),this.drawLayer.parent.setAttribute("height",r),this.drawLayer.setAttribute("size",[t,r]),this.drawLayer.setAttribute("pos",[t*.5,r*.5])),this.snapshotFullLayer&&(this.snapshotFullLayer.parent.setAttribute("width",t),this.snapshotFullLayer.parent.setAttribute("height",r),this.snapshotFullLayer.setAttribute("size",[t,r]),this.snapshotFullLayer.setAttribute("pos",[t*.5,r*.5]))}createScene(e){const{width:t,height:r}=e,s=new OffscreenCanvas(t,r);return new _.Scene({container:s,displayRatio:this.dpr,depth:!1,desynchronized:!0,...e})}createLayer(e,t,r){const{width:s,height:i}=r,n=`offscreen-${e}`,a=t.layer(n,r),l=new _.Group({anchor:[.5,.5],pos:[s*.5,i*.5],size:[s,i],name:"viewport",id:e});return a.append(l),l}clearAll(){var e;this.fullLayer&&(this.fullLayer.parent.children.forEach(t=>{t.name!=="viewport"&&t.remove()}),this.fullLayer.removeAllChildren()),this.drawLayer&&(this.drawLayer.parent.children.forEach(t=>{t.name!=="viewport"&&t.remove()}),this.drawLayer.removeAllChildren()),this.localWork.clearAllWorkShapesCache(),(e=this.serviceWork)==null||e.clearAllWorkShapesCache()}setToolsOpt(e){this.localWork.setToolsOpt(e)}setWorkOpt(e){const{workId:t,toolsOpt:r}=e;t&&r&&this.localWork.setWorkOptions(t,r)}destroy(){var e;this.vNodes.clear(),this.scene.remove(),this.fullLayer.remove(),this.localWork.destroy(),(e=this.serviceWork)==null||e.destroy()}}class io{constructor(e){Object.defineProperty(this,"viewId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vNodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"thread",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_post",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tmpWorkShapeNode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tmpOpt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workShapes",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"workShapeState",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"effectWorkId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.thread=e.thread,this.viewId=e.viewId,this.vNodes=e.vNodes,this.fullLayer=e.fullLayer,this.drawLayer=e.drawLayer,this._post=e.post}destroy(){this.workShapeState.clear(),this.workShapes.clear()}getWorkShape(e){return this.workShapes.get(e)}getTmpWorkShapeNode(){return this.tmpWorkShapeNode}setTmpWorkId(e){if(e&&this.tmpWorkShapeNode){this.tmpWorkShapeNode.setWorkId(e),this.workShapes.set(e,this.tmpWorkShapeNode),this.tmpOpt&&this.setToolsOpt(this.tmpOpt);return}}setTmpWorkOptions(e){var t;(t=this.tmpWorkShapeNode)==null||t.setWorkOptions(e)}setWorkOptions(e,t){var r;this.workShapes.get(e)||this.setTmpWorkId(e),(r=this.workShapes.get(e))==null||r.setWorkOptions(t)}createWorkShapeNode(e){var t;const{toolsType:r,workId:s}=e;return r===g.Selector&&s===tt?kt({...e,vNodes:this.vNodes,fullLayer:this.fullLayer,drawLayer:this.fullLayer}):kt({...e,vNodes:this.vNodes,fullLayer:this.fullLayer,drawLayer:this.drawLayer},(t=this.thread)==null?void 0:t.serviceWork)}setToolsOpt(e){var t,r;((t=this.tmpOpt)==null?void 0:t.toolsType)!==e.toolsType&&(r=this.tmpOpt)!=null&&r.toolsType&&this.clearAllWorkShapesCache(),this.tmpOpt=e,this.tmpWorkShapeNode=this.createWorkShapeNode(e)}clearWorkShapeNodeCache(e){var t;(t=this.getWorkShape(e))==null||t.clearTmpPoints(),this.workShapes.delete(e),this.workShapeState.delete(e)}clearAllWorkShapesCache(){this.workShapes.forEach(e=>e.clearTmpPoints()),this.workShapes.clear(),this.workShapeState.clear()}setFullWork(e){const{workId:t,opt:r,toolsType:s}=e;if(t&&r&&s){const i=t&&this.workShapes.get(t)||this.createWorkShapeNode({toolsOpt:r,toolsType:s,workId:t});return i?(i.setWorkId(t),this.workShapes.set(t,i),i):void 0}}}var Sp=ie,Pp=function(){return Sp.Date.now()},Ip=Pp,Tp=/\s/;function xp(o){for(var e=o.length;e--&&Tp.test(o.charAt(e)););return e}var Op=xp,Cp=Op,Np=/^\s+/;function Lp(o){return o&&o.slice(0,Cp(o)+1).replace(Np,"")}var Wp=Lp,Rp=ye,Mp=ce,jp="[object Symbol]";function Ap(o){return typeof o=="symbol"||Mp(o)&&Rp(o)==jp}var Bp=Ap,Dp=Wp,no=he,Fp=Bp,ao=NaN,Ep=/^[-+]0x[0-9a-f]+$/i,zp=/^0b[01]+$/i,Up=/^0o[0-7]+$/i,_p=parseInt;function Yp(o){if(typeof o=="number")return o;if(Fp(o))return ao;if(no(o)){var e=typeof o.valueOf=="function"?o.valueOf():o;o=no(e)?e+"":e}if(typeof o!="string")return o===0?o:+o;o=Dp(o);var t=zp.test(o);return t||Up.test(o)?_p(o.slice(2),t?2:8):Ep.test(o)?ao:+o}var Xp=Yp,$p=he,St=Ip,lo=Xp,Gp="Expected a function",Vp=Math.max,Hp=Math.min;function qp(o,e,t){var r,s,i,n,a,l,c=0,h=!1,d=!1,u=!0;if(typeof o!="function")throw new TypeError(Gp);e=lo(e)||0,$p(t)&&(h=!!t.leading,d="maxWait"in t,i=d?Vp(lo(t.maxWait)||0,e):i,u="trailing"in t?!!t.trailing:u);function f(C){var L=r,O=s;return r=s=void 0,c=C,n=o.apply(O,L),n}function w(C){return c=C,a=setTimeout(S,e),h?f(C):n}function y(C){var L=C-l,O=C-c,R=e-L;return d?Hp(R,i-O):R}function m(C){var L=C-l,O=C-c;return l===void 0||L>=e||L<0||d&&O>=i}function S(){var C=St();if(m(C))return P(C);a=setTimeout(S,y(C))}function P(C){return a=void 0,u&&r?f(C):(r=s=void 0,n)}function T(){a!==void 0&&clearTimeout(a),c=0,r=l=s=a=void 0}function I(){return a===void 0?n:P(St())}function b(){var C=St(),L=m(C);if(r=arguments,s=this,l=C,L){if(a===void 0)return w(l);if(d)return clearTimeout(a),a=setTimeout(S,e),f(l)}return a===void 0&&(a=setTimeout(S,e)),n}return b.cancel=T,b.flush=I,b}var Zp=qp,Qp=Zp,Jp=he,Kp="Expected a function";function ef(o,e,t){var r=!0,s=!0;if(typeof o!="function")throw new TypeError(Kp);return Jp(t)&&(r="leading"in t?!!t.leading:r,s="trailing"in t?!!t.trailing:s),Qp(o,e,{leading:r,maxWait:e,trailing:s})}var tf=ef,rf=Re(tf);class of extends io{constructor(e){super(e),Object.defineProperty(this,"combineUnitTime",{enumerable:!0,configurable:!0,writable:!0,value:600}),Object.defineProperty(this,"combineTimerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"effectSelectNodeData",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"batchEraserWorks",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"batchEraserRemoveNodes",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"batchEraserCombine",{enumerable:!0,configurable:!0,writable:!0,value:rf(()=>{const t=this.updateBatchEraserCombineNode(this.batchEraserWorks,this.batchEraserRemoveNodes);this.batchEraserWorks.clear(),this.batchEraserRemoveNodes.clear(),t.length&&this._post({render:t})},100,{leading:!1})})}consumeDraw(e,t){const{op:r,workId:s}=e;if(r!=null&&r.length&&s){const i=this.workShapes.get(s);if(!i)return;const n=i.toolsType;if(n===g.LaserPen)return;const a=i.consume({data:e,isFullWork:!0});switch(n){case g.Selector:a.type===v.Select&&(a.selectIds&&t.runReverseSelectWork(a.selectIds),this.drawSelector(a,!0));break;case g.Eraser:a!=null&&a.rect&&this.drawEraser(a);break;case g.Arrow:case g.Straight:case g.Ellipse:case g.Rectangle:case g.Star:case g.Polygon:case g.SpeechBalloon:a&&(this.drawCount++,this.drawPencil(a));break;case g.Pencil:this.combineTimerId||(this.combineTimerId=setTimeout(()=>{this.combineTimerId=void 0,this.drawPencilCombine(s)},Math.floor(i.getWorkOptions().syncUnitTime||this.combineUnitTime/2))),a&&(this.drawCount++,this.drawPencil(a));break}}}consumeDrawAll(e,t){var r,s,i;this.combineTimerId&&(clearTimeout(this.combineTimerId),this.combineTimerId=void 0);const{workId:n,undoTickerId:a}=e;if(n){a&&setTimeout(()=>{this._post({sp:[{type:v.None,undoTickerId:a}]})},0);const l=this.workShapes.get(n);if(!l)return;const c=l.toolsType;if(c===g.LaserPen)return;const h=this.workShapes.get(tt),d=(r=h==null?void 0:h.selectIds)==null?void 0:r[0],u=l.consumeAll({data:e,hoverId:d}),f=this.workShapeState.get(n);switch(c){case g.Selector:u.selectIds&&d&&(s=u.selectIds)!=null&&s.includes(d)&&h.cursorBlur(),u.selectIds&&t.runReverseSelectWork(u.selectIds),this.drawSelector(u,!1),(i=l.selectIds)!=null&&i.length?l.clearTmpPoints():this.clearWorkShapeNodeCache(n);break;case g.Eraser:u!=null&&u.rect&&this.drawEraser(u),l.clearTmpPoints();break;case g.Arrow:case g.Straight:case g.Ellipse:case g.Rectangle:case g.Star:case g.Polygon:case g.SpeechBalloon:this.drawPencilFull(u,l.getWorkOptions(),f),this.drawCount=0,this.clearWorkShapeNodeCache(n);break;case g.Pencil:u!=null&&u.rect&&(this.drawPencilFull(u,l.getWorkOptions(),f),this.drawCount=0),this.clearWorkShapeNodeCache(n);break}}}async consumeFull(e,t){var r,s;const i=this.setFullWork(e),n=e.ops&&Je(e.ops),a=(r=e.workId)==null?void 0:r.toString();if(a&&i){const l=(s=this.vNodes.get(a))==null?void 0:s.rect;let c;i.toolsType===g.Image&&t?c=await i.consumeServiceAsync({scene:t,isFullWork:!0,replaceId:a}):c=i.consumeService({op:n,isFullWork:!0,replaceId:a});const h=(e==null?void 0:e.updateNodeOpt)&&i.updataOptService(e.updateNodeOpt);c=j(c,h);const d=[],u=[];if(c&&e.willRefresh&&(l&&d.push({rect:c,isClear:!0,clearCanvas:N.Bg,isFullWork:!0,viewId:this.viewId}),d.push({rect:c,drawCanvas:N.Bg,isFullWork:!0,viewId:this.viewId})),e.willSyncService&&u.push({opt:e.opt,toolsType:e.toolsType,type:v.FullWork,workId:e.workId,ops:e.ops,updateNodeOpt:e.updateNodeOpt,undoTickerId:e.undoTickerId,viewId:this.viewId}),d.length||u.length){const f={render:d,sp:u};this._post(f)}e.workId&&this.workShapes.delete(e.workId)}}removeWork(e){const{workId:t}=e,r=t==null?void 0:t.toString();if(r){const s=this.removeNode(r);s&&this._post({render:[{rect:s,isClear:!0,isFullWork:!0,clearCanvas:N.Bg,drawCanvas:N.Bg,viewId:this.viewId}]})}}removeNode(e){var t;this.workShapes.has(e)&&this.clearWorkShapeNodeCache(e);let r;const s=this.vNodes.get(e);return s&&(this.fullLayer.getElementsByName(e).concat(((t=this.drawLayer)==null?void 0:t.getElementsByName(e))||[]).forEach(i=>{i.remove()}),r=j(r,s.rect),this.vNodes.delete(e)),r}async checkTextActive(e){const{op:t,viewId:r,dataType:s}=e;if(t!=null&&t.length){let i;for(const n of this.vNodes.curNodeMap.values()){const{rect:a,name:l,toolsType:c,opt:h}=n,d=t[0]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],u=t[1]*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1];if(c===g.Text&&_u([d,u],a)&&h.workState===E.Done){i=l;break}}i&&(await this.blurSelector({viewId:r,msgType:v.Select,dataType:s,isSync:!0}),await this._post({sp:[{type:v.GetTextActive,toolsType:g.Text,workId:i}]}))}}async colloctEffectSelectWork(e){const t=this.workShapes.get(U.selectorId),{workId:r,msgType:s}=e;if(t&&r&&t.selectIds&&t.selectIds.includes(r.toString())){s===v.RemoveNode?t.selectIds=t.selectIds.filter(i=>i!==r.toString()):this.effectSelectNodeData.add(e),await new Promise(i=>{setTimeout(()=>{i(!0)},0)}),await this.runEffectSelectWork(!0).then(()=>{var i;(i=this.effectSelectNodeData)==null||i.clear()});return}return e}async updateSelector(e){var t;const r=this.workShapes.get(U.selectorId);if(!((t=r==null?void 0:r.selectIds)!=null&&t.length))return;const{callback:s,...i}=e,{updateSelectorOpt:n,willRefreshSelector:a,willSerializeData:l,emitEventType:c,scene:h}=i,d=n.workState,u=await(r==null?void 0:r.updateSelector({updateSelectorOpt:n,selectIds:r.selectIds,vNodes:this.vNodes,willSerializeData:l,worker:this,scene:h})),f=u==null?void 0:u.selectRect,w=new Map;r.selectIds.forEach(P=>{const T=this.vNodes.get(P);if(T){const{toolsType:I,op:b,opt:C}=T;w.set(P,{opt:C,toolsType:I,ops:(b==null?void 0:b.length)&&le(b)||void 0})}});const y=[],m=[];if(a){y.push({isClearAll:!0,isFullWork:!1,clearCanvas:N.Selector,viewId:this.viewId});const P={rect:f,isFullWork:!1,drawCanvas:N.Selector,viewId:this.viewId};n.translate&&c===z.TranslateNode&&d===E.Doing&&(P.translate=n.translate),y.push(P)}const S=s&&s({res:u,workShapeNode:r,param:i,postData:{render:y,sp:m},newServiceStore:w})||{render:y,sp:m};(S.render.length||S.sp.length)&&this._post(S)}async blurSelector(e){var t;const r=this.workShapes.get(U.selectorId),s=r==null?void 0:r.blurSelector();if(this.clearWorkShapeNodeCache(U.selectorId),((t=this.drawLayer)==null?void 0:t.parent).children.forEach(i=>{i.name===U.selectorId&&i.remove()}),s){const i=[];i.push({...s,undoTickerId:e==null?void 0:e.undoTickerId,isSync:e==null?void 0:e.isSync}),await this._post({render:(s==null?void 0:s.rect)&&[{rect:s.rect,drawCanvas:N.Bg,isClear:!0,clearCanvas:N.Bg,isFullWork:!0,viewId:this.viewId}],sp:i})}}reRenderSelector(e=!1){var t;const r=this.workShapes.get(U.selectorId);if(r){if(r&&!((t=r.selectIds)!=null&&t.length))return this.blurSelector();if(this.drawLayer){const s=r.reRenderSelector();s&&this._post({render:[{rect:s,isClear:!0,isFullWork:!1,clearCanvas:N.Selector,drawCanvas:N.Selector,viewId:this.viewId}],sp:[{type:v.Select,selectIds:r.selectIds,selectRect:s,willSyncService:e,viewId:this.viewId,points:r.getChildrenPoints(),textOpt:r.textOpt}]})}}}updateFullSelectWork(e){var t,r,s,i,n,a,l,c;const h=this.workShapes.get(U.selectorId),{selectIds:d}=e;if(!(d!=null&&d.length)){this.blurSelector(e);return}if(!h){!this.setFullWork(e)&&e.workId&&((t=this.tmpWorkShapeNode)==null?void 0:t.toolsType)===g.Selector&&this.setTmpWorkId(e.workId),this.updateFullSelectWork(e);return}if(h&&d!=null&&d.length){const{bgRect:u,selectRect:f}=h.updateSelectIds(d),w={render:[],sp:[]};u&&((r=w.render)==null||r.push({rect:J(u),isClear:!0,isFullWork:!0,clearCanvas:N.Bg,drawCanvas:N.Bg,viewId:this.viewId})),(s=w.render)==null||s.push({rect:f,isClear:!0,isFullWork:!1,clearCanvas:N.Selector,drawCanvas:N.Selector,viewId:this.viewId}),(c=w.sp)==null||c.push({...e,selectorColor:((i=e.opt)==null?void 0:i.strokeColor)||h.selectorColor,strokeColor:((n=e.opt)==null?void 0:n.strokeColor)||h.strokeColor,fillColor:((a=e.opt)==null?void 0:a.fillColor)||h.fillColor,textOpt:((l=e.opt)==null?void 0:l.textOpt)||h.textOpt,canTextEdit:h.canTextEdit,canRotate:h.canRotate,scaleType:h.scaleType,type:v.Select,selectRect:f,points:h.getChildrenPoints(),willSyncService:(e==null?void 0:e.willSyncService)||!1,opt:(e==null?void 0:e.willSyncService)&&h.getWorkOptions()||void 0,canLock:h.canLock,isLocked:h.isLocked,toolsTypes:h.toolsTypes,shapeOpt:h.shapeOpt}),this._post(w)}}destroy(){super.destroy(),this.effectSelectNodeData.clear(),this.batchEraserWorks.clear(),this.batchEraserRemoveNodes.clear()}drawPencilCombine(e){var t,r;const s=(t=this.workShapes.get(e))==null?void 0:t.combineConsume();if(s){const i={render:[],drawCount:this.drawCount};(r=i.render)==null||r.push({rect:(s==null?void 0:s.rect)&&J(s.rect),isClear:!0,drawCanvas:N.Float,clearCanvas:N.Float,isFullWork:!1,viewId:this.viewId}),this._post(i)}}drawSelector(e,t){var r,s;const i={render:[],sp:[e]};e.type===v.Select&&!t&&((r=i.render)==null||r.push({rect:e.selectRect,drawCanvas:N.Selector,isClear:!0,clearCanvas:N.Selector,isFullWork:!1,viewId:this.viewId},{rect:e.rect&&J(e.rect),isClear:!0,clearCanvas:N.Float,isFullWork:!1,viewId:this.viewId},{rect:e.rect&&J(e.rect),drawCanvas:N.Bg,isClear:!0,clearCanvas:N.Bg,isFullWork:!0,viewId:this.viewId})),t&&((s=i.render)==null||s.push({rect:e.rect&&J(e.rect),drawCanvas:N.Float,isClear:!0,clearCanvas:N.Float,isFullWork:!1,viewId:this.viewId},{rect:e.rect&&J(e.rect),drawCanvas:N.Bg,isClear:!0,clearCanvas:N.Bg,isFullWork:!0,viewId:this.viewId})),this._post(i)}async drawEraser(e){var t,r;const s=[];if((t=e.newWorkDatas)!=null&&t.size){for(const i of e.newWorkDatas.values()){const n=i.workId.toString();this.batchEraserWorks.add(n),s.push({type:v.FullWork,workId:n,ops:le(i.op),opt:i.opt,toolsType:i.toolsType,updateNodeOpt:{useAnimation:!1}})}delete e.newWorkDatas}(r=e.removeIds)==null||r.forEach(i=>{this.batchEraserRemoveNodes.add(i)}),s.push(e),this._post({sp:s}),this.batchEraserCombine()}drawPencil(e){this._post({drawCount:this.drawCount,sp:(e==null?void 0:e.op)&&[e]})}drawPencilFull(e,t,r){var s;let i=(r==null?void 0:r.willClear)||(t==null?void 0:t.isOpacity)||!1;!i&&e.rect&&(i=this.vNodes.hasRectIntersectRange(e.rect));const n={drawCount:1/0,render:[{rect:e.rect,drawCanvas:N.Bg,isClear:i,clearCanvas:N.Bg,isFullWork:!0,viewId:this.viewId}],sp:[e]};(s=n.render)==null||s.push({isClearAll:!0,clearCanvas:N.Float,isFullWork:!1,viewId:this.viewId}),this._post(n)}updateBatchEraserCombineNode(e,t){const r=[];let s;for(const i of t.keys())this.fullLayer.getElementsByName(i).forEach(n=>{const a=n.getBoundingClientRect();s=j(s,{x:a.x-ne.SafeBorderPadding,y:a.y-ne.SafeBorderPadding,w:a.width+ne.SafeBorderPadding*2,h:a.height+ne.SafeBorderPadding*2}),n.remove()});return e.forEach(i=>{const n=this.vNodes.get(i);if(n)if(this.fullLayer.getElementsByName(i)[0])s=j(s,n.rect);else{const a=this.setFullWork({...n,workId:i}),l=a&&a.consumeService({op:n.op,isFullWork:!0});l&&(n.rect=l,s=j(s,l))}}),s&&r.push({rect:s,isClear:!0,isFullWork:!0,clearCanvas:N.Bg,drawCanvas:N.Bg,viewId:this.viewId}),r}async runEffectSelectWork(e){var t,r,s,i;for(const n of this.effectSelectNodeData.values()){const a=this.setFullWork(n);if(a){if(a.toolsType===g.Image)await a.consumeServiceAsync({scene:(r=(t=this.drawLayer)==null?void 0:t.parent)==null?void 0:r.parent,isFullWork:!1,replaceId:(s=a.getWorkId())==null?void 0:s.toString()});else{const l=n.ops&&Je(n.ops);a.consumeService({op:l,isFullWork:!1,replaceId:(i=a.getWorkId())==null?void 0:i.toString()})}n!=null&&n.updateNodeOpt&&a.updataOptService(n.updateNodeOpt),n.workId&&this.workShapes.delete(n.workId)}}this.reRenderSelector(e)}cursorHover(e){var t;const{opt:r,toolsType:s,point:i}=e,n=this.setFullWork({workId:tt,toolsType:s,opt:r});if(n&&i){const a=n.cursorHover(i),l={render:[]};a&&a.type===v.CursorHover&&((t=l.render)==null||t.push({rect:a.rect&&J(a.rect),isClear:!0,clearCanvas:N.Bg,drawCanvas:N.Bg,isFullWork:!0,viewId:this.viewId}),this._post(l))}}}class sf{constructor(e){Object.defineProperty(this,"viewId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vNodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workShapes",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"selectorWorkShapes",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"animationId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"willRunEffectSelectorIds",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"runEffectId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"noAnimationRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"post",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.viewId=e.viewId,this.vNodes=e.vNodes,this.fullLayer=e.fullLayer,this.drawLayer=e.drawLayer,this.post=e.post}destroy(){this.workShapes.clear(),this.selectorWorkShapes.clear(),this.willRunEffectSelectorIds.clear()}consumeDraw(e){this.activeWorkShape(e),this.runAnimation()}consumeFull(e){this.activeWorkShape(e),this.runAnimation()}clearAllWorkShapesCache(){this.workShapes.forEach((e,t)=>{e.toolsType===g.LaserPen?setTimeout(()=>{this.workShapes.delete(t)},2e3):this.workShapes.delete(t)})}runSelectWork(e){this.activeSelectorShape(e);const{workId:t}=e,r=t==null?void 0:t.toString();r&&this.willRunEffectSelectorIds.add(r),this.runEffect()}setNodeKey(e,t,r){return e.toolsType=t,e.node=kt({toolsType:t,toolsOpt:r,vNodes:this.vNodes,fullLayer:this.fullLayer,drawLayer:this.drawLayer},this),e}runReverseSelectWork(e){e.forEach(t=>{this.selectorWorkShapes.forEach((r,s)=>{var i;if((i=r.selectIds)!=null&&i.length){const n=r.selectIds.indexOf(t);n>-1&&(r.selectIds.splice(n,1),this.willRunEffectSelectorIds.add(s))}})}),this.willRunEffectSelectorIds.size&&this.runEffect()}removeWork(e){const{workId:t}=e,r=t==null?void 0:t.toString();if(r){const s=this.workShapes.get(r);if(s){this.workShapes.delete(r),this.removeNode(r,e,s==null?void 0:s.totalRect,!1);return}this.removeNode(r,e)}}removeSelectWork(e){const{workId:t}=e,r=t==null?void 0:t.toString();r&&(this.activeSelectorShape(e),this.willRunEffectSelectorIds.add(r)),this.runEffect()}removeNode(e,t,r,s=!0){var i;const n=this.fullLayer.getElementsByName(e).concat(this.drawLayer.getElementsByName(e));e.indexOf(U.selectorId)>-1&&this.removeSelectWork(t);const a=[];let l=r;const c=(i=this.vNodes.get(e))==null?void 0:i.rect;c&&(l=j(c,l)),n.forEach(h=>{a.push(h)}),a.length&&a.forEach(h=>h.remove()),l&&(this.post({render:[{rect:J(l),isClear:!0,isFullWork:s,clearCanvas:s?N.Bg:N.Float,drawCanvas:s?N.Bg:N.Float,viewId:this.viewId}]}),this.vNodes.delete(e))}activeWorkShape(e){var t,r,s,i;const{workId:n,opt:a,toolsType:l,type:c,updateNodeOpt:h,ops:d,op:u,useAnimation:f}=e;if(!n)return;const w=n.toString();if(!((t=this.workShapes)!=null&&t.has(w))){let m={toolsType:l,animationWorkData:u||[],animationIndex:0,type:c,updateNodeOpt:h,ops:d,useAnimation:typeof f<"u"?f:typeof(h==null?void 0:h.useAnimation)<"u"?h==null?void 0:h.useAnimation:!0,oldRect:(r=this.vNodes.get(w))==null?void 0:r.rect,isDiff:!1};l&&a&&(m=this.setNodeKey(m,l,a)),(s=this.workShapes)==null||s.set(w,m)}const y=(i=this.workShapes)==null?void 0:i.get(w);c&&(y.type=c),d&&(y.animationWorkData=Je(d),y.ops=d),h&&(y.updateNodeOpt=h),u&&(y.isDiff=this.hasDiffData(y.animationWorkData||[],u,y.toolsType),y.animationWorkData=u),y.node&&y.node.getWorkId()!==w&&y.node.setWorkId(w),l&&a&&(y.toolsType!==l&&l&&a&&this.setNodeKey(y,l,a),y.node&&y.node.setWorkOptions(a))}hasDiffData(e,t,r){const s=e.length;if(t.length<s)return!0;switch(r){case g.Pencil:{for(let i=0;i<s;i+=3)if(t[i]!==e[i]||t[i+1]!==e[i+1])return!0;break}case g.LaserPen:{for(let i=0;i<s;i+=2)if(t[i]!==e[i]||t[i+1]!==e[i+1])return!0;break}}return!1}async animationDraw(){var e,t,r,s,i,n,a,l,c,h,d,u,f,w,y,m,S,P,T,I,b,C,L,O,R,A,B,G,K,re;this.animationId=void 0;let oe=!1;const de=new Map,Ce=[],Ne=[],Le=[],We=[];for(const[D,x]of this.workShapes.entries())switch(x.toolsType){case g.Image:{const F=x.oldRect;F&&Le.push({rect:F,isClear:!0,clearCanvas:N.Bg,viewId:this.viewId});const Q=await((t=x.node)==null?void 0:t.consumeServiceAsync({isFullWork:!0,scene:(e=this.fullLayer.parent)==null?void 0:e.parent}));this.selectorWorkShapes.forEach((Z,H)=>{var ee;(ee=Z.selectIds)!=null&&ee.includes(D)&&(this.willRunEffectSelectorIds.add(H),this.noAnimationRect=j(this.noAnimationRect,F),this.noAnimationRect=j(this.noAnimationRect,Q),this.runEffect())}),this.workShapes.delete(D),Ce.push({rect:Q,drawCanvas:N.Bg,isFullWork:!0,viewId:this.viewId});break}case g.Text:{if(x.node){const F=x.oldRect,Q=(r=x.node)==null?void 0:r.consumeService({op:x.animationWorkData||[],isFullWork:!0});this.selectorWorkShapes.forEach((Z,H)=>{var ee;(ee=Z.selectIds)!=null&&ee.includes(D)&&(this.willRunEffectSelectorIds.add(H),this.noAnimationRect=j(this.noAnimationRect,F),this.noAnimationRect=j(this.noAnimationRect,Q),this.runEffect())}),(s=x.node)==null||s.clearTmpPoints(),this.workShapes.delete(D)}break}case g.Arrow:case g.Straight:case g.Rectangle:case g.Ellipse:case g.Star:case g.Polygon:case g.SpeechBalloon:{const F=!!x.ops;if((i=x.animationWorkData)!=null&&i.length){const Q=x.oldRect,Z=x.node.oldRect;Q&&Le.push({rect:Q,isClear:!0,clearCanvas:N.Bg,viewId:this.viewId}),Z&&We.push({rect:Z,isClear:!0,clearCanvas:N.Float,viewId:this.viewId});const H=(n=x.node)==null?void 0:n.consumeService({op:x.animationWorkData,isFullWork:F});de.set(D,{workState:Q?x.ops?E.Done:E.Doing:E.Start,op:x.animationWorkData.filter((ee,fe)=>{if(fe%3!==2)return!0}).slice(-2)}),F?(this.selectorWorkShapes.forEach((ee,fe)=>{var rt;(rt=ee.selectIds)!=null&&rt.includes(D)&&(this.willRunEffectSelectorIds.add(fe),this.noAnimationRect=j(this.noAnimationRect,Q),this.noAnimationRect=j(this.noAnimationRect,Z),this.noAnimationRect=j(this.noAnimationRect,H),this.runEffect())}),(a=x.node)==null||a.clearTmpPoints(),this.workShapes.delete(D),Ce.push({rect:H,drawCanvas:N.Bg,isFullWork:F,viewId:this.viewId}),de.set(D,{workState:E.Done,op:x.animationWorkData.filter((ee,fe)=>{if(fe%3!==2)return!0}).slice(-2)})):Ne.push({rect:H,drawCanvas:N.Float,isFullWork:F,viewId:this.viewId}),x.animationWorkData.length=0}break}case g.Pencil:{if(!x.useAnimation&&x.ops){let F=(l=x.node)==null?void 0:l.consumeService({op:x.animationWorkData||[],isFullWork:!0,replaceId:D});const Q=(c=x.node)==null?void 0:c.updataOptService(x.updateNodeOpt);F=j(F,Q),Le.push({rect:j(x.oldRect,F),clearCanvas:N.Bg,viewId:this.viewId}),Ce.push({rect:j(x.oldRect,F),drawCanvas:N.Bg,viewId:this.viewId}),this.selectorWorkShapes.forEach((Z,H)=>{var ee;(ee=Z.selectIds)!=null&&ee.includes(D)&&(this.willRunEffectSelectorIds.add(H),this.noAnimationRect=j(this.noAnimationRect,F),this.runEffect())}),(h=x.node)==null||h.clearTmpPoints(),this.workShapes.delete(D)}else if(x.useAnimation){const F=this.computNextAnimationIndex(x,3),Q=x.isDiff?0:Math.max(0,(x.animationIndex||0)-3),Z=(x.animationWorkData||[]).slice(Q,F);if(x.isDel)x.isDel&&((P=x.node)==null||P.clearTmpPoints(),this.workShapes.delete(D));else{if((x.animationIndex||0)<F||x.isDiff){const H=(u=x.node)==null?void 0:u.consumeService({op:Z,isFullWork:!1,replaceId:(d=x.node.getWorkId())==null?void 0:d.toString()});if(Ne.push({rect:H,drawCanvas:N.Float,viewId:this.viewId}),x.animationIndex=F,x.isDiff&&(x.isDiff=!1),Z.length){const ee=Z.filter((fe,rt)=>{if(rt%3!==2)return!0}).slice(-2);de.set(D,{workState:Q===0?E.Start:F===((f=x.animationWorkData)==null?void 0:f.length)?E.Done:E.Doing,op:ee})}}else if(x.ops){const H=(y=x.node)==null?void 0:y.consumeService({op:x.animationWorkData||[],isFullWork:!0,replaceId:(w=x.node.getWorkId())==null?void 0:w.toString()});x.isDel=!0,We.push({rect:H,clearCanvas:N.Float,viewId:this.viewId}),(m=x.node)!=null&&m.getWorkOptions().isOpacity&&Le.push({rect:H,clearCanvas:N.Bg,viewId:this.viewId}),Ce.push({rect:H,drawCanvas:N.Bg,viewId:this.viewId}),this.vNodes.setInfo(D,{op:x.animationWorkData,opt:(S=x.node)==null?void 0:S.getWorkOptions(),toolsType:x.toolsType,rect:H}),de.set(D,{workState:E.Done,op:Z.filter((ee,fe)=>{if(fe%3!==2)return!0}).slice(-2)})}oe=!0}break}break}case g.LaserPen:{const F=this.computNextAnimationIndex(x,2),Q=Math.max(0,(x.animationIndex||0)-2),Z=(x.animationWorkData||[]).slice(Q,F);if(x.isDel){if(x.isDel){const H=(O=x.node)==null?void 0:O.consumeService({op:[],isFullWork:!1});x.totalRect=j(x.totalRect,H),We.push({rect:x.totalRect,clearCanvas:N.Float,viewId:this.viewId}),Ne.push({rect:x.totalRect,drawCanvas:N.Float,viewId:this.viewId}),(R=x.node)==null||R.clearTmpPoints(),this.workShapes.delete(D)}}else{if((x.animationIndex||0)<F){const H=(I=x.node)==null?void 0:I.consumeService({op:Z,isFullWork:!1,replaceId:(T=x.node.getWorkId())==null?void 0:T.toString()});x.totalRect=j(x.totalRect,H),x.timer&&(clearTimeout(x.timer),x.timer=void 0),x.animationIndex=F,Z.length&&de.set(D,{workState:Q===0?E.Start:F===((b=x.animationWorkData)==null?void 0:b.length)?E.Done:E.Doing,op:Z.slice(-2)})}else{x.timer||(x.timer=setTimeout(()=>{x.timer=void 0,x.isDel=!0,this.runAnimation()},((C=x.node)==null?void 0:C.getWorkOptions()).duration*1e3+100),de.set(D,{workState:E.Done,op:[]}));const H=(L=x.node)==null?void 0:L.consumeService({op:[],isFullWork:!1});x.totalRect=j(x.totalRect,H)}We.push({rect:x.totalRect,clearCanvas:N.Float,viewId:this.viewId}),Ne.push({rect:x.totalRect,drawCanvas:N.Float,viewId:this.viewId}),oe=!0}break}}oe&&this.runAnimation();const pe={render:[]};if(Le.length){const D=Le.reduce((x,F)=>(F.rect&&F.clearCanvas===N.Bg&&(x.rect=j(x.rect,F.rect)),x),{isClear:!0,clearCanvas:N.Bg,viewId:this.viewId});D.rect&&(D.rect=D.rect&&J(D.rect),(A=pe.render)==null||A.push(D))}if(We.length){const D=We.reduce((x,F)=>(F.rect&&F.clearCanvas===N.Float&&(x.rect=j(x.rect,F.rect)),x),{isClear:!0,clearCanvas:N.Float,viewId:this.viewId});D.rect&&(D.rect=D.rect&&J(D.rect),(B=pe.render)==null||B.push(D))}if(Ce.length){const D=Ce.reduce((x,F)=>(F.rect&&F.drawCanvas===N.Bg&&(x.rect=j(x.rect,F.rect)),x),{isFullWork:!0,drawCanvas:N.Bg,viewId:this.viewId});D.rect&&(D.rect=D.rect&&J(D.rect),(G=pe.render)==null||G.push(D))}if(Ne.length){const D=Ne.reduce((x,F)=>(F.rect&&F.drawCanvas===N.Float&&(x.rect=j(x.rect,F.rect)),x),{isFullWork:!1,drawCanvas:N.Float,viewId:this.viewId});D.rect&&(D.rect=D.rect&&J(D.rect),(K=pe.render)==null||K.push(D))}de.size&&(pe.sp=[],de.forEach((D,x)=>{var F;(F=pe.sp)==null||F.push({type:v.Cursor,uid:x.split(Hu)[0],op:D.op,workState:D.workState,viewId:this.viewId})})),(re=pe.render)!=null&&re.length&&this.post(pe)}runAnimation(){this.animationId||(this.animationId=requestAnimationFrame(this.animationDraw.bind(this)))}computNextAnimationIndex(e,t){var r;const s=Math.floor((e.animationWorkData||[]).slice(e.animationIndex).length*32/t/(((r=e.node)==null?void 0:r.syncUnitTime)||1e3))*t;return Math.min((e.animationIndex||0)+(s||t),(e.animationWorkData||[]).length)}runEffect(){this.runEffectId||(this.runEffectId=setTimeout(this.effectRunSelector.bind(this),0))}effectRunSelector(){this.runEffectId=void 0;let e=this.noAnimationRect;this.willRunEffectSelectorIds.forEach(t=>{var r,s;const i=this.selectorWorkShapes.get(t),n=i&&i.selectIds&&((r=i.node)==null?void 0:r.selectServiceNode(t,i,!0));e=j(e,n),(s=i==null?void 0:i.selectIds)!=null&&s.length||this.selectorWorkShapes.delete(t)}),e&&this.post({render:[{rect:J(e),drawCanvas:N.Bg,isClear:!0,clearCanvas:N.Bg,isFullWork:!0,viewId:this.viewId}]}),this.willRunEffectSelectorIds.clear(),this.noAnimationRect=void 0}activeSelectorShape(e){var t,r,s;const{workId:i,opt:n,toolsType:a,type:l,selectIds:c}=e;if(!i)return;const h=i.toString();if(!((t=this.selectorWorkShapes)!=null&&t.has(h))){let u={toolsType:a,selectIds:c,type:l,opt:n};a&&n&&(u=this.setNodeKey(u,a,n)),(r=this.selectorWorkShapes)==null||r.set(h,u)}const d=(s=this.selectorWorkShapes)==null?void 0:s.get(h);l&&(d.type=l),d.node&&d.node.getWorkId()!==h&&d.node.setWorkId(h),d.selectIds=c||[]}}class nf extends io{constructor(e){super(e),Object.defineProperty(this,"animationWorkRects",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"combineDrawTimer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"animationId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"closeAnimationTime",{enumerable:!0,configurable:!0,writable:!0,value:1100}),Object.defineProperty(this,"runLaserPenStep",{enumerable:!0,configurable:!0,writable:!0,value:0})}async runFullWork(e,t){var r,s;const i=this.setFullWork(e),n=e.ops&&Je(e.ops);if(i){let a;i.toolsType===g.Image?a=await i.consumeServiceAsync({isFullWork:!0,scene:(r=this.fullLayer.parent)==null?void 0:r.parent}):a=i.consumeService({op:n,isFullWork:!0,replaceId:(s=i.getWorkId())==null?void 0:s.toString(),isDrawLabel:t});const l=(e==null?void 0:e.updateNodeOpt)&&i.updataOptService(e.updateNodeOpt);return e.workId&&this.workShapes.delete(e.workId),l||a}}runSelectWork(e){var t;const r=this.setFullWork(e);r&&(t=e.selectIds)!=null&&t.length&&e.workId&&r.selectServiceNode(e.workId.toString(),{selectIds:e.selectIds},!1)}consumeDraw(e){var t;const{op:r,workId:s}=e;if(r!=null&&r.length&&s){const i=this.workShapes.get(s);if(!i)return;const n=i.toolsType,a=i.consume({data:e,isFullWork:!1,isClearAll:!0,isSubWorker:!0});switch(n){case g.LaserPen:a!=null&&a.rect&&((t=this.animationWorkRects)==null||t.set(s,{res:a,canDel:!1,isRect:!0})),this.runLaserPenAnimation();break;case g.Arrow:case g.Straight:case g.Ellipse:case g.Rectangle:case g.Star:case g.Polygon:case g.SpeechBalloon:a&&(this.drawCount++,this.drawArrow(a));break;case g.Pencil:a&&(this.drawCount++,this.drawPencil(a));break}}}consumeDrawAll(e){var t,r;const{workId:s}=e;if(s){const i=this.workShapes.get(s);if(!i)return;switch(i.toolsType){case g.LaserPen:if(this.animationId){const n=i.consumeAll({data:e});n!=null&&n.op&&n!=null&&n.rect&&((t=this.animationWorkRects)==null||t.set(s,{res:n,canDel:!1,isRect:!0}),this.runLaserPenAnimation(n));const a=(r=i.getWorkOptions())==null?void 0:r.duration;this.closeAnimationTime=a?a*1e3+100:this.closeAnimationTime,setTimeout(()=>{var l;this.fullLayer.getElementsByName(s.toString()).map(h=>h.remove()),this.clearWorkShapeNodeCache(s);const c=(l=this.animationWorkRects)==null?void 0:l.get(s);c&&(c.canDel=!0),setTimeout(()=>{this._post({sp:[{removeIds:[s.toString()],type:v.RemoveNode}]})},i.getWorkOptions().syncUnitTime||this.closeAnimationTime)},this.closeAnimationTime)}break;case g.Arrow:case g.Straight:case g.Ellipse:case g.Pencil:case g.Rectangle:case g.Star:case g.Polygon:case g.SpeechBalloon:this.drawCount=0,this.fullLayer.removeAllChildren(),this.clearWorkShapeNodeCache(s);break}}}updateLabels(e,t){e.children.forEach(r=>{if(r.tagName==="LABEL"){const s=r.name,{width:i}=r.getBoundingClientRect(),[n]=e.worldScaling,{underline:a,lineThrough:l}=t.opt;a&&e.getElementsByName(`${s}_underline`)[0].attr({points:[0,0,i/n,0]}),l&&e.getElementsByName(`${s}_lineThrough`)[0].attr({points:[0,0,i/n,0]})}})}runLaserPenAnimation(e){this.animationId||(this.animationId=requestAnimationFrame(()=>{var t,r;if(this.animationId=void 0,this.runLaserPenStep++,this.runLaserPenStep>1){this.runLaserPenStep=0,this.runLaserPenAnimation(e);return}let s;const i=[];(t=this.animationWorkRects)==null||t.forEach((n,a,l)=>{n.isRect&&(s=j(s,n.res.rect)),n.res.workId&&i.push(n.res),this.fullLayer.getElementsByName(a.toString()).length?n.isRect=!0:n.isRect=!1,n.canDel&&l.delete(a)}),(r=this.animationWorkRects)!=null&&r.size&&this.runLaserPenAnimation(),s&&(e&&i.push(e),this._post({render:[{rect:J(s),drawCanvas:N.Float,isClear:!0,clearCanvas:N.Float,isFullWork:!1,viewId:this.viewId}],sp:i}))}))}drawPencil(e){this._post({drawCount:this.drawCount,render:[{rect:e==null?void 0:e.rect,drawCanvas:N.Float,isClear:!1,isFullWork:!1,viewId:this.viewId}],sp:(e==null?void 0:e.op)&&[e]})}drawArrow(e){this._post({drawCount:this.drawCount,render:[{rect:(e==null?void 0:e.rect)&&J(e.rect),drawCanvas:N.Float,isClear:!0,clearCanvas:N.Float,isFullWork:!1,viewId:this.viewId}]})}}var Be;(function(o){o.Full="full",o.Sub="sub"})(Be||(Be={}));class af{constructor(e,t){Object.defineProperty(this,"_self",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workThreadMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),this._self=e,this.type=t,this.register()}init(e){const{viewId:t,dpr:r,offscreenCanvasOpt:s,layerOpt:i,isSafari:n}=e;if(!r||!s||!i)return;let a;this.type===Be.Full&&(a=new lf(t,{dpr:r,offscreenCanvasOpt:s,layerOpt:i},this.post.bind(this))),this.type===Be.Sub&&(a=new cf(t,{dpr:r,offscreenCanvasOpt:s,layerOpt:i},this.post.bind(this))),a&&n&&a.setIsSafari(n),a&&e.cameraOpt&&a.setCameraOpt(e.cameraOpt),a&&this.workThreadMap.set(t,a)}register(){onmessage=e=>{const t=e.data;if(t)for(const r of t.values()){const{msgType:s,viewId:i,tasksqueue:n,mainTasksqueueCount:a}=r;if(s===v.Init){this.init(r);continue}if(s===v.TasksQueue&&n!=null&&n.size&&a){this.workThreadMap.forEach((c,h)=>{const d=n.get(h);d&&c.on(d),this.post({workerTasksqueueCount:a})});continue}if(i===Zu){this.workThreadMap.forEach(c=>{c.on(r),s===v.Destroy&&this.workThreadMap.delete(i)});continue}const l=this.workThreadMap.get(i);l&&(l.on(r),s===v.Destroy&&this.workThreadMap.delete(i))}}}post(e,t){t?this._self.postMessage(e,t):this._self.postMessage(e)}}class lf extends so{constructor(e,t,r){super(e,t),Object.defineProperty(this,"drawLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"snapshotFullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"methodBuilder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serviceWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_post",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._post=r,this.drawLayer=this.createLayer("drawLayer",this.scene,{...t.layerOpt,bufferSize:1e3});const s={thread:this,viewId:this.viewId,vNodes:this.vNodes,fullLayer:this.fullLayer,drawLayer:this.drawLayer,post:this.post.bind(this)};this.localWork=new of(s),this.serviceWork=new sf(s),this.methodBuilder=new bp([z.CopyNode,z.SetColorNode,z.DeleteNode,z.RotateNode,z.ScaleNode,z.TranslateNode,z.ZIndexActive,z.ZIndexNode,z.SetFontStyle,z.SetPoint,z.SetLock,z.SetShapeOpt]).registerForWorker(this.localWork,this.serviceWork,this.scene),this.vNodes.init(this.fullLayer,this.drawLayer)}async post(e,t){var r,s,i;const n=e.render,a=[];let l=t;if(n!=null&&n.length){for(const h of n){if(h.isClearAll&&(h.rect=this.getSceneRect(),h.isClear=!0,delete h.isClearAll),h.isDrawAll&&(h.rect=this.getSceneRect(),delete h.isDrawAll),h.drawCanvas){const d=h.isFullWork?this.fullLayer:this.drawLayer;(d==null?void 0:d.parent).render()}if(h.rect){h.clearCanvas===h.drawCanvas&&h.drawCanvas===N.Bg&&(h.rect=this.checkRightRectBoundingBox(h.rect));const d=h.drawCanvas===N.Selector&&h.rect;if(h.rect=this.safariFixRect(te(h.rect)),!h.rect)continue;if(h.drawCanvas===N.Selector){const u=(r=e.sp)==null?void 0:r.find(f=>f.type===v.Select);u&&(u.rect=h.rect),d&&(h.offset={x:h.rect.x-d.x,y:h.rect.y-d.y})}if(h.drawCanvas){const u=await this.getRectImageBitmap(h.rect,!!h.isFullWork);h.imageBitmap=u,l||(l=[]),l.push(u)}a.push(h)}}e.render=a}const c=(s=e.sp)==null?void 0:s.filter(h=>h.type!==v.None||Object.keys(h).filter(d=>d==="type").length);if(c!=null&&c.length&&(e.sp=c.map(h=>({...h,viewId:this.viewId}))),(e.drawCount||e.workerTasksqueueCount||(i=e.sp)!=null&&i.length||a!=null&&a.length)&&(this._post(e,l),l!=null&&l.length))for(const h of l)h instanceof ImageBitmap&&h.close()}on(e){if(this.methodBuilder.consumeForWorker(e))return;const{msgType:t,dataType:r,workId:s}=e;switch(t){case v.UpdateCamera:this.updateCamera(e);break;case v.Select:r===M.Service&&(s===U.selectorId?this.localWork.updateFullSelectWork(e):this.serviceWork.runSelectWork(e));break;case v.UpdateNode:case v.FullWork:this.consumeFull(r,e);break;case v.RemoveNode:this.removeNode(e);break;case v.GetTextActive:this.checkTextActive(e);break;case v.CursorHover:this.cursorHover(e)}super.on(e)}async removeNode(e){const{dataType:t,workId:r}=e;if(r===U.selectorId){this.localWork.blurSelector(e);return}t===M.Local&&(this.localWork.removeWork(e),this.localWork.colloctEffectSelectWork(e)),t===M.Service&&(this.serviceWork.removeWork(e),this.localWork.colloctEffectSelectWork(e))}checkTextActive(e){const{dataType:t}=e;t===M.Local&&this.localWork.checkTextActive(e)}clearAll(){this.vNodes.clear(),super.clearAll(),this.post({render:[{isClearAll:!0,clearCanvas:N.Bg,isFullWork:!0,viewId:this.viewId},{isClearAll:!0,clearCanvas:N.Float,isFullWork:!1,viewId:this.viewId}],sp:[{type:v.Clear}]})}setCameraOpt(e){this.cameraOpt=e;const{scale:t,centerX:r,centerY:s,width:i,height:n}=e;(i!==this.scene.width||n!==this.scene.height)&&this.updateScene({width:i,height:n}),this.fullLayer&&(this.fullLayer.setAttribute("scale",[t,t]),this.fullLayer.setAttribute("translate",[-r,-s])),this.drawLayer&&(this.drawLayer.setAttribute("scale",[t,t]),this.drawLayer.setAttribute("translate",[-r,-s]))}getOffscreen(e){return(e?this.fullLayer.parent:this.drawLayer.parent).canvas}async consumeFull(e,t){const r=await this.localWork.colloctEffectSelectWork(t);r&&e===M.Local&&await this.localWork.consumeFull(r,this.scene),r&&e===M.Service&&this.serviceWork.consumeFull(r)}consumeDraw(e,t){e===M.Local&&this.localWork.consumeDraw(t,this.serviceWork),e===M.Service&&this.serviceWork.consumeDraw(t)}consumeDrawAll(e,t){e===M.Local&&this.localWork.consumeDrawAll(t,this.serviceWork)}updateCamera(e){var t;const r=[],{cameraOpt:s}=e;if(s&&(this.setCameraOpt(s),this.localWork.workShapes.forEach((i,n)=>{(i.toolsType===g.Pencil||i.toolsType===g.Arrow||i.toolsType===g.Straight||i.toolsType===g.Ellipse||i.toolsType===g.Rectangle||i.toolsType===g.Star||i.toolsType===g.Polygon||i.toolsType===g.SpeechBalloon||i.toolsType===g.Text)&&this.localWork.workShapeState.set(n,{willClear:!0})}),this.vNodes.curNodeMap.size)){if(this.vNodes.updateNodesRect(),this.localWork.reRenderSelector(),this.serviceWork.selectorWorkShapes.size)for(const[a,l]of this.serviceWork.selectorWorkShapes.entries())this.serviceWork.runSelectWork({workId:a,selectIds:l.selectIds,msgType:v.Select,dataType:M.Service,viewId:this.viewId});let i;const n=this.localWork.getWorkShape(tt);if(n&&(t=n.selectIds)!=null&&t.length&&(i=n.oldSelectRect,n.cursorBlur()),this.vNodes.hasRenderNodes()){r.push({isClearAll:!0,clearCanvas:N.Bg,isFullWork:!0,viewId:this.viewId},{isClearAll:!0,clearCanvas:N.Float,isFullWork:!1,viewId:this.viewId});for(const a of this.vNodes.curNodeMap.values())Wr(a.toolsType)&&(i=j(i,a.rect));i&&r.push({rect:J(i,20),drawCanvas:N.Bg,isClear:!1,isFullWork:!0,viewId:this.viewId})}r.length&&this.post({render:r})}}getRectImageBitmap(e,t){const r=e.x*this.dpr,s=e.y*this.dpr,i=e.w*this.dpr,n=e.h*this.dpr;return createImageBitmap(this.getOffscreen(t),r,s,i,n)}safariFixRect(e){if(e.w+e.x<=0||e.h+e.y<=0||e.w<=0||e.h<=0)return;const t={x:0,y:0,w:Math.floor(this.scene.width),h:Math.floor(this.scene.height)};if(e.x<0?e.w+e.x<this.scene.width&&(t.w=e.w+e.x):e.w+e.x>0&&(t.x=e.x,t.w=Math.floor(this.scene.width-e.x)),e.y<0?e.h+e.y<this.scene.height&&(t.h=e.h+e.y):e.h+e.y>0&&(t.y=e.y,t.h=Math.floor(this.scene.height-e.y)),!(t.w<=0||t.h<=0))return t}getSceneRect(){const{width:e,height:t}=this.scene;return{x:0,y:0,w:Math.floor(e),h:Math.floor(t)}}checkRightRectBoundingBox(e){return this.vNodes.combineIntersectRect(e)}cursorHover(e){this.localWork.cursorHover(e)}}class cf extends so{constructor(e,t,r){super(e,t),Object.defineProperty(this,"_post",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"snapshotFullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serviceWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._post=r;const s={thread:this,viewId:this.viewId,vNodes:this.vNodes,fullLayer:this.fullLayer,drawLayer:this.drawLayer,post:this.post.bind(this)};this.localWork=new nf(s),this.vNodes.init(this.fullLayer,this.drawLayer)}async post(e,t){var r,s;const i=e.render,n=[];let a=t;if(i!=null&&i.length){for(const c of i)if(c.drawCanvas&&this.fullLayer.parent.render(),c.rect){if(c.rect=this.safariFixRect(te(c.rect)),!c.rect)continue;if(c.drawCanvas){const h=await this.getRectImageBitmap(c.rect,!!c.isFullWork);c.imageBitmap=h,a||(a=[]),a.push(h)}n.push(c)}e.render=n}const l=(r=e.sp)==null?void 0:r.filter(c=>c.type!==v.None||Object.keys(c).filter(h=>h==="type").length);if(l!=null&&l.length&&(e.sp=l.map(c=>({...c,viewId:this.viewId}))),((s=e.sp)!=null&&s.length||e.drawCount||n!=null&&n.length)&&(this._post(e,a),a!=null&&a.length))for(const c of a)c instanceof ImageBitmap&&c.close()}on(e){const{msgType:t}=e;switch(t){case v.UpdateCamera:this.updateCamera(e);break;case v.Snapshot:this.snapshotFullLayer=this.createLayer("snapshotFullLayer",this.scene,{...this.opt.layerOpt,bufferSize:this.viewId==="mainView"?6e3:3e3}),this.snapshotFullLayer&&this.getSnapshot(e).then(()=>{this.snapshotFullLayer=void 0});break;case v.BoundingBox:this.snapshotFullLayer=this.createLayer("snapshotFullLayer",this.scene,{...this.opt.layerOpt,bufferSize:this.viewId==="mainView"?6e3:3e3}),this.snapshotFullLayer&&this.getBoundingRect(e).then(()=>{this.snapshotFullLayer=void 0});break}super.on(e)}getOffscreen(e){var t;return(t=(e&&this.snapshotFullLayer||this.fullLayer).parent)==null?void 0:t.canvas}consumeDraw(e,t){e===M.Local&&this.localWork.consumeDraw(t)}consumeDrawAll(e,t){this.localWork.consumeDrawAll(t)}getRectImageBitmap(e,t=!1,r){const s=e.x*this.dpr,i=e.y*this.dpr,n=e.w*this.dpr,a=e.h*this.dpr;return createImageBitmap(this.getOffscreen(t),s,i,n,a,r)}safariFixRect(e){if(e.w+e.x<=0||e.h+e.y<=0||e.w<=0||e.h<=0)return;const t={x:0,y:0,w:Math.floor(this.scene.width),h:Math.floor(this.scene.height)};if(e.x<0?e.w+e.x<this.scene.width&&(t.w=e.w+e.x):e.w+e.x>0&&(t.x=e.x,t.w=Math.floor(this.scene.width-e.x)),e.y<0?e.h+e.y<this.scene.height&&(t.h=e.h+e.y):e.h+e.y>0&&(t.y=e.y,t.h=Math.floor(this.scene.height-e.y)),!(t.w<=0||t.h<=0))return t}updateCamera(e){const{cameraOpt:t}=e;t&&this.setCameraOpt(t)}setCameraOpt(e,t){this.cameraOpt=e;const{scale:r,centerX:s,centerY:i,width:n,height:a}=e;(n!==this.scene.width||a!==this.scene.height)&&this.updateScene({width:n,height:a}),t?(t.setAttribute("scale",[r,r]),t.setAttribute("translate",[-s,-i])):(this.fullLayer.setAttribute("scale",[r,r]),this.fullLayer.setAttribute("translate",[-s,-i]))}async getSnapshot(e){const{scenePath:t,scenes:r,cameraOpt:s,w:i,h:n,maxZIndex:a}=e;if(t&&r&&s&&this.snapshotFullLayer){const l=te(this.cameraOpt);this.setCameraOpt(s,this.snapshotFullLayer),this.localWork.fullLayer=this.snapshotFullLayer,this.localWork.drawLayer=this.fullLayer;let c;const h=new Map;for(const[u,f]of Object.entries(r))if(f!=null&&f.type)switch(f==null?void 0:f.type){case v.UpdateNode:case v.FullWork:{const{toolsType:w,opt:y}=f;w===g.Text&&y&&(y.zIndex=y.zIndex+(a||0),(y.lineThrough||y.underline)&&h.set(u,f));const m=await this.localWork.runFullWork({...f,opt:y,workId:u,msgType:v.FullWork,dataType:M.Service,viewId:this.viewId},w===g.Text);c=j(c,m);break}}this.localWork.fullLayer=this.fullLayer,this.localWork.drawLayer=void 0;let d;i&&n&&(d={resizeWidth:i,resizeHeight:n}),h.size&&(await new Promise(u=>{setTimeout(u,500)}),this.willRenderSpecialLabel(h)),await this.getSnapshotRender({scenePath:t,curCameraOpt:l,options:d})}}willRenderSpecialLabel(e){var t;for(const[r,s]of e.entries()){const i=(t=this.snapshotFullLayer)==null?void 0:t.getElementsByName(r)[0];i&&s.opt&&this.localWork.updateLabels(i,s)}}async getSnapshotRender(e){var t,r;const{scenePath:s,curCameraOpt:i,options:n}=e;((t=this.snapshotFullLayer)==null?void 0:t.parent).render();const a=await this.getRectImageBitmap({x:0,y:0,w:this.scene.width,h:this.scene.height},!0,n);a&&(await this.post({sp:[{type:v.Snapshot,scenePath:s,imageBitmap:a}]},[a]),a.close(),(r=this.snapshotFullLayer)==null||r.removeAllChildren(),this.setCameraOpt(i,this.fullLayer))}async getBoundingRect(e){const{scenePath:t,scenes:r,cameraOpt:s}=e;if(t&&r&&s&&this.snapshotFullLayer){const i=te(this.cameraOpt);this.setCameraOpt(s,this.snapshotFullLayer),this.localWork.fullLayer=this.snapshotFullLayer,this.localWork.drawLayer=this.drawLayer;let n;for(const[a,l]of Object.entries(r))if(l!=null&&l.type)switch(l==null?void 0:l.type){case v.UpdateNode:case v.FullWork:{const c=await this.localWork.runFullWork({...l,workId:a,msgType:v.FullWork,dataType:M.Service,viewId:this.viewId});n=j(n,c);break}}n&&await this.post({sp:[{type:v.BoundingBox,scenePath:t,rect:n}]}),this.localWork.fullLayer=this.fullLayer,this.localWork.drawLayer=void 0,this.snapshotFullLayer.removeAllChildren(),this.setCameraOpt(i,this.fullLayer)}}}const hf=self;new af(hf,Be.Sub)})(spritejs,lzString,lineclip)})();
