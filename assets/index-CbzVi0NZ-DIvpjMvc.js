import{o as q,b as d,$ as H,L as J,E as x,y as A,d as ee,R as W,U as f,e as N,P as T,N as k,z as X,l as R,h as K,G as U,f as j,_,i as Q,j as P,I as M,k as B,w as te,m as Z,n as se,X as V,p as oe,Q as z}from"./index-avFpGiXE.js";var re=Object.defineProperty,ae=(L,e,s)=>e in L?re(L,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):L[e]=s,u=(L,e,s)=>ae(L,typeof e!="symbol"?e+"":e,s);class ie{constructor(e){u(this,"vNodes"),u(this,"thread"),u(this,"serviceWorkShapes",new Map),u(this,"localWorkShapes",new Map),u(this,"tmpOpt"),u(this,"animationId"),u(this,"syncUnitTime",x.syncOpt.interval),this.vNodes=e.vNodes,this.thread=e.thread}createLocalWork(e){const{workId:s,opt:t,toolsType:o}=e;if(s&&t){const r=s.toString();!this.getToolsOpt()&&o&&this.setToolsOpt({toolsType:o,toolsOpt:t}),this.setWorkOptions(r,t)}}getLocalWorkShape(e){return this.localWorkShapes.get(e)}createLocalWorkShape(e,s){if(e&&this.tmpOpt){const t={toolsType:this.tmpOpt.toolsType,toolsOpt:s||this.tmpOpt.toolsOpt},o=this.createWorkShapeNode({...t,workId:e});return o&&this.localWorkShapes.set(e,{node:o,toolsType:o.toolsType,workState:T.Start}),o}}canUseTopLayer(e){return e===k.LaserPen}destroy(){this.clearAll()}clearAll(){this.thread.topLayer.children.length&&(this.thread.topLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),this.thread.serviceLayer.removeAllChildren()),this.serviceWorkShapes.clear(),this.localWorkShapes.clear()}consumeDraw(e){const{workId:s,dataType:t}=e;if(t===f.Service)this.activeServiceWorkShape(e);else{const o=s==null?void 0:s.toString(),r=o&&this.localWorkShapes.get(o);if(!r)return;const a=r.node.consume({data:e,isFullWork:!1,isSubWorker:!0});a.rect&&(r.result=a,r.workState=T.Doing,o&&this.localWorkShapes.set(o,r))}this.runAnimation()}setToolsOpt(e){var s;this.tmpOpt=e,(s=e.toolsOpt)!=null&&s.syncUnitTime&&(this.syncUnitTime=e.toolsOpt.syncUnitTime)}getToolsOpt(){return this.tmpOpt}createWorkShapeNode(e){const{toolsType:s}=e;if(s===k.LaserPen)return P({...e,vNodes:this.vNodes,fullLayer:this.thread.topLayer,drawLayer:this.thread.topLayer})}setNodeKey(e,s,t,o){return s.toolsType=t,s.node=this.createWorkShapeNode({workId:e,toolsType:t,toolsOpt:o}),s}activeServiceWorkShape(e){var s,t;const{workId:o,opt:r,toolsType:a,type:i,updateNodeOpt:n,ops:l,op:h}=e;if(!o)return;const c=o.toString(),m=(s=this.vNodes.get(c))==null?void 0:s.rect;if(!((t=this.serviceWorkShapes)!=null&&t.has(c))){let S={toolsType:a,animationWorkData:h||[],animationIndex:0,type:i,updateNodeOpt:n,ops:l,oldRect:m};a&&r&&(S=this.setNodeKey(c,S,a,r)),this.serviceWorkShapes.set(c,S)}const p=this.serviceWorkShapes.get(c);i&&(p.type=i),l&&(p.animationWorkData=M(l),p.ops=l),n&&(p.updateNodeOpt=n),h&&(p.animationWorkData=h),p.node&&p.node.getWorkId()!==c&&p.node.setWorkId(c),m&&(p.oldRect=m),a&&r&&(p.toolsType!==a&&a&&r&&this.setNodeKey(c,p,a,r),p.node&&p.node.setWorkOptions(r))}computNextAnimationIndex(e,s){var t;const o=((t=e.node)==null?void 0:t.syncUnitTime)||this.syncUnitTime,r=Math.floor((e.animationWorkData||[]).slice(e.animationIndex).length*32/s/o)*s;return Math.min((e.animationIndex||0)+(r||s),(e.animationWorkData||[]).length)}animationDraw(){var e,s,t,o;this.animationId=void 0;let r=!1;const a=new Map,i=[];for(const[n,l]of this.serviceWorkShapes.entries())switch(l.toolsType){case k.LaserPen:{const h=this.computNextAnimationIndex(l,8),c=Math.max(0,l.animationIndex||0),m=(l.animationWorkData||[]).slice(c,h);if((l.animationIndex||0)<h&&((e=l.node)==null||e.consumeService({op:m,isFullWork:!1}),l.animationIndex=h,m.length&&a.set(n,{workState:c===0?T.Start:h===((s=l.animationWorkData)==null?void 0:s.length)?T.Done:T.Doing,op:m.slice(-2)})),l.isDel){(t=l.node)==null||t.clearTmpPoints(),this.serviceWorkShapes.delete(n);break}l.ops&&l.animationIndex===((o=l.animationWorkData)==null?void 0:o.length)&&!l.isDel&&(this.thread.topLayer.getElementsByName(n.toString())[0]||(l.isDel=!0,this.serviceWorkShapes.set(n,l))),r=!0;break}}for(const[n,l]of this.localWorkShapes.entries()){const{result:h,toolsType:c,isDel:m,workState:p}=l;switch(c){case k.LaserPen:{if(m){l.node.clearTmpPoints(),this.localWorkShapes.delete(n),i.push({removeIds:[n.toString()],type:d.RemoveNode});break}h&&((h.op||h.ops)&&i.push(h),l.result=void 0),!this.thread.topLayer.getElementsByName(n.toString())[0]&&p===T.Done&&(l.isDel=!0,this.localWorkShapes.set(n,l)),r=!0;break}}}r&&this.runAnimation(),a.size&&a.forEach((n,l)=>{i.push({type:d.Cursor,uid:l.split(Z)[0],op:n.op,workState:n.workState,viewId:this.thread.viewId})}),i.length&&this.thread.post({sp:i})}runAnimation(){this.animationId||(this.animationId=requestAnimationFrame(this.animationDraw.bind(this)))}setWorkOptions(e,s){var t;let o=(t=this.localWorkShapes.get(e))==null?void 0:t.node;if(!o&&this.tmpOpt){const{toolsType:r}=this.tmpOpt;this.tmpOpt.toolsOpt=s,o=this.createWorkShapeNode({workId:e,toolsType:r,toolsOpt:s}),o&&this.localWorkShapes.set(e,{node:o,toolsType:r,workState:T.Start}),this.setToolsOpt(this.tmpOpt)}s!=null&&s.syncUnitTime||(s.syncUnitTime=this.syncUnitTime),o&&o.setWorkOptions(s)}consumeDrawAll(e){const{workId:s,dataType:t}=e;if(t===f.Service)this.activeServiceWorkShape(e);else{const o=s==null?void 0:s.toString(),r=o&&this.localWorkShapes.get(o);if(!r)return;const a=r.node.consumeAll({data:e});r.result=a,r.workState=T.Done,o&&this.localWorkShapes.set(o,r)}this.runAnimation()}}class le{constructor(e){u(this,"vNodes"),u(this,"thread"),u(this,"workShapes",new Map),u(this,"effectSelectNodeData",new Set),u(this,"batchEraserRemoveNodes",new Set),u(this,"batchEraserWorks",new Set),u(this,"tmpOpt"),u(this,"syncUnitTime",x.syncOpt.interval),u(this,"drawCount",0),u(this,"drawWorkActiveId"),u(this,"batchEraserCombine",se(()=>{this.updateBatchEraserCombineNode(this.batchEraserWorks,this.batchEraserRemoveNodes),this.batchEraserWorks.clear(),this.batchEraserRemoveNodes.clear()},100,{leading:!1})),this.vNodes=e.vNodes,this.thread=e.thread}async loadImageBitMap(e){return await this.thread.loadImageBitMap(e)}createLocalWork(e){const{workId:s,opt:t,toolsType:o}=e;if(s&&t){const r=s.toString();!this.getToolsOpt()&&o&&this.setToolsOpt({toolsType:o,toolsOpt:t}),this.setWorkOptions(r,t)}}workShapesDone(e,s){for(const t of this.workShapes.keys())this.consumeDrawAll({workId:t,scenePath:e,viewId:this.thread.viewId,msgType:d.DrawWork,dataType:f.Local},s)}async updateSelector(e){var s;const t=this.workShapes.get(N);if(!((s=t==null?void 0:t.selectIds)!=null&&s.length))return;const{callback:o,...r}=e,{updateSelectorOpt:a,willSerializeData:i}=r,n=await(t==null?void 0:t.updateSelector({updateSelectorOpt:a,selectIds:R.cloneDeep(t.selectIds),vNodes:this.vNodes,willSerializeData:i,worker:this})),l=new Map;let h;n!=null&&n.selectIds&&(h=R.xor(t.selectIds,n.selectIds),n.selectIds.forEach(p=>{const S=this.vNodes.get(p);if(S){const{toolsType:y,op:I,opt:w}=S;l.set(p,{opt:w,toolsType:y,ops:(I==null?void 0:I.length)&&V(I)||void 0})}}),t.selectIds=n.selectIds);const c=[],m=o&&o({res:n,workShapeNode:t,param:r,postData:{sp:c},newServiceStore:l})||{sp:c};h&&m.sp.push({type:d.RemoveNode,removeIds:h,viewId:this.thread.viewId}),m.sp.length&&this.thread.post(m)}destroy(){this.clearAll()}clearAll(){if(this.thread.localLayer.children.length&&(this.thread.topLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),this.thread.localLayer.removeAllChildren()),this.workShapes.get(N)){const e=[];e.push({type:d.Select,dataType:f.Local,selectIds:[],willSyncService:!1}),this.thread.post({sp:e})}this.workShapes.clear(),this.effectSelectNodeData.clear(),this.batchEraserWorks.clear(),this.batchEraserRemoveNodes.clear()}async checkTextActive(e){const{op:s,viewId:t,dataType:o}=e;if(s!=null&&s.length){let r;for(const a of this.vNodes.curNodeMap.values()){const{rect:i,name:n,toolsType:l,opt:h}=a,c=s[0]*this.thread.fullLayer.worldScaling[0]+this.thread.fullLayer.worldPosition[0],m=s[1]*this.thread.fullLayer.worldScaling[1]+this.thread.fullLayer.worldPosition[1];if(l===k.Text&&oe([c,m],i)&&h.workState===T.Done){r=n;break}}r&&(await this.blurSelector({viewId:t,msgType:d.Select,dataType:o,isSync:!0}),this.thread.post({sp:[{type:d.GetTextActive,toolsType:k.Text,workId:r}]}))}}cursorHover(e){const{opt:s,toolsType:t,point:o}=e,r=this.setFullWork({workId:z,toolsType:t,opt:s});r&&o&&r.cursorHover(o)}updateFullSelectWork(e){var s,t,o,r,a;const i=this.workShapes.get(N),{selectIds:n}=e;if(!(n!=null&&n.length)){this.blurSelector(e);return}if(!i){const l=this.setFullWork(e);!l&&e.workId&&this.tmpOpt&&((s=this.tmpOpt)==null?void 0:s.toolsType)===k.Selector&&this.setWorkOptions(e.workId.toString(),e.opt||this.tmpOpt.toolsOpt),l&&this.updateFullSelectWork(e);return}if(i&&n!=null&&n.length){const{selectRect:l}=i.updateSelectIds(n),h=[{...e,selectorColor:((t=e.opt)==null?void 0:t.strokeColor)||i.selectorColor,strokeColor:((o=e.opt)==null?void 0:o.strokeColor)||i.strokeColor,fillColor:((r=e.opt)==null?void 0:r.fillColor)||i.fillColor,textOpt:((a=e.opt)==null?void 0:a.textOpt)||i.textOpt,canTextEdit:i.canTextEdit,canRotate:i.canRotate,scaleType:i.scaleType,type:d.Select,selectRect:l,points:i.getChildrenPoints(),willSyncService:(e==null?void 0:e.willSyncService)||!1,opt:(e==null?void 0:e.willSyncService)&&i.getWorkOptions()||void 0,canLock:i.canLock,isLocked:i.isLocked,toolsTypes:i.toolsTypes,shapeOpt:i.shapeOpt,thickness:i.thickness,useStroke:i.useStroke,strokeType:i.strokeType}];this.thread.post({sp:h})}}commandDeleteText(e){const s=this.vNodes.get(e);if(s&&s.toolsType===k.Text)return{type:d.TextUpdate,toolsType:k.Text,workId:e,dataType:f.Local}}async removeSelector(e){const{willSyncService:s}=e,t=[],o=[],r=this.workShapes.get(N);if(!r)return;const a=r.selectIds&&[...r.selectIds]||[];for(const i of a){if(this.vNodes.get(i)){const n=this.commandDeleteText(i);n&&t.push(n)}this.removeNode(i),o.push(i)}o.length&&t.push({type:d.RemoveNode,removeIds:o}),t.push({type:d.Select,selectIds:[],willSyncService:s}),await this.blurSelector(),t.length&&this.thread.post({sp:t})}removeWork(e){const{workId:s}=e,t=s==null?void 0:s.toString();t&&this.removeNode(t)}removeNode(e){var s;this.vNodes.get(e)&&((s=this.thread.fullLayer)==null||s.getElementsByName(e).forEach(t=>{t.remove()}),this.vNodes.delete(e)),this.workShapes.has(e)&&(this.thread.localLayer.getElementsByName(e).forEach(t=>{t.remove()}),this.clearWorkShapeNodeCache(e))}setFullWork(e){const{workId:s,opt:t,toolsType:o}=e;if(s&&t&&o){const r=s.toString();let a;return s&&this.workShapes.has(r)?(a=this.workShapes.get(r),a==null||a.setWorkOptions(t)):a=this.createWorkShapeNode({toolsOpt:t,toolsType:o,workId:r}),a?(this.workShapes.set(r,a),a):void 0}}async consumeFull(e){var s;const t=this.setFullWork(e),o=e.ops&&M(e.ops);if(t){const r=(s=e.workId)==null?void 0:s.toString();t.toolsType===k.Image?await t.consumeServiceAsync({isFullWork:!0,replaceId:r,worker:this}):t.toolsType===k.Text?await t.consumeServiceAsync({isFullWork:!0,replaceId:r}):t.consumeService({op:o,isFullWork:!0,replaceId:r}),e!=null&&e.updateNodeOpt&&t.updataOptService(e.updateNodeOpt);const a=[];e.workId&&this.workShapes.delete(e.workId.toString()),e.willSyncService&&a.push({opt:e.opt,toolsType:e.toolsType,type:d.FullWork,workId:e.workId,ops:e.ops,updateNodeOpt:e.updateNodeOpt,viewId:this.thread.viewId}),a.length&&this.thread.post({sp:a})}}async colloctEffectSelectWork(e){const s=this.workShapes.get(N),{workId:t,msgType:o}=e;if(s&&t&&s.selectIds&&s.selectIds.includes(t.toString())){o===d.RemoveNode?s.selectIds=s.selectIds.filter(r=>r!==t.toString()):this.effectSelectNodeData.add(e),await new Promise(r=>{setTimeout(()=>{r(!0)},0)}),await this.runEffectSelectWork(!0).then(()=>{var r;(r=this.effectSelectNodeData)==null||r.clear()});return}return e}async runEffectSelectWork(e){var s;for(const t of this.effectSelectNodeData.values()){const o=this.setFullWork(t);if(o){const r=(s=t.workId)==null?void 0:s.toString();if(o.toolsType===k.Image)await o.consumeServiceAsync({isFullWork:!0,replaceId:r,worker:this});else if(o.toolsType===k.Text)await o.consumeServiceAsync({isFullWork:!0,replaceId:r});else{const a=t.ops&&M(t.ops);o.consumeService({op:a,isFullWork:!0,replaceId:r}),t!=null&&t.updateNodeOpt&&o.updataOptService(t.updateNodeOpt)}t.workId&&this.workShapes.delete(t.workId.toString())}}this.reRenderSelector(e)}hasSelector(){return this.workShapes.has(N)}getSelector(){return this.workShapes.get(N)}reRenderSelector(e=!1){var s;const t=this.workShapes.get(N);if(!t)return;if(t&&!((s=t.selectIds)!=null&&s.length))return this.blurSelector();const o=t.reRenderSelector();o&&this.thread.post({sp:[{type:d.Select,selectIds:t.selectIds,selectRect:o,willSyncService:e,viewId:this.thread.viewId,points:t.getChildrenPoints(),textOpt:t.textOpt,selectorColor:t.selectorColor,strokeColor:t.strokeColor,fillColor:t.fillColor,canTextEdit:t.canTextEdit,canRotate:t.canRotate,scaleType:t.scaleType,opt:t.getWorkOptions()||void 0,canLock:t.canLock,isLocked:t.isLocked,toolsTypes:t.toolsTypes,shapeOpt:t.shapeOpt,thickness:t.thickness,useStroke:t.useStroke,strokeType:t.strokeType}]})}async blurSelector(e){var s;const t=this.workShapes.get(N),o=t==null?void 0:t.blurSelector();if(this.clearWorkShapeNodeCache(N),((s=this.thread.fullLayer)==null?void 0:s.parent).children.forEach(r=>{r.name===N&&r.remove()}),o){const r=[];r.push({...o,isSync:e==null?void 0:e.isSync}),this.thread.post({sp:r})}}clearWorkShapeNodeCache(e){var s;(s=this.getWorkShape(e))==null||s.clearTmpPoints(),this.workShapes.delete(e)}drawBitMapEraser(e){const s=[];e.op&&s.push(e),s.length&&this.thread.post({sp:s})}async drawBitMapEraserFull(e,s,t){const{willUpdateNodes:o,scenePath:r,...a}=s,i=e.getWorkId(),n=[{...a,workId:i,scenePath:r,updateNodeOpt:{useAnimation:!1},isSync:!0,nextTasks:[{type:d.RemoveNode,removeIds:[i],viewId:this.thread.viewId}]}];if(t&&n.push({type:d.None,isLockSentEventCursor:t}),o!=null&&o.size){await(e==null?void 0:e.reRenderEffectNodes({willUpdateNodes:o,worker:this}));for(const[l,h]of o)n.push({type:d.UpdateNode,dataType:f.Local,opt:h.opt,workId:l,updateNodeOpt:{useAnimation:!1}})}n.length&&this.thread.post({sp:n})}drawPencilEraser(e,s){var t,o;const r=[];if((t=e.newWorkDatas)!=null&&t.size){for(const a of e.newWorkDatas.values()){const i=a.workId.toString();this.batchEraserWorks.add(i),r.push({type:d.FullWork,workId:i,ops:V(a.op),opt:a.opt,toolsType:a.toolsType,updateNodeOpt:{useAnimation:!1}})}delete e.newWorkDatas}(o=e.removeIds)==null||o.forEach(a=>{this.batchEraserRemoveNodes.add(a)}),s&&r.push({type:d.None,isLockSentEventCursor:s}),e.rect,this.thread.post({sp:r}),this.batchEraserCombine()}drawEraser(e,s){const t=[];e.removeIds&&t.push(e),s&&t.push({type:d.None,isLockSentEventCursor:s}),this.thread.post({sp:t})}updateBatchEraserCombineNode(e,s){for(const t of s.keys())this.thread.fullLayer.getElementsByName(t).forEach(o=>{o.remove()});e.forEach(t=>{const o=this.vNodes.get(t);if(o&&o.toolsType===k.Pencil&&!this.thread.fullLayer.getElementsByName(t)[0]){const r=this.setFullWork({...o,workId:t});r&&r.consumeService({op:o.op,isFullWork:!0})}})}getWorkShape(e){return this.workShapes.get(e)}getWorkShapes(){return this.workShapes}consumeDraw(e,s){const{op:t,workId:o,scenePath:r}=e;if(t!=null&&t.length&&o){const a=o.toString(),i=this.workShapes.get(a);if(!i)return;const n=i.toolsType;if(n===k.LaserPen)return;switch(this.drawWorkActiveId&&this.drawWorkActiveId!==a&&(this.consumeDrawAll({workId:this.drawWorkActiveId,scenePath:r,viewId:this.thread.viewId,msgType:d.DrawWork,dataType:f.Local},s),this.drawWorkActiveId=void 0),!this.drawWorkActiveId&&a!==N&&(this.drawWorkActiveId=a),n){case k.Selector:{const l=i.consume({data:e,isFullWork:!0});l.type===d.Select&&(l.selectIds&&s.runReverseSelectWork(l.selectIds),this.thread.post({sp:[l]}))}break;case k.PencilEraser:{const l=i.consume({data:e,isFullWork:!0});l!=null&&l.rect&&this.drawPencilEraser(l)}break;case k.BitMapEraser:{const l=i.consume({data:e,isFullWork:!0});l!=null&&l.rect&&this.drawBitMapEraser(l);break}case k.Eraser:{const l=i.consume({data:e,isFullWork:!0});l!=null&&l.rect&&this.drawEraser(l)}break;case k.Arrow:case k.Straight:case k.Ellipse:case k.Rectangle:case k.Star:case k.Polygon:case k.SpeechBalloon:case k.Pencil:{const l=i.consume({data:e,isFullWork:!1,isMainThread:!0});l&&(this.drawCount++,this.thread.post({drawCount:this.drawCount,sp:l.op&&[{...l,scenePath:r}]||void 0}))}break}}}consumeDrawAll(e,s){var t,o,r,a;const{workId:i,scenePath:n,isLockSentEventCursor:l}=e;if(i){const h=i.toString();this.drawWorkActiveId===h&&(this.drawWorkActiveId=void 0);const c=this.workShapes.get(h);if(!c)return;const m=c.toolsType;if(m===k.LaserPen)return;const p=this.workShapes.get(z),S=(t=p==null?void 0:p.selectIds)==null?void 0:t[0],y=c.consumeAll({data:e});switch(m){case k.Selector:y.selectIds&&S&&(o=y.selectIds)!=null&&o.includes(S)&&p.cursorBlur(),y.type===d.Select&&(y.selectIds&&s.runReverseSelectWork(y.selectIds),this.thread.post({sp:[{...y,scenePath:n}]})),(r=c.selectIds)!=null&&r.length?c.clearTmpPoints():this.clearWorkShapeNodeCache(h);break;case k.PencilEraser:this.drawPencilEraser({...y,scenePath:n},l),c.clearTmpPoints();break;case k.BitMapEraser:(y.rect||(a=y.newWorkDatas)!=null&&a.size)&&this.drawBitMapEraserFull(c,y,l);break;case k.Eraser:this.drawEraser({...y,scenePath:n},l),c.clearTmpPoints();break;case k.Arrow:case k.Straight:case k.Ellipse:case k.Rectangle:case k.Star:case k.Polygon:case k.SpeechBalloon:case k.Pencil:{const I=[];l&&I.push({type:d.None,isLockSentEventCursor:l}),y&&(I.push(y),this.drawCount=0,this.thread.post({drawCount:this.drawCount,sp:I})),this.clearWorkShapeNodeCache(h);break}}}}getToolsOpt(){return this.tmpOpt}setToolsOpt(e){var s;this.tmpOpt=e,(s=e.toolsOpt)!=null&&s.syncUnitTime&&(this.syncUnitTime=e.toolsOpt.syncUnitTime)}setWorkOptions(e,s){let t=this.workShapes.get(e);if(!t&&this.tmpOpt){const{toolsType:o}=this.tmpOpt;this.tmpOpt.toolsOpt=s,t=this.createWorkShapeNode({workId:e,toolsType:o,toolsOpt:s}),t&&this.workShapes.set(e,t),this.setToolsOpt(this.tmpOpt)}s.syncUnitTime||(s.syncUnitTime=this.syncUnitTime),t==null||t.setWorkOptions(s)}createWorkShapeNode(e){return P({...e,vNodes:this.vNodes,fullLayer:this.thread.fullLayer,drawLayer:this.thread.localLayer},this.thread.serviceWork)}}class ne{constructor(e){u(this,"vNodes"),u(this,"thread"),u(this,"workShapes",new Map),u(this,"selectorWorkShapes",new Map),u(this,"willRunEffectSelectorIds",new Set),u(this,"runEffectId"),u(this,"animationId"),u(this,"syncUnitTime",x.syncOpt.interval),this.vNodes=e.vNodes,this.thread=e.thread}async loadImageBitMap(e){return await this.thread.loadImageBitMap(e)}destroy(){this.clearAll()}clearAll(){this.thread.serviceLayer.children.length&&(this.thread.serviceLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),this.thread.serviceLayer.removeAllChildren()),this.workShapes.clear(),this.selectorWorkShapes.clear(),this.willRunEffectSelectorIds.clear()}runEffect(){this.runEffectId||(this.runEffectId=setTimeout(this.effectRunSelector.bind(this),0))}effectRunSelector(){this.runEffectId=void 0,this.willRunEffectSelectorIds.forEach(e=>{var s,t;const o=this.selectorWorkShapes.get(e);o&&o.selectIds&&((s=o.node)==null||s.selectServiceNode(e,o,!0)),(t=o==null?void 0:o.selectIds)!=null&&t.length||this.selectorWorkShapes.delete(e)}),this.willRunEffectSelectorIds.clear()}runSelectWork(e){this.activeSelectorShape(e);const{workId:s}=e,t=s==null?void 0:s.toString();t&&this.willRunEffectSelectorIds.add(t),this.runEffect()}removeWork(e){const{workId:s}=e,t=s==null?void 0:s.toString();if(t){if(this.workShapes.get(t)){this.workShapes.delete(t),this.removeNode(t,e);return}this.removeNode(t,e)}}consumeFull(e){this.activeWorkShape(e),this.runAnimation()}runReverseSelectWork(e){e.forEach(s=>{this.selectorWorkShapes.forEach((t,o)=>{var r;if((r=t.selectIds)!=null&&r.length){const a=t.selectIds.indexOf(s);a>-1&&(t.selectIds.splice(a,1),this.willRunEffectSelectorIds.add(o))}})}),this.willRunEffectSelectorIds.size&&this.runEffect()}consumeDraw(e){this.activeWorkShape(e),this.runAnimation()}computNextAnimationIndex(e,s){const t=Math.floor((e.animationWorkData||[]).slice(e.animationIndex).length*32/s/this.syncUnitTime)*s;return Math.min((e.animationIndex||0)+(t||s),(e.animationWorkData||[]).length)}async animationDraw(){var e,s,t,o,r,a,i,n,l,h,c,m,p,S,y;this.animationId=void 0;let I=!1;const w=new Map;for(const[g,v]of this.workShapes.entries())switch(v.toolsType){case k.Image:{await((e=v.node)==null?void 0:e.consumeServiceAsync({isFullWork:!0,worker:this})),this.selectorWorkShapes.forEach((b,E)=>{var O;(O=b.selectIds)!=null&&O.includes(g)&&(this.willRunEffectSelectorIds.add(E),this.runEffect())}),this.workShapes.delete(g);break}case k.Text:{v.node&&(await((s=v.node)==null?void 0:s.consumeServiceAsync({isFullWork:!0,replaceId:g})),this.selectorWorkShapes.forEach((b,E)=>{var O;(O=b.selectIds)!=null&&O.includes(g)&&(this.willRunEffectSelectorIds.add(E),this.runEffect())}),(t=v.node)==null||t.clearTmpPoints(),this.workShapes.delete(g));break}case k.Arrow:case k.Straight:case k.Rectangle:case k.Ellipse:case k.Star:case k.Polygon:case k.SpeechBalloon:{const b=!!v.ops;if((o=v.animationWorkData)!=null&&o.length){const E=v.oldRect;(r=v.node)==null||r.consumeService({op:v.animationWorkData,isFullWork:b}),b&&(this.selectorWorkShapes.forEach((O,D)=>{var F;(F=O.selectIds)!=null&&F.includes(g)&&(this.willRunEffectSelectorIds.add(D),this.runEffect())}),(a=v.node)==null||a.clearTmpPoints(),this.workShapes.delete(g)),w.set(g,{workState:E?v.ops?T.Done:T.Doing:T.Start,op:v.animationWorkData.filter((O,D)=>{if(D%3!==2)return!0}).slice(-2)}),v.animationWorkData.length=0}break}case k.Pencil:{if(!v.useAnimation&&v.ops)(i=v.node)==null||i.consumeService({op:v.animationWorkData||[],isFullWork:!0,replaceId:g}),(n=v.node)==null||n.updataOptService(v.updateNodeOpt),this.selectorWorkShapes.forEach((b,E)=>{var O;(O=b.selectIds)!=null&&O.includes(g)&&(this.willRunEffectSelectorIds.add(E),this.runEffect())}),(l=v.node)==null||l.clearTmpPoints(),this.workShapes.delete(g);else if(v.useAnimation){if(v.isDel){(h=v.node)==null||h.clearTmpPoints(),this.workShapes.delete(g);break}const b=3,E=this.computNextAnimationIndex(v,b),O=v.isDiff?0:Math.max(0,(v.animationIndex||0)-b),D=(v.animationWorkData||[]).slice(O,E),F=(m=(c=v.node)==null?void 0:c.getWorkId())==null?void 0:m.toString();if((v.animationIndex||0)<E||v.isDiff){if((p=v.node)==null||p.consumeService({op:D,isFullWork:!1}),v.animationIndex=E,v.isDiff&&(v.isDiff=!1),D.length){const $=D.filter((G,Y)=>{if(Y%b!==b-1)return!0}).slice(-2);w.set(g,{workState:O===0?T.Start:E===((S=v.animationWorkData)==null?void 0:S.length)?T.Done:T.Doing,op:$})}}else v.ops&&((y=v.node)==null||y.consumeService({op:v.animationWorkData||[],isFullWork:!0,replaceId:F}),v.isDel=!0,w.set(g,{workState:T.Done,op:D.filter(($,G)=>{if(G%b!==b-1)return!0}).slice(-2)}));I=!0;break}break}}if(I&&this.runAnimation(),w.size){const g=[];w.forEach((v,b)=>{g.push({type:d.Cursor,uid:b.split(Z)[0],op:v.op,workState:v.workState,viewId:this.thread.viewId})}),this.thread.post({sp:g})}}runAnimation(){this.animationId||(this.animationId=requestAnimationFrame(this.animationDraw.bind(this)))}hasDiffData(e,s,t){const o=e.length;if(s.length<o)return!0;switch(t){case k.Pencil:{for(let r=0;r<o;r+=3)if(s[r]!==e[r]||s[r+1]!==e[r+1])return!0;break}case k.LaserPen:{for(let r=0;r<o;r+=2)if(s[r]!==e[r]||s[r+1]!==e[r+1])return!0;break}}return!1}activeWorkShape(e){var s,t,o,r;const{workId:a,opt:i,toolsType:n,type:l,updateNodeOpt:h,ops:c,op:m,useAnimation:p,imageBitmap:S}=e;if(!a)return;const y=a.toString(),I=(s=this.vNodes.get(y))==null?void 0:s.rect;if(!((t=this.workShapes)!=null&&t.has(y))){let g={toolsType:n,animationWorkData:m||[],animationIndex:0,type:l,updateNodeOpt:h,ops:c,useAnimation:typeof p<"u"?p:typeof(h==null?void 0:h.useAnimation)<"u"?h==null?void 0:h.useAnimation:!0,oldRect:I,isDiff:!1,imageBitmap:S};n&&i&&(g=this.setNodeKey(y,g,n,i)),(o=this.workShapes)==null||o.set(y,g)}const w=(r=this.workShapes)==null?void 0:r.get(y);l&&(w.type=l),c&&(w.animationWorkData=M(c),w.ops=c),h&&(w.updateNodeOpt=h),m&&(w.isDiff=this.hasDiffData(w.animationWorkData||[],m,w.toolsType),w.animationWorkData=m),w.node&&w.node.getWorkId()!==y&&w.node.setWorkId(y),I&&(w.oldRect=I),n&&i&&(i.syncUnitTime&&(this.syncUnitTime=i.syncUnitTime),w.toolsType!==n&&n&&i&&this.setNodeKey(y,w,n,i),w.node&&w.node.setWorkOptions(i)),S&&(w.imageBitmap=S)}removeNode(e,s){e.indexOf(N)>-1&&this.removeSelectWork(s),this.thread.fullLayer.getElementsByName(e).forEach(t=>{t.remove()}),this.thread.serviceLayer.getElementsByName(e).forEach(t=>{t.remove()}),this.vNodes.delete(e)}removeSelectWork(e){const{workId:s}=e,t=s==null?void 0:s.toString();t&&(this.activeSelectorShape(e),this.willRunEffectSelectorIds.add(t)),this.runEffect()}activeSelectorShape(e){var s,t,o;const{workId:r,opt:a,toolsType:i,type:n,selectIds:l}=e;if(!r)return;const h=r.toString();if(!((s=this.selectorWorkShapes)!=null&&s.has(h))){let m={toolsType:i,selectIds:l,type:n,opt:a};i&&a&&(m=this.setNodeKey(h,m,i,a)),(t=this.selectorWorkShapes)==null||t.set(h,m)}const c=(o=this.selectorWorkShapes)==null?void 0:o.get(h);n&&(c.type=n),c.node&&c.node.getWorkId()!==h&&c.node.setWorkId(h),c.selectIds=l||[]}setNodeKey(e,s,t,o){return s.toolsType=t,s.node=P({toolsType:t,toolsOpt:o,vNodes:this.vNodes,fullLayer:this.thread.fullLayer,drawLayer:this.thread.serviceLayer,workId:e},this),s}}class C{constructor(){u(this,"localWork"),u(this,"serviceWork"),u(this,"threadEngine")}registerMainThread(e){return this.threadEngine=e,this.localWork=e.localWork,this.serviceWork=e.serviceWork,this}}class ce extends C{constructor(){super(...arguments),u(this,"emitEventType",W.CopyNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:o}=e;if(s===d.FullWork&&t===f.Local&&o===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t}=e;t&&await((s=this.localWork)==null?void 0:s.consumeFull(e))}}class he extends C{constructor(){super(...arguments),u(this,"emitEventType",W.SetColorNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:o}=e;if(s===d.UpdateNode&&t===f.Local&&o===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,textUpdateForWoker:n}=e;t===N&&o&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,textUpdateForWoker:n,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:o}=e,{willSyncService:r,isSync:a,textUpdateForWoker:i}=s,n=t.sp||[];if(r)for(const[l,h]of o.entries())i&&h.toolsType===k.Text?n.push({...h,workId:l,type:d.TextUpdate,dataType:f.Local,willSyncService:!0}):n.push({...h,workId:l,type:d.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:a});return{sp:n}}}class de extends C{constructor(){super(...arguments),u(this,"emitEventType",W.ZIndexNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:o}=e;if(s===d.UpdateNode&&t===f.Local&&o===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i}=e;t===N&&o&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:o}=e,{willSyncService:r,isSync:a}=s,i=t.sp||[];if(r&&i)for(const[n,l]of o.entries())i.push({...l,workId:n,type:d.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:a});return{sp:i}}}class pe extends C{constructor(){super(...arguments),u(this,"emitEventType",W.TranslateNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:o}=e;if(s===d.UpdateNode&&t===f.Local&&o===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s,t;const{workId:o,updateNodeOpt:r,willRefreshSelector:a,willSyncService:i,willSerializeData:n,textUpdateForWoker:l,emitEventType:h}=e;o===N&&r&&(r.workState===T.Done&&r!=null&&r.translate&&(r.translate[0]||r.translate[1])||r.workState!==T.Done?await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:a,willSyncService:i,willSerializeData:n,isSync:!0,textUpdateForWoker:l,emitEventType:h,callback:this.updateSelectorCallback})):r.workState===T.Done&&((t=this.localWork)==null||t.vNodes.deleteLastTarget()))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:o,workShapeNode:r,res:a}=e,{willSyncService:i,isSync:n,updateSelectorOpt:l,textUpdateForWoker:h}=s,c=l.workState,m=t.sp||[];if(c===T.Start)return{sp:[],render:[]};const p=a==null?void 0:a.selectRect;if(i){c===T.Doing&&m.push({type:d.Select,selectIds:r.selectIds,selectRect:p,willSyncService:!0,isSync:!0,points:r.getChildrenPoints(),textOpt:r.textOpt});for(const[S,y]of o.entries())h&&y.toolsType===k.Text?m.push({...y,workId:S,type:d.TextUpdate,dataType:f.Local,willSyncService:!0}):m.push({...y,workId:S,type:d.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n})}return{sp:m}}}class ue extends C{constructor(){super(...arguments),u(this,"emitEventType",W.DeleteNode)}async consume(){return!1}}class me extends C{constructor(){super(...arguments),u(this,"emitEventType",W.ScaleNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:o}=e;if(s===d.UpdateNode&&t===f.Local&&o===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:o,willSyncService:r,willSerializeData:a}=e;t===N&&o&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:o,willSyncService:r,willSerializeData:a,isSync:!0,callback:this.updateSelectorCallback.bind(this)}))}updateSelectorCallback(e){const{param:s,postData:t,workShapeNode:o,res:r,newServiceStore:a}=e,{updateSelectorOpt:i,willSyncService:n}=s,l=i.workState,h=t.sp||[],c=r==null?void 0:r.selectRect;if(l===T.Start)return{sp:[],render:[]};if(n){h.push({type:d.Select,selectIds:o.selectIds,selectRect:c,willSyncService:!0,isSync:!0,points:l===T.Done&&o.getChildrenPoints()||void 0,textOpt:o.textOpt});for(const[m,p]of a.entries())p.toolsType===k.Text?h.push({...p,workId:m,type:d.TextUpdate,dataType:f.Local,willSyncService:!0}):h.push({...p,workId:m,type:d.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:!0})}return{sp:h}}}class ke extends C{constructor(){super(...arguments),u(this,"emitEventType",W.RotateNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:o}=e;if(s===d.UpdateNode&&t===f.Local&&o===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,emitEventType:n}=e;t===N&&o&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,emitEventType:n,isSync:!0,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,workShapeNode:o,res:r,newServiceStore:a}=e,{updateSelectorOpt:i,willSyncService:n,willSerializeData:l,isSync:h}=s,c=i.workState,m=t.sp||[],p=r==null?void 0:r.selectRect;if(n){l&&c===T.Done&&m.push({type:d.Select,selectIds:o.selectIds,selectRect:p,willSyncService:!0,isSync:h,points:o.getChildrenPoints()});for(const[S,y]of a.entries())m.push({...y,workId:S,type:d.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:h})}return{sp:m}}}class Se extends C{constructor(){super(...arguments),u(this,"emitEventType",W.SetFontStyle)}async consume(e){const{msgType:s,dataType:t,emitEventType:o}=e;if(s===d.UpdateNode&&t===f.Local&&o===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,textUpdateForWoker:n}=e;t===N&&o&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,textUpdateForWoker:n,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:o,workShapeNode:r,res:a}=e,{willSyncService:i,isSync:n,updateSelectorOpt:l,textUpdateForWoker:h}=s,c=t.sp||[],m=a==null?void 0:a.selectRect;if(i&&c){l.fontSize&&c.push({type:d.Select,selectIds:r.selectIds,selectRect:m,willSyncService:i,isSync:n,points:r.getChildrenPoints()});for(const[p,S]of o.entries())h&&S.toolsType===k.Text?c.push({...S,workId:p,type:d.TextUpdate,dataType:f.Local,willSyncService:!0}):c.push({...S,workId:p,type:d.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n})}return{sp:c}}}class ye extends C{constructor(){super(...arguments),u(this,"emitEventType",W.SetPoint)}async consume(e){const{msgType:s,dataType:t,emitEventType:o}=e;if(s===d.UpdateNode&&t===f.Local&&o===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,textUpdateForWoker:n}=e;t===N&&o&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,emitEventType:this.emitEventType,willSerializeData:i,isSync:!0,textUpdateForWoker:n,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:o,workShapeNode:r,res:a}=e,{willSyncService:i,isSync:n}=s,l=t.sp||[],h=a==null?void 0:a.selectRect;if(i&&l){for(const[c,m]of o.entries())l.push({...m,workId:c,type:d.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n});l.push({type:d.Select,selectIds:r.selectIds,selectRect:h,willSyncService:i,isSync:n,points:r.getChildrenPoints()})}return{sp:l}}}class ve extends C{constructor(){super(...arguments),u(this,"emitEventType",W.SetLock)}async consume(e){const{msgType:s,dataType:t,emitEventType:o}=e;if(s===d.UpdateNode&&t===f.Local&&o===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i}=e;t===N&&o&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:o,workShapeNode:r,res:a}=e,{willSyncService:i,isSync:n,updateSelectorOpt:l}=s,h=t.sp||[],c=a==null?void 0:a.selectRect;if(i&&h){for(const[m,p]of o.entries())h.push({...p,workId:m,type:d.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n});h.push({isLocked:l.isLocked,selectorColor:r.selectorColor,scaleType:r.scaleType,canRotate:r.canRotate,type:d.Select,selectIds:r.selectIds,selectRect:c,willSyncService:i,isSync:n})}return{sp:h}}}class we extends C{constructor(){super(...arguments),u(this,"emitEventType",W.SetShapeOpt)}async consume(e){const{msgType:s,dataType:t,emitEventType:o}=e;if(s===d.UpdateNode&&t===f.Local&&o===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i}=e;t===N&&o&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:o}=e,{willSyncService:r,isSync:a}=s,i=t.sp||[];if(r&&i)for(const[n,l]of o.entries())i.push({...l,workId:n,type:d.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:a});return{sp:i}}}class fe{constructor(e){u(this,"builders",new Map),this.builders=new Map(e.map(s=>[s,this.build(s)]))}build(e){switch(e){case W.TranslateNode:return new pe;case W.ZIndexNode:return new de;case W.CopyNode:return new ce;case W.SetColorNode:return new he;case W.DeleteNode:return new ue;case W.ScaleNode:return new me;case W.RotateNode:return new ke;case W.SetFontStyle:return new Se;case W.SetPoint:return new ye;case W.SetLock:return new ve;case W.SetShapeOpt:return new we}}registerForMainThread(e){return this.builders.forEach(s=>{s&&s.registerMainThread(e)}),this}async consumeForMainThread(e){for(const s of this.builders.values())if(await(s==null?void 0:s.consume(e)))return!0;return!1}}class ge{constructor(e,s){u(this,"viewId"),u(this,"fullLayer"),u(this,"topLayer"),u(this,"localLayer"),u(this,"serviceLayer"),u(this,"snapshotFullLayer"),u(this,"vNodes"),u(this,"master"),u(this,"opt"),u(this,"cameraOpt"),u(this,"scene"),u(this,"localWork"),u(this,"serviceWork"),u(this,"topWork"),u(this,"taskUpdateCameraId"),u(this,"debounceUpdateCameraId"),u(this,"debounceUpdateCache",new Set),u(this,"mainThreadPostId"),u(this,"combinePostMsg",new Set),u(this,"methodBuilder"),u(this,"cacheImages",new Map),u(this,"imageResolveMap",new Map),this.viewId=e,this.opt=s,this.scene=this.createScene({...s.canvasOpt,container:s.container}),this.master=s.master;const t=x.bufferSize.full,o=x.bufferSize.sub;this.fullLayer=this.createLayer("fullLayer",this.scene,{...s.layerOpt,bufferSize:this.viewId===A?t:o}),this.topLayer=this.createLayer("topLayer",this.scene,{...s.layerOpt,bufferSize:(this.viewId,A,o)}),this.localLayer=this.createLayer("localLayer",this.scene,{...s.layerOpt,bufferSize:(this.viewId,A,o)}),this.serviceLayer=this.createLayer("serviceLayer",this.scene,{...s.layerOpt,bufferSize:(this.viewId,A,o)}),this.vNodes=new ee(e,this.scene);const r={thread:this,vNodes:this.vNodes};this.localWork=new le(r),this.serviceWork=new ne(r),this.topWork=new ie(r),this.vNodes.init(this.fullLayer),this.methodBuilder=new fe([W.CopyNode,W.SetColorNode,W.DeleteNode,W.RotateNode,W.ScaleNode,W.TranslateNode,W.ZIndexNode,W.SetFontStyle,W.SetPoint,W.SetLock,W.SetShapeOpt]).registerForMainThread(this)}getCachedImages(e){var s;return(s=this.cacheImages.get(e))==null?void 0:s.imageBitmap}getCachedImagesByWorkId(e){for(const[s,t]of this.cacheImages.entries())if(s===e&&t.imageBitmap)return t.imageBitmap}deleteCachedImagesByWorkId(e){for(const[s,t]of this.cacheImages.entries())t.workId===e&&(t.imageBitmap.close(),this.cacheImages.delete(s))}clearCacheImages(){this.cacheImages.forEach(e=>e.imageBitmap.close()),this.cacheImages.clear()}clearImageResolveMap(){this.imageResolveMap.forEach(({timer:e})=>{e&&clearTimeout(e)}),this.imageResolveMap.clear()}post(e){this.combinePostMsg.add(e),this.runBatchPostData()}async on(e){if(!await this.methodBuilder.consumeForMainThread(e)){const{msgType:s,toolsType:t,opt:o,dataType:r,workId:a,workState:i,imageSrc:n,imageBitmap:l,workIds:h}=e,c=a==null?void 0:a.toString();switch(s){case d.AuthClear:{const{clearUids:m,localUid:p}=e;this.vNodes.setCanClearUids(m),this.vNodes.setLocalUid(p);break}case d.Destroy:this.destroy();break;case d.Clear:this.clearAll();break;case d.UpdateCamera:await this.updateCamera(e);break;case d.UpdateTools:if(t&&o){const m={toolsType:t,toolsOpt:o};this.topWork.canUseTopLayer(t)?this.topWork.setToolsOpt(m):this.localWork.setToolsOpt(m)}break;case d.CreateWork:if(c&&o&&t){if(this.topWork.canUseTopLayer(t)){this.topWork.getToolsOpt()||this.topWork.setToolsOpt({toolsType:t,toolsOpt:o}),this.topWork.setWorkOptions(c,o);break}this.localWork.getToolsOpt()||this.localWork.setToolsOpt({toolsType:t,toolsOpt:o}),this.localWork.setWorkOptions(c,o)}break;case d.DrawWork:i===T.Done&&r===f.Local?this.consumeDrawAll(r,e):this.consumeDraw(r,e);break;case d.UpdateNode:case d.FullWork:if(t&&this.topWork.canUseTopLayer(t)){this.consumeDrawAll(r,e);break}this.consumeFull(r,e);break;case d.RemoveNode:await this.removeNode(e);return;case d.Select:r===f.Service&&(a===N?this.localWork.updateFullSelectWork(e):this.serviceWork.runSelectWork(e));break;case d.CursorHover:this.localWork.cursorHover(e);break;case d.GetTextActive:r===f.Local&&this.localWork.checkTextActive(e);break;case d.GetImageBitMap:if(n&&l&&a){const m=a.toString();this.deleteCachedImagesByWorkId(m),this.cacheImages.set(n,{imageBitmap:l,workId:m});const p=this.imageResolveMap.get(n);if(p){const{resolve:S,timer:y}=p;y&&clearTimeout(y),S&&S(n)}}break;case d.GetVNodeInfo:if(a&&h){const m=h.map(p=>this.vNodes.get(p));this.post({sp:[{type:d.GetVNodeInfo,dataType:f.Local,workId:a,vInfo:m}]})}break}}}getIconSize(e,s){const t=e*3,o=s*3;return t<=50||o<=50?[50,50]:t<=100||o<=100?[100,100]:t<=400||o<=400?[400,400]:t<=800||o<=800?[800,800]:t<=1600||o<=1600?[1600,1600]:[2e3,2e3]}async loadImageBitMap(e){const{toolsType:s,opt:t,workId:o}=e;if(s===k.Image&&t&&o){const r=o.toString(),{src:a,type:i,width:n,height:l,strokeColor:h}=t;if(!a||!i||!n||!l)return;let c=a;if(i===X.Iconify){const[p,S]=this.getIconSize(n,l);c=`${a}?width=${p}&height=${S}&color=${h}`}if(this.cacheImages.has(c)){const p=this.getCachedImages(c);if(p)return p}if(this.imageResolveMap.has(c)){const p=this.getCachedImagesByWorkId(r);if(p)return p}const m=await new Promise(p=>{const S=this.imageResolveMap.get(c)||{resolve:void 0,timer:void 0};S.timer&&clearTimeout(S.timer),S.resolve=p,S.timer=setTimeout(()=>{const y=this.imageResolveMap.get(c);y!=null&&y.resolve&&y.resolve(c)},5e3),this.imageResolveMap.set(c,S),this.opt.post({sp:[{imageSrc:c,workId:r,viewId:this.viewId,isgl:!!this.fullLayer.parent.gl,isSubWorker:!1,type:d.GetImageBitMap}]})});return this.imageResolveMap.delete(m),this.getCachedImages(c)}}async removeNode(e){const{dataType:s,workId:t,removeIds:o}=e,r=o||[];if(t&&r.push(t.toString()),r.length)for(const a of r){if(a===N){await this.localWork.removeSelector(e);continue}s===f.Local?this.localWork.removeWork(e):s===f.Service&&this.serviceWork.removeWork(e),await this.localWork.colloctEffectSelectWork(e)}}async consumeFull(e,s){const t=await this.localWork.colloctEffectSelectWork(s);t&&e===f.Local&&await this.localWork.consumeFull(t),t&&e===f.Service&&this.serviceWork.consumeFull(t)}setCameraOpt(e){this.cameraOpt=e;const{scale:s,centerX:t,centerY:o,width:r,height:a}=e;(r!==this.scene.width||a!==this.scene.height)&&this.updateScene({width:r,height:a}),this.fullLayer.setAttribute("scale",[s,s]),this.fullLayer.setAttribute("translate",[-t,-o]),this.topLayer.setAttribute("scale",[s,s]),this.topLayer.setAttribute("translate",[-t,-o]),this.localLayer.setAttribute("scale",[s,s]),this.localLayer.setAttribute("translate",[-t,-o]),this.serviceLayer.setAttribute("scale",[s,s]),this.serviceLayer.setAttribute("translate",[-t,-o])}runBatchPostData(){this.mainThreadPostId||(this.mainThreadPostId=requestAnimationFrame(this.combinePost.bind(this)))}combinePostData(){var e;this.mainThreadPostId=void 0;const s=[];let t;for(const o of this.combinePostMsg.values()){if((e=o.sp)!=null&&e.length)for(const r of o.sp){let a=!1;for(const i of s)if(R.isEqual(r,i)){a=!0;break}a||s.push(r)}R.isNumber(o.drawCount)&&(t=o.drawCount)}return this.combinePostMsg.clear(),{sp:s,drawCount:t}}combinePost(){var e,s;const t=this.combinePostData(),o=(e=t.sp)==null?void 0:e.filter(r=>r.type!==d.None||r.isLockSentEventCursor);o!=null&&o.length?t.sp=o.map(r=>r.viewId?r:{...r,viewId:this.viewId}):delete t.sp,t.drawCount===void 0&&delete t.drawCount,(t!=null&&t.drawCount||(s=t.sp)!=null&&s.length)&&this.opt.post(t)}clearAll(){this.fullLayer.children.length&&(this.fullLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),this.fullLayer.removeAllChildren()),this.clearCacheImages(),this.clearImageResolveMap(),this.localWork.clearAll(),this.topWork.clearAll(),this.serviceWork.clearAll(),this.vNodes.clear(),this.post({sp:[{type:d.Clear}]})}consumeDrawAll(e,s){const{toolsType:t,workId:o}=s;if(o){const r=o.toString();if(t&&this.topWork.canUseTopLayer(t)){e===f.Local&&(this.topWork.getLocalWorkShape(o.toString())||this.topWork.createLocalWork(s)),this.topWork.consumeDrawAll(s);return}e===f.Local&&(this.localWork.getWorkShape(r)||this.localWork.createLocalWork(s),this.localWork.consumeDrawAll(s,this.serviceWork))}}consumeDraw(e,s){const{opt:t,workId:o,toolsType:r}=s;if(o&&r&&t){const a=o.toString();if(this.topWork.canUseTopLayer(r)){e===f.Local&&(this.topWork.getLocalWorkShape(a)||this.topWork.createLocalWork(s)),this.topWork.consumeDraw(s);return}e===f.Local?(this.localWork.getWorkShape(a)||this.localWork.createLocalWork(s),this.localWork.consumeDraw(s,this.serviceWork)):e===f.Service&&this.serviceWork.consumeDraw(s);return}}async updateCamera(e){var s;const{cameraOpt:t,scenePath:o}=e;if(t&&!R.isEqual(this.cameraOpt,t)){if(this.taskUpdateCameraId&&(clearTimeout(this.taskUpdateCameraId),this.taskUpdateCameraId=void 0),o){let l=!1;for(const[h,c]of this.localWork.getWorkShapes().entries())switch(c.toolsType){case k.Text:case k.BitMapEraser:case k.PencilEraser:case k.Eraser:case k.Selector:case k.LaserPen:break;default:h!==z&&h!==N&&(l=!0);break}if(l){this.taskUpdateCameraId=setTimeout(()=>{this.taskUpdateCameraId=void 0,this.updateCamera(e)},K);return}}const r=new Map;for(const[l,h]of this.vNodes.getNodesByType(k.Text).entries()){const c=h.rect;r.set(l,R.cloneDeep(c))}const a=new Set(r.keys());let i=!1;if(this.localWork.hasSelector()){const l=(s=this.localWork.getSelector())==null?void 0:s.selectIds;if(l){i=!0;for(const h of l)a.add(h)}}let n=!1;if(this.serviceWork.selectorWorkShapes.size)for(const l of this.serviceWork.selectorWorkShapes.values()){const h=l.selectIds;if(h){n=!0;for(const c of h)a.add(c)}}if(this.setCameraOpt(t),this.vNodes.curNodeMap.size){this.vNodes.clearTarget(),this.vNodes.updateHighLevelNodesRect(a),this.debounceUpdateCameraId&&clearTimeout(this.debounceUpdateCameraId);for(const[l,h]of r.entries()){const c=this.vNodes.get(l);if(c){const m=h,p=c.rect,S=this.getSceneRect(),y=U(m,S),I=U(p,S);let w=!1;if((y!==I||m.w!==p.w||m.h!==p.h||I===j.intersect)&&(w=!0),w){const{toolsType:g,opt:v}=c;g===k.Text&&v.workState===T.Done&&this.debounceUpdateCache.add(l)}}}if(i&&this.localWork.reRenderSelector(),n)for(const[l,h]of this.serviceWork.selectorWorkShapes.entries())this.serviceWork.runSelectWork({workId:l,selectIds:h.selectIds,msgType:d.Select,dataType:f.Service,viewId:this.viewId});this.debounceUpdateCameraId=setTimeout(()=>{var l;this.debounceUpdateCameraId=void 0;const h=[];for(const c of this.debounceUpdateCache.values()){if((l=this.fullLayer)!=null&&l.getElementsByName(c)[0]){const m=this.vNodes.get(c);if(m){const{toolsType:p,opt:S,rect:y}=m,I=this.localWork.setFullWork({toolsType:p,opt:S,workId:c});if(I){const w=this.getSceneRect(),g=U(y,w);h.push(I.consumeServiceAsync({isFullWork:!0,replaceId:c,isDrawLabel:g!==j.outside}))}}}this.debounceUpdateCache.delete(c)}this.vNodes.updateLowLevelNodesRect(),this.vNodes.clearHighLevelIds()},K)}}}getSceneRect(){const{width:e,height:s}=this.scene;return{x:0,y:0,w:Math.floor(e),h:Math.floor(s)}}createScene(e){return new _({displayRatio:this.opt.displayer.dpr,depth:!1,desynchronized:!0,...e,autoRender:!0,id:this.viewId,contextType:"2d"})}createLayer(e,s,t){const{width:o,height:r}=t,a=`canvas-${e}`,i=s.layer(a,{...t,offscreen:!1}),n=new Q({anchor:[.5,.5],pos:[o*.5,r*.5],size:[o,r],name:"viewport",id:e});return i.append(n),n}updateScene(e){this.scene.attr({...e});const{width:s,height:t}=e;this.scene.width=s,this.scene.height=t,this.updateLayer({width:s,height:t})}updateLayer(e){const{width:s,height:t}=e;this.fullLayer.parent.setAttribute("width",s),this.fullLayer.parent.setAttribute("height",t),this.fullLayer.setAttribute("size",[s,t]),this.fullLayer.setAttribute("pos",[s*.5,t*.5]),this.topLayer.parent.setAttribute("width",s),this.topLayer.parent.setAttribute("height",t),this.topLayer.setAttribute("size",[s,t]),this.topLayer.setAttribute("pos",[s*.5,t*.5]),this.localLayer.parent.setAttribute("width",s),this.localLayer.parent.setAttribute("height",t),this.localLayer.setAttribute("size",[s,t]),this.localLayer.setAttribute("pos",[s*.5,t*.5]),this.serviceLayer.parent.setAttribute("width",s),this.serviceLayer.parent.setAttribute("height",t),this.serviceLayer.setAttribute("size",[s,t]),this.serviceLayer.setAttribute("pos",[s*.5,t*.5])}destroy(){this.clearCacheImages(),this.clearImageResolveMap(),this.vNodes.clear(),this.fullLayer.remove(),this.topLayer.remove(),this.localLayer.remove(),this.serviceLayer.remove(),this.scene.remove(),this.localWork.destroy(),this.serviceWork.destroy(),this.topWork.destroy()}}class Ie{constructor(e,s){u(this,"viewId"),u(this,"fullLayer"),u(this,"master"),u(this,"opt"),u(this,"scene"),u(this,"mainThreadPostId"),u(this,"combinePostMsg",new Set),u(this,"workShapes",new Map),u(this,"cacheImages",new Map),u(this,"imageResolveMap",new Map),this.viewId=e,this.opt=s,this.scene=this.createScene({...s.canvasOpt,container:s.container}),this.master=s.master,this.fullLayer=this.createLayer("fullLayer",this.scene,{...s.layerOpt,bufferSize:this.viewId===A?6e3:3e3})}getCachedImages(e){var s;return(s=this.cacheImages.get(e))==null?void 0:s.imageBitmap}getCachedImagesByWorkId(e){for(const[s,t]of this.cacheImages.entries())if(s===e&&t.imageBitmap)return t.imageBitmap}deleteCachedImagesByWorkId(e){for(const[s,t]of this.cacheImages.entries())t.workId===e&&(t.imageBitmap.close(),this.cacheImages.delete(s))}clearCacheImages(){this.cacheImages.forEach(e=>e.imageBitmap.close()),this.cacheImages.clear()}clearImageResolveMap(){this.imageResolveMap.forEach(({timer:e})=>{e&&clearTimeout(e)}),this.imageResolveMap.clear()}post(e){this.combinePostMsg.add(e),this.runBatchPostData()}async on(e){const{msgType:s,imageSrc:t,imageBitmap:o,workId:r}=e;switch(s){case d.Snapshot:await this.getSnapshot(e),this.destroy();return;case d.BoundingBox:await this.getBoundingRect(e),this.destroy();return;case d.GetImageBitMap:if(t&&o&&r){const a=r.toString();this.deleteCachedImagesByWorkId(a),this.cacheImages.set(t,{imageBitmap:o,workId:a});const i=this.imageResolveMap.get(t);if(i){const{resolve:n,timer:l}=i;l&&clearTimeout(l),n&&n(t)}}break}}getIconSize(e,s){const t=e*3,o=s*3;return t<=50||o<=50?[50,50]:t<=100||o<=100?[100,100]:t<=400||o<=400?[400,400]:t<=800||o<=800?[800,800]:t<=1600||o<=1600?[1600,1600]:[2e3,2e3]}async loadImageBitMap(e){const{toolsType:s,opt:t,workId:o}=e;if(s===k.Image&&t&&o){const r=o.toString(),{src:a,type:i,width:n,height:l,strokeColor:h}=t;if(!a||!i||!n||!l)return;let c=a;if(i===X.Iconify){const[p,S]=this.getIconSize(n,l);c=`${a}?width=${p}&height=${S}&color=${h}`}if(this.cacheImages.has(c)){const p=this.getCachedImages(c);if(p)return p}if(this.imageResolveMap.has(c)){const p=this.getCachedImagesByWorkId(r);if(p)return p}const m=await new Promise(p=>{const S=this.imageResolveMap.get(c)||{resolve:void 0,timer:void 0};S.timer&&clearTimeout(S.timer),S.resolve=p,S.timer=setTimeout(()=>{const y=this.imageResolveMap.get(c);y!=null&&y.resolve&&y.resolve(c)},5e3),this.imageResolveMap.set(c,S),this.opt.post({sp:[{imageSrc:c,workId:r,viewId:this.viewId,isgl:!!this.fullLayer.parent.gl,isSubWorker:!0,type:d.GetImageBitMap}]})});return this.imageResolveMap.delete(m),this.getCachedImages(c)}}createWorkShapeNode(e){return P({...e,fullLayer:this.fullLayer,drawLayer:void 0})}setFullWork(e){const{workId:s,opt:t,toolsType:o}=e;if(s&&t&&o){const r=s.toString();let a;return s&&this.workShapes.has(r)?(a=this.workShapes.get(r),a==null||a.setWorkOptions(t)):a=this.createWorkShapeNode({toolsOpt:t,toolsType:o,workId:r}),a?(this.workShapes.set(r,a),a):void 0}}async runFullWork(e){var s;const t=this.setFullWork(e),o=e.ops&&M(e.ops);if(t){let r,a;const i=(s=t.getWorkId())==null?void 0:s.toString();return t.toolsType===k.Image?r=await t.consumeServiceAsync({isFullWork:!0,worker:this}):t.toolsType===k.Text?r=await t.consumeServiceAsync({isFullWork:!0,replaceId:i,isDrawLabel:!0}):(r=t.consumeService({op:o,isFullWork:!0,replaceId:i}),a=(e==null?void 0:e.updateNodeOpt)&&t.updataOptService(e.updateNodeOpt)),B(r,a)}}async getSnapshot(e){const{scenePath:s,scenes:t,cameraOpt:o,w:r,h:a}=e;if(s&&t&&o){this.setCameraOpt(o);let i;for(const[l,h]of Object.entries(t))if(h!=null&&h.type)switch(h==null?void 0:h.type){case d.UpdateNode:case d.FullWork:{const{opt:c}=h,m={...h,opt:c,workId:l,msgType:d.FullWork,dataType:f.Service,viewId:this.viewId},p=await this.runFullWork(m);i=B(i,p);break}}let n;r&&a&&(n={resizeWidth:r,resizeHeight:a}),await this.getSnapshotRender({scenePath:s,options:n})}}getSceneRect(){const{width:e,height:s}=this.scene;return{x:0,y:0,w:Math.floor(e),h:Math.floor(s)}}getRectImageBitmap(e,s){const t=Math.floor(e.x*this.opt.displayer.dpr),o=Math.floor(e.y*this.opt.displayer.dpr),r=e.w>0&&Math.floor(e.w*this.opt.displayer.dpr||1)||1,a=e.h>0&&Math.floor(e.h*this.opt.displayer.dpr||1)||1;return createImageBitmap(this.fullLayer.parent.canvas,t,o,r,a,s)}async getSnapshotRender(e){var s,t;const{scenePath:o,options:r}=e;((s=this.fullLayer)==null?void 0:s.parent).render();const a=await this.getRectImageBitmap(this.getSceneRect(),r);a&&(this.post({sp:[{type:d.Snapshot,scenePath:o,imageBitmap:a,viewId:this.viewId}]}),(t=this.fullLayer)==null||t.removeAllChildren())}async getBoundingRect(e){const{scenePath:s,scenes:t,cameraOpt:o}=e;if(s&&t&&o){this.setCameraOpt(o);let r;for(const[a,i]of Object.entries(t))if(i!=null&&i.type)switch(i==null?void 0:i.type){case d.UpdateNode:case d.FullWork:{const n=await this.runFullWork({...i,workId:a,msgType:d.FullWork,dataType:f.Service,viewId:this.viewId});r=B(r,n);break}}r&&this.post({sp:[{type:d.BoundingBox,scenePath:s,rect:r}]})}}setCameraOpt(e){const{scale:s,centerX:t,centerY:o,width:r,height:a}=e;this.updateScene({width:r,height:a}),this.fullLayer.setAttribute("scale",[s,s]),this.fullLayer.setAttribute("translate",[-t,-o])}runBatchPostData(){this.mainThreadPostId||(this.mainThreadPostId=requestAnimationFrame(this.combinePost.bind(this)))}combinePostData(){var e;this.mainThreadPostId=void 0;const s=[];for(const t of this.combinePostMsg.values())if((e=t.sp)!=null&&e.length)for(const o of t.sp){let r=!1;for(const a of s)if(te(o,a)){r=!0;break}r||s.push(o)}return this.combinePostMsg.clear(),{sp:s}}combinePost(){var e,s;const t=this.combinePostData(),o=(e=t.sp)==null?void 0:e.filter(r=>r.type!==d.None||r.isLockSentEventCursor);o!=null&&o.length?t.sp=o.map(r=>r.viewId?r:{...r,viewId:this.viewId}):delete t.sp,(t!=null&&t.drawCount||(s=t.sp)!=null&&s.length)&&this.opt.post(t)}createScene(e){return new _({displayRatio:this.opt.displayer.dpr,depth:!1,desynchronized:!0,...e,autoRender:!1,contextType:"2d"})}createLayer(e,s,t){const{width:o,height:r}=t,a=`canvas-${e}`,i=s.layer(a,t),n=new Q({anchor:[.5,.5],pos:[o*.5,r*.5],size:[o,r],name:"viewport",id:e});return i.append(n),n}updateScene(e){this.scene.attr({...e});const{width:s,height:t}=e;this.scene.width=s,this.scene.height=t,this.updateLayer({width:s,height:t})}updateLayer(e){const{width:s,height:t}=e;this.fullLayer.parent.setAttribute("width",s),this.fullLayer.parent.setAttribute("height",t),this.fullLayer.setAttribute("size",[s,t]),this.fullLayer.setAttribute("pos",[s*.5,t*.5])}destroy(){this.clearCacheImages(),this.clearImageResolveMap(),this.fullLayer.remove(),this.scene.remove()}}class Te{constructor(e){u(this,"mainThreadMap",new Map),u(this,"snapshotThread"),u(this,"master"),this.master=e}post(e){const{drawCount:s,sp:t,workerTasksqueueCount:o}=e;this.master.isBusy&&q(o)&&this.master.setWorkerTasksqueueCount(o),q(s)&&this.master.setMaxDrawCount(s),t&&this.master.collectorSyncData(t)}destroy(){this.mainThreadMap.clear()}createMainThread(e,s){return new ge(e,s)}createSnapshotThread(e,s){return new Ie(e,s)}async consume(e){var s,t,o,r;for(const a of e.values()){const{msgType:i,viewId:n,tasksqueue:l,mainTasksqueueCount:h,layerOpt:c,offscreenCanvasOpt:m,cameraOpt:p,isSubWorker:S}=a;if(i===d.Console){console.log(this);continue}if(i===d.Init){const I=(s=this.master.control.viewContainerManager.getView(n))==null?void 0:s.displayer,w=I==null?void 0:I.canvasContainerRef.current;if(I&&w&&c&&m){const g=this.createMainThread(n,{displayer:I,container:w,layerOpt:c,master:this.master,canvasOpt:m,post:this.post.bind(this)});this.mainThreadMap.set(n,g),g&&p&&g.setCameraOpt(p)}continue}if((i===d.Snapshot||i===d.BoundingBox)&&n===((t=this.master.control.viewContainerManager.mainView)==null?void 0:t.id)){const I=(o=this.master.control.viewContainerManager.getView(n))==null?void 0:o.displayer,w=(r=I.snapshotContainerRef)==null?void 0:r.current;if(I&&w&&p){w.style.width=`${p.width}px`,w.style.height=`${p.height}px`;const g={...H.defaultLayerOpt,offscreen:!1,width:p.width,height:p.height},v={...H.defaultScreenCanvasOpt,width:p.width,height:p.height};this.snapshotThread=this.createSnapshotThread(n,{displayer:I,container:w,layerOpt:g,master:this.master,canvasOpt:v,post:this.post.bind(this)}),this.snapshotThread.on(a).then(()=>{this.snapshotThread=void 0,w.innerHTML="",w.style.width="",w.style.height=""});continue}}if(i===d.GetImageBitMap&&S&&this.snapshotThread){this.snapshotThread.on(a);continue}if(i===d.TasksQueue&&l!=null&&l.size){for(const[I,w]of this.mainThreadMap.entries()){const g=l.get(I);g&&(await w.on(g),h&&this.post({workerTasksqueueCount:h}))}continue}if(n===J){for(const I of this.mainThreadMap.values())I.on(a),i===d.Destroy&&this.mainThreadMap.delete(n);continue}const y=this.mainThreadMap.get(n);y&&(y.on(a),i===d.Destroy&&this.mainThreadMap.delete(n))}}}export{Te as MainThreadManagerImpl};
