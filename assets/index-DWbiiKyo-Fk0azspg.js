import{o as $,z as h,W as j,k as J,B as U,a as A,R as I,F as w,V as L,P as W,C as u,l as R,U as V,Y as q,q as Y,_ as Z,b as _,c as z,d as x,g as P,e as ee,h as M,f as te,i as se,j as oe,X as re,m as B,O as ae,n as ie,p as X,r as le,s as H}from"./index-WPaopvIM.js";var ne=Object.defineProperty,ce=(N,e,t)=>e in N?ne(N,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):N[e]=t,d=(N,e,t)=>ce(N,typeof e!="symbol"?e+"":e,t);class he{constructor(e,t){d(this,"viewId"),d(this,"scene"),d(this,"fullLayer"),d(this,"curNodeMap",new Map),d(this,"targetNodeMap",[]),d(this,"highLevelIds"),d(this,"canClearUids"),d(this,"localUid"),this.viewId=e,this.scene=t}init(e){this.fullLayer=e}get(e){return this.curNodeMap.get(e)}setLocalUid(e){this.localUid=e}getLocalUid(){return this.localUid}setCanClearUids(e){this.canClearUids=e}getCanClearUids(){return this.canClearUids}getCanEraserNodes(e){const t=new Map;for(const[s,o]of e.entries())o.toolsType===u.Image&&o.opt.locked||o.toolsType===u.Text&&(o.opt.workState===W.Doing||o.opt.workState===W.Start)||this.isCanClearWorkId(s)&&t.set(s,o);return t}getNodesByType(e){const t=new Map;return this.curNodeMap.forEach((s,o)=>{s.toolsType===e&&t.set(o,s)}),t}hasRenderNodes(){return!0}has(e){return this.curNodeMap.has(e)}setInfo(e,t){const s=this.curNodeMap.get(e)||{name:e,rect:t.rect};t.rect&&(s.rect=M(t.rect)),t.op&&te(t.op)&&(s.op=M(t.op)),t.canRotate&&(s.canRotate=t.canRotate),t.scaleType&&(s.scaleType=t.scaleType),t.opt&&(s.opt=M(t.opt)),t.toolsType&&(s.toolsType=t.toolsType),t.centerPos&&(s.centerPos=M(t.centerPos)),se(t.isSelected)&&(s.isSelected=t.isSelected),s.rect?this.curNodeMap.set(e,s):this.curNodeMap.delete(e)}selected(e){this.setInfo(e,{isSelected:!0})}unSelected(e){this.setInfo(e,{isSelected:!1})}delete(e){this.curNodeMap.delete(e)}clear(){this.curNodeMap.clear(),this.targetNodeMap.length=0}getRectIntersectRange(e,t=!0,s=!0){let o;const r=new Map;for(const[a,i]of this.curNodeMap.entries())if(oe(e,i.rect)){if(t&&i.toolsType===u.Image&&i.opt.locked||s&&i.toolsType===u.Text&&(i.opt.workState===W.Doing||i.opt.workState===W.Start))continue;o=P(o,i.rect),r.set(a,i)}return{rectRange:o,nodeRange:r}}getNodeRectFormShape(e,t){const s=re(t.toolsType);return this.fullLayer&&(s==null?void 0:s.getRectFromLayer(this.fullLayer,e))}updateNodeRect(e){const t=this.curNodeMap.get(e);if(t){const s=this.getNodeRectFormShape(e,t);if(!s){this.curNodeMap.delete(e);return}t.rect=s,this.curNodeMap.set(e,t)}}updateHighLevelNodesRect(e){this.highLevelIds=e;for(const t of this.highLevelIds.keys())this.updateNodeRect(t)}updateLowLevelNodesRect(){var e;for(const t of this.curNodeMap.keys())(e=this.highLevelIds)!=null&&e.has(t)||this.updateNodeRect(t)}clearHighLevelIds(){this.highLevelIds=void 0}setTargetAssignKeys(e){const t=new Map;for(const s of e){const o=this.curNodeMap.get(s);o&&t.set(s,M(o))}return this.targetNodeMap.push(M(t)),this.targetNodeMap.length-1}setTarget(){return this.targetNodeMap.push(M(this.curNodeMap)),this.targetNodeMap.length-1}getLastTarget(){return this.targetNodeMap[this.targetNodeMap.length-1]}deleteLastTarget(){this.targetNodeMap.length&&(this.targetNodeMap.length=this.targetNodeMap.length-1)}getTarget(e){return this.targetNodeMap[e]}deleteTarget(e){this.targetNodeMap.length=e}clearTarget(){this.targetNodeMap.length=0}isLocalWorkId(e){return e.split(B).length===1}isCanClearWorkId(e){if(this.canClearUids===void 0||this.canClearUids===!0)return!0;if(ae(this.canClearUids)){const t=e.split(B);if(t.length===1)return this.canClearUids.has("localSelf")||this.localUid&&this.canClearUids.has(this.localUid);if(t.length===2)return this.canClearUids.has(t[0])}return!1}}class pe{constructor(e){d(this,"vNodes"),d(this,"thread"),d(this,"serviceWorkShapes",new Map),d(this,"localWorkShapes",new Map),d(this,"tmpOpt"),d(this,"animationId"),d(this,"syncUnitTime",U.syncOpt.interval),this.vNodes=e.vNodes,this.thread=e.thread}createLocalWork(e){const{workId:t,opt:s,toolsType:o}=e;if(t&&s){const r=t.toString();!this.getToolsOpt()&&o&&this.setToolsOpt({toolsType:o,toolsOpt:s}),this.setWorkOptions(r,s)}}getLocalWorkShape(e){return this.localWorkShapes.get(e)}createLocalWorkShape(e,t){if(e&&this.tmpOpt){const s={toolsType:this.tmpOpt.toolsType,toolsOpt:t||this.tmpOpt.toolsOpt},o=this.createWorkShapeNode({...s,workId:e});return o&&this.localWorkShapes.set(e,{node:o,toolsType:o.toolsType,workState:W.Start}),o}}canUseTopLayer(e){return e===u.LaserPen}destroy(){this.clearAll()}clearAll(){this.thread.topLayer.children.length&&(this.thread.topLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),this.thread.serviceLayer.removeAllChildren()),this.serviceWorkShapes.clear(),this.localWorkShapes.clear()}consumeDraw(e){const{workId:t,dataType:s}=e;if(s===w.Service)this.activeServiceWorkShape(e);else{const o=t==null?void 0:t.toString(),r=o&&this.localWorkShapes.get(o);if(!r)return;const a=r.node.consume({data:e,isFullWork:!1,isSubWorker:!0});a.rect&&(r.result=a,r.workState=W.Doing,o&&this.localWorkShapes.set(o,r))}this.runAnimation()}setToolsOpt(e){var t;this.tmpOpt=e,(t=e.toolsOpt)!=null&&t.syncUnitTime&&(this.syncUnitTime=e.toolsOpt.syncUnitTime)}getToolsOpt(){return this.tmpOpt}createWorkShapeNode(e){const{toolsType:t}=e;if(t===u.LaserPen)return z({...e,vNodes:this.vNodes,fullLayer:this.thread.topLayer,drawLayer:this.thread.topLayer})}setNodeKey(e,t,s,o){return t.toolsType=s,t.node=this.createWorkShapeNode({workId:e,toolsType:s,toolsOpt:o}),t}activeServiceWorkShape(e){var t,s;const{workId:o,opt:r,toolsType:a,type:i,updateNodeOpt:n,ops:l,op:c}=e;if(!o)return;const p=o.toString(),k=(t=this.vNodes.get(p))==null?void 0:t.rect;if(!((s=this.serviceWorkShapes)!=null&&s.has(p))){let T={toolsType:a,animationWorkData:c||[],animationIndex:0,type:i,updateNodeOpt:n,ops:l,oldRect:k};a&&r&&(T=this.setNodeKey(p,T,a,r)),this.serviceWorkShapes.set(p,T)}const S=this.serviceWorkShapes.get(p);i&&(S.type=i),l&&(S.animationWorkData=x(l),S.ops=l),n&&(S.updateNodeOpt=n),c&&(S.animationWorkData=c),S.node&&S.node.getWorkId()!==p&&S.node.setWorkId(p),k&&(S.oldRect=k),a&&r&&(S.toolsType!==a&&a&&r&&this.setNodeKey(p,S,a,r),S.node&&S.node.setWorkOptions(r))}computNextAnimationIndex(e,t){var s;const o=((s=e.node)==null?void 0:s.syncUnitTime)||this.syncUnitTime,r=Math.floor((e.animationWorkData||[]).slice(e.animationIndex).length*32/t/o)*t;return Math.min((e.animationIndex||0)+(r||t),(e.animationWorkData||[]).length)}animationDraw(){var e,t,s,o;this.animationId=void 0;let r=!1;const a=new Map,i=[];for(const[n,l]of this.serviceWorkShapes.entries())switch(l.toolsType){case u.LaserPen:{const c=this.computNextAnimationIndex(l,8),p=Math.max(0,l.animationIndex||0),k=(l.animationWorkData||[]).slice(p,c);if((l.animationIndex||0)<c&&((e=l.node)==null||e.consumeService({op:k,isFullWork:!1}),l.animationIndex=c,k.length&&a.set(n,{workState:p===0?W.Start:c===((t=l.animationWorkData)==null?void 0:t.length)?W.Done:W.Doing,op:k.slice(-2)})),l.isDel){(s=l.node)==null||s.clearTmpPoints(),this.serviceWorkShapes.delete(n);break}l.ops&&l.animationIndex===((o=l.animationWorkData)==null?void 0:o.length)&&!l.isDel&&(this.thread.topLayer.getElementsByName(n.toString())[0]||(l.isDel=!0,this.serviceWorkShapes.set(n,l))),r=!0;break}}for(const[n,l]of this.localWorkShapes.entries()){const{result:c,toolsType:p,isDel:k,workState:S}=l;switch(p){case u.LaserPen:{if(k){l.node.clearTmpPoints(),this.localWorkShapes.delete(n),i.push({removeIds:[n.toString()],type:h.RemoveNode});break}c&&((c.op||c.ops)&&i.push(c),l.result=void 0),!this.thread.topLayer.getElementsByName(n.toString())[0]&&S===W.Done&&(l.isDel=!0,this.localWorkShapes.set(n,l)),r=!0;break}}}r&&this.runAnimation(),a.size&&a.forEach((n,l)=>{i.push({type:h.Cursor,uid:l.split(B)[0],op:n.op,workState:n.workState,viewId:this.thread.viewId})}),i.length&&this.thread.post({sp:i})}runAnimation(){this.animationId||(this.animationId=requestAnimationFrame(this.animationDraw.bind(this)))}setWorkOptions(e,t){var s;let o=(s=this.localWorkShapes.get(e))==null?void 0:s.node;if(!o&&this.tmpOpt){const{toolsType:r}=this.tmpOpt;this.tmpOpt.toolsOpt=t,o=this.createWorkShapeNode({workId:e,toolsType:r,toolsOpt:t}),o&&this.localWorkShapes.set(e,{node:o,toolsType:r,workState:W.Start}),this.setToolsOpt(this.tmpOpt)}t!=null&&t.syncUnitTime||(t.syncUnitTime=this.syncUnitTime),o&&o.setWorkOptions(t)}consumeDrawAll(e){const{workId:t,dataType:s}=e;if(s===w.Service)this.activeServiceWorkShape(e);else{const o=t==null?void 0:t.toString(),r=o&&this.localWorkShapes.get(o);if(!r)return;const a=r.node.consumeAll({data:e});r.result=a,r.workState=W.Done,o&&this.localWorkShapes.set(o,r)}this.runAnimation()}}class de{constructor(e){d(this,"vNodes"),d(this,"thread"),d(this,"workShapes",new Map),d(this,"effectSelectNodeData",new Set),d(this,"batchEraserRemoveNodes",new Set),d(this,"batchEraserWorks",new Set),d(this,"tmpOpt"),d(this,"syncUnitTime",U.syncOpt.interval),d(this,"drawCount",0),d(this,"drawWorkActiveId"),d(this,"batchEraserCombine",ie(()=>{this.updateBatchEraserCombineNode(this.batchEraserWorks,this.batchEraserRemoveNodes),this.batchEraserWorks.clear(),this.batchEraserRemoveNodes.clear()},100,{leading:!1})),this.vNodes=e.vNodes,this.thread=e.thread}async loadImageBitMap(e){return this.thread.loadImageBitMap(e)}createLocalWork(e){const{workId:t,opt:s,toolsType:o}=e;if(t&&s){const r=t.toString();!this.getToolsOpt()&&o&&this.setToolsOpt({toolsType:o,toolsOpt:s}),this.setWorkOptions(r,s)}}workShapesDone(e,t){for(const s of this.workShapes.keys())this.consumeDrawAll({workId:s,scenePath:e,viewId:this.thread.viewId,msgType:h.DrawWork,dataType:w.Local},t)}async updateSelector(e){var t;const s=this.workShapes.get(L);if(!((t=s==null?void 0:s.selectIds)!=null&&t.length))return;const{callback:o,...r}=e,{updateSelectorOpt:a,willSerializeData:i}=r,n=await(s==null?void 0:s.updateSelector({updateSelectorOpt:a,selectIds:R.cloneDeep(s.selectIds),vNodes:this.vNodes,willSerializeData:i,worker:this})),l=new Map;let c;n!=null&&n.selectIds&&(c=R.xor(s.selectIds,n.selectIds),n.selectIds.forEach(S=>{const T=this.vNodes.get(S);if(T){const{toolsType:v,op:g,opt:m}=T;l.set(S,{opt:m,toolsType:v,ops:(g==null?void 0:g.length)&&X(g)||void 0})}}),s.selectIds=n.selectIds);const p=[],k=o&&o({res:n,workShapeNode:s,param:r,postData:{sp:p},newServiceStore:l})||{sp:p};c&&k.sp.push({type:h.RemoveNode,removeIds:c,viewId:this.thread.viewId}),k.sp.length&&this.thread.post(k)}destroy(){this.clearAll()}clearAll(){if(this.thread.localLayer.children.length&&(this.thread.topLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),this.thread.localLayer.removeAllChildren()),this.workShapes.get(L)){const e=[];e.push({type:h.Select,dataType:w.Local,selectIds:[],willSyncService:!1}),this.thread.post({sp:e})}this.workShapes.clear(),this.effectSelectNodeData.clear(),this.batchEraserWorks.clear(),this.batchEraserRemoveNodes.clear()}async checkTextActive(e){const{op:t,viewId:s,dataType:o}=e;if(t!=null&&t.length){let r;for(const a of this.vNodes.curNodeMap.values()){const{rect:i,name:n,toolsType:l,opt:c}=a,p=t[0]*this.thread.fullLayer.worldScaling[0]+this.thread.fullLayer.worldPosition[0],k=t[1]*this.thread.fullLayer.worldScaling[1]+this.thread.fullLayer.worldPosition[1];if(l===u.Text&&le([p,k],i)&&c.workState===W.Done){r=n;break}}r&&(await this.blurSelector({viewId:s,msgType:h.Select,dataType:o,isSync:!0}),this.thread.post({sp:[{type:h.GetTextActive,toolsType:u.Text,workId:r}]}))}}cursorHover(e){const{opt:t,toolsType:s,point:o}=e,r=this.setFullWork({workId:H,toolsType:s,opt:t});r&&o&&r.cursorHover(o)}updateFullSelectWork(e){var t,s,o,r,a;const i=this.workShapes.get(L),{selectIds:n}=e;if(!(n!=null&&n.length)){this.blurSelector(e);return}if(!i){const l=this.setFullWork(e);!l&&e.workId&&this.tmpOpt&&((t=this.tmpOpt)==null?void 0:t.toolsType)===u.Selector&&this.setWorkOptions(e.workId.toString(),e.opt||this.tmpOpt.toolsOpt),l&&this.updateFullSelectWork(e);return}if(i&&n!=null&&n.length){const{selectRect:l}=i.updateSelectIds(n),c=[{...e,selectorColor:((s=e.opt)==null?void 0:s.strokeColor)||i.selectorColor,strokeColor:((o=e.opt)==null?void 0:o.strokeColor)||i.strokeColor,fillColor:((r=e.opt)==null?void 0:r.fillColor)||i.fillColor,textOpt:((a=e.opt)==null?void 0:a.textOpt)||i.textOpt,canTextEdit:i.canTextEdit,canRotate:i.canRotate,scaleType:i.scaleType,type:h.Select,selectRect:l,points:i.getChildrenPoints(),willSyncService:(e==null?void 0:e.willSyncService)||!1,opt:(e==null?void 0:e.willSyncService)&&i.getWorkOptions()||void 0,canLock:i.canLock,isLocked:i.isLocked,toolsTypes:i.toolsTypes,shapeOpt:i.shapeOpt,thickness:i.thickness,useStroke:i.useStroke,strokeType:i.strokeType}];this.thread.post({sp:c})}}commandDeleteText(e){const t=this.vNodes.get(e);if(t&&t.toolsType===u.Text)return{type:h.TextUpdate,toolsType:u.Text,workId:e,dataType:w.Local}}async removeSelector(e){const{willSyncService:t}=e,s=[],o=[],r=this.workShapes.get(L);if(!r)return;const a=r.selectIds&&[...r.selectIds]||[];for(const i of a){if(this.vNodes.get(i)){const n=this.commandDeleteText(i);n&&s.push(n)}this.removeNode(i),o.push(i)}o.length&&s.push({type:h.RemoveNode,removeIds:o}),s.push({type:h.Select,selectIds:[],willSyncService:t}),await this.blurSelector(),s.length&&this.thread.post({sp:s})}removeWork(e){const{workId:t}=e,s=t==null?void 0:t.toString();s&&this.removeNode(s)}removeNode(e){var t;this.vNodes.get(e)&&((t=this.thread.fullLayer)==null||t.getElementsByName(e).forEach(s=>{s.remove()}),this.vNodes.delete(e)),this.workShapes.has(e)&&(this.thread.localLayer.getElementsByName(e).forEach(s=>{s.remove()}),this.clearWorkShapeNodeCache(e))}setFullWork(e){const{workId:t,opt:s,toolsType:o}=e;if(t&&s&&o){const r=t.toString();let a;return t&&this.workShapes.has(r)?(a=this.workShapes.get(r),a==null||a.setWorkOptions(s)):a=this.createWorkShapeNode({toolsOpt:s,toolsType:o,workId:r}),a?(this.workShapes.set(r,a),a):void 0}}async consumeFull(e){var t;const s=this.setFullWork(e),o=e.ops&&x(e.ops);if(s){const r=(t=e.workId)==null?void 0:t.toString();s.toolsType===u.Image?await s.consumeServiceAsync({isFullWork:!0,replaceId:r,worker:this}):s.toolsType===u.Text?await s.consumeServiceAsync({isFullWork:!0,replaceId:r}):s.consumeService({op:o,isFullWork:!0,replaceId:r}),e!=null&&e.updateNodeOpt&&s.updataOptService(e.updateNodeOpt);const a=[];e.workId&&this.workShapes.delete(e.workId.toString()),e.willSyncService&&a.push({opt:e.opt,toolsType:e.toolsType,type:h.FullWork,workId:e.workId,ops:e.ops,updateNodeOpt:e.updateNodeOpt,viewId:this.thread.viewId}),a.length&&this.thread.post({sp:a})}}async colloctEffectSelectWork(e){const t=this.workShapes.get(L),{workId:s,msgType:o}=e;if(t&&s&&t.selectIds&&t.selectIds.includes(s.toString())){o===h.RemoveNode?t.selectIds=t.selectIds.filter(r=>r!==s.toString()):this.effectSelectNodeData.add(e),await new Promise(r=>{setTimeout(()=>{r(!0)},0)}),await this.runEffectSelectWork(!0).then(()=>{var r;(r=this.effectSelectNodeData)==null||r.clear()});return}return e}async runEffectSelectWork(e){var t;for(const s of this.effectSelectNodeData.values()){const o=this.setFullWork(s);if(o){const r=(t=s.workId)==null?void 0:t.toString();if(o.toolsType===u.Image)await o.consumeServiceAsync({isFullWork:!0,replaceId:r,worker:this});else if(o.toolsType===u.Text)await o.consumeServiceAsync({isFullWork:!0,replaceId:r});else{const a=s.ops&&x(s.ops);o.consumeService({op:a,isFullWork:!0,replaceId:r}),s!=null&&s.updateNodeOpt&&o.updataOptService(s.updateNodeOpt)}s.workId&&this.workShapes.delete(s.workId.toString())}}this.reRenderSelector(e)}hasSelector(){return this.workShapes.has(L)}getSelector(){return this.workShapes.get(L)}reRenderSelector(e=!1){var t;const s=this.workShapes.get(L);if(!s)return;if(s&&!((t=s.selectIds)!=null&&t.length))return this.blurSelector();const o=s.reRenderSelector();o&&this.thread.post({sp:[{type:h.Select,selectIds:s.selectIds,selectRect:o,willSyncService:e,viewId:this.thread.viewId,points:s.getChildrenPoints(),textOpt:s.textOpt,selectorColor:s.selectorColor,strokeColor:s.strokeColor,fillColor:s.fillColor,canTextEdit:s.canTextEdit,canRotate:s.canRotate,scaleType:s.scaleType,opt:s.getWorkOptions()||void 0,canLock:s.canLock,isLocked:s.isLocked,toolsTypes:s.toolsTypes,shapeOpt:s.shapeOpt,thickness:s.thickness,useStroke:s.useStroke,strokeType:s.strokeType}]})}async blurSelector(e){var t;const s=this.workShapes.get(L),o=s==null?void 0:s.blurSelector();if(this.clearWorkShapeNodeCache(L),((t=this.thread.fullLayer)==null?void 0:t.parent).children.forEach(r=>{r.name===L&&r.remove()}),o){const r=[];r.push({...o,isSync:e==null?void 0:e.isSync}),this.thread.post({sp:r})}}clearWorkShapeNodeCache(e){var t;(t=this.getWorkShape(e))==null||t.clearTmpPoints(),this.workShapes.delete(e)}drawBitMapEraser(e){const t=[];e.op&&t.push(e),t.length&&this.thread.post({sp:t})}async drawBitMapEraserFull(e,t,s){const{willUpdateNodes:o,scenePath:r,...a}=t,i=e.getWorkId(),n=[{...a,workId:i,scenePath:r,updateNodeOpt:{useAnimation:!1},isSync:!0,nextTasks:[{type:h.RemoveNode,removeIds:[i],viewId:this.thread.viewId}]}];if(s&&n.push({type:h.None,isLockSentEventCursor:s}),o!=null&&o.size){await(e==null?void 0:e.reRenderEffectNodes({willUpdateNodes:o,worker:this}));for(const[l,c]of o)n.push({type:h.UpdateNode,dataType:w.Local,opt:c.opt,workId:l,updateNodeOpt:{useAnimation:!1}})}n.length&&this.thread.post({sp:n})}drawPencilEraser(e,t){var s,o;const r=[];if((s=e.newWorkDatas)!=null&&s.size){for(const a of e.newWorkDatas.values()){const i=a.workId.toString();this.batchEraserWorks.add(i),r.push({type:h.FullWork,workId:i,ops:X(a.op),opt:a.opt,toolsType:a.toolsType,updateNodeOpt:{useAnimation:!1}})}delete e.newWorkDatas}(o=e.removeIds)==null||o.forEach(a=>{this.batchEraserRemoveNodes.add(a)}),t&&r.push({type:h.None,isLockSentEventCursor:t}),e.rect,this.thread.post({sp:r}),this.batchEraserCombine()}drawEraser(e,t){const s=[];e.removeIds&&s.push(e),t&&s.push({type:h.None,isLockSentEventCursor:t}),this.thread.post({sp:s})}updateBatchEraserCombineNode(e,t){for(const s of t.keys())this.thread.fullLayer.getElementsByName(s).forEach(o=>{o.remove()});e.forEach(s=>{const o=this.vNodes.get(s);if(o&&o.toolsType===u.Pencil&&!this.thread.fullLayer.getElementsByName(s)[0]){const r=this.setFullWork({...o,workId:s});r&&r.consumeService({op:o.op,isFullWork:!0})}})}getWorkShape(e){return this.workShapes.get(e)}getWorkShapes(){return this.workShapes}consumeDraw(e,t){const{op:s,workId:o,scenePath:r}=e;if(s!=null&&s.length&&o){const a=o.toString(),i=this.workShapes.get(a);if(!i)return;const n=i.toolsType;if(n===u.LaserPen)return;switch(this.drawWorkActiveId&&this.drawWorkActiveId!==a&&(this.consumeDrawAll({workId:this.drawWorkActiveId,scenePath:r,viewId:this.thread.viewId,msgType:h.DrawWork,dataType:w.Local},t),this.drawWorkActiveId=void 0),!this.drawWorkActiveId&&a!==L&&(this.drawWorkActiveId=a),n){case u.Selector:{const l=i.consume({data:e,isFullWork:!0});l.type===h.Select&&(l.selectIds&&t.runReverseSelectWork(l.selectIds),this.thread.post({sp:[l]}))}break;case u.PencilEraser:{const l=i.consume({data:e,isFullWork:!0});l!=null&&l.rect&&this.drawPencilEraser(l)}break;case u.BitMapEraser:{const l=i.consume({data:e,isFullWork:!0});l!=null&&l.rect&&this.drawBitMapEraser(l);break}case u.Eraser:{const l=i.consume({data:e,isFullWork:!0});l!=null&&l.rect&&this.drawEraser(l)}break;case u.Arrow:case u.Straight:case u.Ellipse:case u.Rectangle:case u.Star:case u.Polygon:case u.SpeechBalloon:case u.Pencil:{const l=i.consume({data:e,isFullWork:!1,isMainThread:!0});l&&(this.drawCount++,this.thread.post({drawCount:this.drawCount,sp:l.op&&[{...l,scenePath:r}]||void 0}))}break}}}consumeDrawAll(e,t){var s,o,r,a;const{workId:i,scenePath:n,isLockSentEventCursor:l}=e;if(i){const c=i.toString();this.drawWorkActiveId===c&&(this.drawWorkActiveId=void 0);const p=this.workShapes.get(c);if(!p)return;const k=p.toolsType;if(k===u.LaserPen)return;const S=this.workShapes.get(H),T=(s=S==null?void 0:S.selectIds)==null?void 0:s[0],v=p.consumeAll({data:e});switch(k){case u.Selector:v.selectIds&&T&&(o=v.selectIds)!=null&&o.includes(T)&&S.cursorBlur(),v.type===h.Select&&(v.selectIds&&t.runReverseSelectWork(v.selectIds),this.thread.post({sp:[{...v,scenePath:n}]})),(r=p.selectIds)!=null&&r.length?p.clearTmpPoints():this.clearWorkShapeNodeCache(c);break;case u.PencilEraser:this.drawPencilEraser({...v,scenePath:n},l),p.clearTmpPoints();break;case u.BitMapEraser:(v.rect||(a=v.newWorkDatas)!=null&&a.size)&&this.drawBitMapEraserFull(p,v,l);break;case u.Eraser:this.drawEraser({...v,scenePath:n},l),p.clearTmpPoints();break;case u.Arrow:case u.Straight:case u.Ellipse:case u.Rectangle:case u.Star:case u.Polygon:case u.SpeechBalloon:case u.Pencil:{const g=[];l&&g.push({type:h.None,isLockSentEventCursor:l}),v&&(g.push(v),this.drawCount=0,this.thread.post({drawCount:this.drawCount,sp:g})),this.clearWorkShapeNodeCache(c);break}}}}getToolsOpt(){return this.tmpOpt}setToolsOpt(e){var t;this.tmpOpt=e,(t=e.toolsOpt)!=null&&t.syncUnitTime&&(this.syncUnitTime=e.toolsOpt.syncUnitTime)}setWorkOptions(e,t){let s=this.workShapes.get(e);if(!s&&this.tmpOpt){const{toolsType:o}=this.tmpOpt;this.tmpOpt.toolsOpt=t,s=this.createWorkShapeNode({workId:e,toolsType:o,toolsOpt:t}),s&&this.workShapes.set(e,s),this.setToolsOpt(this.tmpOpt)}t.syncUnitTime||(t.syncUnitTime=this.syncUnitTime),s==null||s.setWorkOptions(t)}createWorkShapeNode(e){return z({...e,vNodes:this.vNodes,fullLayer:this.thread.fullLayer,drawLayer:this.thread.localLayer},this.thread.serviceWork)}}class ue{constructor(e){d(this,"vNodes"),d(this,"thread"),d(this,"workShapes",new Map),d(this,"selectorWorkShapes",new Map),d(this,"willRunEffectSelectorIds",new Set),d(this,"runEffectId"),d(this,"animationId"),d(this,"syncUnitTime",U.syncOpt.interval),this.vNodes=e.vNodes,this.thread=e.thread}async loadImageBitMap(e){return this.thread.loadImageBitMap(e)}destroy(){this.clearAll()}clearAll(){this.thread.serviceLayer.children.length&&(this.thread.serviceLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),this.thread.serviceLayer.removeAllChildren()),this.workShapes.clear(),this.selectorWorkShapes.clear(),this.willRunEffectSelectorIds.clear()}runEffect(){this.runEffectId||(this.runEffectId=setTimeout(this.effectRunSelector.bind(this),0))}effectRunSelector(){this.runEffectId=void 0,this.willRunEffectSelectorIds.forEach(e=>{var t,s;const o=this.selectorWorkShapes.get(e);o&&o.selectIds&&((t=o.node)==null||t.selectServiceNode(e,o,!0)),(s=o==null?void 0:o.selectIds)!=null&&s.length||this.selectorWorkShapes.delete(e)}),this.willRunEffectSelectorIds.clear()}runSelectWork(e){this.activeSelectorShape(e);const{workId:t}=e,s=t==null?void 0:t.toString();s&&this.willRunEffectSelectorIds.add(s),this.runEffect()}removeWork(e){const{workId:t}=e,s=t==null?void 0:t.toString();if(s){if(this.workShapes.get(s)){this.workShapes.delete(s),this.removeNode(s,e);return}this.removeNode(s,e)}}consumeFull(e){this.activeWorkShape(e),this.runAnimation()}runReverseSelectWork(e){e.forEach(t=>{this.selectorWorkShapes.forEach((s,o)=>{var r;if((r=s.selectIds)!=null&&r.length){const a=s.selectIds.indexOf(t);a>-1&&(s.selectIds.splice(a,1),this.willRunEffectSelectorIds.add(o))}})}),this.willRunEffectSelectorIds.size&&this.runEffect()}consumeDraw(e){this.activeWorkShape(e),this.runAnimation()}computNextAnimationIndex(e,t){const s=Math.floor((e.animationWorkData||[]).slice(e.animationIndex).length*32/t/this.syncUnitTime)*t;return Math.min((e.animationIndex||0)+(s||t),(e.animationWorkData||[]).length)}async animationDraw(){var e,t,s,o,r,a,i,n,l,c,p,k,S,T,v;this.animationId=void 0;let g=!1;const m=new Map;for(const[f,y]of this.workShapes.entries())switch(y.toolsType){case u.Image:{await((e=y.node)==null?void 0:e.consumeServiceAsync({isFullWork:!0,worker:this})),this.selectorWorkShapes.forEach((b,E)=>{var O;(O=b.selectIds)!=null&&O.includes(f)&&(this.willRunEffectSelectorIds.add(E),this.runEffect())}),this.workShapes.delete(f);break}case u.Text:{y.node&&(await((t=y.node)==null?void 0:t.consumeServiceAsync({isFullWork:!0,replaceId:f})),this.selectorWorkShapes.forEach((b,E)=>{var O;(O=b.selectIds)!=null&&O.includes(f)&&(this.willRunEffectSelectorIds.add(E),this.runEffect())}),(s=y.node)==null||s.clearTmpPoints(),this.workShapes.delete(f));break}case u.Arrow:case u.Straight:case u.Rectangle:case u.Ellipse:case u.Star:case u.Polygon:case u.SpeechBalloon:{const b=!!y.ops;if((o=y.animationWorkData)!=null&&o.length){const E=y.oldRect;(r=y.node)==null||r.consumeService({op:y.animationWorkData,isFullWork:b}),b&&(this.selectorWorkShapes.forEach((O,D)=>{var F;(F=O.selectIds)!=null&&F.includes(f)&&(this.willRunEffectSelectorIds.add(D),this.runEffect())}),(a=y.node)==null||a.clearTmpPoints(),this.workShapes.delete(f)),m.set(f,{workState:E?y.ops?W.Done:W.Doing:W.Start,op:y.animationWorkData.filter((O,D)=>{if(D%3!==2)return!0}).slice(-2)}),y.animationWorkData.length=0}break}case u.Pencil:{if(!y.useAnimation&&y.ops)(i=y.node)==null||i.consumeService({op:y.animationWorkData||[],isFullWork:!0,replaceId:f}),(n=y.node)==null||n.updataOptService(y.updateNodeOpt),this.selectorWorkShapes.forEach((b,E)=>{var O;(O=b.selectIds)!=null&&O.includes(f)&&(this.willRunEffectSelectorIds.add(E),this.runEffect())}),(l=y.node)==null||l.clearTmpPoints(),this.workShapes.delete(f);else if(y.useAnimation){if(y.isDel){(c=y.node)==null||c.clearTmpPoints(),this.workShapes.delete(f);break}const b=3,E=this.computNextAnimationIndex(y,b),O=y.isDiff?0:Math.max(0,(y.animationIndex||0)-b),D=(y.animationWorkData||[]).slice(O,E),F=(k=(p=y.node)==null?void 0:p.getWorkId())==null?void 0:k.toString();if((y.animationIndex||0)<E||y.isDiff){if((S=y.node)==null||S.consumeService({op:D,isFullWork:!1}),y.animationIndex=E,y.isDiff&&(y.isDiff=!1),D.length){const G=D.filter((K,Q)=>{if(Q%b!==b-1)return!0}).slice(-2);m.set(f,{workState:O===0?W.Start:E===((T=y.animationWorkData)==null?void 0:T.length)?W.Done:W.Doing,op:G})}}else y.ops&&((v=y.node)==null||v.consumeService({op:y.animationWorkData||[],isFullWork:!0,replaceId:F}),y.isDel=!0,m.set(f,{workState:W.Done,op:D.filter((G,K)=>{if(K%b!==b-1)return!0}).slice(-2)}));g=!0;break}break}}if(g&&this.runAnimation(),m.size){const f=[];m.forEach((y,b)=>{f.push({type:h.Cursor,uid:b.split(B)[0],op:y.op,workState:y.workState,viewId:this.thread.viewId})}),this.thread.post({sp:f})}}runAnimation(){this.animationId||(this.animationId=requestAnimationFrame(this.animationDraw.bind(this)))}hasDiffData(e,t,s){const o=e.length;if(t.length<o)return!0;switch(s){case u.Pencil:{for(let r=0;r<o;r+=3)if(t[r]!==e[r]||t[r+1]!==e[r+1])return!0;break}case u.LaserPen:{for(let r=0;r<o;r+=2)if(t[r]!==e[r]||t[r+1]!==e[r+1])return!0;break}}return!1}activeWorkShape(e){var t,s,o,r;const{workId:a,opt:i,toolsType:n,type:l,updateNodeOpt:c,ops:p,op:k,useAnimation:S,imageBitmap:T}=e;if(!a)return;const v=a.toString(),g=(t=this.vNodes.get(v))==null?void 0:t.rect;if(!((s=this.workShapes)!=null&&s.has(v))){let f={toolsType:n,animationWorkData:k||[],animationIndex:0,type:l,updateNodeOpt:c,ops:p,useAnimation:typeof S<"u"?S:typeof(c==null?void 0:c.useAnimation)<"u"?c==null?void 0:c.useAnimation:!0,oldRect:g,isDiff:!1,imageBitmap:T};n&&i&&(f=this.setNodeKey(v,f,n,i)),(o=this.workShapes)==null||o.set(v,f)}const m=(r=this.workShapes)==null?void 0:r.get(v);l&&(m.type=l),p&&(m.animationWorkData=x(p),m.ops=p),c&&(m.updateNodeOpt=c),k&&(m.isDiff=this.hasDiffData(m.animationWorkData||[],k,m.toolsType),m.animationWorkData=k),m.node&&m.node.getWorkId()!==v&&m.node.setWorkId(v),g&&(m.oldRect=g),n&&i&&(i.syncUnitTime&&(this.syncUnitTime=i.syncUnitTime),m.toolsType!==n&&n&&i&&this.setNodeKey(v,m,n,i),m.node&&m.node.setWorkOptions(i)),T&&(m.imageBitmap=T)}removeNode(e,t){e.indexOf(L)>-1&&this.removeSelectWork(t),this.thread.fullLayer.getElementsByName(e).forEach(s=>{s.remove()}),this.thread.serviceLayer.getElementsByName(e).forEach(s=>{s.remove()}),this.vNodes.delete(e)}removeSelectWork(e){const{workId:t}=e,s=t==null?void 0:t.toString();s&&(this.activeSelectorShape(e),this.willRunEffectSelectorIds.add(s)),this.runEffect()}activeSelectorShape(e){var t,s,o;const{workId:r,opt:a,toolsType:i,type:n,selectIds:l}=e;if(!r)return;const c=r.toString();if(!((t=this.selectorWorkShapes)!=null&&t.has(c))){let k={toolsType:i,selectIds:l,type:n,opt:a};i&&a&&(k=this.setNodeKey(c,k,i,a)),(s=this.selectorWorkShapes)==null||s.set(c,k)}const p=(o=this.selectorWorkShapes)==null?void 0:o.get(c);n&&(p.type=n),p.node&&p.node.getWorkId()!==c&&p.node.setWorkId(c),p.selectIds=l||[]}setNodeKey(e,t,s,o){return t.toolsType=s,t.node=z({toolsType:s,toolsOpt:o,vNodes:this.vNodes,fullLayer:this.thread.fullLayer,drawLayer:this.thread.serviceLayer,workId:e},this),t}}class C{constructor(){d(this,"localWork"),d(this,"serviceWork"),d(this,"threadEngine")}registerMainThread(e){return this.threadEngine=e,this.localWork=e.localWork,this.serviceWork=e.serviceWork,this}}class ke extends C{constructor(){super(...arguments),d(this,"emitEventType",I.CopyNode)}async consume(e){const{msgType:t,dataType:s,emitEventType:o}=e;if(t===h.FullWork&&s===w.Local&&o===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var t;const{workId:s}=e;s&&await((t=this.localWork)==null?void 0:t.consumeFull(e))}}class Se extends C{constructor(){super(...arguments),d(this,"emitEventType",I.SetColorNode)}async consume(e){const{msgType:t,dataType:s,emitEventType:o}=e;if(t===h.UpdateNode&&s===w.Local&&o===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var t;const{workId:s,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,textUpdateForWoker:n}=e;s===L&&o&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,textUpdateForWoker:n,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:s,newServiceStore:o}=e,{willSyncService:r,isSync:a,textUpdateForWoker:i}=t,n=s.sp||[];if(r)for(const[l,c]of o.entries())i&&c.toolsType===u.Text?n.push({...c,workId:l,type:h.TextUpdate,dataType:w.Local,willSyncService:!0}):n.push({...c,workId:l,type:h.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:a});return{sp:n}}}class ye extends C{constructor(){super(...arguments),d(this,"emitEventType",I.ZIndexNode)}async consume(e){const{msgType:t,dataType:s,emitEventType:o}=e;if(t===h.UpdateNode&&s===w.Local&&o===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var t;const{workId:s,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i}=e;s===L&&o&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:s,newServiceStore:o}=e,{willSyncService:r,isSync:a}=t,i=s.sp||[];if(r&&i)for(const[n,l]of o.entries())i.push({...l,workId:n,type:h.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:a});return{sp:i}}}class me extends C{constructor(){super(...arguments),d(this,"emitEventType",I.TranslateNode)}async consume(e){const{msgType:t,dataType:s,emitEventType:o}=e;if(t===h.UpdateNode&&s===w.Local&&o===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var t,s;const{workId:o,updateNodeOpt:r,willRefreshSelector:a,willSyncService:i,willSerializeData:n,textUpdateForWoker:l,emitEventType:c}=e;o===L&&r&&(r.workState===W.Done&&r!=null&&r.translate&&(r.translate[0]||r.translate[1])||r.workState!==W.Done?await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:r,willRefreshSelector:a,willSyncService:i,willSerializeData:n,isSync:!0,textUpdateForWoker:l,emitEventType:c,callback:this.updateSelectorCallback})):r.workState===W.Done&&((s=this.localWork)==null||s.vNodes.deleteLastTarget()))}updateSelectorCallback(e){const{param:t,postData:s,newServiceStore:o,workShapeNode:r,res:a}=e,{willSyncService:i,isSync:n,updateSelectorOpt:l,textUpdateForWoker:c}=t,p=l.workState,k=s.sp||[];if(p===W.Start)return{sp:[],render:[]};const S=a==null?void 0:a.selectRect;if(i){p===W.Doing&&k.push({type:h.Select,selectIds:r.selectIds,selectRect:S,willSyncService:!0,isSync:!0,points:r.getChildrenPoints(),textOpt:r.textOpt});for(const[T,v]of o.entries())c&&v.toolsType===u.Text?k.push({...v,workId:T,type:h.TextUpdate,dataType:w.Local,willSyncService:!0}):k.push({...v,workId:T,type:h.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n})}return{sp:k}}}class ve extends C{constructor(){super(...arguments),d(this,"emitEventType",I.DeleteNode)}async consume(){return!1}}class we extends C{constructor(){super(...arguments),d(this,"emitEventType",I.ScaleNode)}async consume(e){const{msgType:t,dataType:s,emitEventType:o}=e;if(t===h.UpdateNode&&s===w.Local&&o===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var t;const{workId:s,updateNodeOpt:o,willSyncService:r,willSerializeData:a}=e;s===L&&o&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:o,willSyncService:r,willSerializeData:a,isSync:!0,callback:this.updateSelectorCallback.bind(this)}))}updateSelectorCallback(e){const{param:t,postData:s,workShapeNode:o,res:r,newServiceStore:a}=e,{updateSelectorOpt:i,willSyncService:n}=t,l=i.workState,c=s.sp||[],p=r==null?void 0:r.selectRect;if(l===W.Start)return{sp:[],render:[]};if(n){c.push({type:h.Select,selectIds:o.selectIds,selectRect:p,willSyncService:!0,isSync:!0,points:l===W.Done&&o.getChildrenPoints()||void 0,textOpt:o.textOpt});for(const[k,S]of a.entries())S.toolsType===u.Text?c.push({...S,workId:k,type:h.TextUpdate,dataType:w.Local,willSyncService:!0}):c.push({...S,workId:k,type:h.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:!0})}return{sp:c}}}class fe extends C{constructor(){super(...arguments),d(this,"emitEventType",I.RotateNode)}async consume(e){const{msgType:t,dataType:s,emitEventType:o}=e;if(t===h.UpdateNode&&s===w.Local&&o===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var t;const{workId:s,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,emitEventType:n}=e;s===L&&o&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,emitEventType:n,isSync:!0,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:s,workShapeNode:o,res:r,newServiceStore:a}=e,{updateSelectorOpt:i,willSyncService:n,willSerializeData:l,isSync:c}=t,p=i.workState,k=s.sp||[],S=r==null?void 0:r.selectRect;if(n){l&&p===W.Done&&k.push({type:h.Select,selectIds:o.selectIds,selectRect:S,willSyncService:!0,isSync:c,points:o.getChildrenPoints()});for(const[T,v]of a.entries())k.push({...v,workId:T,type:h.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:c})}return{sp:k}}}class ge extends C{constructor(){super(...arguments),d(this,"emitEventType",I.SetFontStyle)}async consume(e){const{msgType:t,dataType:s,emitEventType:o}=e;if(t===h.UpdateNode&&s===w.Local&&o===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var t;const{workId:s,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,textUpdateForWoker:n}=e;s===L&&o&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,textUpdateForWoker:n,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:s,newServiceStore:o,workShapeNode:r,res:a}=e,{willSyncService:i,isSync:n,updateSelectorOpt:l,textUpdateForWoker:c}=t,p=s.sp||[],k=a==null?void 0:a.selectRect;if(i&&p){l.fontSize&&p.push({type:h.Select,selectIds:r.selectIds,selectRect:k,willSyncService:i,isSync:n,points:r.getChildrenPoints()});for(const[S,T]of o.entries())c&&T.toolsType===u.Text?p.push({...T,workId:S,type:h.TextUpdate,dataType:w.Local,willSyncService:!0}):p.push({...T,workId:S,type:h.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n})}return{sp:p}}}class Ie extends C{constructor(){super(...arguments),d(this,"emitEventType",I.SetPoint)}async consume(e){const{msgType:t,dataType:s,emitEventType:o}=e;if(t===h.UpdateNode&&s===w.Local&&o===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var t;const{workId:s,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,textUpdateForWoker:n}=e;s===L&&o&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,emitEventType:this.emitEventType,willSerializeData:i,isSync:!0,textUpdateForWoker:n,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:s,newServiceStore:o,workShapeNode:r,res:a}=e,{willSyncService:i,isSync:n}=t,l=s.sp||[],c=a==null?void 0:a.selectRect;if(i&&l){for(const[p,k]of o.entries())l.push({...k,workId:p,type:h.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n});l.push({type:h.Select,selectIds:r.selectIds,selectRect:c,willSyncService:i,isSync:n,points:r.getChildrenPoints()})}return{sp:l}}}class Te extends C{constructor(){super(...arguments),d(this,"emitEventType",I.SetLock)}async consume(e){const{msgType:t,dataType:s,emitEventType:o}=e;if(t===h.UpdateNode&&s===w.Local&&o===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var t;const{workId:s,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i}=e;s===L&&o&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:s,newServiceStore:o,workShapeNode:r,res:a}=e,{willSyncService:i,isSync:n,updateSelectorOpt:l}=t,c=s.sp||[],p=a==null?void 0:a.selectRect;if(i&&c){for(const[k,S]of o.entries())c.push({...S,workId:k,type:h.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n});c.push({isLocked:l.isLocked,selectorColor:r.selectorColor,scaleType:r.scaleType,canRotate:r.canRotate,type:h.Select,selectIds:r.selectIds,selectRect:p,willSyncService:i,isSync:n})}return{sp:c}}}class We extends C{constructor(){super(...arguments),d(this,"emitEventType",I.SetShapeOpt)}async consume(e){const{msgType:t,dataType:s,emitEventType:o}=e;if(t===h.UpdateNode&&s===w.Local&&o===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var t;const{workId:s,updateNodeOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i}=e;s===L&&o&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:o,willRefreshSelector:r,willSyncService:a,willSerializeData:i,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:s,newServiceStore:o}=e,{willSyncService:r,isSync:a}=t,i=s.sp||[];if(r&&i)for(const[n,l]of o.entries())i.push({...l,workId:n,type:h.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:a});return{sp:i}}}class Ne{constructor(e){d(this,"builders",new Map),this.builders=new Map(e.map(t=>[t,this.build(t)]))}build(e){switch(e){case I.TranslateNode:return new me;case I.ZIndexNode:return new ye;case I.CopyNode:return new ke;case I.SetColorNode:return new Se;case I.DeleteNode:return new ve;case I.ScaleNode:return new we;case I.RotateNode:return new fe;case I.SetFontStyle:return new ge;case I.SetPoint:return new Ie;case I.SetLock:return new Te;case I.SetShapeOpt:return new We}}registerForMainThread(e){return this.builders.forEach(t=>{t&&t.registerMainThread(e)}),this}async consumeForMainThread(e){for(const t of this.builders.values())if(await(t==null?void 0:t.consume(e)))return!0;return!1}}class Le{constructor(e,t){d(this,"viewId"),d(this,"fullLayer"),d(this,"topLayer"),d(this,"localLayer"),d(this,"serviceLayer"),d(this,"snapshotFullLayer"),d(this,"vNodes"),d(this,"master"),d(this,"opt"),d(this,"cameraOpt"),d(this,"scene"),d(this,"localWork"),d(this,"serviceWork"),d(this,"topWork"),d(this,"taskUpdateCameraId"),d(this,"debounceUpdateCameraId"),d(this,"debounceUpdateCache",new Set),d(this,"mainThreadPostId"),d(this,"combinePostMsg",new Set),d(this,"methodBuilder"),d(this,"cacheImages",new Map),d(this,"imageResolveMap",new Map),this.viewId=e,this.opt=t,this.scene=this.createScene({...t.canvasOpt,container:t.container}),this.master=t.master;const s=U.bufferSize.full,o=U.bufferSize.sub;this.fullLayer=this.createLayer("fullLayer",this.scene,{...t.layerOpt,bufferSize:this.viewId===A?s:o}),this.topLayer=this.createLayer("topLayer",this.scene,{...t.layerOpt,bufferSize:(this.viewId,A,o)}),this.localLayer=this.createLayer("localLayer",this.scene,{...t.layerOpt,bufferSize:(this.viewId,A,o)}),this.serviceLayer=this.createLayer("serviceLayer",this.scene,{...t.layerOpt,bufferSize:(this.viewId,A,o)}),this.vNodes=new he(e,this.scene);const r={thread:this,vNodes:this.vNodes};this.localWork=new de(r),this.serviceWork=new ue(r),this.topWork=new pe(r),this.vNodes.init(this.fullLayer),this.methodBuilder=new Ne([I.CopyNode,I.SetColorNode,I.DeleteNode,I.RotateNode,I.ScaleNode,I.TranslateNode,I.ZIndexNode,I.SetFontStyle,I.SetPoint,I.SetLock,I.SetShapeOpt]).registerForMainThread(this)}getCachedImages(e){return this.cacheImages.get(e)}clearCacheImages(){this.cacheImages.forEach(e=>e.close()),this.cacheImages.clear()}clearImageResolveMap(){this.imageResolveMap.forEach(({timer:e})=>{e&&clearTimeout(e)}),this.imageResolveMap.clear()}post(e){this.combinePostMsg.add(e),this.runBatchPostData()}async on(e){var t;if(!await this.methodBuilder.consumeForMainThread(e)){const{msgType:s,toolsType:o,opt:r,dataType:a,workId:i,workState:n,imageSrc:l,imageBitmap:c}=e,p=i==null?void 0:i.toString();switch(s){case h.AuthClear:{const{clearUids:k,localUid:S}=e;this.vNodes.setCanClearUids(k),this.vNodes.setLocalUid(S);break}case h.Destroy:this.destroy();break;case h.Clear:this.clearAll();break;case h.UpdateCamera:await this.updateCamera(e);break;case h.UpdateTools:if(o&&r){const k={toolsType:o,toolsOpt:r};this.topWork.canUseTopLayer(o)?this.topWork.setToolsOpt(k):this.localWork.setToolsOpt(k)}break;case h.CreateWork:if(p&&r&&o){if(this.topWork.canUseTopLayer(o)){this.topWork.getToolsOpt()||this.topWork.setToolsOpt({toolsType:o,toolsOpt:r}),this.topWork.setWorkOptions(p,r);break}this.localWork.getToolsOpt()||this.localWork.setToolsOpt({toolsType:o,toolsOpt:r}),this.localWork.setWorkOptions(p,r)}break;case h.DrawWork:n===W.Done&&a===w.Local?this.consumeDrawAll(a,e):this.consumeDraw(a,e);break;case h.UpdateNode:case h.FullWork:if(o&&this.topWork.canUseTopLayer(o)){this.consumeDrawAll(a,e);break}this.consumeFull(a,e);break;case h.RemoveNode:await this.removeNode(e);return;case h.Select:a===w.Service&&(i===L?this.localWork.updateFullSelectWork(e):this.serviceWork.runSelectWork(e));break;case h.CursorHover:this.localWork.cursorHover(e);break;case h.GetTextActive:a===w.Local&&this.localWork.checkTextActive(e);break;case h.GetImageBitMap:if(l&&c&&this.cacheImages.set(l,c),i){const k=i.toString(),S=(t=this.imageResolveMap.get(k))==null?void 0:t.resolve;S&&S(k)}break}}}async loadImageBitMap(e){const{toolsType:t,opt:s,workId:o}=e;if(t===u.Image&&s&&s.src&&o){const r=s.src,a=this.cacheImages.has(r),i=o.toString();if(!a){const n=await new Promise(l=>{const c=this.imageResolveMap.get(i)||{resolve:void 0,timer:void 0};c.timer&&clearTimeout(c.timer),c.resolve=l,c.timer=setTimeout(()=>{const p=this.imageResolveMap.get(i);p!=null&&p.resolve&&p.resolve(i)},5e3),this.imageResolveMap.set(i,c),this.opt.post({sp:[{imageSrc:r,workId:i,viewId:this.viewId,isgl:!!this.fullLayer.parent.gl,isSubWorker:!1,type:h.GetImageBitMap}]})});this.imageResolveMap.delete(n)}return this.cacheImages.get(r)}}async removeNode(e){const{dataType:t,workId:s,removeIds:o}=e,r=o||[];if(s&&r.push(s.toString()),r.length)for(const a of r){if(a===L){await this.localWork.removeSelector(e);continue}t===w.Local?this.localWork.removeWork(e):t===w.Service&&this.serviceWork.removeWork(e),await this.localWork.colloctEffectSelectWork(e)}}async consumeFull(e,t){const s=await this.localWork.colloctEffectSelectWork(t);s&&e===w.Local&&await this.localWork.consumeFull(s),s&&e===w.Service&&this.serviceWork.consumeFull(s)}setCameraOpt(e){this.cameraOpt=e;const{scale:t,centerX:s,centerY:o,width:r,height:a}=e;(r!==this.scene.width||a!==this.scene.height)&&this.updateScene({width:r,height:a}),this.fullLayer.setAttribute("scale",[t,t]),this.fullLayer.setAttribute("translate",[-s,-o]),this.topLayer.setAttribute("scale",[t,t]),this.topLayer.setAttribute("translate",[-s,-o]),this.localLayer.setAttribute("scale",[t,t]),this.localLayer.setAttribute("translate",[-s,-o]),this.serviceLayer.setAttribute("scale",[t,t]),this.serviceLayer.setAttribute("translate",[-s,-o])}runBatchPostData(){this.mainThreadPostId||(this.mainThreadPostId=requestAnimationFrame(this.combinePost.bind(this)))}combinePostData(){var e;this.mainThreadPostId=void 0;const t=[];let s;for(const o of this.combinePostMsg.values()){if((e=o.sp)!=null&&e.length)for(const r of o.sp){let a=!1;for(const i of t)if(R.isEqual(r,i)){a=!0;break}a||t.push(r)}R.isNumber(o.drawCount)&&(s=o.drawCount)}return this.combinePostMsg.clear(),{sp:t,drawCount:s}}combinePost(){var e,t;const s=this.combinePostData(),o=(e=s.sp)==null?void 0:e.filter(r=>r.type!==h.None||r.isLockSentEventCursor);o!=null&&o.length?s.sp=o.map(r=>r.viewId?r:{...r,viewId:this.viewId}):delete s.sp,s.drawCount===void 0&&delete s.drawCount,(s!=null&&s.drawCount||(t=s.sp)!=null&&t.length)&&this.opt.post(s)}clearAll(){this.fullLayer.children.length&&(this.fullLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),this.fullLayer.removeAllChildren()),this.clearCacheImages(),this.clearImageResolveMap(),this.localWork.clearAll(),this.topWork.clearAll(),this.serviceWork.clearAll(),this.vNodes.clear(),this.post({sp:[{type:h.Clear}]})}consumeDrawAll(e,t){const{toolsType:s,workId:o}=t;if(o){const r=o.toString();if(s&&this.topWork.canUseTopLayer(s)){e===w.Local&&(this.topWork.getLocalWorkShape(o.toString())||this.topWork.createLocalWork(t)),this.topWork.consumeDrawAll(t);return}e===w.Local&&(this.localWork.getWorkShape(r)||this.localWork.createLocalWork(t),this.localWork.consumeDrawAll(t,this.serviceWork))}}consumeDraw(e,t){const{opt:s,workId:o,toolsType:r}=t;if(o&&r&&s){const a=o.toString();if(this.topWork.canUseTopLayer(r)){e===w.Local&&(this.topWork.getLocalWorkShape(a)||this.topWork.createLocalWork(t)),this.topWork.consumeDraw(t);return}e===w.Local?(this.localWork.getWorkShape(a)||this.localWork.createLocalWork(t),this.localWork.consumeDraw(t,this.serviceWork)):e===w.Service&&this.serviceWork.consumeDraw(t);return}}async updateCamera(e){var t;const{cameraOpt:s,scenePath:o}=e;if(s&&!R.isEqual(this.cameraOpt,s)){if(this.taskUpdateCameraId&&(clearTimeout(this.taskUpdateCameraId),this.taskUpdateCameraId=void 0),o){let l=!1;for(const[c,p]of this.localWork.getWorkShapes().entries())switch(p.toolsType){case u.Text:case u.BitMapEraser:case u.PencilEraser:case u.Eraser:case u.Selector:case u.LaserPen:break;default:c!==H&&c!==L&&(l=!0);break}if(l){this.taskUpdateCameraId=setTimeout(()=>{this.taskUpdateCameraId=void 0,this.updateCamera(e)},V);return}}const r=new Map;for(const[l,c]of this.vNodes.getNodesByType(u.Text).entries()){const p=c.rect;r.set(l,R.cloneDeep(p))}const a=new Set(r.keys());let i=!1;if(this.localWork.hasSelector()){const l=(t=this.localWork.getSelector())==null?void 0:t.selectIds;if(l){i=!0;for(const c of l)a.add(c)}}let n=!1;if(this.serviceWork.selectorWorkShapes.size)for(const l of this.serviceWork.selectorWorkShapes.values()){const c=l.selectIds;if(c){n=!0;for(const p of c)a.add(p)}}if(this.setCameraOpt(s),this.vNodes.curNodeMap.size){this.vNodes.clearTarget(),this.vNodes.updateHighLevelNodesRect(a),this.debounceUpdateCameraId&&clearTimeout(this.debounceUpdateCameraId);for(const[l,c]of r.entries()){const p=this.vNodes.get(l);if(p){const k=c,S=p.rect,T=this.getSceneRect(),v=q(k,T),g=q(S,T);let m=!1;if((v!==g||k.w!==S.w||k.h!==S.h||g===Y.intersect)&&(m=!0),m){const{toolsType:f,opt:y}=p;f===u.Text&&y.workState===W.Done&&this.debounceUpdateCache.add(l)}}}if(i&&this.localWork.reRenderSelector(),n)for(const[l,c]of this.serviceWork.selectorWorkShapes.entries())this.serviceWork.runSelectWork({workId:l,selectIds:c.selectIds,msgType:h.Select,dataType:w.Service,viewId:this.viewId});this.debounceUpdateCameraId=setTimeout(()=>{var l;this.debounceUpdateCameraId=void 0;const c=[];for(const p of this.debounceUpdateCache.values()){if((l=this.fullLayer)!=null&&l.getElementsByName(p)[0]){const k=this.vNodes.get(p);if(k){const{toolsType:S,opt:T,rect:v}=k,g=this.localWork.setFullWork({toolsType:S,opt:T,workId:p});if(g){const m=this.getSceneRect(),f=q(v,m);c.push(g.consumeServiceAsync({isFullWork:!0,replaceId:p,isDrawLabel:f!==Y.outside}))}}}this.debounceUpdateCache.delete(p)}this.vNodes.updateLowLevelNodesRect(),this.vNodes.clearHighLevelIds()},V)}}}getSceneRect(){const{width:e,height:t}=this.scene;return{x:0,y:0,w:Math.floor(e),h:Math.floor(t)}}createScene(e){return new Z({displayRatio:this.opt.displayer.dpr,depth:!1,desynchronized:!0,...e,autoRender:!0,id:this.viewId,contextType:"2d"})}createLayer(e,t,s){const{width:o,height:r}=s,a=`canvas-${e}`,i=t.layer(a,{...s,offscreen:!1}),n=new _({anchor:[.5,.5],pos:[o*.5,r*.5],size:[o,r],name:"viewport",id:e});return i.append(n),n}updateScene(e){this.scene.attr({...e});const{width:t,height:s}=e;this.scene.width=t,this.scene.height=s,this.updateLayer({width:t,height:s})}updateLayer(e){const{width:t,height:s}=e;this.fullLayer.parent.setAttribute("width",t),this.fullLayer.parent.setAttribute("height",s),this.fullLayer.setAttribute("size",[t,s]),this.fullLayer.setAttribute("pos",[t*.5,s*.5]),this.topLayer.parent.setAttribute("width",t),this.topLayer.parent.setAttribute("height",s),this.topLayer.setAttribute("size",[t,s]),this.topLayer.setAttribute("pos",[t*.5,s*.5]),this.localLayer.parent.setAttribute("width",t),this.localLayer.parent.setAttribute("height",s),this.localLayer.setAttribute("size",[t,s]),this.localLayer.setAttribute("pos",[t*.5,s*.5]),this.serviceLayer.parent.setAttribute("width",t),this.serviceLayer.parent.setAttribute("height",s),this.serviceLayer.setAttribute("size",[t,s]),this.serviceLayer.setAttribute("pos",[t*.5,s*.5])}destroy(){this.clearCacheImages(),this.clearImageResolveMap(),this.vNodes.clear(),this.fullLayer.remove(),this.topLayer.remove(),this.localLayer.remove(),this.serviceLayer.remove(),this.scene.remove(),this.localWork.destroy(),this.serviceWork.destroy(),this.topWork.destroy()}}class be{constructor(e,t){d(this,"viewId"),d(this,"fullLayer"),d(this,"master"),d(this,"opt"),d(this,"scene"),d(this,"mainThreadPostId"),d(this,"combinePostMsg",new Set),d(this,"workShapes",new Map),d(this,"cacheImages",new Map),d(this,"imageResolveMap",new Map),this.viewId=e,this.opt=t,this.scene=this.createScene({...t.canvasOpt,container:t.container}),this.master=t.master,this.fullLayer=this.createLayer("fullLayer",this.scene,{...t.layerOpt,bufferSize:this.viewId===A?6e3:3e3})}getCachedImages(e){return this.cacheImages.get(e)}clearCacheImages(){this.cacheImages.forEach(e=>e.close()),this.cacheImages.clear()}clearImageResolveMap(){this.imageResolveMap.forEach(({timer:e})=>{e&&clearTimeout(e)}),this.imageResolveMap.clear()}post(e){this.combinePostMsg.add(e),this.runBatchPostData()}async on(e){var t;const{msgType:s,imageSrc:o,imageBitmap:r,workId:a}=e;switch(s){case h.Snapshot:await this.getSnapshot(e),this.destroy();return;case h.BoundingBox:await this.getBoundingRect(e),this.destroy();return;case h.GetImageBitMap:if(o&&r&&this.cacheImages.set(o,r),a){const i=a.toString(),n=(t=this.imageResolveMap.get(i))==null?void 0:t.resolve;n&&n(i)}break}}async loadImageBitMap(e){const{toolsType:t,opt:s,workId:o}=e;if(t===u.Image&&s&&s.src&&o){const r=s.src,a=this.cacheImages.has(r),i=o.toString();if(!a){const n=await new Promise(l=>{const c=this.imageResolveMap.get(i)||{resolve:void 0,timer:void 0};c.timer&&clearTimeout(c.timer),c.resolve=l,c.timer=setTimeout(()=>{const p=this.imageResolveMap.get(i);p!=null&&p.resolve&&p.resolve(i)},5e3),this.imageResolveMap.set(i,c),this.opt.post({sp:[{imageSrc:r,workId:i,viewId:this.viewId,isgl:!!this.fullLayer.parent.gl,isSubWorker:!0,type:h.GetImageBitMap}]})});this.imageResolveMap.delete(n)}return this.cacheImages.get(r)}}createWorkShapeNode(e){return z({...e,fullLayer:this.fullLayer,drawLayer:void 0})}setFullWork(e){const{workId:t,opt:s,toolsType:o}=e;if(t&&s&&o){const r=t.toString();let a;return t&&this.workShapes.has(r)?(a=this.workShapes.get(r),a==null||a.setWorkOptions(s)):a=this.createWorkShapeNode({toolsOpt:s,toolsType:o,workId:r}),a?(this.workShapes.set(r,a),a):void 0}}async runFullWork(e){var t;const s=this.setFullWork(e),o=e.ops&&x(e.ops);if(s){let r,a;const i=(t=s.getWorkId())==null?void 0:t.toString();return s.toolsType===u.Image?r=await s.consumeServiceAsync({isFullWork:!0,worker:this}):s.toolsType===u.Text?r=await s.consumeServiceAsync({isFullWork:!0,replaceId:i,isDrawLabel:!0}):(r=s.consumeService({op:o,isFullWork:!0,replaceId:i}),a=(e==null?void 0:e.updateNodeOpt)&&s.updataOptService(e.updateNodeOpt)),P(r,a)}}async getSnapshot(e){const{scenePath:t,scenes:s,cameraOpt:o,w:r,h:a}=e;if(t&&s&&o){this.setCameraOpt(o);let i;for(const[l,c]of Object.entries(s))if(c!=null&&c.type)switch(c==null?void 0:c.type){case h.UpdateNode:case h.FullWork:{const{opt:p}=c,k={...c,opt:p,workId:l,msgType:h.FullWork,dataType:w.Service,viewId:this.viewId},S=await this.runFullWork(k);i=P(i,S);break}}let n;r&&a&&(n={resizeWidth:r,resizeHeight:a}),await this.getSnapshotRender({scenePath:t,options:n})}}getSceneRect(){const{width:e,height:t}=this.scene;return{x:0,y:0,w:Math.floor(e),h:Math.floor(t)}}getRectImageBitmap(e,t){const s=Math.floor(e.x*this.opt.displayer.dpr),o=Math.floor(e.y*this.opt.displayer.dpr),r=e.w>0&&Math.floor(e.w*this.opt.displayer.dpr||1)||1,a=e.h>0&&Math.floor(e.h*this.opt.displayer.dpr||1)||1;return createImageBitmap(this.fullLayer.parent.canvas,s,o,r,a,t)}async getSnapshotRender(e){var t,s;const{scenePath:o,options:r}=e;((t=this.fullLayer)==null?void 0:t.parent).render();const a=await this.getRectImageBitmap(this.getSceneRect(),r);a&&(this.post({sp:[{type:h.Snapshot,scenePath:o,imageBitmap:a,viewId:this.viewId}]}),(s=this.fullLayer)==null||s.removeAllChildren())}async getBoundingRect(e){const{scenePath:t,scenes:s,cameraOpt:o}=e;if(t&&s&&o){this.setCameraOpt(o);let r;for(const[a,i]of Object.entries(s))if(i!=null&&i.type)switch(i==null?void 0:i.type){case h.UpdateNode:case h.FullWork:{const n=await this.runFullWork({...i,workId:a,msgType:h.FullWork,dataType:w.Service,viewId:this.viewId});r=P(r,n);break}}r&&this.post({sp:[{type:h.BoundingBox,scenePath:t,rect:r}]})}}setCameraOpt(e){const{scale:t,centerX:s,centerY:o,width:r,height:a}=e;this.updateScene({width:r,height:a}),this.fullLayer.setAttribute("scale",[t,t]),this.fullLayer.setAttribute("translate",[-s,-o])}runBatchPostData(){this.mainThreadPostId||(this.mainThreadPostId=requestAnimationFrame(this.combinePost.bind(this)))}combinePostData(){var e;this.mainThreadPostId=void 0;const t=[];for(const s of this.combinePostMsg.values())if((e=s.sp)!=null&&e.length)for(const o of s.sp){let r=!1;for(const a of t)if(ee(o,a)){r=!0;break}r||t.push(o)}return this.combinePostMsg.clear(),{sp:t}}combinePost(){var e,t;const s=this.combinePostData(),o=(e=s.sp)==null?void 0:e.filter(r=>r.type!==h.None||r.isLockSentEventCursor);o!=null&&o.length?s.sp=o.map(r=>r.viewId?r:{...r,viewId:this.viewId}):delete s.sp,(s!=null&&s.drawCount||(t=s.sp)!=null&&t.length)&&this.opt.post(s)}createScene(e){return new Z({displayRatio:this.opt.displayer.dpr,depth:!1,desynchronized:!0,...e,autoRender:!1,contextType:"2d"})}createLayer(e,t,s){const{width:o,height:r}=s,a=`canvas-${e}`,i=t.layer(a,s),n=new _({anchor:[.5,.5],pos:[o*.5,r*.5],size:[o,r],name:"viewport",id:e});return i.append(n),n}updateScene(e){this.scene.attr({...e});const{width:t,height:s}=e;this.scene.width=t,this.scene.height=s,this.updateLayer({width:t,height:s})}updateLayer(e){const{width:t,height:s}=e;this.fullLayer.parent.setAttribute("width",t),this.fullLayer.parent.setAttribute("height",s),this.fullLayer.setAttribute("size",[t,s]),this.fullLayer.setAttribute("pos",[t*.5,s*.5])}destroy(){this.clearCacheImages(),this.clearImageResolveMap(),this.fullLayer.remove(),this.scene.remove()}}class Ee{constructor(e){d(this,"mainThreadMap",new Map),d(this,"snapshotThread"),d(this,"master"),this.master=e}post(e){const{drawCount:t,sp:s,workerTasksqueueCount:o}=e;this.master.isBusy&&$(o)&&this.master.setWorkerTasksqueueCount(o),$(t)&&this.master.setMaxDrawCount(t),s&&this.master.collectorSyncData(s)}destroy(){this.mainThreadMap.clear()}createMainThread(e,t){return new Le(e,t)}createSnapshotThread(e,t){return new be(e,t)}async consume(e){var t,s,o,r;for(const a of e.values()){const{msgType:i,viewId:n,tasksqueue:l,mainTasksqueueCount:c,layerOpt:p,offscreenCanvasOpt:k,cameraOpt:S,isSubWorker:T}=a;if(i===h.Console){console.log(this);continue}if(i===h.Init){const g=(t=this.master.control.viewContainerManager.getView(n))==null?void 0:t.displayer,m=g==null?void 0:g.canvasContainerRef.current;if(g&&m&&p&&k){const f=this.createMainThread(n,{displayer:g,container:m,layerOpt:p,master:this.master,canvasOpt:k,post:this.post.bind(this)});this.mainThreadMap.set(n,f),f&&S&&f.setCameraOpt(S)}continue}if((i===h.Snapshot||i===h.BoundingBox)&&n===((s=this.master.control.viewContainerManager.mainView)==null?void 0:s.id)){const g=(o=this.master.control.viewContainerManager.getView(n))==null?void 0:o.displayer,m=(r=g.snapshotContainerRef)==null?void 0:r.current;if(g&&m&&S){m.style.width=`${S.width}px`,m.style.height=`${S.height}px`;const f={...j.defaultLayerOpt,offscreen:!1,width:S.width,height:S.height},y={...j.defaultScreenCanvasOpt,width:S.width,height:S.height};this.snapshotThread=this.createSnapshotThread(n,{displayer:g,container:m,layerOpt:f,master:this.master,canvasOpt:y,post:this.post.bind(this)}),this.snapshotThread.on(a).then(()=>{this.snapshotThread=void 0,m.innerHTML="",m.style.width="",m.style.height=""});continue}}if(i===h.GetImageBitMap&&T&&this.snapshotThread){this.snapshotThread.on(a);continue}if(i===h.TasksQueue&&l!=null&&l.size){for(const[g,m]of this.mainThreadMap.entries()){const f=l.get(g);f&&(await m.on(f),c&&this.post({workerTasksqueueCount:c}))}continue}if(n===J){for(const g of this.mainThreadMap.values())g.on(a),i===h.Destroy&&this.mainThreadMap.delete(n);continue}const v=this.mainThreadMap.get(n);v&&(v.on(a),i===h.Destroy&&this.mainThreadMap.delete(n))}}}export{Ee as MainThreadManagerImpl};
