(function(){"use strict";var Ot=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};importScripts("https://unpkg.com/spritejs@3/dist/spritejs.worker.js"),function(_){var Fe=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof Ot<"u"?Ot:typeof self<"u"?self:{};function ge(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}function fo(){this.__data__=[],this.size=0}var yo=fo;function wo(o,e){return o===e||o!==o&&e!==e}var it=wo,vo=it;function mo(o,e){for(var t=o.length;t--;)if(vo(o[t][0],e))return t;return-1}var Ee=mo,go=Ee,bo=Array.prototype,ko=bo.splice;function So(o){var e=this.__data__,t=go(e,o);if(t<0)return!1;var r=e.length-1;return t==r?e.pop():ko.call(e,t,1),--this.size,!0}var Po=So,Io=Ee;function To(o){var e=this.__data__,t=Io(e,o);return t<0?void 0:e[t][1]}var xo=To,Oo=Ee;function Co(o){return Oo(this.__data__,o)>-1}var No=Co,Lo=Ee;function Wo(o,e){var t=this.__data__,r=Lo(t,o);return r<0?(++this.size,t.push([o,e])):t[r][1]=e,this}var Ro=Wo,Mo=yo,jo=Po,Ao=xo,Bo=No,Do=Ro;function be(o){var e=-1,t=o==null?0:o.length;for(this.clear();++e<t;){var r=o[e];this.set(r[0],r[1])}}be.prototype.clear=Mo,be.prototype.delete=jo,be.prototype.get=Ao,be.prototype.has=Bo,be.prototype.set=Do;var ze=be,Fo=ze;function Eo(){this.__data__=new Fo,this.size=0}var zo=Eo;function Uo(o){var e=this.__data__,t=e.delete(o);return this.size=e.size,t}var _o=Uo;function $o(o){return this.__data__.get(o)}var Yo=$o;function Xo(o){return this.__data__.has(o)}var Go=Xo,Vo=typeof Fe=="object"&&Fe&&Fe.Object===Object&&Fe,Ct=Vo,Ho=Ct,Zo=typeof self=="object"&&self&&self.Object===Object&&self,qo=Ho||Zo||Function("return this")(),ie=qo,Qo=ie,Jo=Qo.Symbol,Ue=Jo,Nt=Ue,Lt=Object.prototype,Ko=Lt.hasOwnProperty,es=Lt.toString,je=Nt?Nt.toStringTag:void 0;function ts(o){var e=Ko.call(o,je),t=o[je];try{o[je]=void 0;var r=!0}catch{}var s=es.call(o);return r&&(e?o[je]=t:delete o[je]),s}var rs=ts,os=Object.prototype,ss=os.toString;function is(o){return ss.call(o)}var ns=is,Wt=Ue,as=rs,ls=ns,cs="[object Null]",hs="[object Undefined]",Rt=Wt?Wt.toStringTag:void 0;function us(o){return o==null?o===void 0?hs:cs:Rt&&Rt in Object(o)?as(o):ls(o)}var ye=us;function ds(o){var e=typeof o;return o!=null&&(e=="object"||e=="function")}var he=ds,ps=ye,fs=he,ys="[object AsyncFunction]",ws="[object Function]",vs="[object GeneratorFunction]",ms="[object Proxy]";function gs(o){if(!fs(o))return!1;var e=ps(o);return e==ws||e==vs||e==ys||e==ms}var Mt=gs,bs=ie,ks=bs["__core-js_shared__"],Ss=ks,nt=Ss,jt=function(){var o=/[^.]+$/.exec(nt&&nt.keys&&nt.keys.IE_PROTO||"");return o?"Symbol(src)_1."+o:""}();function Ps(o){return!!jt&&jt in o}var Is=Ps,Ts=Function.prototype,xs=Ts.toString;function Os(o){if(o!=null){try{return xs.call(o)}catch{}try{return o+""}catch{}}return""}var At=Os,Cs=Mt,Ns=Is,Ls=he,Ws=At,Rs=/[\\^$.*+?()[\]{}|]/g,Ms=/^\[object .+?Constructor\]$/,js=Function.prototype,As=Object.prototype,Bs=js.toString,Ds=As.hasOwnProperty,Fs=RegExp("^"+Bs.call(Ds).replace(Rs,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function Es(o){if(!Ls(o)||Ns(o))return!1;var e=Cs(o)?Fs:Ms;return e.test(Ws(o))}var zs=Es;function Us(o,e){return o==null?void 0:o[e]}var _s=Us,$s=zs,Ys=_s;function Xs(o,e){var t=Ys(o,e);return $s(t)?t:void 0}var we=Xs,Gs=we,Vs=ie,Hs=Gs(Vs,"Map"),at=Hs,Zs=we,qs=Zs(Object,"create"),_e=qs,Bt=_e;function Qs(){this.__data__=Bt?Bt(null):{},this.size=0}var Js=Qs;function Ks(o){var e=this.has(o)&&delete this.__data__[o];return this.size-=e?1:0,e}var ei=Ks,ti=_e,ri="__lodash_hash_undefined__",oi=Object.prototype,si=oi.hasOwnProperty;function ii(o){var e=this.__data__;if(ti){var t=e[o];return t===ri?void 0:t}return si.call(e,o)?e[o]:void 0}var ni=ii,ai=_e,li=Object.prototype,ci=li.hasOwnProperty;function hi(o){var e=this.__data__;return ai?e[o]!==void 0:ci.call(e,o)}var ui=hi,di=_e,pi="__lodash_hash_undefined__";function fi(o,e){var t=this.__data__;return this.size+=this.has(o)?0:1,t[o]=di&&e===void 0?pi:e,this}var yi=fi,wi=Js,vi=ei,mi=ni,gi=ui,bi=yi;function ke(o){var e=-1,t=o==null?0:o.length;for(this.clear();++e<t;){var r=o[e];this.set(r[0],r[1])}}ke.prototype.clear=wi,ke.prototype.delete=vi,ke.prototype.get=mi,ke.prototype.has=gi,ke.prototype.set=bi;var ki=ke,Dt=ki,Si=ze,Pi=at;function Ii(){this.size=0,this.__data__={hash:new Dt,map:new(Pi||Si),string:new Dt}}var Ti=Ii;function xi(o){var e=typeof o;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?o!=="__proto__":o===null}var Oi=xi,Ci=Oi;function Ni(o,e){var t=o.__data__;return Ci(e)?t[typeof e=="string"?"string":"hash"]:t.map}var $e=Ni,Li=$e;function Wi(o){var e=Li(this,o).delete(o);return this.size-=e?1:0,e}var Ri=Wi,Mi=$e;function ji(o){return Mi(this,o).get(o)}var Ai=ji,Bi=$e;function Di(o){return Bi(this,o).has(o)}var Fi=Di,Ei=$e;function zi(o,e){var t=Ei(this,o),r=t.size;return t.set(o,e),this.size+=t.size==r?0:1,this}var Ui=zi,_i=Ti,$i=Ri,Yi=Ai,Xi=Fi,Gi=Ui;function Se(o){var e=-1,t=o==null?0:o.length;for(this.clear();++e<t;){var r=o[e];this.set(r[0],r[1])}}Se.prototype.clear=_i,Se.prototype.delete=$i,Se.prototype.get=Yi,Se.prototype.has=Xi,Se.prototype.set=Gi;var Ft=Se,Vi=ze,Hi=at,Zi=Ft,qi=200;function Qi(o,e){var t=this.__data__;if(t instanceof Vi){var r=t.__data__;if(!Hi||r.length<qi-1)return r.push([o,e]),this.size=++t.size,this;t=this.__data__=new Zi(r)}return t.set(o,e),this.size=t.size,this}var Ji=Qi,Ki=ze,en=zo,tn=_o,rn=Yo,on=Go,sn=Ji;function Pe(o){var e=this.__data__=new Ki(o);this.size=e.size}Pe.prototype.clear=en,Pe.prototype.delete=tn,Pe.prototype.get=rn,Pe.prototype.has=on,Pe.prototype.set=sn;var Et=Pe;function nn(o,e){for(var t=-1,r=o==null?0:o.length;++t<r&&e(o[t],t,o)!==!1;);return o}var an=nn,ln=we,cn=function(){try{var o=ln(Object,"defineProperty");return o({},"",{}),o}catch{}}(),hn=cn,zt=hn;function un(o,e,t){e=="__proto__"&&zt?zt(o,e,{configurable:!0,enumerable:!0,value:t,writable:!0}):o[e]=t}var Ut=un,dn=Ut,pn=it,fn=Object.prototype,yn=fn.hasOwnProperty;function wn(o,e,t){var r=o[e];(!(yn.call(o,e)&&pn(r,t))||t===void 0&&!(e in o))&&dn(o,e,t)}var _t=wn,vn=_t,mn=Ut;function gn(o,e,t,r){var s=!t;t||(t={});for(var i=-1,n=e.length;++i<n;){var a=e[i],l=r?r(t[a],o[a],a,t,o):void 0;l===void 0&&(l=o[a]),s?mn(t,a,l):vn(t,a,l)}return t}var Ye=gn;function bn(o,e){for(var t=-1,r=Array(o);++t<o;)r[t]=e(t);return r}var kn=bn;function Sn(o){return o!=null&&typeof o=="object"}var ce=Sn,Pn=ye,In=ce,Tn="[object Arguments]";function xn(o){return In(o)&&Pn(o)==Tn}var On=xn,$t=On,Cn=ce,Yt=Object.prototype,Nn=Yt.hasOwnProperty,Ln=Yt.propertyIsEnumerable,Wn=$t(function(){return arguments}())?$t:function(o){return Cn(o)&&Nn.call(o,"callee")&&!Ln.call(o,"callee")},Rn=Wn,Mn=Array.isArray,Xe=Mn,Ge={exports:{}};function jn(){return!1}var An=jn;Ge.exports,function(o,e){var t=ie,r=An,s=e&&!e.nodeType&&e,i=s&&!0&&o&&!o.nodeType&&o,n=i&&i.exports===s,a=n?t.Buffer:void 0,l=a?a.isBuffer:void 0,c=l||r;o.exports=c}(Ge,Ge.exports);var lt=Ge.exports,Bn=9007199254740991,Dn=/^(?:0|[1-9]\d*)$/;function Fn(o,e){var t=typeof o;return e=e??Bn,!!e&&(t=="number"||t!="symbol"&&Dn.test(o))&&o>-1&&o%1==0&&o<e}var En=Fn,zn=9007199254740991;function Un(o){return typeof o=="number"&&o>-1&&o%1==0&&o<=zn}var Xt=Un,_n=ye,$n=Xt,Yn=ce,Xn="[object Arguments]",Gn="[object Array]",Vn="[object Boolean]",Hn="[object Date]",Zn="[object Error]",qn="[object Function]",Qn="[object Map]",Jn="[object Number]",Kn="[object Object]",ea="[object RegExp]",ta="[object Set]",ra="[object String]",oa="[object WeakMap]",sa="[object ArrayBuffer]",ia="[object DataView]",na="[object Float32Array]",aa="[object Float64Array]",la="[object Int8Array]",ca="[object Int16Array]",ha="[object Int32Array]",ua="[object Uint8Array]",da="[object Uint8ClampedArray]",pa="[object Uint16Array]",fa="[object Uint32Array]",X={};X[na]=X[aa]=X[la]=X[ca]=X[ha]=X[ua]=X[da]=X[pa]=X[fa]=!0,X[Xn]=X[Gn]=X[sa]=X[Vn]=X[ia]=X[Hn]=X[Zn]=X[qn]=X[Qn]=X[Jn]=X[Kn]=X[ea]=X[ta]=X[ra]=X[oa]=!1;function ya(o){return Yn(o)&&$n(o.length)&&!!X[_n(o)]}var wa=ya;function va(o){return function(e){return o(e)}}var ct=va,Ve={exports:{}};Ve.exports,function(o,e){var t=Ct,r=e&&!e.nodeType&&e,s=r&&!0&&o&&!o.nodeType&&o,i=s&&s.exports===r,n=i&&t.process,a=function(){try{var l=s&&s.require&&s.require("util").types;return l||n&&n.binding&&n.binding("util")}catch{}}();o.exports=a}(Ve,Ve.exports);var ht=Ve.exports,ma=wa,ga=ct,Gt=ht,Vt=Gt&&Gt.isTypedArray,ba=Vt?ga(Vt):ma,Ht=ba,ka=kn,Sa=Rn,Pa=Xe,Ia=lt,Ta=En,xa=Ht,Oa=Object.prototype,Ca=Oa.hasOwnProperty;function Na(o,e){var t=Pa(o),r=!t&&Sa(o),s=!t&&!r&&Ia(o),i=!t&&!r&&!s&&xa(o),n=t||r||s||i,a=n?ka(o.length,String):[],l=a.length;for(var c in o)(e||Ca.call(o,c))&&!(n&&(c=="length"||s&&(c=="offset"||c=="parent")||i&&(c=="buffer"||c=="byteLength"||c=="byteOffset")||Ta(c,l)))&&a.push(c);return a}var Zt=Na,La=Object.prototype;function Wa(o){var e=o&&o.constructor,t=typeof e=="function"&&e.prototype||La;return o===t}var ut=Wa;function Ra(o,e){return function(t){return o(e(t))}}var qt=Ra,Ma=qt,ja=Ma(Object.keys,Object),Aa=ja,Ba=ut,Da=Aa,Fa=Object.prototype,Ea=Fa.hasOwnProperty;function za(o){if(!Ba(o))return Da(o);var e=[];for(var t in Object(o))Ea.call(o,t)&&t!="constructor"&&e.push(t);return e}var Ua=za,_a=Mt,$a=Xt;function Ya(o){return o!=null&&$a(o.length)&&!_a(o)}var Qt=Ya,Xa=Zt,Ga=Ua,Va=Qt;function Ha(o){return Va(o)?Xa(o):Ga(o)}var dt=Ha,Za=Ye,qa=dt;function Qa(o,e){return o&&Za(e,qa(e),o)}var Ja=Qa;function Ka(o){var e=[];if(o!=null)for(var t in Object(o))e.push(t);return e}var el=Ka,tl=he,rl=ut,ol=el,sl=Object.prototype,il=sl.hasOwnProperty;function nl(o){if(!tl(o))return ol(o);var e=rl(o),t=[];for(var r in o)r=="constructor"&&(e||!il.call(o,r))||t.push(r);return t}var al=nl,ll=Zt,cl=al,hl=Qt;function ul(o){return hl(o)?ll(o,!0):cl(o)}var pt=ul,dl=Ye,pl=pt;function fl(o,e){return o&&dl(e,pl(e),o)}var yl=fl,He={exports:{}};He.exports,function(o,e){var t=ie,r=e&&!e.nodeType&&e,s=r&&!0&&o&&!o.nodeType&&o,i=s&&s.exports===r,n=i?t.Buffer:void 0,a=n?n.allocUnsafe:void 0;function l(c,h){if(h)return c.slice();var d=c.length,u=a?a(d):new c.constructor(d);return c.copy(u),u}o.exports=l}(He,He.exports);var wl=He.exports;function vl(o,e){var t=-1,r=o.length;for(e||(e=Array(r));++t<r;)e[t]=o[t];return e}var ml=vl;function gl(o,e){for(var t=-1,r=o==null?0:o.length,s=0,i=[];++t<r;){var n=o[t];e(n,t,o)&&(i[s++]=n)}return i}var bl=gl;function kl(){return[]}var Jt=kl,Sl=bl,Pl=Jt,Il=Object.prototype,Tl=Il.propertyIsEnumerable,Kt=Object.getOwnPropertySymbols,xl=Kt?function(o){return o==null?[]:(o=Object(o),Sl(Kt(o),function(e){return Tl.call(o,e)}))}:Pl,ft=xl,Ol=Ye,Cl=ft;function Nl(o,e){return Ol(o,Cl(o),e)}var Ll=Nl;function Wl(o,e){for(var t=-1,r=e.length,s=o.length;++t<r;)o[s+t]=e[t];return o}var er=Wl,Rl=qt,Ml=Rl(Object.getPrototypeOf,Object),tr=Ml,jl=er,Al=tr,Bl=ft,Dl=Jt,Fl=Object.getOwnPropertySymbols,El=Fl?function(o){for(var e=[];o;)jl(e,Bl(o)),o=Al(o);return e}:Dl,rr=El,zl=Ye,Ul=rr;function _l(o,e){return zl(o,Ul(o),e)}var $l=_l,Yl=er,Xl=Xe;function Gl(o,e,t){var r=e(o);return Xl(o)?r:Yl(r,t(o))}var or=Gl,Vl=or,Hl=ft,Zl=dt;function ql(o){return Vl(o,Zl,Hl)}var sr=ql,Ql=or,Jl=rr,Kl=pt;function ec(o){return Ql(o,Kl,Jl)}var tc=ec,rc=we,oc=ie,sc=rc(oc,"DataView"),ic=sc,nc=we,ac=ie,lc=nc(ac,"Promise"),cc=lc,hc=we,uc=ie,dc=hc(uc,"Set"),pc=dc,fc=we,yc=ie,wc=fc(yc,"WeakMap"),vc=wc,yt=ic,wt=at,vt=cc,mt=pc,gt=vc,ir=ye,Ie=At,nr="[object Map]",mc="[object Object]",ar="[object Promise]",lr="[object Set]",cr="[object WeakMap]",hr="[object DataView]",gc=Ie(yt),bc=Ie(wt),kc=Ie(vt),Sc=Ie(mt),Pc=Ie(gt),ve=ir;(yt&&ve(new yt(new ArrayBuffer(1)))!=hr||wt&&ve(new wt)!=nr||vt&&ve(vt.resolve())!=ar||mt&&ve(new mt)!=lr||gt&&ve(new gt)!=cr)&&(ve=function(o){var e=ir(o),t=e==mc?o.constructor:void 0,r=t?Ie(t):"";if(r)switch(r){case gc:return hr;case bc:return nr;case kc:return ar;case Sc:return lr;case Pc:return cr}return e});var Ze=ve,Ic=Object.prototype,Tc=Ic.hasOwnProperty;function xc(o){var e=o.length,t=new o.constructor(e);return e&&typeof o[0]=="string"&&Tc.call(o,"index")&&(t.index=o.index,t.input=o.input),t}var Oc=xc,Cc=ie,Nc=Cc.Uint8Array,ur=Nc,dr=ur;function Lc(o){var e=new o.constructor(o.byteLength);return new dr(e).set(new dr(o)),e}var bt=Lc,Wc=bt;function Rc(o,e){var t=e?Wc(o.buffer):o.buffer;return new o.constructor(t,o.byteOffset,o.byteLength)}var Mc=Rc,jc=/\w*$/;function Ac(o){var e=new o.constructor(o.source,jc.exec(o));return e.lastIndex=o.lastIndex,e}var Bc=Ac,pr=Ue,fr=pr?pr.prototype:void 0,yr=fr?fr.valueOf:void 0;function Dc(o){return yr?Object(yr.call(o)):{}}var Fc=Dc,Ec=bt;function zc(o,e){var t=e?Ec(o.buffer):o.buffer;return new o.constructor(t,o.byteOffset,o.length)}var Uc=zc,_c=bt,$c=Mc,Yc=Bc,Xc=Fc,Gc=Uc,Vc="[object Boolean]",Hc="[object Date]",Zc="[object Map]",qc="[object Number]",Qc="[object RegExp]",Jc="[object Set]",Kc="[object String]",eh="[object Symbol]",th="[object ArrayBuffer]",rh="[object DataView]",oh="[object Float32Array]",sh="[object Float64Array]",ih="[object Int8Array]",nh="[object Int16Array]",ah="[object Int32Array]",lh="[object Uint8Array]",ch="[object Uint8ClampedArray]",hh="[object Uint16Array]",uh="[object Uint32Array]";function dh(o,e,t){var r=o.constructor;switch(e){case th:return _c(o);case Vc:case Hc:return new r(+o);case rh:return $c(o,t);case oh:case sh:case ih:case nh:case ah:case lh:case ch:case hh:case uh:return Gc(o,t);case Zc:return new r;case qc:case Kc:return new r(o);case Qc:return Yc(o);case Jc:return new r;case eh:return Xc(o)}}var ph=dh,fh=he,wr=Object.create,yh=function(){function o(){}return function(e){if(!fh(e))return{};if(wr)return wr(e);o.prototype=e;var t=new o;return o.prototype=void 0,t}}(),wh=yh,vh=wh,mh=tr,gh=ut;function bh(o){return typeof o.constructor=="function"&&!gh(o)?vh(mh(o)):{}}var kh=bh,Sh=Ze,Ph=ce,Ih="[object Map]";function Th(o){return Ph(o)&&Sh(o)==Ih}var xh=Th,Oh=xh,Ch=ct,vr=ht,mr=vr&&vr.isMap,Nh=mr?Ch(mr):Oh,Lh=Nh,Wh=Ze,Rh=ce,Mh="[object Set]";function jh(o){return Rh(o)&&Wh(o)==Mh}var Ah=jh,Bh=Ah,Dh=ct,gr=ht,br=gr&&gr.isSet,Fh=br?Dh(br):Bh,Eh=Fh,zh=Et,Uh=an,_h=_t,$h=Ja,Yh=yl,Xh=wl,Gh=ml,Vh=Ll,Hh=$l,Zh=sr,qh=tc,Qh=Ze,Jh=Oc,Kh=ph,eu=kh,tu=Xe,ru=lt,ou=Lh,su=he,iu=Eh,nu=dt,au=pt,lu=1,cu=2,hu=4,kr="[object Arguments]",uu="[object Array]",du="[object Boolean]",pu="[object Date]",fu="[object Error]",Sr="[object Function]",yu="[object GeneratorFunction]",wu="[object Map]",vu="[object Number]",Pr="[object Object]",mu="[object RegExp]",gu="[object Set]",bu="[object String]",ku="[object Symbol]",Su="[object WeakMap]",Pu="[object ArrayBuffer]",Iu="[object DataView]",Tu="[object Float32Array]",xu="[object Float64Array]",Ou="[object Int8Array]",Cu="[object Int16Array]",Nu="[object Int32Array]",Lu="[object Uint8Array]",Wu="[object Uint8ClampedArray]",Ru="[object Uint16Array]",Mu="[object Uint32Array]",$={};$[kr]=$[uu]=$[Pu]=$[Iu]=$[du]=$[pu]=$[Tu]=$[xu]=$[Ou]=$[Cu]=$[Nu]=$[wu]=$[vu]=$[Pr]=$[mu]=$[gu]=$[bu]=$[ku]=$[Lu]=$[Wu]=$[Ru]=$[Mu]=!0,$[fu]=$[Sr]=$[Su]=!1;function qe(o,e,t,r,s,i){var n,a=e&lu,l=e&cu,c=e&hu;if(t&&(n=s?t(o,r,s,i):t(o)),n!==void 0)return n;if(!su(o))return o;var h=tu(o);if(h){if(n=Jh(o),!a)return Gh(o,n)}else{var d=Qh(o),u=d==Sr||d==yu;if(ru(o))return Xh(o,a);if(d==Pr||d==kr||u&&!s){if(n=l||u?{}:eu(o),!a)return l?Hh(o,Yh(n,o)):Vh(o,$h(n,o))}else{if(!$[d])return s?o:{};n=Kh(o,d,a)}}i||(i=new zh);var p=i.get(o);if(p)return p;i.set(o,n),iu(o)?o.forEach(function(v){n.add(qe(v,e,t,v,o,i))}):ou(o)&&o.forEach(function(v,S){n.set(S,qe(v,e,t,S,o,i))});var w=c?l?qh:Zh:l?au:nu,y=h?void 0:w(o);return Uh(y||o,function(v,S){y&&(S=v,v=o[S]),_h(n,S,qe(v,e,t,S,o,i))}),n}var ju=qe,Au=ju,Bu=1,Du=4;function Fu(o){return Au(o,Bu|Du)}var Eu=Fu,te=ge(Eu),Ir;(function(o){o[o.pedding=0]="pedding",o[o.mounted=1]="mounted",o[o.update=2]="update",o[o.unmounted=3]="unmounted"})(Ir||(Ir={}));var Z;(function(o){o[o.Normal=0]="Normal",o[o.Stroke=1]="Stroke",o[o.Dotted=2]="Dotted",o[o.LongDotted=3]="LongDotted"})(Z||(Z={}));var Tr;(function(o){o.Triangle="triangle",o.Rhombus="rhombus",o.Pentagram="pentagram",o.SpeechBalloon="speechBalloon",o.Star="star",o.Polygon="polygon"})(Tr||(Tr={}));var z;(function(o){o.None="None",o.ShowFloatBar="ShowFloatBar",o.ZIndexFloatBar="ZIndexFloatBar",o.DeleteNode="DeleteNode",o.CopyNode="CopyNode",o.ZIndexActive="ZIndexActive",o.ZIndexNode="ZIndexNode",o.RotateNode="RotateNode",o.SetColorNode="SetColorNode",o.TranslateNode="TranslateNode",o.ScaleNode="ScaleNode",o.OriginalEvent="OriginalEvent",o.CreateScene="CreateScene",o.ActiveCursor="ActiveCursor",o.MoveCursor="MoveCursor",o.CommandEditor="CommandEditor",o.SetEditorData="SetEditorData",o.SetFontStyle="SetFontStyle",o.SetPoint="SetPoint",o.SetLock="SetLock",o.SetShapeOpt="SetShapeOpt"})(z||(z={}));var xr;(function(o){o.DisplayState="DisplayState",o.FloatBar="FloatBar",o.CanvasSelector="CanvasSelector",o.MainEngine="MainEngine",o.DisplayContainer="DisplayContainer",o.Cursor="Cursor",o.TextEditor="TextEditor",o.BindMainView="BindMainView",o.MountMainView="MountMainView",o.MountAppView="MountAppView"})(xr||(xr={}));var Or;(function(o){o[o.MainView=0]="MainView",o[o.Plugin=1]="Plugin",o[o.Both=2]="Both"})(Or||(Or={}));var k;(function(o){o[o.Pencil=1]="Pencil",o[o.Eraser=2]="Eraser",o[o.Selector=3]="Selector",o[o.Clicker=4]="Clicker",o[o.Arrow=5]="Arrow",o[o.Hand=6]="Hand",o[o.LaserPen=7]="LaserPen",o[o.Text=8]="Text",o[o.Straight=9]="Straight",o[o.Rectangle=10]="Rectangle",o[o.Ellipse=11]="Ellipse",o[o.Star=12]="Star",o[o.Triangle=13]="Triangle",o[o.Rhombus=14]="Rhombus",o[o.Polygon=15]="Polygon",o[o.SpeechBalloon=16]="SpeechBalloon",o[o.Image=17]="Image"})(k||(k={}));var M;(function(o){o[o.Local=1]="Local",o[o.Service=2]="Service",o[o.Worker=3]="Worker"})(M||(M={}));var E;(function(o){o[o.Pending=0]="Pending",o[o.Start=1]="Start",o[o.Doing=2]="Doing",o[o.Done=3]="Done",o[o.Freeze=4]="Freeze",o[o.Unwritable=5]="Unwritable"})(E||(E={}));var m;(function(o){o[o.None=0]="None",o[o.Init=1]="Init",o[o.UpdateCamera=2]="UpdateCamera",o[o.UpdateTools=3]="UpdateTools",o[o.CreateWork=4]="CreateWork",o[o.DrawWork=5]="DrawWork",o[o.FullWork=6]="FullWork",o[o.UpdateNode=7]="UpdateNode",o[o.RemoveNode=8]="RemoveNode",o[o.Clear=9]="Clear",o[o.Select=10]="Select",o[o.Destroy=11]="Destroy",o[o.Snapshot=12]="Snapshot",o[o.BoundingBox=13]="BoundingBox",o[o.Cursor=14]="Cursor",o[o.TextUpdate=15]="TextUpdate",o[o.GetTextActive=16]="GetTextActive",o[o.TasksQueue=17]="TasksQueue",o[o.CursorHover=18]="CursorHover"})(m||(m={}));var Cr;(function(o){o.Webgl2="webgl2",o.Webgl="webgl",o.Canvas2d="2d"})(Cr||(Cr={}));var L;(function(o){o[o.Float=1]="Float",o[o.Bg=2]="Bg",o[o.Selector=3]="Selector",o[o.None=4]="None"})(L||(L={}));var Nr;(function(o){o[o.Cursor=1]="Cursor",o[o.TextCreate=2]="TextCreate"})(Nr||(Nr={}));var Lr;(function(o){o[o.Top=1]="Top",o[o.Bottom=2]="Bottom"})(Lr||(Lr={}));var V;(function(o){o[o.none=1]="none",o[o.all=2]="all",o[o.both=3]="both",o[o.proportional=4]="proportional"})(V||(V={}));class se{constructor(){Object.defineProperty(this,"localWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serviceWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"scene",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}registerForWorker(e,t,r){return this.localWork=e,this.serviceWork=t,this.scene=r,this}}const zu={linear:o=>o,easeInQuad:o=>o*o,easeOutQuad:o=>o*(2-o),easeInOutQuad:o=>o<.5?2*o*o:-1+(4-2*o)*o,easeInCubic:o=>o*o*o,easeOutCubic:o=>--o*o*o+1,easeInOutCubic:o=>o<.5?4*o*o*o:(o-1)*(2*o-2)*(2*o-2)+1,easeInQuart:o=>o*o*o*o,easeOutQuart:o=>1- --o*o*o*o,easeInOutQuart:o=>o<.5?8*o*o*o*o:1-8*--o*o*o*o,easeInQuint:o=>o*o*o*o*o,easeOutQuint:o=>1+--o*o*o*o*o,easeInOutQuint:o=>o<.5?16*o*o*o*o*o:1+16*--o*o*o*o*o,easeInSine:o=>1-Math.cos(o*Math.PI/2),easeOutSine:o=>Math.sin(o*Math.PI/2),easeInOutSine:o=>-(Math.cos(Math.PI*o)-1)/2,easeInExpo:o=>o<=0?0:Math.pow(2,10*o-10),easeOutExpo:o=>o>=1?1:1-Math.pow(2,-10*o),easeInOutExpo:o=>o<=0?0:o>=1?1:o<.5?Math.pow(2,20*o-10)/2:(2-Math.pow(2,-20*o+10))/2};class f{constructor(e=0,t=0,r=1){Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"z",{enumerable:!0,configurable:!0,writable:!0,value:r})}get XY(){return[this.x,this.y]}setz(e){return this.z=e,this}setXY(e=this.x,t=this.y){return this.x=e,this.y=t,this}set(e=this.x,t=this.y,r=this.z){return this.x=e,this.y=t,this.z=r,this}setTo({x:e=0,y:t=0,z:r=1}){return this.x=e,this.y=t,this.z=r,this}rot(e){if(e===0)return this;const{x:t,y:r}=this,s=Math.sin(e),i=Math.cos(e);return this.x=t*i-r*s,this.y=t*s+r*i,this}rotWith(e,t){if(t===0)return this;const r=this.x-e.x,s=this.y-e.y,i=Math.sin(t),n=Math.cos(t);return this.x=e.x+(r*n-s*i),this.y=e.y+(r*i+s*n),this}clone(){const{x:e,y:t,z:r}=this;return new f(e,t,r)}sub(e){return this.x-=e.x,this.y-=e.y,this}subXY(e,t){return this.x-=e,this.y-=t,this}subScalar(e){return this.x-=e,this.y-=e,this}add(e){return this.x+=e.x,this.y+=e.y,this}addXY(e,t){return this.x+=e,this.y+=t,this}addScalar(e){return this.x+=e,this.y+=e,this}clamp(e,t){return this.x=Math.max(this.x,e),this.y=Math.max(this.y,e),t!==void 0&&(this.x=Math.min(this.x,t),this.y=Math.min(this.y,t)),this}div(e){return this.x/=e,this.y/=e,this}divV(e){return this.x/=e.x,this.y/=e.y,this}mul(e){return this.x*=e,this.y*=e,this}mulV(e){return this.x*=e.x,this.y*=e.y,this}abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this}nudge(e,t){const r=f.Tan(e,this);return this.add(r.mul(t))}neg(){return this.x*=-1,this.y*=-1,this}cross(e){return this.x=this.y*e.z-this.z*e.y,this.y=this.z*e.x-this.x*e.z,this}dpr(e){return f.Dpr(this,e)}cpr(e){return f.Cpr(this,e)}len2(){return f.Len2(this)}len(){return f.Len(this)}pry(e){return f.Pry(this,e)}per(){const{x:e,y:t}=this;return this.x=t,this.y=-e,this}uni(){return f.Uni(this)}tan(e){return f.Tan(this,e)}dist(e){return f.Dist(this,e)}distanceToLineSegment(e,t){return f.DistanceToLineSegment(e,t,this)}slope(e){return f.Slope(this,e)}snapToGrid(e){return this.x=Math.round(this.x/e)*e,this.y=Math.round(this.y/e)*e,this}angle(e){return f.Angle(this,e)}toAngle(){return f.ToAngle(this)}lrp(e,t){return this.x=this.x+(e.x-this.x)*t,this.y=this.y+(e.y-this.y)*t,this}equals(e,t){return f.Equals(this,e,t)}equalsXY(e,t){return f.EqualsXY(this,e,t)}norm(){const e=this.len();return this.x=e===0?0:this.x/e,this.y=e===0?0:this.y/e,this}toFixed(){return f.ToFixed(this)}toString(){return f.ToString(f.ToFixed(this))}toJson(){return f.ToJson(this)}toArray(){return f.ToArray(this)}static Add(e,t){return new f(e.x+t.x,e.y+t.y)}static AddXY(e,t,r){return new f(e.x+t,e.y+r)}static Sub(e,t){return new f(e.x-t.x,e.y-t.y)}static SubXY(e,t,r){return new f(e.x-t,e.y-r)}static AddScalar(e,t){return new f(e.x+t,e.y+t)}static SubScalar(e,t){return new f(e.x-t,e.y-t)}static Div(e,t){return new f(e.x/t,e.y/t)}static Mul(e,t){return new f(e.x*t,e.y*t)}static DivV(e,t){return new f(e.x/t.x,e.y/t.y)}static MulV(e,t){return new f(e.x*t.x,e.y*t.y)}static Neg(e){return new f(-e.x,-e.y)}static Per(e){return new f(e.y,-e.x)}static Dist2(e,t){return f.Sub(e,t).len2()}static Abs(e){return new f(Math.abs(e.x),Math.abs(e.y))}static Dist(e,t){return Math.hypot(e.y-t.y,e.x-t.x)}static Dpr(e,t){return e.x*t.x+e.y*t.y}static Cross(e,t){return new f(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z)}static Cpr(e,t){return e.x*t.y-t.x*e.y}static Len2(e){return e.x*e.x+e.y*e.y}static Len(e){return Math.hypot(e.x,e.y)}static Pry(e,t){return f.Dpr(e,t)/f.Len(t)}static Uni(e){return f.Div(e,f.Len(e))}static Tan(e,t){return f.Uni(f.Sub(e,t))}static Min(e,t){return new f(Math.min(e.x,t.x),Math.min(e.y,t.y))}static Max(e,t){return new f(Math.max(e.x,t.x),Math.max(e.y,t.y))}static From(e){return new f().add(e)}static FromArray(e){return new f(e[0],e[1])}static Rot(e,t=0){const r=Math.sin(t),s=Math.cos(t);return new f(e.x*s-e.y*r,e.x*r+e.y*s)}static RotWith(e,t,r){const s=e.x-t.x,i=e.y-t.y,n=Math.sin(r),a=Math.cos(r);return new f(t.x+(s*a-i*n),t.y+(s*n+i*a))}static NearestPointOnLineThroughPoint(e,t,r){return f.Mul(t,f.Sub(r,e).pry(t)).add(e)}static NearestPointOnLineSegment(e,t,r,s=!0){const i=f.Tan(t,e),n=f.Add(e,f.Mul(i,f.Sub(r,e).pry(i)));if(s){if(n.x<Math.min(e.x,t.x))return f.Cast(e.x<t.x?e:t);if(n.x>Math.max(e.x,t.x))return f.Cast(e.x>t.x?e:t);if(n.y<Math.min(e.y,t.y))return f.Cast(e.y<t.y?e:t);if(n.y>Math.max(e.y,t.y))return f.Cast(e.y>t.y?e:t)}return n}static DistanceToLineThroughPoint(e,t,r){return f.Dist(r,f.NearestPointOnLineThroughPoint(e,t,r))}static DistanceToLineSegment(e,t,r,s=!0){return f.Dist(r,f.NearestPointOnLineSegment(e,t,r,s))}static Snap(e,t=1){return new f(Math.round(e.x/t)*t,Math.round(e.y/t)*t)}static Cast(e){return e instanceof f?e:f.From(e)}static Slope(e,t){return e.x===t.y?NaN:(e.y-t.y)/(e.x-t.x)}static Angle(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}static Lrp(e,t,r){return f.Sub(t,e).mul(r).add(e)}static Med(e,t){return new f((e.x+t.x)/2,(e.y+t.y)/2)}static Equals(e,t,r=1e-4){return Math.abs(e.x-t.x)<r&&Math.abs(e.y-t.y)<r}static EqualsXY(e,t,r){return e.x===t&&e.y===r}static EqualsXYZ(e,t,r=1e-4){return f.Equals(e,t,r)&&Math.abs((e.z||0)-(t.z||0))<r}static Clockwise(e,t,r){return(r.x-e.x)*(t.y-e.y)-(t.x-e.x)*(r.y-e.y)<0}static Rescale(e,t){const r=f.Len(e);return new f(t*e.x/r,t*e.y/r)}static ScaleWithOrigin(e,t,r){return f.Sub(e,r).mul(t).add(r)}static ScaleWOrigin(e,t,r){return f.Sub(e,r).mulV(t).add(r)}static ToFixed(e,t=2){return new f(+e.x.toFixed(t),+e.y.toFixed(t),+e.z.toFixed(t))}static Nudge(e,t,r){return f.Add(e,f.Tan(t,e).mul(r))}static ToString(e){return`${e.x}, ${e.y}`}static ToAngle(e){let t=Math.atan2(e.y,e.x);return t<0&&(t+=Math.PI*2),t}static FromAngle(e,t=1){return new f(Math.cos(e)*t,Math.sin(e)*t)}static ToArray(e){return[e.x,e.y,e.z]}static ToJson(e){const{x:t,y:r,z:s}=e;return{x:t,y:r,z:s}}static Average(e){const t=e.length,r=new f(0,0);for(let s=0;s<t;s++)r.add(e[s]);return r.div(t)}static Clamp(e,t,r){return r===void 0?new f(Math.min(Math.max(e.x,t)),Math.min(Math.max(e.y,t))):new f(Math.min(Math.max(e.x,t),r),Math.min(Math.max(e.y,t),r))}static PointsBetween(e,t,r=6){const s=[];for(let i=0;i<r;i++){const n=zu.easeInQuad(i/(r-1)),a=f.Lrp(e,t,n);a.z=Math.min(1,.5+Math.abs(.5-Uu(n))*.65),s.push(a)}return s}static SnapToGrid(e,t=8){return new f(Math.round(e.x/t)*t,Math.round(e.y/t)*t)}}const Uu=o=>o<.5?2*o*o:-1+(4-2*o)*o;class W extends f{constructor(e=0,t=0,r=0,s={x:0,y:0},i=0,n=0){super(e,t,r),Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"z",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"v",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"t",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"a",{enumerable:!0,configurable:!0,writable:!0,value:n})}get timestamp(){return this.t}get pressure(){return this.z}get angleNum(){return this.a}get XY(){return[this.x,this.y]}setA(e){this.a=e}setT(e){this.t=e}setv(e){return this.v={x:e.x,y:e.y},this}set(e=this.x,t=this.y,r=this.z,s=this.v,i=this.t,n=this.a){return this.x=e,this.y=t,this.z=r,this.v=s,this.t=i,this.a=n,this}clone(){const{x:e,y:t,z:r,v:s,t:i,a:n}=this,a={x:s.x,y:s.y};return new W(e,t,r,a,i,n)}distance(e){return W.GetDistance(this,e)}isNear(e,t){return W.IsNear(this,e,t)}getAngleByPoints(e,t){return W.GetAngleByPoints(e,this,t)}static Sub(e,t){return new W(e.x-t.x,e.y-t.y)}static Add(e,t){return new W(e.x+t.x,e.y+t.y)}static GetDistance(e,t){return W.Len(e.clone().sub(t))}static GetAngleByPoints(e,t,r){const s=t.x-e.x,i=r.x-t.x,n=t.y-e.y,a=r.y-t.y;let l=0;const c=Math.sqrt(s*s+n*n),h=Math.sqrt(i*i+a*a);if(c&&h){const d=s*i+n*a;l=Math.acos(d/(c*h)),l=l/Math.PI*180;let u=s*a-n*i;u=u>0?1:-1,l=180+u*l}return l}static IsNear(e,t,r){return W.Len(e.clone().sub(t))<r}static RotWith(e,t,r,s=2){const i=e.x-t.x,n=e.y-t.y,a=Math.sin(r),l=Math.cos(r),c=Math.pow(10,s),h=Math.floor((t.x+(i*l-n*a))*c)/c,d=Math.floor((t.y+(i*a+n*l))*c)/c;return new W(h,d)}static GetDotStroke(e,t,r=16){const s=new f(1,1),i=Math.PI+.001,n=W.Add(e,W.Sub(e,s).uni().per().mul(-t)),a=[];for(let l=1/r,c=l;c<=1;c+=l)a.push(W.RotWith(n,e,i*2*c));return a}static GetSemicircleStroke(e,t,r=-1,s=8){const i=r*(Math.PI+.001),n=[];for(let a=1/s,l=a;l<=1;l+=a)n.push(W.RotWith(t,e,i*l));return n}}function j(o,e){if(o&&e){const t=Math.min(o.x,e.x),r=Math.min(o.y,e.y),s=Math.max(o.x+o.w,e.x+e.w),i=Math.max(o.y+o.h,e.y+e.h),n=s-t,a=i-r;return{x:t,y:r,w:n,h:a}}return e||o}function Y(o,e=0){const t={x:0,y:0,w:0,h:0};let r=1/0,s=1/0,i=-1/0,n=-1/0;return o.forEach(a=>{const[l,c]=a.XY;r=Math.min(r,l-e),s=Math.min(s,c-e),i=Math.max(i,l+e),n=Math.max(n,c+e)}),t.x=r,t.y=s,t.w=i-r,t.h=n-s,t}function Te(o,e){return!(o.x+o.w<e.x||o.x>e.x+e.w||o.y+o.h<e.y||o.y>e.y+e.h)}function _u(o,e){return o.length===e.length&&o.sort().toString()===e.sort().toString()}function J(o,e=10){return{x:Math.floor(o.x-e),y:Math.floor(o.y-e),w:Math.floor(o.w+e*2),h:Math.floor(o.h+e*2)}}function Ae(o,e){return{x:o.x+e[0],y:o.y+e[1],w:o.w,h:o.h}}function Wr(o,e){const t=new f(o.x,o.y),r=new f(o.x+o.w,o.y),s=new f(o.x+o.w,o.y+o.h),i=new f(o.x,o.y+o.h),n=new f(o.x+o.w/2,o.y+o.h/2),a=Math.PI*e/180,l=f.RotWith(t,n,a),c=f.RotWith(r,n,a),h=f.RotWith(s,n,a),d=f.RotWith(i,n,a);return Y([l,c,h,d])}function Rr(o,e){const t=new f(o.x,o.y),r=new f(o.x+o.w,o.y),s=new f(o.x+o.w,o.y+o.h),i=new f(o.x,o.y+o.h),n=new f(o.x+o.w/2,o.y+o.h/2),a=new f(e[0],e[1]),l=f.ScaleWOrigin(t,a,n),c=f.ScaleWOrigin(r,a,n),h=f.ScaleWOrigin(s,a,n),d=f.ScaleWOrigin(i,a,n);return Y([l,c,h,d])}function $u(o,e,t){const r=new f(e[0],e[1]);for(let s=0;s<o.length;s+=3){const i=new f(o[s],o[s+1]),n=Math.PI*t/180,a=f.RotWith(i,r,n);o[s]=a.x,o[s+1]=a.y}}function Yu(o,e,t){const r=new f(e[0],e[1]);for(let s=0;s<o.length;s+=3){const i=new f(o[s],o[s+1]),n=new f(t[0],t[1]);if(s<o.length-3){const l=new f(o[s+3],o[s+4]),c=f.Tan(l,i).per().mul(o[s+2]).mulV(n).len();o[s+2]=c}else if(s===o.length-3){const l=new f(o[s-3],o[s-2]),c=f.Tan(i,l).per().mul(o[s+2]).mulV(n).len();o[s+2]=c}const a=f.ScaleWOrigin(i,n,r);o[s]=a.x,o[s+1]=a.y}}function Xu(o,e){return o[0]>=e.x&&o[0]<=e.x+e.w&&o[1]>=e.y&&o[1]<=e.y+e.h}function Mr(o,e){const t=o<=e?1:o/e,r=e<=o?1:e/o;return[t,r]}const Qe=o=>{if(o.tagName==="GROUP"){const e=Object.getOwnPropertySymbols(o).find(t=>t.toString()==="Symbol(sealed)");if(e&&o[e])return!0}return!1},jr=o=>o!==k.Text;function xe(o){return`${Je(o.x)},${Je(o.y)} `}function Oe(o,e){return`${Je((o.x+e.x)/2)},${Je((o.y+e.y)/2)} `}function Je(o){return+o.toFixed(4)}var Gu=ye,Vu=ce,Hu="[object Number]";function Zu(o){return typeof o=="number"||Vu(o)&&Gu(o)==Hu}var qu=Zu,ue=ge(qu);class x{constructor(e){Object.defineProperty(this,"syncUnitTime",{enumerable:!0,configurable:!0,writable:!0,value:1e3}),Object.defineProperty(this,"vNodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workId",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{vNodes:t,fullLayer:r,drawLayer:s}=e;this.vNodes=t,this.fullLayer=r,this.drawLayer=s}setWorkId(e){this.workId=e}getWorkId(){return this.workId}getWorkOptions(){return this.workOptions}setWorkOptions(e){var t;this.workOptions=e,this.syncUnitTime=e.syncUnitTime||this.syncUnitTime;const r=(t=this.workId)==null?void 0:t.toString(),s=r&&this.vNodes.get(r)||void 0;r&&s&&(s.opt=e,this.vNodes.setInfo(r,s))}updataOptService(e){var t;let r;const s=(t=this.workId)==null?void 0:t.toString();if(s&&e){const i=this.fullLayer.getElementsByName(s)||this.drawLayer&&this.drawLayer.getElementsByName(s)||[];if(i.length!==1)return;const n=i[0],{pos:a,zIndex:l,scale:c,angle:h,translate:d}=e,u={};ue(l)&&(u.zIndex=l),a&&(u.pos=[a[0],a[1]]),c&&(u.scale=c),h&&(u.rotate=h),d&&(u.translate=d),n.attr(u);const p=n==null?void 0:n.getBoundingClientRect();return p&&(r=j(r,{x:Math.floor(p.x-x.SafeBorderPadding),y:Math.floor(p.y-x.SafeBorderPadding),w:Math.floor(p.width+x.SafeBorderPadding*2),h:Math.floor(p.height+x.SafeBorderPadding*2)})),this.vNodes.setInfo(s,{rect:r,centerPos:a}),r}}static updateNodeOpt(e){const{node:t,opt:r,vNodes:s,willSerializeData:i,targetNode:n}=e,{zIndex:a,translate:l,angle:c,box:h,boxScale:d,boxTranslate:u,pointMap:p}=r;let w;const y=n&&te(n)||s.get(t.name);if(!y)return;ue(a)&&(t.setAttribute("zIndex",a),y.opt.zIndex=a);const v=t.parent;if(v){if(h&&u&&d){const{rect:S}=y,T=[];for(let B=0;B<y.op.length;B+=3)T.push(new W(y.op[B],y.op[B+1],y.op[B+2]));const O=Y(T),P=[O.w*v.worldScaling[0],O.h*v.worldScaling[0]],g=[S.w-P[0],S.h-P[1]],b=[(S.w*d[0]-g[0])/P[0],(S.h*d[1]-g[1])/P[1]],C=[u[0]/v.worldScaling[0],u[1]/v.worldScaling[1]],I=y.op.map((B,G)=>{const K=G%3;return K===0?B+C[0]:K===1?B+C[1]:B}),R=[y.centerPos[0]+C[0],y.centerPos[1]+C[1]];Yu(I,R,b);const A=[];for(let B=0;B<I.length;B+=3)A.push(new W(I[B],I[B+1],I[B+2]));y.op=I,y.centerPos=R}else if(l){const S=[l[0]/v.worldScaling[0],l[1]/v.worldScaling[1]];t.setAttribute("translate",S),y.opt.translate=S,n&&(w=Ae(y.rect,l),y.rect=w)}else ue(c)&&(t.setAttribute("rotate",c),y.opt.rotate=c,n&&(w=Wr(y.rect,c),y.rect=w));if(p){const S=p.get(t.name);if(S)for(let T=0,O=0;T<y.op.length;T+=3,O++)y.op[T]=S[O][0],y.op[T+1]=S[O][1]}if(i){if(l){const S=[l[0]/v.worldScaling[0],l[1]/v.worldScaling[1]],T=y.op.map((O,P)=>{const g=P%3;return g===0?O+S[0]:g===1?O+S[1]:O});y.op=T,y.centerPos=[y.centerPos[0]+S[0],y.centerPos[1]+S[1]],y!=null&&y.opt&&(y.opt.translate=void 0)}else if(ue(c)){const S=y.op;$u(S,y.centerPos,c),y.op=S,y!=null&&y.opt&&(y.opt.rotate=void 0)}}y&&s.setInfo(t.name,y)}}static getCenterPos(e,t){const{worldPosition:r,worldScaling:s}=t;return[(e.x+e.w/2-r[0])/s[0],(e.y+e.h/2-r[1])/s[1]]}static getRectFromLayer(e,t){const r=e.getElementsByName(t)[0];if(r){const s=r.getBoundingClientRect();return{x:Math.floor(s.x-x.SafeBorderPadding),y:Math.floor(s.y-x.SafeBorderPadding),w:Math.floor(s.width+x.SafeBorderPadding*2),h:Math.floor(s.height+x.SafeBorderPadding*2)}}}}Object.defineProperty(x,"SafeBorderPadding",{enumerable:!0,configurable:!0,writable:!0,value:10});function Ce(o,e=!0){const t=o.length;if(t<2)return"";let r=o[0],s=o[1];if(t===2)return`M${xe(r)}L${xe(s)}`;let i="";for(let n=2,a=t-1;n<a;n++)r=o[n],s=o[n+1],i+=Oe(r,s);return e?`M${Oe(o[0],o[1])}Q${xe(o[1])}${Oe(o[1],o[2])}T${i}${Oe(o[t-1],o[0])}${Oe(o[0],o[1])}Z`:`M${xe(o[0])}Q${xe(o[1])}${Oe(o[1],o[2])}${o.length>3?"T":""}${i}L${xe(o[t-1])}`}var kt={exports:{}};kt.exports,function(o){var e=function(){var t=String.fromCharCode,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",i={};function n(l,c){if(!i[l]){i[l]={};for(var h=0;h<l.length;h++)i[l][l.charAt(h)]=h}return i[l][c]}var a={compressToBase64:function(l){if(l==null)return"";var c=a._compress(l,6,function(h){return r.charAt(h)});switch(c.length%4){default:case 0:return c;case 1:return c+"===";case 2:return c+"==";case 3:return c+"="}},decompressFromBase64:function(l){return l==null?"":l==""?null:a._decompress(l.length,32,function(c){return n(r,l.charAt(c))})},compressToUTF16:function(l){return l==null?"":a._compress(l,15,function(c){return t(c+32)})+" "},decompressFromUTF16:function(l){return l==null?"":l==""?null:a._decompress(l.length,16384,function(c){return l.charCodeAt(c)-32})},compressToUint8Array:function(l){for(var c=a.compress(l),h=new Uint8Array(c.length*2),d=0,u=c.length;d<u;d++){var p=c.charCodeAt(d);h[d*2]=p>>>8,h[d*2+1]=p%256}return h},decompressFromUint8Array:function(l){if(l==null)return a.decompress(l);for(var c=new Array(l.length/2),h=0,d=c.length;h<d;h++)c[h]=l[h*2]*256+l[h*2+1];var u=[];return c.forEach(function(p){u.push(t(p))}),a.decompress(u.join(""))},compressToEncodedURIComponent:function(l){return l==null?"":a._compress(l,6,function(c){return s.charAt(c)})},decompressFromEncodedURIComponent:function(l){return l==null?"":l==""?null:(l=l.replace(/ /g,"+"),a._decompress(l.length,32,function(c){return n(s,l.charAt(c))}))},compress:function(l){return a._compress(l,16,function(c){return t(c)})},_compress:function(l,c,h){if(l==null)return"";var d,u,p={},w={},y="",v="",S="",T=2,O=3,P=2,g=[],b=0,C=0,I;for(I=0;I<l.length;I+=1)if(y=l.charAt(I),Object.prototype.hasOwnProperty.call(p,y)||(p[y]=O++,w[y]=!0),v=S+y,Object.prototype.hasOwnProperty.call(p,v))S=v;else{if(Object.prototype.hasOwnProperty.call(w,S)){if(S.charCodeAt(0)<256){for(d=0;d<P;d++)b=b<<1,C==c-1?(C=0,g.push(h(b)),b=0):C++;for(u=S.charCodeAt(0),d=0;d<8;d++)b=b<<1|u&1,C==c-1?(C=0,g.push(h(b)),b=0):C++,u=u>>1}else{for(u=1,d=0;d<P;d++)b=b<<1|u,C==c-1?(C=0,g.push(h(b)),b=0):C++,u=0;for(u=S.charCodeAt(0),d=0;d<16;d++)b=b<<1|u&1,C==c-1?(C=0,g.push(h(b)),b=0):C++,u=u>>1}T--,T==0&&(T=Math.pow(2,P),P++),delete w[S]}else for(u=p[S],d=0;d<P;d++)b=b<<1|u&1,C==c-1?(C=0,g.push(h(b)),b=0):C++,u=u>>1;T--,T==0&&(T=Math.pow(2,P),P++),p[v]=O++,S=String(y)}if(S!==""){if(Object.prototype.hasOwnProperty.call(w,S)){if(S.charCodeAt(0)<256){for(d=0;d<P;d++)b=b<<1,C==c-1?(C=0,g.push(h(b)),b=0):C++;for(u=S.charCodeAt(0),d=0;d<8;d++)b=b<<1|u&1,C==c-1?(C=0,g.push(h(b)),b=0):C++,u=u>>1}else{for(u=1,d=0;d<P;d++)b=b<<1|u,C==c-1?(C=0,g.push(h(b)),b=0):C++,u=0;for(u=S.charCodeAt(0),d=0;d<16;d++)b=b<<1|u&1,C==c-1?(C=0,g.push(h(b)),b=0):C++,u=u>>1}T--,T==0&&(T=Math.pow(2,P),P++),delete w[S]}else for(u=p[S],d=0;d<P;d++)b=b<<1|u&1,C==c-1?(C=0,g.push(h(b)),b=0):C++,u=u>>1;T--,T==0&&(T=Math.pow(2,P),P++)}for(u=2,d=0;d<P;d++)b=b<<1|u&1,C==c-1?(C=0,g.push(h(b)),b=0):C++,u=u>>1;for(;;)if(b=b<<1,C==c-1){g.push(h(b));break}else C++;return g.join("")},decompress:function(l){return l==null?"":l==""?null:a._decompress(l.length,32768,function(c){return l.charCodeAt(c)})},_decompress:function(l,c,h){var d=[],u=4,p=4,w=3,y="",v=[],S,T,O,P,g,b,C,I={val:h(0),position:c,index:1};for(S=0;S<3;S+=1)d[S]=S;for(O=0,g=Math.pow(2,2),b=1;b!=g;)P=I.val&I.position,I.position>>=1,I.position==0&&(I.position=c,I.val=h(I.index++)),O|=(P>0?1:0)*b,b<<=1;switch(O){case 0:for(O=0,g=Math.pow(2,8),b=1;b!=g;)P=I.val&I.position,I.position>>=1,I.position==0&&(I.position=c,I.val=h(I.index++)),O|=(P>0?1:0)*b,b<<=1;C=t(O);break;case 1:for(O=0,g=Math.pow(2,16),b=1;b!=g;)P=I.val&I.position,I.position>>=1,I.position==0&&(I.position=c,I.val=h(I.index++)),O|=(P>0?1:0)*b,b<<=1;C=t(O);break;case 2:return""}for(d[3]=C,T=C,v.push(C);;){if(I.index>l)return"";for(O=0,g=Math.pow(2,w),b=1;b!=g;)P=I.val&I.position,I.position>>=1,I.position==0&&(I.position=c,I.val=h(I.index++)),O|=(P>0?1:0)*b,b<<=1;switch(C=O){case 0:for(O=0,g=Math.pow(2,8),b=1;b!=g;)P=I.val&I.position,I.position>>=1,I.position==0&&(I.position=c,I.val=h(I.index++)),O|=(P>0?1:0)*b,b<<=1;d[p++]=t(O),C=p-1,u--;break;case 1:for(O=0,g=Math.pow(2,16),b=1;b!=g;)P=I.val&I.position,I.position>>=1,I.position==0&&(I.position=c,I.val=h(I.index++)),O|=(P>0?1:0)*b,b<<=1;d[p++]=t(O),C=p-1,u--;break;case 2:return v.join("")}if(u==0&&(u=Math.pow(2,w),w++),d[C])y=d[C];else if(C===p)y=T+T.charAt(0);else return null;v.push(y),d[p++]=T+y.charAt(0),u--,T=y,u==0&&(u=Math.pow(2,w),w++)}}};return a}();o!=null?o.exports=e:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return e})}(kt);var Ar=kt.exports;function Ke(o){return JSON.parse(Ar.decompress(o))}function le(o){return Ar.compress(JSON.stringify(o))}class Br extends x{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.Pencil}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"MAX_REPEAR",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"uniThickness",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"centerPos",{enumerable:!0,configurable:!0,writable:!0,value:[0,0]}),this.workOptions=e.toolsOpt,this.uniThickness=this.MAX_REPEAR/this.workOptions.thickness/10,this.syncTimestamp=0}combineConsume(){var e;const t=(e=this.workId)==null?void 0:e.toString(),r=this.transformDataAll(!0),s={name:t};let i;const n=this.drawLayer||this.fullLayer;return r.length&&(i=this.draw({attrs:s,tasks:r,replaceId:t,layer:n,isClearAll:!0})),{rect:i,type:m.DrawWork,dataType:M.Local}}setWorkOptions(e){super.setWorkOptions(e),this.syncTimestamp=Date.now()}consume(e){var t;const{data:r,isFullWork:s,isClearAll:i,isSubWorker:n}=e;if(((t=r.op)==null?void 0:t.length)===0)return{type:m.None};const{workId:a}=r,{tasks:l,effects:c,consumeIndex:h}=this.transformData(r,!1);this.syncIndex=Math.min(this.syncIndex,h,Math.max(0,this.tmpPoints.length-2));const d={name:a==null?void 0:a.toString()};let u,p=!1;const w=this.syncIndex;if(this.syncTimestamp===0&&(this.syncTimestamp=Date.now()),l.length&&(l[0].taskId-this.syncTimestamp>this.syncUnitTime&&(p=!0,this.syncTimestamp=l[0].taskId,this.syncIndex=this.tmpPoints.length),n)){const v=s?this.fullLayer:this.drawLayer||this.fullLayer;u=this.draw({attrs:d,tasks:l,effects:c,layer:v,isClearAll:i})}if(n)return h>10&&this.tmpPoints.splice(0,h-10),{rect:u,type:m.DrawWork,dataType:M.Local};const y=[];return this.tmpPoints.slice(w).forEach(v=>{y.push(v.x,v.y,this.computRadius(v.z,this.workOptions.thickness))}),{rect:u,type:m.DrawWork,dataType:M.Local,workId:p?a:void 0,op:p?y:void 0,index:p?w*3:void 0}}consumeAll(e){var t,r;if(e.data){const{op:d,workState:u}=e.data;d!=null&&d.length&&u===E.Done&&this.workOptions.strokeType===Z.Stroke&&this.updateTempPointsWithPressureWhenDone(d)}const s=(t=this.workId)==null?void 0:t.toString();if(!s)return{type:m.None};const i=this.transformDataAll(!0),n={name:s};let a;const l=this.fullLayer;i.length&&(a=this.draw({attrs:n,tasks:i,replaceId:s,layer:l,isClearAll:!1}));const c=[];this.tmpPoints.map(d=>{c.push(d.x,d.y,this.computRadius(d.z,this.workOptions.thickness))}),this.syncTimestamp=0,delete this.workOptions.syncUnitTime;const h=le(c);return this.vNodes.setInfo(s,{rect:a,op:c,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:a&&x.getCenterPos(a,l)}),{rect:a,type:m.FullWork,dataType:M.Local,workId:s,ops:h,updateNodeOpt:{pos:this.centerPos,useAnimation:!0},opt:this.workOptions,undoTickerId:(r=e.data)==null?void 0:r.undoTickerId}}clearTmpPoints(){this.tmpPoints.length=0,this.syncTimestamp=0,this.syncIndex=0}consumeService(e){var t;const{op:r,isFullWork:s,replaceId:i,isClearAll:n}=e;this.tmpPoints.length=0;for(let d=0;d<r.length;d+=3){const u=new W(r[d],r[d+1],r[d+2]);if(this.tmpPoints.length>0){const p=this.tmpPoints[this.tmpPoints.length-1],w=f.Sub(u,p).uni();u.setv(w)}this.tmpPoints.push(u)}const a=this.transformDataAll(!1),l=(t=this.workId)==null?void 0:t.toString(),c={name:l};let h;if(l&&a.length){const d=s?this.fullLayer:this.drawLayer||this.fullLayer;h=this.draw({attrs:c,tasks:a,replaceId:i,layer:d,isClearAll:n}),this.vNodes.setInfo(l,{rect:h,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:h&&x.getCenterPos(h,d)})}return h}transformDataAll(e=!0){return this.getTaskPoints(this.tmpPoints,e&&this.workOptions.thickness||void 0)}draw(e){var t;const{attrs:r,tasks:s,replaceId:i,effects:n,layer:a,isClearAll:l}=e,{strokeColor:c,strokeType:h,thickness:d,zIndex:u,scale:p,rotate:w,translate:y}=this.workOptions;l&&a.removeAllChildren(),i&&(this.fullLayer.getElementsByName(i+"").map(g=>g.remove()),(t=this.drawLayer)==null||t.getElementsByName(i+"").map(g=>g.remove())),n!=null&&n.size&&(n.forEach(g=>{var b;(b=a.getElementById(g+""))==null||b.remove()}),n.clear());let v;const S=[],T=a.worldPosition,O=a.worldScaling;for(let g=0;g<s.length;g++){const{pos:b,points:C,taskId:I}=s[g];r.id=I.toString();const{ps:R,rect:A}=this.computDrawPoints(C);let B;const G=C.length===1;h===Z.Stroke||G?B=Ce(R,!0):B=Ce(R,!1);const K={pos:b,d:B,fillColor:h===Z.Stroke||G?c:void 0,lineDash:h===Z.Dotted&&!G?[1,d*2]:h===Z.LongDotted&&!G?[d,d*2]:void 0,strokeColor:c,lineCap:h===Z.Stroke||G?void 0:"round",lineWidth:h===Z.Stroke||G?0:d};v=j(v,{x:Math.floor((A.x+b[0])*O[0]+T[0]-x.SafeBorderPadding),y:Math.floor((A.y+b[1])*O[1]+T[1]-x.SafeBorderPadding),w:Math.floor(A.w*O[0]+2*x.SafeBorderPadding),h:Math.floor(A.h*O[1]+2*x.SafeBorderPadding)}),S.push(K)}p&&(r.scale=p),w&&(r.rotate=w),y&&(r.translate=y);const P=new _.Group;if(v){this.centerPos=x.getCenterPos(v,a),P.attr({...r,normalize:!0,id:r.name,anchor:[.5,.5],bgcolor:h===Z.Stroke?c:void 0,pos:this.centerPos,size:[(v.w-2*x.SafeBorderPadding)/O[0],(v.h-2*x.SafeBorderPadding)/O[1]],zIndex:u});const g=S.map(b=>(b.pos=[b.pos[0]-this.centerPos[0],b.pos[1]-this.centerPos[1]],new _.Path(b)));P.append(...g),h===Z.Stroke&&P.seal(),a.append(P)}if(p||w||y){const g=P==null?void 0:P.getBoundingClientRect();if(g)return{x:Math.floor(g.x-x.SafeBorderPadding),y:Math.floor(g.y-x.SafeBorderPadding),w:Math.floor(g.width+x.SafeBorderPadding*2),h:Math.floor(g.height+x.SafeBorderPadding*2)}}return v}computDrawPoints(e){return this.workOptions.strokeType===Z.Stroke||e.length===1?this.computStroke(e):this.computNomal(e)}computNomal(e){let t=this.workOptions.thickness;const r=e.map(s=>(t=Math.max(t,s.radius),s.point));return{ps:r,rect:Y(r,t)}}computStroke(e){return e.length===1?this.computDotStroke(e[0]):this.computLineStroke(e)}computLineStroke(e){const t=[],r=[];for(let l=0;l<e.length;l++){const{point:c,radius:h}=e[l];let d=c.v;l===0&&e.length>1&&(d=e[l+1].point.v);const u=f.Per(d).mul(h);t.push(W.Sub(c,u)),r.push(W.Add(c,u))}const s=e[e.length-1],i=W.GetSemicircleStroke(s.point,t[t.length-1],-1,8),n=W.GetSemicircleStroke(e[0].point,r[0],-1,8),a=t.concat(i,r.reverse(),n);return{ps:a,rect:Y(a)}}computDotStroke(e){const{point:t,radius:r}=e,s={x:t.x-r,y:t.y-r,w:r*2,h:r*2};return{ps:W.GetDotStroke(t,r,8),rect:s}}transformData(e,t){const{op:r,workState:s}=e;let i=this.tmpPoints.length-1,n=[];if(r!=null&&r.length&&s){const{strokeType:a,thickness:l}=this.workOptions,c=new Set;i=a===Z.Stroke?this.updateTempPointsWithPressure(r,l,c):this.updateTempPoints(r,l,c);const h=t?this.tmpPoints:this.tmpPoints.slice(i);return n=this.getTaskPoints(h,l),{tasks:n,effects:c,consumeIndex:i}}return{tasks:n,consumeIndex:i}}computRadius(e,t){return e*.03*t+t*.5}getMinZ(e,t){return((t||Math.max(1,Math.floor(e*.3)))-e*.5)*100/e/3}getTaskPoints(e,t){var r;const s=[];if(e.length===0)return[];let i=0,n=e[0].x,a=e[0].y,l=[n,a],c=[],h=e[0].t;for(;i<e.length;){const d=e[i],u=d.x-n,p=d.y-a,w=d.z,y=t?this.computRadius(w,t):w;if(c.push({point:new W(u,p,w,e[i].v),radius:y}),i>0&&i<e.length-1){const v=e[i].getAngleByPoints(e[i-1],e[i+1]);if(v<90||v>270){const S=(r=c.pop())==null?void 0:r.point.clone();S&&s.push({taskId:h,pos:l,points:[...c,{point:S,radius:y}]}),n=e[i].x,a=e[i].y,l=[n,a];const T=d.x-n,O=d.y-a;c=[{point:new W(T,O,w),radius:y}],h=Date.now()}}i++}return s.push({taskId:h,pos:l,points:c}),s}updateTempPointsWithPressure(e,t,r){const s=Date.now(),i=this.tmpPoints.length;let n=i;for(let l=0;l<e.length;l+=2){n=Math.min(n,i);const c=this.tmpPoints.length,h=new W(e[l],e[l+1]);if(c===0){this.tmpPoints.push(h);continue}const d=c-1,u=this.tmpPoints[d],p=f.Sub(h,u).uni();if(h.isNear(u,t)){if(u.z<this.MAX_REPEAR){if(u.setz(Math.min(u.z+1,this.MAX_REPEAR)),n=Math.min(n,d),c>1){let v=c-1;for(;v>0;){const S=this.tmpPoints[v].distance(this.tmpPoints[v-1]),T=Math.max(this.tmpPoints[v].z-this.uniThickness*S,0);if(this.tmpPoints[v-1].z>=T)break;this.tmpPoints[v-1].setz(T),n=Math.min(n,v-1),v--}}}else n=1/0;continue}h.setv(p);const w=h.distance(u),y=Math.max(u.z-this.uniThickness*w,0);c>1&&f.Equals(p,u.v,.02)&&(y>0||u.z<=0)&&(r&&u.t&&r.add(u.t),this.tmpPoints.pop(),n=Math.min(d,n)),h.setz(y),this.tmpPoints.push(h)}if(n===1/0)return this.tmpPoints.length;let a=i;if(n===i){a=Math.max(a-1,0);const l=this.tmpPoints[a].t;l&&(r==null||r.add(l))}else{let l=i-1;for(a=n;l>=0;){const c=this.tmpPoints[l].t;if(c&&(r==null||r.add(c),l<=n)){a=l,l=-1;break}l--}}return this.tmpPoints[a].setT(s),a}updateTempPoints(e,t,r){var s;const i=Date.now(),n=this.tmpPoints.length;let a=n;for(let c=0;c<e.length;c+=2){const h=this.tmpPoints.length,d=new W(e[c],e[c+1]);if(h===0){this.tmpPoints.push(d);continue}const u=h-1,p=this.tmpPoints[u],w=f.Sub(d,p).uni();if(d.isNear(p,t/2)){a=Math.min(u,a);continue}f.Equals(w,p.v,.02)&&(r&&p.t&&r.add(p.t),this.tmpPoints.pop(),a=Math.min(u,a)),d.setv(w),this.tmpPoints.push(d)}let l=n;if(a===n){l=Math.max(l-1,0);const c=this.tmpPoints[l].t;c&&(r==null||r.add(c))}else{let c=Math.min(n-1,a);for(l=a;c>=0;){const h=(s=this.tmpPoints[c])==null?void 0:s.t;if(h&&(r==null||r.add(h),c<=a)){l=c,c=-1;break}c--}}return this.tmpPoints[l].setT(i),l}updateTempPointsWithPressureWhenDone(e){const{thickness:t}=this.workOptions,r=e.length,s=this.getMinZ(t);for(let i=0;i<r;i+=2){const n=this.tmpPoints.length,a=new W(e[i],e[i+1]);if(n===0){this.tmpPoints.push(a);continue}const l=n-1,c=this.tmpPoints[l],h=f.Sub(a,c).uni(),d=a.distance(c);if(n>1&&c.z===s)break;if(a.isNear(c,t/2)){if(r<3&&c.z<this.MAX_REPEAR&&(c.setz(Math.min(c.z+1,this.MAX_REPEAR)),n>1)){let p=n-1;for(;p>0;){const w=this.tmpPoints[p].distance(this.tmpPoints[p-1]),y=Math.max(this.tmpPoints[p].z-this.uniThickness*w,-t/4);if(this.tmpPoints[p-1].z>=y)break;this.tmpPoints[p-1].setz(y),p--}}continue}a.setv(h);const u=Math.max(c.z-this.uniThickness*d,s);n>1&&f.Equals(h,c.v,.02)&&c.z<=0&&this.tmpPoints.pop(),a.setz(u),this.tmpPoints.push(a)}}static updateNodeOpt(e){var t;const{node:r,opt:s,vNodes:i}=e,{strokeColor:n}=s,a=i.get(r.name);return n&&(r.tagName==="GROUP"?Qe(r)?r.setAttribute("bgcolor",n):r.children.forEach(l=>{l.setAttribute("strokeColor",n),l.getAttribute("fillColor")&&l.setAttribute("fillColor",n)}):(r.setAttribute("strokeColor",n),r.setAttribute("fillColor",n)),(t=a==null?void 0:a.opt)!=null&&t.strokeColor&&(a.opt.strokeColor=n)),a&&i.setInfo(r.name,a),x.updateNodeOpt(e)}static getRectFromLayer(e,t){const r=e.getElementsByName(t)[0];if(r){const s=r.getBoundingClientRect();return{x:Math.floor(s.x-x.SafeBorderPadding),y:Math.floor(s.y-x.SafeBorderPadding),w:Math.floor(s.width+x.SafeBorderPadding*2),h:Math.floor(s.height+x.SafeBorderPadding*2)}}}}class Dr extends x{constructor(e){super(e),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.LaserPen}),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.none}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"consumeIndex",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.workOptions=e.toolsOpt,this.syncTimestamp=0}combineConsume(){}setWorkOptions(e){super.setWorkOptions(e),this.syncTimestamp=Date.now()}consume(e){const{data:t,isSubWorker:r}=e,{workId:s,op:i}=t;if((i==null?void 0:i.length)===0)return{type:m.None};if(this.updateTempPoints(i||[]),this.consumeIndex>this.tmpPoints.length-4)return{type:m.None};const{strokeColor:n,thickness:a,strokeType:l}=this.workOptions,c=Y(this.tmpPoints,a);let h=!1;const d=this.syncIndex,u=this.tmpPoints.slice(this.consumeIndex);this.consumeIndex=this.tmpPoints.length-1,this.syncTimestamp===0&&(this.syncTimestamp=Date.now());const p={name:s==null?void 0:s.toString(),opacity:1,lineDash:l===Z.Dotted?[1,a*2]:l===Z.LongDotted?[a,a*2]:void 0,strokeColor:n,lineCap:"round",lineWidth:a,anchor:[.5,.5]},w=this.getTaskPoints(u);if(w.length){const v=Date.now();v-this.syncTimestamp>this.syncUnitTime&&(h=!0,this.syncTimestamp=v,this.syncIndex=this.tmpPoints.length),r&&this.draw({attrs:p,tasks:w,isDot:!1,layer:this.drawLayer||this.fullLayer})}const y=[];return this.tmpPoints.slice(d).forEach(v=>{y.push(v.x,v.y)}),{rect:{x:c.x*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],y:c.y*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1],w:c.w*this.fullLayer.worldScaling[0],h:c.h*this.fullLayer.worldScaling[1]},type:m.DrawWork,dataType:M.Local,workId:h?s:void 0,op:h?y:void 0,index:h?d*2:void 0}}consumeAll(){var e;const t=(e=this.workId)==null?void 0:e.toString();let r;if(this.tmpPoints.length-1>this.consumeIndex){let i=this.tmpPoints.slice(this.consumeIndex);const n=i.length===1,{strokeColor:a,thickness:l,strokeType:c}=this.workOptions;if(n){const u=this.computDotStroke({point:i[0],radius:l/2});i=u.ps,r=u.rect}else r=Y(this.tmpPoints,l);const h={name:t==null?void 0:t.toString(),fillColor:n?a:void 0,opacity:1,lineDash:c===Z.Dotted&&!n?[1,l*2]:c===Z.LongDotted&&!n?[l,l*2]:void 0,strokeColor:a,lineCap:n?void 0:"round",lineWidth:n?0:l,anchor:[.5,.5]},d=this.getTaskPoints(i);d.length&&this.draw({attrs:h,tasks:d,isDot:n,layer:this.drawLayer||this.fullLayer})}const s=[];return this.tmpPoints.slice(this.syncIndex).forEach(i=>{s.push(i.x,i.y)}),{rect:r&&{x:r.x*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],y:r.y*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1],w:r.w*this.fullLayer.worldScaling[0],h:r.h*this.fullLayer.worldScaling[1]},type:m.DrawWork,dataType:M.Local,workId:t,op:s,index:this.syncIndex*2}}clearTmpPoints(){this.tmpPoints.length=0,this.syncTimestamp=0,this.syncIndex=0}consumeService(e){var t;const{op:r,replaceId:s,isFullWork:i}=e,{strokeColor:n,thickness:a,strokeType:l}=this.workOptions;if(!r.length){const y=Y(this.tmpPoints,a);return{x:y.x*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],y:y.y*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1],w:y.w*this.fullLayer.worldScaling[0],h:y.h*this.fullLayer.worldScaling[1]}}const c=Math.max(0,this.tmpPoints.length-1);this.updateTempPoints(r||[]);let h,d=this.tmpPoints.slice(c);const u=d.length===1;if(u){const y=this.computDotStroke({point:d[0],radius:a/2});d=y.ps,h=y.rect}else h=Y(this.tmpPoints,a);const p={name:(t=this.workId)==null?void 0:t.toString(),fillColor:u?n:void 0,opacity:1,lineDash:l===Z.Dotted&&!u?[1,a*2]:l===Z.LongDotted&&!u?[a,a*2]:void 0,strokeColor:n,lineCap:u?void 0:"round",lineWidth:u?0:a,anchor:[.5,.5]},w=this.getTaskPoints(d);if(w.length){const y=i?this.fullLayer:this.drawLayer||this.fullLayer;this.draw({attrs:p,tasks:w,isDot:u,replaceId:s,layer:y})}return{x:h.x*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],y:h.y*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1],w:h.w*this.fullLayer.worldScaling[0],h:h.h*this.fullLayer.worldScaling[1]}}computDotStroke(e){const{point:t,radius:r}=e,s={x:t.x-r,y:t.y-r,w:r*2,h:r*2};return{ps:W.GetDotStroke(t,r,8),rect:s}}updateTempPoints(e){const t=this.tmpPoints.length;for(let r=0;r<e.length;r+=2){if(t){const s=this.tmpPoints.slice(-1)[0];s&&s.x===e[r]&&s.y===e[r+1]&&this.tmpPoints.pop()}this.tmpPoints.push(new W(e[r],e[r+1]))}}async draw(e){const{attrs:t,tasks:r,isDot:s,layer:i}=e,{duration:n}=this.workOptions;for(const a of r){const l=new _.Path,{pos:c,points:h}=a;let d;s?d=Ce(h,!0):d=Ce(h,!1),l.attr({...t,pos:c,d});const{vertex:u,fragment:p}=this.workOptions;if(u&&p){const w=i.renderer.createProgram({vertex:u,fragment:p}),{width:y,height:v}=i.getResolution();l.setUniforms({u_time:0,u_resolution:[y,v]}),l.setProgram(w)}i.appendChild(l),l.transition(n).attr({scale:s?[.1,.1]:[1,1],lineWidth:s?0:1}).then(()=>{l.remove()})}}getTaskPoints(e){var t;const r=[];if(e.length===0)return[];let s=0,i=e[0].x,n=e[0].y,a=[i,n],l=[];for(;s<e.length;){const c=e[s],h=c.x-i,d=c.y-n;if(l.push(new W(h,d)),s>0&&s<e.length-1){const u=e[s].getAngleByPoints(e[s-1],e[s+1]);if(u<90||u>270){const p=(t=l.pop())==null?void 0:t.clone();p&&r.push({pos:a,points:[...l,p]}),i=e[s].x,n=e[s].y,a=[i,n];const w=c.x-i,y=c.y-n;l=[new W(w,y)]}}s++}return r.push({pos:a,points:l}),r}removeLocal(){}removeService(e){let t;const r=[];return this.fullLayer.getElementsByName(e).forEach(s=>{if(s.name===e){const i=s.getBoundingClientRect();t=j(t,{x:i.x,y:i.y,w:i.width,h:i.height}),r.push(s)}}),r.length&&r.forEach(s=>s.remove()),t}}var Qu=et;et.polyline=et,et.polygon=Ju;function et(o,e,t){var r=o.length,s=Ne(o[0],e),i=[],n,a,l,c,h;for(t||(t=[]),n=1;n<r;n++){for(a=o[n-1],l=o[n],c=h=Ne(l,e);;)if(s|c){if(s&c)break;s?(a=St(a,l,s,e),s=Ne(a,e)):(l=St(a,l,c,e),c=Ne(l,e))}else{i.push(a),c!==h?(i.push(l),n<r-1&&(t.push(i),i=[])):n===r-1&&i.push(l);break}s=h}return i.length&&t.push(i),t}function Ju(o,e){var t,r,s,i,n,a,l;for(r=1;r<=8;r*=2){for(t=[],s=o[o.length-1],i=!(Ne(s,e)&r),n=0;n<o.length;n++)a=o[n],l=!(Ne(a,e)&r),l!==i&&t.push(St(s,a,r,e)),l&&t.push(a),s=a,i=l;if(o=t,!o.length)break}return t}function St(o,e,t,r){return t&8?[o[0]+(e[0]-o[0])*(r[3]-o[1])/(e[1]-o[1]),r[3]]:t&4?[o[0]+(e[0]-o[0])*(r[1]-o[1])/(e[1]-o[1]),r[1]]:t&2?[r[2],o[1]+(e[1]-o[1])*(r[2]-o[0])/(e[0]-o[0])]:t&1?[r[0],o[1]+(e[1]-o[1])*(r[0]-o[0])/(e[0]-o[0])]:null}function Ne(o,e){var t=0;return o[0]<e[0]?t|=1:o[0]>e[2]&&(t|=2),o[1]<e[1]?t|=4:o[1]>e[3]&&(t|=8),t}var Ku=ge(Qu);class ne extends x{constructor(e,t){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.none}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.Eraser}),Object.defineProperty(this,"serviceWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"worldPosition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"worldScaling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"eraserRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"eraserPolyline",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.serviceWork=t,this.workOptions=e.toolsOpt,this.worldPosition=this.fullLayer.worldPosition,this.worldScaling=this.fullLayer.worldScaling}combineConsume(){}consumeService(){}setWorkOptions(e){super.setWorkOptions(e)}createEraserRect(e){const t=e[0]*this.worldScaling[0]+this.worldPosition[0],r=e[1]*this.worldScaling[1]+this.worldPosition[1],{width:s,height:i}=ne.eraserSizes[this.workOptions.thickness];this.eraserRect={x:t-s*.5,y:r-i*.5,w:s,h:i},this.eraserPolyline=[this.eraserRect.x,this.eraserRect.y,this.eraserRect.x+this.eraserRect.w,this.eraserRect.y+this.eraserRect.h]}computRectCenterPoints(){const e=this.tmpPoints.slice(-2);if(this.tmpPoints.length===4){const t=new f(this.tmpPoints[0],this.tmpPoints[1]),r=new f(this.tmpPoints[2],this.tmpPoints[3]),s=f.Sub(r,t).uni(),i=f.Dist(t,r),{width:n,height:a}=ne.eraserSizes[this.workOptions.thickness],l=Math.min(n,a),c=Math.round(i/l);if(c>1){const h=[];for(let d=0;d<c;d++){const u=f.Mul(s,d*l);h.push(this.tmpPoints[0]+u.x,this.tmpPoints[1]+u.y)}return h.concat(e)}}return e}isNear(e,t){const r=new f(e[0],e[1]),s=new f(t[0],t[1]),{width:i,height:n}=ne.eraserSizes[this.workOptions.thickness];return f.Dist(r,s)<Math.hypot(i,n)*.5}cutPolyline(e,t){let r=[t],s=0;for(;s<e.length;){const a=e[s];if(a.length<2)break;r=i(r,a),s++}return r;function i(a,l){const c=a;for(let h=0;h<a.length;h++){const d=a[h],u=d.findIndex((p,w)=>w<d.length-1?n([p,d[w+1]],[l[0],l[1]]):!1);if(u!==-1&&u>-1){const p=[],w=d.slice(0,u+1);if(f.Equals(d[u],l[0])||w.push(l[0].clone().setz(d[u].z)),w.length>1&&p.push(w),u+l.length-1<d.length-1){const y=u+l.length-1,v=d.slice(y),S=l[l.length-1];f.Equals(d[y],S)||v.unshift(S.clone().setz(d[y].z)),v.length>1&&p.push(v)}return c.splice(h,1,...p),c}}return c}function n(a,l){const c=f.Sub(a[1],a[0]),h=f.Sub(l[1],l[0]),d=f.Sub(l[0],a[0]);return Math.abs(f.Cpr(c,h))<.1&&Math.abs(f.Cpr(c,d))<.1}}isSamePoint(e,t){return e[0]===t[0]&&e[1]===t[1]}translateIntersect(e){const t=[];for(let r=0;r<e.length;r++){const s=e[r].filter((a,l,c)=>!(l>0&&this.isSamePoint(a,c[l-1]))),i=[];let n=0;for(;n<s.length;){const a=s[n],l=new f(a[0],a[1]);i.push(l),n++}t.push(i)}return t}isLineEraser(e,t){return!(e===k.Pencil&&!t)}remove(e){const{curNodeMap:t,removeIds:r,newWorkDatas:s}=e,{isLine:i}=this.workOptions;let n;for(const[a,l]of t.entries())if(l.rect&&this.eraserRect&&this.eraserPolyline&&Te(this.eraserRect,l.rect)){const{op:c,toolsType:h}=l,d=this.isLineEraser(h,i),u=[],p=[];for(let y=0;y<c.length;y+=3){const v=new f(c[y]*this.worldScaling[0]+this.worldPosition[0],c[y+1]*this.worldScaling[1]+this.worldPosition[1],c[y+2]);p.push(v),u.push(new W(v.x,v.y))}const w=u.length&&Y(u)||l.rect;if(Te(w,this.eraserRect)){if(p.length>1){const y=Ku.polyline(p.map(v=>v.XY),this.eraserPolyline);if(y.length&&(r.add(l.name),!d)){const v=this.translateIntersect(y),S=this.cutPolyline(v,p);for(let T=0;T<S.length;T++){const O=`${a}_s_${T}`,P=[];S[T].forEach(g=>{P.push((g.x-this.worldPosition[0])/this.worldScaling[0],(g.y-this.worldPosition[1])/this.worldScaling[1],g.z)}),l.opt&&l.toolsType&&this.vNodes&&(this.vNodes.setInfo(O,{rect:w,op:P,opt:l.opt,canRotate:l.canRotate,scaleType:l.scaleType,toolsType:l.toolsType}),s.set(O,{workId:O,op:P,opt:l.opt,toolsType:l.toolsType}))}}}else r.add(l.name);n=j(n,w)}}return r.forEach(a=>{var l;return(l=this.vNodes)==null?void 0:l.delete(a)}),n&&(n.x-=x.SafeBorderPadding,n.y-=x.SafeBorderPadding,n.w+=x.SafeBorderPadding*2,n.h+=x.SafeBorderPadding*2),n}consume(e){const{op:t}=e.data;if(!t||t.length===0)return{type:m.None};const r=this.tmpPoints.length;if(r>1&&this.isNear([t[0],t[1]],[this.tmpPoints[r-2],this.tmpPoints[r-1]]))return{type:m.None};r===4&&(this.tmpPoints.shift(),this.tmpPoints.shift()),this.tmpPoints.push(t[0],t[1]);const s=this.computRectCenterPoints();let i;const n=new Set,a=new Map;this.vNodes.setTarget();const l=this.getUnLockNodeMap(this.vNodes.getLastTarget());for(let c=0;c<s.length-1;c+=2){this.createEraserRect(s.slice(c,c+2));const h=this.remove({curNodeMap:l,removeIds:n,newWorkDatas:a});i=j(i,h)}if(this.vNodes.deleteLastTarget(),i&&n.size){for(const c of a.keys())n.has(c)&&a.delete(c);return{type:m.RemoveNode,dataType:M.Local,rect:i,removeIds:[...n],newWorkDatas:a}}return{type:m.None}}consumeAll(e){return this.consume(e)}clearTmpPoints(){this.tmpPoints.length=0}getUnLockNodeMap(e){var t;if(this.serviceWork){const r=te(e),s=this.serviceWork.selectorWorkShapes,i=this.serviceWork.workShapes;for(const n of s.values())if((t=n.selectIds)!=null&&t.length)for(const a of n.selectIds)r.delete(a);for(const n of i.keys())r.delete(n);return r}return e}}Object.defineProperty(ne,"eraserSizes",{enumerable:!0,configurable:!0,writable:!0,value:Object.freeze([Object.freeze({width:18,height:26}),Object.freeze({width:26,height:34}),Object.freeze({width:34,height:50})])});const ed="++",td="selector",rd="all";var od="__lodash_hash_undefined__";function sd(o){return this.__data__.set(o,od),this}var id=sd;function nd(o){return this.__data__.has(o)}var ad=nd,ld=Ft,cd=id,hd=ad;function tt(o){var e=-1,t=o==null?0:o.length;for(this.__data__=new ld;++e<t;)this.add(o[e])}tt.prototype.add=tt.prototype.push=cd,tt.prototype.has=hd;var ud=tt;function dd(o,e){for(var t=-1,r=o==null?0:o.length;++t<r;)if(e(o[t],t,o))return!0;return!1}var pd=dd;function fd(o,e){return o.has(e)}var yd=fd,wd=ud,vd=pd,md=yd,gd=1,bd=2;function kd(o,e,t,r,s,i){var n=t&gd,a=o.length,l=e.length;if(a!=l&&!(n&&l>a))return!1;var c=i.get(o),h=i.get(e);if(c&&h)return c==e&&h==o;var d=-1,u=!0,p=t&bd?new wd:void 0;for(i.set(o,e),i.set(e,o);++d<a;){var w=o[d],y=e[d];if(r)var v=n?r(y,w,d,e,o,i):r(w,y,d,o,e,i);if(v!==void 0){if(v)continue;u=!1;break}if(p){if(!vd(e,function(S,T){if(!md(p,T)&&(w===S||s(w,S,t,r,i)))return p.push(T)})){u=!1;break}}else if(!(w===y||s(w,y,t,r,i))){u=!1;break}}return i.delete(o),i.delete(e),u}var Fr=kd;function Sd(o){var e=-1,t=Array(o.size);return o.forEach(function(r,s){t[++e]=[s,r]}),t}var Pd=Sd;function Id(o){var e=-1,t=Array(o.size);return o.forEach(function(r){t[++e]=r}),t}var Td=Id,Er=Ue,zr=ur,xd=it,Od=Fr,Cd=Pd,Nd=Td,Ld=1,Wd=2,Rd="[object Boolean]",Md="[object Date]",jd="[object Error]",Ad="[object Map]",Bd="[object Number]",Dd="[object RegExp]",Fd="[object Set]",Ed="[object String]",zd="[object Symbol]",Ud="[object ArrayBuffer]",_d="[object DataView]",Ur=Er?Er.prototype:void 0,Pt=Ur?Ur.valueOf:void 0;function $d(o,e,t,r,s,i,n){switch(t){case _d:if(o.byteLength!=e.byteLength||o.byteOffset!=e.byteOffset)return!1;o=o.buffer,e=e.buffer;case Ud:return!(o.byteLength!=e.byteLength||!i(new zr(o),new zr(e)));case Rd:case Md:case Bd:return xd(+o,+e);case jd:return o.name==e.name&&o.message==e.message;case Dd:case Ed:return o==e+"";case Ad:var a=Cd;case Fd:var l=r&Ld;if(a||(a=Nd),o.size!=e.size&&!l)return!1;var c=n.get(o);if(c)return c==e;r|=Wd,n.set(o,e);var h=Od(a(o),a(e),r,s,i,n);return n.delete(o),h;case zd:if(Pt)return Pt.call(o)==Pt.call(e)}return!1}var Yd=$d,_r=sr,Xd=1,Gd=Object.prototype,Vd=Gd.hasOwnProperty;function Hd(o,e,t,r,s,i){var n=t&Xd,a=_r(o),l=a.length,c=_r(e),h=c.length;if(l!=h&&!n)return!1;for(var d=l;d--;){var u=a[d];if(!(n?u in e:Vd.call(e,u)))return!1}var p=i.get(o),w=i.get(e);if(p&&w)return p==e&&w==o;var y=!0;i.set(o,e),i.set(e,o);for(var v=n;++d<l;){u=a[d];var S=o[u],T=e[u];if(r)var O=n?r(T,S,u,e,o,i):r(S,T,u,o,e,i);if(!(O===void 0?S===T||s(S,T,t,r,i):O)){y=!1;break}v||(v=u=="constructor")}if(y&&!v){var P=o.constructor,g=e.constructor;P!=g&&"constructor"in o&&"constructor"in e&&!(typeof P=="function"&&P instanceof P&&typeof g=="function"&&g instanceof g)&&(y=!1)}return i.delete(o),i.delete(e),y}var Zd=Hd,It=Et,qd=Fr,Qd=Yd,Jd=Zd,$r=Ze,Yr=Xe,Xr=lt,Kd=Ht,ep=1,Gr="[object Arguments]",Vr="[object Array]",rt="[object Object]",tp=Object.prototype,Hr=tp.hasOwnProperty;function rp(o,e,t,r,s,i){var n=Yr(o),a=Yr(e),l=n?Vr:$r(o),c=a?Vr:$r(e);l=l==Gr?rt:l,c=c==Gr?rt:c;var h=l==rt,d=c==rt,u=l==c;if(u&&Xr(o)){if(!Xr(e))return!1;n=!0,h=!1}if(u&&!h)return i||(i=new It),n||Kd(o)?qd(o,e,t,r,s,i):Qd(o,e,l,t,r,s,i);if(!(t&ep)){var p=h&&Hr.call(o,"__wrapped__"),w=d&&Hr.call(e,"__wrapped__");if(p||w){var y=p?o.value():o,v=w?e.value():e;return i||(i=new It),s(y,v,t,r,i)}}return u?(i||(i=new It),Jd(o,e,t,r,s,i)):!1}var op=rp,sp=op,Zr=ce;function qr(o,e,t,r,s){return o===e?!0:o==null||e==null||!Zr(o)&&!Zr(e)?o!==o&&e!==e:sp(o,e,t,r,qr,s)}var ip=qr,np=ip;function ap(o,e){return np(o,e)}var lp=ap,Qr=ge(lp);class U extends x{constructor(e){super(e),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.Selector}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"selectIds",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"selectorColor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"strokeColor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fillColor",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldSelectRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"canTextEdit",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"canLock",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shapeOpt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"textOpt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isLocked",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt}computSelector(e=!0){const t=Y(this.tmpPoints);if(t.w===0||t.h===0)return{selectIds:[],intersectRect:void 0,subNodeMap:new Map};const{rectRange:r,nodeRange:s}=this.vNodes.getRectIntersectRange(t,e);return{selectIds:[...s.keys()],intersectRect:r,subNodeMap:s}}updateTempPoints(e){const t=this.tmpPoints.length,r=e.length;if(r>1){const s=new W(e[r-2]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],e[r-1]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[1]);t===2?this.tmpPoints.splice(1,1,s):this.tmpPoints.push(s)}}drawSelector(e){const{drawRect:t,subNodeMap:r,selectorId:s,layer:i,isService:n}=e,a=new _.Group({pos:[t.x,t.y],anchor:[0,0],size:[t.w,t.h],id:s,name:s,zIndex:1e3}),l=[];if(n){const c=new _.Rect({normalize:!0,pos:[t.w/2,t.h/2],lineWidth:1,strokeColor:this.selectorColor||this.workOptions.strokeColor,width:t.w,height:t.h,name:U.selectorBorderId});l.push(c)}r.forEach((c,h)=>{const d=[c.rect.x+c.rect.w/2-t.x,c.rect.y+c.rect.h/2-t.y],u=new _.Rect({normalize:!0,pos:d,lineWidth:1,strokeColor:r.size>1?this.selectorColor||this.workOptions.strokeColor:void 0,width:c.rect.w,height:c.rect.h,id:`selector-${h}`,name:`selector-${h}`});l.push(u)}),l&&a.append(...l),(i==null?void 0:i.parent).appendChild(a)}draw(e,t,r,s=!1){var i,n;const{intersectRect:a,subNodeMap:l}=r;(n=(i=t.parent)==null?void 0:i.getElementById(e))==null||n.remove(),a&&this.drawSelector({drawRect:a,subNodeMap:l,selectorId:e,layer:t,isService:s})}getSelecteorInfo(e){this.scaleType=V.all,this.canRotate=!1,this.textOpt=void 0,this.strokeColor=void 0,this.fillColor=void 0,this.canTextEdit=!1,this.canLock=!1,this.isLocked=!1,this.toolsTypes=void 0,this.shapeOpt=void 0;const t=new Set;let r;for(const s of e.values()){const{opt:i,canRotate:n,scaleType:a,toolsType:l}=s;this.selectorColor=this.workOptions.strokeColor,i.strokeColor&&(this.strokeColor=i.strokeColor),i.fillColor&&(this.fillColor=i.fillColor),i.textOpt&&(this.textOpt=i.textOpt),l===k.SpeechBalloon&&(t.add(l),this.shapeOpt||(this.shapeOpt={}),this.shapeOpt.placement=i.placement),l===k.Polygon&&(t.add(l),this.shapeOpt||(this.shapeOpt={}),this.shapeOpt.vertices=i.vertices),l===k.Star&&(t.add(l),this.shapeOpt||(this.shapeOpt={}),this.shapeOpt.vertices=i.vertices,this.shapeOpt.innerRatio=i.innerRatio,this.shapeOpt.innerVerticeStep=i.innerVerticeStep),l===k.Text&&(this.textOpt=i),e.size===1&&(this.textOpt&&(this.canTextEdit=!0),this.canRotate=n,this.scaleType=a),a===V.none&&(this.scaleType=a),l===k.Image&&(r=s)}t.size&&(this.toolsTypes=[...t]),r&&(e.size===1?(this.canLock=!0,r.opt.locked&&(this.isLocked=!0,this.scaleType=V.none,this.canRotate=!1,this.textOpt=void 0,this.fillColor=void 0,this.selectorColor="rgb(177,177,177)",this.strokeColor=void 0,this.canTextEdit=!1)):e.size>1&&!r.opt.locked&&(this.canLock=!1,this.canRotate=!1))}getChildrenPoints(){var e;if(this.scaleType===V.both&&this.selectIds){const t=this.selectIds[0],r=(e=this.vNodes.get(t))==null?void 0:e.op;if(r){const s=[];for(let i=0;i<r.length;i+=3)s.push([r[i],r[i+1]]);return s}}}consume(e){const{op:t,workState:r}=e.data;let s=this.oldSelectRect;if(r===E.Start&&(s=this.backToFullLayer()),!(t!=null&&t.length)||!this.vNodes.curNodeMap.size)return{type:m.None};this.updateTempPoints(t);const i=this.computSelector();if(this.selectIds&&_u(this.selectIds,i.selectIds))return{type:m.None};this.selectIds=i.selectIds;const n=i.intersectRect;this.getSelecteorInfo(i.subNodeMap),this.draw(U.selectorId,this.drawLayer||this.fullLayer,i),this.oldSelectRect=n;const a=this.getChildrenPoints();return{type:m.Select,dataType:M.Local,rect:j(n,s),selectIds:i.selectIds,opt:this.workOptions,selectRect:n,selectorColor:this.selectorColor,strokeColor:this.strokeColor,fillColor:this.fillColor,textOpt:this.textOpt,canTextEdit:this.canTextEdit,canRotate:this.canRotate,canLock:this.canLock,scaleType:this.scaleType,willSyncService:!0,points:a,isLocked:this.isLocked,toolsTypes:this.toolsTypes,shapeOpt:this.shapeOpt}}consumeAll(e){var t,r;if(!((t=this.selectIds)!=null&&t.length)&&this.tmpPoints[0]&&this.selectSingleTool(this.tmpPoints[0].XY,U.selectorId,!1,e==null?void 0:e.hoverId),(r=this.selectIds)!=null&&r.length&&this.sealToDrawLayer(this.selectIds),this.oldSelectRect){const s=this.getChildrenPoints();return{type:m.Select,dataType:M.Local,rect:this.oldSelectRect,selectIds:this.selectIds,opt:this.workOptions,selectorColor:this.selectorColor,selectRect:this.oldSelectRect,strokeColor:this.strokeColor,fillColor:this.fillColor,textOpt:this.textOpt,canTextEdit:this.canTextEdit,canRotate:this.canRotate,canLock:this.canLock,scaleType:this.scaleType,willSyncService:!0,points:s,isLocked:this.isLocked,toolsTypes:this.toolsTypes,shapeOpt:this.shapeOpt}}return{type:m.None}}consumeService(){}clearTmpPoints(){this.tmpPoints.length=0}clearSelectData(){this.selectIds=void 0,this.oldSelectRect=void 0}selectSingleTool(e,t=U.selectorId,r=!1,s){if(e.length===2){const i=e[0],n=e[1];let a;for(const l of this.fullLayer.children){const c=ao([l]);let h=!1;if(s&&s===l.name&&c.find(d=>d.isPointCollision(i,n))){a=l;break}for(const d of c)if(h=d.isPointCollision(i,n),h){if(!a)a=l;else{const u=this.vNodes.get(l.name),p=this.vNodes.get(a.name);if((u==null?void 0:u.toolsType)!==k.Text&&(p==null?void 0:p.toolsType)===k.Text)break;if((u==null?void 0:u.toolsType)===k.Text&&(p==null?void 0:p.toolsType)!==k.Text)a=l;else{const w=(u==null?void 0:u.opt.zIndex)||0,y=(p==null?void 0:p.opt.zIndex)||0;Number(w)>=Number(y)&&(a=l)}}break}}if(a){const l=a.name,c=this.vNodes.get(l);if(c){if(!Qr(this.oldSelectRect,c.rect)){const h=new Map([[l,c]]);this.getSelecteorInfo(h),this.draw(t,this.drawLayer||this.fullLayer,{intersectRect:c.rect,subNodeMap:h,selectIds:this.selectIds||[]},r)}this.selectIds=[l],this.oldSelectRect=c.rect}}}}backToFullLayer(e){var t,r;let s;const i=[],n=[];for(const a of((t=this.drawLayer)==null?void 0:t.children)||[])if(!(e!=null&&e.length&&!e.includes(a.id))&&a.id!==U.selectorId){const l=a.cloneNode(!0);Qe(a)&&l.seal(),this.fullLayer.getElementsByName(a.name).length||i.push(l),n.push(a);const c=(r=this.vNodes.get(a.name))==null?void 0:r.rect;c&&(s=j(s,c))}return n.forEach(a=>a.remove()),i.length&&this.fullLayer.append(...i),s}sealToDrawLayer(e){var t;const r=[],s=[];e.forEach(i=>{this.fullLayer.getElementsByName(i.toString()).forEach(n=>{var a;const l=n.cloneNode(!0);Qe(n)&&l.seal(),(a=this.drawLayer)!=null&&a.getElementsByName(n.name).length||r.push(l),s.push(n)})}),s.forEach(i=>i.remove()),r&&((t=this.drawLayer)==null||t.append(...r))}getSelectorRect(e,t){var r;let s;const i=(r=e.parent)==null?void 0:r.getElementById(t),n=i==null?void 0:i.getBoundingClientRect();return n&&(s=j(s,{x:Math.floor(n.x),y:Math.floor(n.y),w:Math.round(n.width),h:Math.round(n.height)})),s}isCanFillColor(e){return e===k.Ellipse||e===k.Triangle||e===k.Rectangle||e===k.Polygon||e===k.Star||e===k.SpeechBalloon}async updateSelector(e){const{updateSelectorOpt:t,selectIds:r,vNodes:s,willSerializeData:i,worker:n,offset:a,scene:l}=e,c=this.drawLayer;if(!c)return;let h;const d=new Map,{box:u,workState:p,angle:w,translate:y}=t;let v=[0,0],S=[1,1],T=[0,0],O,P;if(u||y||ue(w)){if(p===E.Start)return s.setTarget(),{type:m.Select,dataType:M.Local,selectRect:this.oldSelectRect,rect:this.oldSelectRect};if(O=s.getLastTarget(),O&&u){let C;r==null||r.forEach(I=>{const R=O==null?void 0:O.get(I);C=j(C,R==null?void 0:R.rect)}),C&&(S=[u.w/C.w,u.h/C.h],v=[u.x+u.w/2-(C.x+C.w/2),u.y+u.h/2-(C.y+C.h/2)],T=[C.x+C.w/2,C.y+C.h/2]),P=C}}if(r)for(const C of r){const I=s.get(C);if(I){const{toolsType:R}=I;let A=(c==null?void 0:c.getElementsByName(C))[0];if(A){const B={...t};let G;if(R){if(O&&(G=O.get(C),G&&u)){B.boxScale=S;const re=[G.rect.x+G.rect.w/2,G.rect.y+G.rect.h/2],oe=[re[0]-T[0],re[1]-T[1]];B.boxTranslate=[oe[0]*(S[0]-1)+v[0]+(a&&a[0]||0),oe[1]*(S[1]-1)+v[1]+(a&&a[1]||0)]}const K=no(R);if(K==null||K.updateNodeOpt({node:A,opt:B,vNodes:s,willSerializeData:i,targetNode:G}),I&&n&&(i&&(B.angle||B.translate)||B.box&&B.workState!==E.Start||B.pointMap&&B.pointMap.has(C)||R===k.Text&&(B.fontSize||B.translate||B.textInfos&&B.textInfos.get(C))||R===k.Image&&(B.angle||B.translate||B.boxScale)||R===B.toolsType&&B.willRefresh)){const re=n.createWorkShapeNode({toolsType:R,toolsOpt:I.opt});re==null||re.setWorkId(C);let oe;R===k.Image&&l?oe=await re.consumeServiceAsync({isFullWork:!1,replaceId:C,scene:l}):oe=re==null?void 0:re.consumeService({op:I.op,isFullWork:!1,replaceId:C,isClearAll:!1}),oe&&(I.rect=oe,s.setInfo(C,I)),A=(c==null?void 0:c.getElementsByName(C))[0]}I&&(d.set(C,I),h=j(h,I.rect))}}}}O&&p===E.Done&&s.deleteLastTarget();const g=h;if(P&&t.dir&&g){let C=[0,0];switch(t.dir){case"topLeft":case"left":{const I=[P.x+P.w,P.y+P.h];C=[I[0]-(g.x+g.w),I[1]-(g.y+g.h)];break}case"bottomLeft":case"bottom":{const I=[P.x+P.w,P.y];C=[I[0]-(g.x+g.w),I[1]-g.y];break}case"topRight":case"top":{const I=[P.x,P.y+P.h];C=[I[0]-g.x,I[1]-(g.y+g.h)];break}case"right":case"bottomRight":{const I=[P.x,P.y];C=[I[0]-g.x,I[1]-g.y];break}}if(C[0]||C[1])return g.x=g.x+C[0],g.y=g.y+C[1],await this.updateSelector({...e,offset:C})}this.getSelecteorInfo(d),this.draw(U.selectorId,c,{selectIds:r||[],subNodeMap:d,intersectRect:g});const b=j(this.oldSelectRect,h);return this.oldSelectRect=h,{type:m.Select,dataType:M.Local,selectRect:g,renderRect:h,rect:j(b,g)}}blurSelector(){const e=this.backToFullLayer();return{type:m.Select,dataType:M.Local,rect:e,selectIds:[],willSyncService:!0}}getRightServiceId(e){return e.replace("++","-")}selectServiceNode(e,t,r){const{selectIds:s}=t,i=this.getRightServiceId(e),n=this.getSelectorRect(this.fullLayer,i);let a;const l=new Map;return s==null||s.forEach(c=>{const h=this.vNodes.get(c),d=this.fullLayer.getElementsByName(c)[0];h&&d&&(a=j(a,h.rect),l.set(c,h))}),this.getSelecteorInfo(l),this.draw(i,this.fullLayer,{intersectRect:a,selectIds:s||[],subNodeMap:l},r),j(a,n)}reRenderSelector(){var e;let t;const r=new Map;return(e=this.selectIds)==null||e.forEach(s=>{const i=this.vNodes.get(s);i&&(t=j(t,i.rect),r.set(s,i))},this),this.getSelecteorInfo(r),this.draw(U.selectorId,this.drawLayer||this.fullLayer,{intersectRect:t,subNodeMap:r,selectIds:this.selectIds||[]}),this.oldSelectRect=t,t}updateSelectIds(e){var t,r;let s;const i=(t=this.selectIds)==null?void 0:t.filter(l=>!e.includes(l)),n=e.filter(l=>{var c;return!((c=this.selectIds)!=null&&c.includes(l))});if(i!=null&&i.length&&(s=this.backToFullLayer(i)),n.length){this.sealToDrawLayer(n);for(const l of n){const c=(r=this.vNodes.get(l))==null?void 0:r.rect;c&&(s=j(s,c))}}this.selectIds=e;const a=this.reRenderSelector();return{bgRect:s,selectRect:a}}cursorHover(e){var t,r;const s=this.oldSelectRect;this.selectIds=[];const i=(t=this.workId)==null?void 0:t.toString(),n=[e[0]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],e[1]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[1]];if(this.selectSingleTool(n,i,!0),this.oldSelectRect&&!Qr(s,this.oldSelectRect))return{type:m.CursorHover,dataType:M.Local,rect:j(s,this.oldSelectRect),selectorColor:this.selectorColor,willSyncService:!1};if((r=this.selectIds)!=null&&r.length||(this.oldSelectRect=void 0),s&&!this.oldSelectRect)return this.cursorBlur(),{type:m.CursorHover,dataType:M.Local,rect:s,selectorColor:this.selectorColor,willSyncService:!1}}cursorBlur(){var e,t;this.selectIds=[];const r=(e=this.workId)==null?void 0:e.toString();((t=this.fullLayer)==null?void 0:t.parent).children.forEach(s=>{s.name===r&&s.remove()})}}Object.defineProperty(U,"selectorId",{enumerable:!0,configurable:!0,writable:!0,value:td}),Object.defineProperty(U,"selectorBorderId",{enumerable:!0,configurable:!0,writable:!0,value:"selector-border"});class Jr extends x{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.both}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.Arrow}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"arrowTipWidth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.arrowTipWidth=this.workOptions.thickness*4,this.syncTimestamp=0,this.syncUnitTime=50}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:m.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:m.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:m.None};if(!i){const w=Date.now();return w-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=w,{type:m.DrawWork,dataType:M.Local,workId:n,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0}):{type:m.None}}const d=s?this.fullLayer:this.drawLayer||this.fullLayer,u=this.draw({workId:n,layer:d}),p=j(u,this.oldRect);return this.oldRect=u,{rect:p,type:m.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:m.None};if(this.tmpPoints.length<2)return{type:m.RemoveNode,removeIds:[s]};const i=this.fullLayer,n=this.draw({workId:s,layer:i});this.oldRect=n;const a=this.tmpPoints.map(c=>[...c.XY,0]).flat(1),l=le(a);return this.vNodes.setInfo(s,{rect:n,op:a,opt:this.workOptions,toolsType:this.toolsType,canRotate:this.canRotate,scaleType:this.scaleType,centerPos:x.getCenterPos(n,i)}),{rect:n,type:m.FullWork,dataType:M.Local,workId:s,ops:l,isSync:!0,opt:this.workOptions}}draw(e){var t;const{workId:r,layer:s}=e;this.fullLayer.getElementsByName(r).map(S=>S.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(S=>S.remove());const{strokeColor:i,thickness:n,zIndex:a,scale:l,rotate:c,translate:h}=this.workOptions,d=s.worldPosition,u=s.worldScaling,{points:p,rect:w}=this.computDrawPoints(n),y={pos:[w.x+w.w/2,w.y+w.h/2],name:r,id:r,close:!0,points:p,fillColor:i,strokeColor:i,lineWidth:0,normalize:!0,zIndex:a};l&&(y.scale=l),c&&(y.rotate=c),h&&(y.translate=h);const v=new _.Polyline(y);if(s.append(v),l||c||h){const S=v.getBoundingClientRect();return{x:Math.floor(S.x-x.SafeBorderPadding),y:Math.floor(S.y-x.SafeBorderPadding),w:Math.floor(S.width+x.SafeBorderPadding*2),h:Math.floor(S.height+x.SafeBorderPadding*2)}}return{x:Math.floor(w.x*u[0]+d[0]-x.SafeBorderPadding),y:Math.floor(w.y*u[1]+d[1]-x.SafeBorderPadding),w:Math.floor(w.w*u[0]+2*x.SafeBorderPadding),h:Math.floor(w.h*u[1]+2*x.SafeBorderPadding)}}computDrawPoints(e){return this.tmpPoints[1].distance(this.tmpPoints[0])>this.arrowTipWidth?this.computFullArrowPoints(e):this.computTrianglePoints()}computFullArrowPoints(e){const t=f.Sub(this.tmpPoints[1],this.tmpPoints[0]).uni(),r=f.Per(t).mul(e/2),s=W.Sub(this.tmpPoints[0],r),i=W.Add(this.tmpPoints[0],r),n=f.Mul(t,this.arrowTipWidth),a=f.Sub(this.tmpPoints[1],n),l=W.Sub(a,r),c=W.Add(a,r),h=f.Per(t).mul(e*1.5),d=W.Sub(a,h),u=W.Add(a,h),p=[s,l,d,this.tmpPoints[1],u,c,i];return{points:p.map(w=>W.Sub(w,this.tmpPoints[0]).XY).flat(1),rect:Y(p),isTriangle:!1,pos:this.tmpPoints[0].XY}}computTrianglePoints(){const e=f.Sub(this.tmpPoints[1],this.tmpPoints[0]).uni(),t=this.tmpPoints[1].distance(this.tmpPoints[0]),r=f.Per(e).mul(Math.floor(t*3/8)),s=W.Sub(this.tmpPoints[0],r),i=W.Add(this.tmpPoints[0],r),n=[s,this.tmpPoints[1],i];return{points:n.map(a=>W.Sub(a,this.tmpPoints[0]).XY).flat(1),rect:Y(n),isTriangle:!0,pos:this.tmpPoints[0].XY}}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s}=e,i=(t=this.workId)==null?void 0:t.toString();if(!i)return;this.tmpPoints.length=0;for(let l=0;l<r.length;l+=3)this.tmpPoints.push(new W(r[l],r[l+1],r[l+2]));const n=s?this.fullLayer:this.drawLayer||this.fullLayer,a=this.draw({workId:i,layer:n});return this.oldRect=a,this.vNodes.setInfo(i,{rect:a,op:r,opt:this.workOptions,toolsType:this.toolsType,canRotate:this.canRotate,scaleType:this.scaleType,centerPos:x.getCenterPos(a,n)}),a}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){var t;const{node:r,opt:s,vNodes:i}=e,{strokeColor:n}=s,a=i.get(r.name);return n&&(r.setAttribute("strokeColor",n),r.setAttribute("fillColor",n),(t=a==null?void 0:a.opt)!=null&&t.strokeColor&&(a.opt.strokeColor=n),a&&i.setInfo(r.name,a)),x.updateNodeOpt(e)}}class Kr extends x{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.Ellipse}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:m.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:m.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:m.None};if(!i){const w=Date.now();return w-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=w,{type:m.DrawWork,dataType:M.Local,workId:n,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0}):{type:m.None}}const d=s?this.fullLayer:this.drawLayer||this.fullLayer,u=this.draw({workId:n,layer:d,isDrawing:!0}),p=j(u,this.oldRect);return this.oldRect=u,{rect:p,type:m.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:m.None};if(this.tmpPoints.length<2)return{type:m.RemoveNode,removeIds:[s]};const i=this.fullLayer,n=this.draw({workId:s,layer:i,isDrawing:!1});this.oldRect=n;const a=this.tmpPoints.map(c=>[...c.XY,0]).flat(1),l=le(a);return this.vNodes.setInfo(s,{rect:n,op:a,opt:this.workOptions,toolsType:this.toolsType,canRotate:this.canRotate,scaleType:this.scaleType,centerPos:n&&x.getCenterPos(n,i)}),{rect:n,type:m.FullWork,dataType:M.Local,workId:s,ops:l,isSync:!0,opt:this.workOptions}}draw(e){var t;const{workId:r,layer:s,isDrawing:i}=e;this.fullLayer.getElementsByName(r).map(g=>g.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(g=>g.remove());const{strokeColor:n,fillColor:a,thickness:l,zIndex:c,scale:h,rotate:d,translate:u}=this.workOptions,p=s.worldPosition,w=s.worldScaling,{radius:y,rect:v,pos:S}=this.computDrawPoints(l),T={pos:S,name:r,id:r,radius:y,lineWidth:l,fillColor:a!=="transparent"&&a||void 0,strokeColor:n,normalize:!0,zIndex:c},O={x:Math.floor(v.x*w[0]+p[0]-x.SafeBorderPadding),y:Math.floor(v.y*w[1]+p[1]-x.SafeBorderPadding),w:Math.floor(v.w*w[0]+2*x.SafeBorderPadding),h:Math.floor(v.h*w[1]+2*x.SafeBorderPadding)};if(i){const{name:g,id:b,zIndex:C,strokeColor:I}=T,R=x.getCenterPos(O,s),A=new _.Group({name:g,id:b,zIndex:C,pos:R,anchor:[.5,.5],size:[O.w,O.h]}),B=new _.Ellipse({...T,pos:[0,0]}),G=new _.Path({d:"M-4,0H4M0,-4V4",normalize:!0,pos:[0,0],strokeColor:I,lineWidth:1,scale:[1/w[0],1/w[1]]});return A.append(B,G),s.append(A),O}h&&(T.scale=h),d&&(T.rotate=d),u&&(T.translate=u);const P=new _.Ellipse(T);if(s.append(P),d||h||u){const g=P.getBoundingClientRect();return{x:Math.floor(g.x-x.SafeBorderPadding),y:Math.floor(g.y-x.SafeBorderPadding),w:Math.floor(g.width+x.SafeBorderPadding*2),h:Math.floor(g.height+x.SafeBorderPadding*2)}}return O}computDrawPoints(e){const t=Y(this.tmpPoints),r=Y(this.tmpPoints,e),s=[Math.floor(t.x+t.w/2),Math.floor(t.y+t.h/2)];return{rect:r,pos:s,radius:[Math.floor(t.w/2),Math.floor(t.h/2)]}}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s}=e,i=(t=this.workId)==null?void 0:t.toString();if(!i)return;this.tmpPoints.length=0;for(let l=0;l<r.length;l+=3)this.tmpPoints.push(new W(r[l],r[l+1],r[l+2]));const n=s?this.fullLayer:this.drawLayer||this.fullLayer,a=this.draw({workId:i,layer:n,isDrawing:!1});return this.oldRect=a,this.vNodes.setInfo(i,{rect:a,op:r,opt:this.workOptions,toolsType:this.toolsType,canRotate:this.canRotate,scaleType:this.scaleType,centerPos:x.getCenterPos(a,n)}),a}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){var t,r;const{node:s,opt:i,vNodes:n}=e,{strokeColor:a,fillColor:l}=i,c=n.get(s.name);let h=s;return s.tagName==="GROUP"&&(h=s.children[0]),a&&(h.setAttribute("strokeColor",a),(t=c==null?void 0:c.opt)!=null&&t.strokeColor&&(c.opt.strokeColor=a)),l&&(l==="transparent"?h.setAttribute("fillColor","rgba(0,0,0,0)"):h.setAttribute("fillColor",l),(r=c==null?void 0:c.opt)!=null&&r.fillColor&&(c.opt.fillColor=l)),c&&n.setInfo(s.name,c),x.updateNodeOpt(e)}}var cp=ye,hp=ce,up="[object Boolean]";function dp(o){return o===!0||o===!1||hp(o)&&cp(o)==up}var pp=dp,me=ge(pp);class eo extends x{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.Rectangle}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}transformData(){const e=Y(this.tmpPoints);return[[e.x,e.y,0],[e.x+e.w,e.y,0],[e.x+e.w,e.y+e.h,0],[e.x,e.y+e.h,0]]}computDrawPoints(e){const{thickness:t}=this.workOptions,r=[];for(const n of e)r.push(new f(...n));const s=Y(r,t),i=[s.x+s.w/2,s.y+s.h/2];return{rect:s,pos:i,points:r.map(n=>n.XY).flat(1)}}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:m.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:m.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:m.None};const d=this.transformData();if(!i){const y=Date.now();return y-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=y,{type:m.DrawWork,dataType:M.Local,workId:n,op:d.flat(1),isSync:!0,index:0}):{type:m.None}}const u=s?this.fullLayer:this.drawLayer||this.fullLayer,p=this.draw({ps:d,workId:n,layer:u,isDrawing:!0}),w=j(p,this.oldRect);return this.oldRect=p,{rect:w,type:m.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:m.None};if(this.tmpPoints.length<2)return{type:m.RemoveNode,removeIds:[s]};const i=this.transformData(),n=this.fullLayer,a=this.draw({ps:i,workId:s,layer:n,isDrawing:!1});this.oldRect=a;const l=i.flat(1),c=le(l);return this.vNodes.setInfo(s,{rect:a,op:l,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:a&&x.getCenterPos(a,n)}),{rect:a,type:m.FullWork,dataType:M.Local,workId:s,ops:c,opt:this.workOptions,isSync:!0}}draw(e){var t;const{workId:r,layer:s,isDrawing:i,ps:n,replaceId:a}=e;this.fullLayer.getElementsByName(a||r).map(R=>R.remove()),(t=this.drawLayer)==null||t.getElementsByName(a||r).map(R=>R.remove());const{strokeColor:l,fillColor:c,thickness:h,zIndex:d,scale:u,rotate:p,translate:w,textOpt:y}=this.workOptions,v=s.worldPosition,S=s.worldScaling,{points:T,rect:O,pos:P}=this.computDrawPoints(n),g={close:!0,normalize:!0,points:T,lineWidth:h,fillColor:c!=="transparent"&&c||void 0,strokeColor:l,lineJoin:"round"},b={x:Math.floor(O.x*S[0]+v[0]-x.SafeBorderPadding),y:Math.floor(O.y*S[1]+v[1]-x.SafeBorderPadding),w:Math.floor(O.w*S[0]+2*x.SafeBorderPadding),h:Math.floor(O.h*S[0]+2*x.SafeBorderPadding)},C=new _.Group({name:r,id:r,zIndex:d,pos:P,anchor:[.5,.5],size:[O.w,O.h],scale:u,rotate:p,translate:w}),I=new _.Polyline({...g,pos:[0,0]});if(C.appendChild(I),i){const R=new _.Path({d:"M-4,0H4M0,-4V4",normalize:!0,pos:[0,0],strokeColor:l,lineWidth:1,scale:[1/S[0],1/S[1]]});C.appendChild(R)}if(s.append(C),u||p||w){const R=C.getBoundingClientRect();return{x:Math.floor(R.x-x.SafeBorderPadding),y:Math.floor(R.y-x.SafeBorderPadding),w:Math.floor(R.width+2*x.SafeBorderPadding),h:Math.floor(R.height+2*x.SafeBorderPadding)}}return b}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s,replaceId:i}=e,n=(t=this.workId)==null?void 0:t.toString();if(!n)return;const a=[];for(let h=0;h<r.length;h+=3)a.push([r[h],r[h+1],r[h+2]]);const l=s?this.fullLayer:this.drawLayer||this.fullLayer,c=this.draw({ps:a,workId:n,layer:l,isDrawing:!1,replaceId:i});return this.oldRect=c,this.vNodes.setInfo(n,{rect:c,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:c&&x.getCenterPos(c,l)}),c}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){var t,r;const{node:s,opt:i,vNodes:n}=e,{strokeColor:a,fillColor:l,fontColor:c,fontBgColor:h,bold:d,italic:u,lineThrough:p,underline:w,fontSize:y}=i,v=n.get(s.name);let S=s;if(s.tagName==="GROUP"&&(S=s.children[0]),a&&(S.setAttribute("strokeColor",a),(t=v==null?void 0:v.opt)!=null&&t.strokeColor&&(v.opt.strokeColor=a)),l&&(l==="transparent"?S.setAttribute("fillColor","rgba(0,0,0,0)"):S.setAttribute("fillColor",l),(r=v==null?void 0:v.opt)!=null&&r.fillColor&&(v.opt.fillColor=l)),v!=null&&v.opt.textOpt){const T=v.opt.textOpt;c&&T.fontColor&&(T.fontColor=c),h&&T.fontBgColor&&(T.fontBgColor=h),d&&(T.bold=d),u&&(T.italic=u),me(p)&&(T.lineThrough=p),me(w)&&(T.underline=w),y&&(T.fontSize=y)}return v&&n.setInfo(s.name,v),x.updateNodeOpt(e)}}class to extends x{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.Star}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:m.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:m.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:m.None};if(!i){const w=Date.now();return w-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=w,{type:m.DrawWork,dataType:M.Local,workId:n,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0}):{type:m.None}}const d=s?this.fullLayer:this.drawLayer||this.fullLayer,u=this.draw({workId:n,layer:d,isDrawing:!0}),p=j(u,this.oldRect);return this.oldRect=u,{rect:p,type:m.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:m.None};if(this.tmpPoints.length<2)return{type:m.RemoveNode,removeIds:[s]};const i=this.fullLayer,n=this.draw({workId:s,layer:i,isDrawing:!1});this.oldRect=n;const a=this.tmpPoints.map(c=>[...c.XY,0]).flat(1),l=le(a);return this.vNodes.setInfo(s,{rect:n,op:a,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:n&&x.getCenterPos(n,i)}),{rect:n,type:m.FullWork,dataType:M.Local,workId:s,ops:l,isSync:!0,opt:this.workOptions}}draw(e){var t;const{workId:r,layer:s,isDrawing:i}=e;this.fullLayer.getElementsByName(r).map(I=>I.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(I=>I.remove());const{strokeColor:n,fillColor:a,thickness:l,zIndex:c,vertices:h,innerVerticeStep:d,innerRatio:u,scale:p,rotate:w,translate:y}=this.workOptions,v=s.worldPosition,S=s.worldScaling,{rect:T,pos:O,points:P}=this.computDrawPoints(l,h,d,u),g={pos:O,close:!0,name:r,id:r,points:P,lineWidth:l,fillColor:a!=="transparent"&&a||void 0,strokeColor:n,className:`${O[0]},${O[1]}`,normalize:!0,zIndex:c,lineJoin:"round"},b={x:Math.floor(T.x*S[0]+v[0]-x.SafeBorderPadding*S[0]),y:Math.floor(T.y*S[1]+v[1]-x.SafeBorderPadding*S[1]),w:Math.floor(T.w*S[0]+2*x.SafeBorderPadding*S[0]),h:Math.floor(T.h*S[1]+2*x.SafeBorderPadding*S[1])};if(i){const{name:I,id:R,zIndex:A,strokeColor:B}=g,G=[(b.x+b.w/2-v[0])/S[0],(b.y+b.h/2-v[1])/S[1]],K=new _.Group({name:I,id:R,zIndex:A,pos:G,anchor:[.5,.5],size:[b.w,b.h]}),re=new _.Polyline({...g,pos:[0,0]}),oe=new _.Path({d:"M-4,0H4M0,-4V4",normalize:!0,pos:[0,0],strokeColor:B,lineWidth:1,scale:[1/S[0],1/S[1]]});return K.append(re,oe),s.append(K),b}p&&(g.scale=p),w&&(g.rotate=w),y&&(g.translate=y);const C=new _.Polyline(g);if(s.append(C),p||w||y){const I=C.getBoundingClientRect();return{x:Math.floor(I.x-x.SafeBorderPadding),y:Math.floor(I.y-x.SafeBorderPadding),w:Math.floor(I.width+x.SafeBorderPadding*2),h:Math.floor(I.height+x.SafeBorderPadding*2)}}return b}computDrawPoints(e,t,r,s){const i=Y(this.tmpPoints),n=[Math.floor(i.x+i.w/2),Math.floor(i.y+i.h/2)],a=Mr(i.w,i.h),l=Math.floor(Math.min(i.w,i.h)/2),c=s*l,h=[],d=2*Math.PI/t;for(let u=0;u<t;u++){const p=u*d-.5*Math.PI;let w,y;u%r===1?(w=c*a[0]*Math.cos(p),y=c*a[1]*Math.sin(p)):(w=l*a[0]*Math.cos(p),y=l*a[1]*Math.sin(p),h.push(w,y)),h.push(w,y)}return{rect:Y(this.tmpPoints,e),pos:n,points:h}}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i)||W.Sub(s,r).XY.includes(0))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s}=e,i=(t=this.workId)==null?void 0:t.toString();if(!i)return;this.tmpPoints.length=0;for(let l=0;l<r.length;l+=3)this.tmpPoints.push(new W(r[l],r[l+1],r[l+2]));const n=s?this.fullLayer:this.drawLayer||this.fullLayer,a=this.draw({workId:i,layer:n,isDrawing:!1});return this.oldRect=a,this.vNodes.setInfo(i,{rect:a,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:a&&x.getCenterPos(a,n)}),a}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){const{node:t,opt:r,vNodes:s}=e,{strokeColor:i,fillColor:n,toolsType:a,vertices:l,innerVerticeStep:c,innerRatio:h}=r,d=s.get(t.name),u=d==null?void 0:d.opt;let p=t;return t.tagName==="GROUP"&&(p=t.children[0]),i&&(p.setAttribute("strokeColor",i),u!=null&&u.strokeColor&&(u.strokeColor=i)),n&&(n==="transparent"?p.setAttribute("fillColor","rgba(0,0,0,0)"):p.setAttribute("fillColor",n),u!=null&&u.fillColor&&(u.fillColor=n)),a===k.Star&&(l&&(u.vertices=l),c&&(u.innerVerticeStep=c),h&&(u.innerRatio=h)),d&&s.setInfo(t.name,{...d,opt:u}),x.updateNodeOpt(e)}}class ro extends x{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.Polygon}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:m.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:m.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:m.None};if(!i){const w=Date.now();return w-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=w,{type:m.DrawWork,dataType:M.Local,workId:n,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0}):{type:m.None}}const d=s?this.fullLayer:this.drawLayer||this.fullLayer,u=this.draw({workId:n,layer:d,isDrawing:!0}),p=j(u,this.oldRect);return this.oldRect=u,{rect:p,type:m.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:m.None};if(this.tmpPoints.length<2)return{type:m.RemoveNode,removeIds:[s]};const i=this.fullLayer,n=this.draw({workId:s,layer:i,isDrawing:!1});this.oldRect=n;const a=this.tmpPoints.map(c=>[...c.XY,0]).flat(1),l=le(a);return this.vNodes.setInfo(s,{rect:n,op:a,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:n&&x.getCenterPos(n,i)}),{rect:n,type:m.FullWork,dataType:M.Local,workId:s,ops:l,isSync:!0,opt:this.workOptions}}draw(e){var t;const{workId:r,layer:s,isDrawing:i}=e;this.fullLayer.getElementsByName(r).map(b=>b.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(b=>b.remove());const{strokeColor:n,fillColor:a,thickness:l,zIndex:c,vertices:h,scale:d,rotate:u,translate:p}=this.workOptions,w=s.worldPosition,y=s.worldScaling,{rect:v,pos:S,points:T}=this.computDrawPoints(l,h),O={pos:S,close:!0,name:r,id:r,points:T,lineWidth:l,fillColor:a!=="transparent"&&a||void 0,strokeColor:n,normalize:!0,zIndex:c,lineJoin:"round"},P={x:Math.floor(v.x*y[0]+w[0]-x.SafeBorderPadding*y[0]),y:Math.floor(v.y*y[1]+w[1]-x.SafeBorderPadding*y[1]),w:Math.floor(v.w*y[0]+2*x.SafeBorderPadding*y[0]),h:Math.floor(v.h*y[1]+2*x.SafeBorderPadding*y[1])};if(i){const{name:b,id:C,zIndex:I,strokeColor:R}=O,A=[(P.x+P.w/2-w[0])/y[0],(P.y+P.h/2-w[1])/y[1]],B=new _.Group({name:b,id:C,zIndex:I,pos:A,anchor:[.5,.5],size:[P.w,P.h]}),G=new _.Polyline({...O,pos:[0,0]}),K=new _.Path({d:"M-4,0H4M0,-4V4",normalize:!0,pos:[0,0],strokeColor:R,lineWidth:1,scale:[1/y[0],1/y[1]]});return B.append(G,K),s.append(B),P}d&&(O.scale=d),u&&(O.rotate=u),p&&(O.translate=p);const g=new _.Polyline(O);if(s.append(g),d||u||p){const b=g.getBoundingClientRect();return{x:Math.floor(b.x-x.SafeBorderPadding),y:Math.floor(b.y-x.SafeBorderPadding),w:Math.floor(b.width+x.SafeBorderPadding*2),h:Math.floor(b.height+x.SafeBorderPadding*2)}}return P}computDrawPoints(e,t){const r=Y(this.tmpPoints),s=[Math.floor(r.x+r.w/2),Math.floor(r.y+r.h/2)],i=Mr(r.w,r.h),n=Math.floor(Math.min(r.w,r.h)/2),a=[],l=2*Math.PI/t;for(let c=0;c<t;c++){const h=c*l-.5*Math.PI,d=n*i[0]*Math.cos(h),u=n*i[1]*Math.sin(h);a.push(d,u)}return{rect:Y(this.tmpPoints,e),pos:s,points:a}}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i)||W.Sub(s,r).XY.includes(0))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s}=e,i=(t=this.workId)==null?void 0:t.toString();if(!i)return;this.tmpPoints.length=0;for(let l=0;l<r.length;l+=3)this.tmpPoints.push(new W(r[l],r[l+1],r[l+2]));const n=s?this.fullLayer:this.drawLayer||this.fullLayer,a=this.draw({workId:i,layer:n,isDrawing:!1});return this.oldRect=a,this.vNodes.setInfo(i,{rect:a,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:a&&x.getCenterPos(a,n)}),a}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){const{node:t,opt:r,vNodes:s}=e,{strokeColor:i,fillColor:n,toolsType:a,vertices:l}=r,c=s.get(t.name),h=c==null?void 0:c.opt;let d=t;return t.tagName==="GROUP"&&(d=t.children[0]),i&&(d.setAttribute("strokeColor",i),h!=null&&h.strokeColor&&(h.strokeColor=i)),n&&(n==="transparent"?d.setAttribute("fillColor","rgba(0,0,0,0)"):d.setAttribute("fillColor",n),h!=null&&h.fillColor&&(h.fillColor=n)),a===k.Polygon&&l&&(h.vertices=l),c&&s.setInfo(t.name,{...c,opt:h}),x.updateNodeOpt(e)}}class ae{static bezier(e,t){const r=[];for(let s=0;s<t.length;s+=4){const i=t[s],n=t[s+1],a=t[s+2],l=t[s+3];i&&n&&a&&l?r.push(...ae.getBezierPoints(e,i,n,a,l)):i&&n&&a?r.push(...ae.getBezierPoints(e,i,n,a)):i&&n?r.push(...ae.getBezierPoints(e,i,n)):i&&r.push(i)}return r}static getBezierPoints(e=10,t,r,s,i){let n=null;const a=[];!s&&!i?n=ae.oneBezier:s&&!i?n=ae.twoBezier:s&&i&&(n=ae.threeBezier);for(let l=0;l<e;l++)n&&a.push(n(l/e,t,r,s,i));return i?a.push(i):s&&a.push(s),a}static oneBezier(e,t,r){const s=t.x+(r.x-t.x)*e,i=t.y+(r.y-t.y)*e;return new f(s,i)}static twoBezier(e,t,r,s){const i=(1-e)*(1-e)*t.x+2*e*(1-e)*r.x+e*e*s.x,n=(1-e)*(1-e)*t.y+2*e*(1-e)*r.y+e*e*s.y;return new f(i,n)}static threeBezier(e,t,r,s,i){const n=t.x*(1-e)*(1-e)*(1-e)+3*r.x*e*(1-e)*(1-e)+3*s.x*e*e*(1-e)+i.x*e*e*e,a=t.y*(1-e)*(1-e)*(1-e)+3*r.y*e*(1-e)*(1-e)+3*s.y*e*e*(1-e)+i.y*e*e*e;return new f(n,a)}}class oo extends x{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.SpeechBalloon}),Object.defineProperty(this,"ratio",{enumerable:!0,configurable:!0,writable:!0,value:.8}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:m.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:m.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:m.None};if(!i){const w=Date.now();return w-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=w,{type:m.DrawWork,dataType:M.Local,workId:n,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0}):{type:m.None}}const d=s?this.fullLayer:this.drawLayer||this.fullLayer,u=this.draw({workId:n,layer:d,isDrawing:!0}),p=j(u,this.oldRect);return this.oldRect=u,{rect:p,type:m.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:m.None};if(this.tmpPoints.length<2)return{type:m.RemoveNode,removeIds:[s]};const i=this.fullLayer,n=this.draw({workId:s,layer:i,isDrawing:!1});this.oldRect=n;const a=this.tmpPoints.map(c=>[...c.XY,0]).flat(1),l=le(a);return this.vNodes.setInfo(s,{rect:n,op:a,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:n&&x.getCenterPos(n,i)}),{rect:n,type:m.FullWork,dataType:M.Local,workId:s,ops:l,isSync:!0,opt:this.workOptions}}draw(e){var t;const{workId:r,layer:s}=e;this.fullLayer.getElementsByName(r).map(g=>g.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(g=>g.remove());const{strokeColor:i,fillColor:n,thickness:a,zIndex:l,placement:c,scale:h,rotate:d,translate:u}=this.workOptions,p=s.worldPosition,w=s.worldScaling,{rect:y,pos:v,points:S}=this.computDrawPoints(a,c),T={pos:v,name:r,id:r,points:S.map(g=>g.XY),lineWidth:a,fillColor:n!=="transparent"&&n||void 0,strokeColor:i,normalize:!0,className:`${v[0]},${v[1]}`,zIndex:l,lineJoin:"round",close:!0},O={x:Math.floor(y.x*w[0]+p[0]-x.SafeBorderPadding*w[0]),y:Math.floor(y.y*w[1]+p[1]-x.SafeBorderPadding*w[1]),w:Math.floor(y.w*w[0]+2*x.SafeBorderPadding*w[0]),h:Math.floor(y.h*w[1]+2*x.SafeBorderPadding*w[1])};h&&(T.scale=h),d&&(T.rotate=d),u&&(T.translate=u);const P=new _.Polyline(T);if(s.append(P),h||d||u){const g=P.getBoundingClientRect();return{x:Math.floor(g.x-x.SafeBorderPadding),y:Math.floor(g.y-x.SafeBorderPadding),w:Math.floor(g.width+x.SafeBorderPadding*2),h:Math.floor(g.height+x.SafeBorderPadding*2)}}return O}transformControlPoints(e){const t=Y(this.tmpPoints);switch(e){case"bottom":case"bottomLeft":case"bottomRight":{const r=t.y+t.h*this.ratio;return[new f(t.x,t.y,0),new f(t.x+t.w,t.y,0),new f(t.x+t.w,r,0),new f(t.x,r,0)]}case"top":case"topLeft":case"topRight":{const r=t.y+t.h*(1-this.ratio);return[new f(t.x,r,0),new f(t.x+t.w,r,0),new f(t.x+t.w,t.y+t.h,0),new f(t.x,t.y+t.h,0)]}case"left":case"leftBottom":case"leftTop":{const r=t.x+t.w*(1-this.ratio);return[new f(r,t.y,0),new f(t.x+t.w,t.y,0),new f(t.x+t.w,t.y+t.h,0),new f(r,t.y+t.h,0)]}case"right":case"rightBottom":case"rightTop":{const r=t.x+t.w*this.ratio;return[new f(t.x,t.y,0),new f(r,t.y,0),new f(r,t.y+t.h,0),new f(t.x,t.y+t.h,0)]}}}computDrawPoints(e,t){const r=Y(this.tmpPoints),s=this.transformControlPoints(t),i=Math.floor(r.w*.1),n=Math.floor(r.h*.1),a=[],l=f.Add(s[0],new f(0,n,0)),c=f.Add(s[0],new f(i,0,0)),h=ae.getBezierPoints(10,l,s[0],c),d=f.Sub(s[1],new f(i,0,0)),u=f.Add(s[1],new f(0,n,0)),p=ae.getBezierPoints(10,d,s[1],u),w=f.Sub(s[2],new f(0,n,0)),y=f.Sub(s[2],new f(i,0,0)),v=ae.getBezierPoints(10,w,s[2],y),S=f.Add(s[3],new f(i,0,0)),T=f.Sub(s[3],new f(0,n,0)),O=ae.getBezierPoints(10,S,s[3],T),P=i*(1-this.ratio)*10,g=n*(1-this.ratio)*10;switch(t){case"bottom":{const I=f.Sub(s[2],new f(i*5-P/2,0,0)),R=f.Sub(s[2],new f(i*5,-g,0)),A=f.Sub(s[2],new f(i*5+P/2,0,0));a.push(R,A,...O,...h,...p,...v,I);break}case"bottomRight":{const I=f.Sub(s[2],new f(i*1.1,0,0)),R=f.Sub(s[2],new f(i*1.1+P/2,-g,0)),A=f.Sub(s[2],new f(i*1.1+P,0,0));a.push(R,A,...O,...h,...p,...v,I);break}case"bottomLeft":{const I=f.Add(s[3],new f(i*1.1+P,0,0)),R=f.Add(s[3],new f(i*1.1+P/2,g,0)),A=f.Add(s[3],new f(i*1.1,0,0));a.push(R,A,...O,...h,...p,...v,I);break}case"top":{const I=f.Sub(s[1],new f(i*5-P/2,0,0)),R=f.Sub(s[1],new f(i*5,g,0)),A=f.Sub(s[1],new f(i*5+P/2,0,0));a.push(R,I,...p,...v,...O,...h,A);break}case"topRight":{const I=f.Sub(s[1],new f(i*1.1,0,0)),R=f.Sub(s[1],new f(i*1.1+P/2,g,0)),A=f.Sub(s[1],new f(i*1.1+P,0,0));a.push(R,I,...p,...v,...O,...h,A);break}case"topLeft":{const I=f.Add(s[0],new f(i*1.1+P,0,0)),R=f.Add(s[0],new f(i*1.1+P/2,-g,0)),A=f.Add(s[0],new f(i*1.1,0,0));a.push(R,I,...p,...v,...O,...h,A);break}case"left":{const I=f.Add(s[0],new f(0,n*5-g/2,0)),R=f.Add(s[0],new f(-P,n*5,0)),A=f.Add(s[0],new f(0,n*5+g/2,0));a.push(R,I,...h,...p,...v,...O,A);break}case"leftTop":{const I=f.Add(s[0],new f(0,n*1.1,0)),R=f.Add(s[0],new f(-P,n*1.1+g/2,0)),A=f.Add(s[0],new f(0,n*1.1+g,0));a.push(R,I,...h,...p,...v,...O,A);break}case"leftBottom":{const I=f.Sub(s[3],new f(0,n*1.1+g,0)),R=f.Sub(s[3],new f(P,n*1.1+g/2,0)),A=f.Sub(s[3],new f(0,n*1.1,0));a.push(R,I,...h,...p,...v,...O,A);break}case"right":{const I=f.Add(s[1],new f(0,n*5-g/2,0)),R=f.Add(s[1],new f(P,n*5,0)),A=f.Add(s[1],new f(0,n*5+g/2,0));a.push(R,A,...v,...O,...h,...p,I);break}case"rightTop":{const I=f.Add(s[1],new f(0,n*1.1,0)),R=f.Add(s[1],new f(P,n*1.1+g/2,0)),A=f.Add(s[1],new f(0,n*1.1+g,0));a.push(R,A,...v,...O,...h,...p,I);break}case"rightBottom":{const I=f.Sub(s[2],new f(0,n*1.1+g,0)),R=f.Sub(s[2],new f(-P,n*1.1+g/2,0)),A=f.Sub(s[2],new f(0,n*1.1,0));a.push(R,A,...v,...O,...h,...p,I);break}}const b=Y(this.tmpPoints,e),C=[Math.floor(b.x+b.w/2),Math.floor(b.y+b.h/2)];return{rect:b,pos:C,points:a}}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i)||W.Sub(s,r).XY.includes(0))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s}=e,i=(t=this.workId)==null?void 0:t.toString();if(!i)return;this.tmpPoints.length=0;for(let l=0;l<r.length;l+=3)this.tmpPoints.push(new W(r[l],r[l+1],r[l+2]));const n=s?this.fullLayer:this.drawLayer||this.fullLayer,a=this.draw({workId:i,layer:n,isDrawing:!1});return this.oldRect=a,this.vNodes.setInfo(i,{rect:a,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:a&&x.getCenterPos(a,n)}),a}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){const{node:t,opt:r,vNodes:s}=e,{strokeColor:i,fillColor:n,toolsType:a,placement:l}=r,c=s.get(t.name),h=c==null?void 0:c.opt;let d=t;return t.tagName==="GROUP"&&(d=t.children[0]),i&&(d.setAttribute("strokeColor",i),h!=null&&h.strokeColor&&(h.strokeColor=i)),n&&(n==="transparent"?d.setAttribute("fillColor","rgba(0,0,0,0)"):d.setAttribute("fillColor",n),h!=null&&h.fillColor&&(h.fillColor=n)),a===k.SpeechBalloon&&l&&(h.placement=l),c&&s.setInfo(t.name,{...c,opt:h}),x.updateNodeOpt(e)}}class so extends x{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.Image}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.scaleType=this.workOptions.uniformScale?V.proportional:V.all}consume(){return{type:m.None}}consumeAll(){return{type:m.None}}draw(e){var t;const{layer:r,workId:s,replaceId:i,imageBitmap:n}=e,{centerX:a,centerY:l,width:c,height:h,scale:d,rotate:u,translate:p,zIndex:w}=this.workOptions;this.fullLayer.getElementsByName(i||s).map(O=>O.remove()),(t=this.drawLayer)==null||t.getElementsByName(i||s).map(O=>O.remove());const y={anchor:[.5,.5],pos:[a,l],name:s,size:[c,h],zIndex:w};if(d)if(this.scaleType===V.proportional){const O=Math.min(d[0],d[1]);y.scale=[O,O]}else y.scale=d;p&&(y.translate=p),u&&(y.rotate=u);const v=new _.Group(y),S=new _.Sprite({anchor:[.5,.5],pos:[0,0],size:[c,h],texture:n,rotate:180});v.append(S),r.append(v);const T=v.getBoundingClientRect();if(T)return{x:Math.floor(T.x-x.SafeBorderPadding),y:Math.floor(T.y-x.SafeBorderPadding),w:Math.floor(T.width+x.SafeBorderPadding*2),h:Math.floor(T.height+x.SafeBorderPadding*2)}}consumeService(){}async consumeServiceAsync(e){var t,r;const{isFullWork:s,replaceId:i,scene:n}=e,{src:a,uuid:l}=this.workOptions,c=((t=this.workId)==null?void 0:t.toString())||l,h=s?this.fullLayer:this.drawLayer||this.fullLayer;if(a){const d=await n.preload({id:l,src:this.workOptions.src}),u=this.draw({workId:c,layer:h,replaceId:i,imageBitmap:d[0]});return this.oldRect=c&&((r=this.vNodes.get(c))==null?void 0:r.rect)||void 0,this.vNodes.setInfo(c,{rect:u,op:[],opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:u&&x.getCenterPos(u,h)}),u}}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){const{node:t,opt:r,vNodes:s,targetNode:i}=e,{translate:n,box:a,boxScale:l,boxTranslate:c,angle:h,isLocked:d,zIndex:u}=r,p=i&&te(i)||s.get(t.name);if(!p)return;const w=t.parent;if(w){if(ue(u)&&(t.setAttribute("zIndex",u),p.opt.zIndex=u),me(d)&&(p.opt.locked=d),a&&c&&l){const{centerX:y,centerY:v,width:S,height:T,uniformScale:O}=p.opt;if(O){const b=Math.min(l[0],l[1]);p.opt.scale=[b,b]}else p.opt.scale=l;p.opt.width=Math.floor(S*l[0]),p.opt.height=Math.floor(T*l[1]);const P=[c[0]/w.worldScaling[0],c[1]/w.worldScaling[1]];p.opt.centerX=y+P[0],p.opt.centerY=v+P[1];const g=[p.centerPos[0]+P[0],p.centerPos[1]+P[1]];if(p.centerPos=g,i){let b=Rr(p.rect,l);b=Ae(b,P),p.rect=b}}else if(n){const y=[n[0]/w.worldScaling[0],n[1]/w.worldScaling[1]];if(p.opt.centerX=p.opt.centerX+y[0],p.opt.centerY=p.opt.centerY+y[1],p.centerPos=[p.centerPos[0]+y[0],p.centerPos[1]+y[1]],i){const v=Ae(p.rect,y);p.rect=v}}else if(ue(h)&&(t.setAttribute("rotate",h),p.opt.rotate=h,i)){const y=Wr(p.rect,h);p.rect=y}return p&&s.setInfo(t.name,p),p==null?void 0:p.rect}}}class io extends x{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.both}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.Straight}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"straightTipWidth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncTimestamp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt,this.straightTipWidth=this.workOptions.thickness/2,this.syncTimestamp=0,this.syncUnitTime=50}consume(e){var t;const{data:r,isFullWork:s,isSubWorker:i}=e,n=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!n)return{type:m.None};const{op:a,workState:l}=r,c=a==null?void 0:a.length;if(!c||c<2)return{type:m.None};let h;if(l===E.Start?(this.tmpPoints=[new W(a[0],a[1])],h=!1):h=this.updateTempPoints(a),!h)return{type:m.None};if(!i){const w=Date.now();return w-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=w,{type:m.DrawWork,dataType:M.Local,workId:n,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0}):{type:m.None}}const d=s?this.fullLayer:this.drawLayer||this.fullLayer,u=this.draw({workId:n,layer:d}),p=j(u,this.oldRect);return this.oldRect=u,{rect:p,type:m.DrawWork,dataType:M.Local,workId:n}}consumeAll(e){var t;const{data:r}=e,s=(t=r==null?void 0:r.workId)==null?void 0:t.toString();if(!s)return{type:m.None};if(this.tmpPoints.length<2)return{type:m.RemoveNode,removeIds:[s]};const i=this.fullLayer,n=this.draw({workId:s,layer:i});this.oldRect=n;const a=this.tmpPoints.map(c=>[...c.XY,0]).flat(1),l=le(a);return this.vNodes.setInfo(s,{rect:n,op:a,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:n&&x.getCenterPos(n,i)}),{rect:n,type:m.FullWork,dataType:M.Local,workId:s,ops:l,isSync:!0,opt:this.workOptions}}draw(e){var t;const{workId:r,layer:s}=e;this.fullLayer.getElementsByName(r).map(T=>T.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(T=>T.remove());const{strokeColor:i,thickness:n,zIndex:a,scale:l,rotate:c,translate:h}=this.workOptions,d=s.worldPosition,u=s.worldScaling,{d:p,rect:w}=this.computDrawPoints(n),y=[w.x+w.w/2,w.y+w.h/2],v={pos:y,name:r,id:r,d:p,fillColor:i,strokeColor:i,lineWidth:0,className:`${y[0]},${y[1]}`,normalize:!0,zIndex:a};l&&(v.scale=l),c&&(v.rotate=c),h&&(v.translate=h);const S=new _.Path(v);if(s.append(S),c||l||h){const T=S.getBoundingClientRect();return{x:Math.floor(T.x-x.SafeBorderPadding),y:Math.floor(T.y-x.SafeBorderPadding),w:Math.floor(T.width+x.SafeBorderPadding*2),h:Math.floor(T.height+x.SafeBorderPadding*2)}}return{x:Math.floor(w.x*u[0]+d[0]-x.SafeBorderPadding),y:Math.floor(w.y*u[1]+d[1]-x.SafeBorderPadding),w:Math.floor(w.w*u[0]+2*x.SafeBorderPadding),h:Math.floor(w.h*u[1]+2*x.SafeBorderPadding)}}computDrawPoints(e){return this.tmpPoints[1].distance(this.tmpPoints[0])>this.straightTipWidth?this.computFullPoints(e):this.computDotPoints(e)}computFullPoints(e){const t=f.Sub(this.tmpPoints[1],this.tmpPoints[0]).uni(),r=f.Per(t).mul(e/2),s=W.Sub(this.tmpPoints[0],r),i=W.Add(this.tmpPoints[0],r),n=W.Sub(this.tmpPoints[1],r),a=W.Add(this.tmpPoints[1],r),l=W.GetSemicircleStroke(this.tmpPoints[1],n,-1,8),c=W.GetSemicircleStroke(this.tmpPoints[0],i,-1,8),h=[s,n,...l,a,i,...c];return{d:Ce(h,!0),rect:Y(h),isDot:!1,pos:this.tmpPoints[0].XY}}computDotPoints(e){const t=W.GetDotStroke(this.tmpPoints[0],e/2,8);return{d:Ce(t,!0),rect:Y(t),isDot:!0,pos:this.tmpPoints[0].XY}}updateTempPoints(e){const t=e.slice(-2),r=new W(t[0],t[1]),s=this.tmpPoints[0],{thickness:i}=this.workOptions;if(s.isNear(r,i))return!1;if(this.tmpPoints.length===2){if(r.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=r}else this.tmpPoints.push(r);return!0}consumeService(e){var t;const{op:r,isFullWork:s}=e,i=(t=this.workId)==null?void 0:t.toString();if(!i)return;this.tmpPoints.length=0;for(let l=0;l<r.length;l+=3)this.tmpPoints.push(new W(r[l],r[l+1],r[l+2]));const n=s?this.fullLayer:this.drawLayer||this.fullLayer,a=this.draw({workId:i,layer:n});return this.oldRect=a,this.vNodes.setInfo(i,{rect:a,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:a&&x.getCenterPos(a,n)}),a}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(e){var t;const{node:r,opt:s,vNodes:i}=e,{strokeColor:n}=s,a=i.get(r.name);return n&&(r.setAttribute("strokeColor",n),r.setAttribute("fillColor",n),(t=a==null?void 0:a.opt)!=null&&t.strokeColor&&(a.opt.strokeColor=n)),a&&i.setInfo(r.name,a),x.updateNodeOpt(e)}}class Be extends x{constructor(e){super(e),Object.defineProperty(this,"canRotate",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"scaleType",{enumerable:!0,configurable:!0,writable:!0,value:V.all}),Object.defineProperty(this,"toolsType",{enumerable:!0,configurable:!0,writable:!0,value:k.Text}),Object.defineProperty(this,"tmpPoints",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"workOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oldRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.workOptions=e.toolsOpt}consume(){return{type:m.None}}consumeAll(){return{type:m.None}}draw(e){var t;const{workId:r,layer:s,isDrawLabel:i}=e;this.fullLayer.getElementsByName(r).map(y=>y.remove()),(t=this.drawLayer)==null||t.getElementsByName(r).map(y=>y.remove());const{boxSize:n,boxPoint:a,zIndex:l}=this.workOptions,c=s.worldPosition,h=s.worldScaling;if(!a||!n)return;const d=new _.Group({name:r,id:r,pos:[a[0]+n[0]/2,a[1]+n[1]/2],anchor:[.5,.5],size:n,zIndex:l}),u={x:a[0],y:a[1],w:n[0],h:n[1]},p=new _.Rect({normalize:!0,pos:[0,0],size:n}),w=i&&Be.createLabels(this.workOptions,s)||[];return d.append(...w,p),s.append(d),{x:Math.floor(u.x*h[0]+c[0]),y:Math.floor(u.y*h[1]+c[1]),w:Math.floor(u.w*h[0]),h:Math.floor(u.h*h[1])}}consumeService(e){var t,r;const s=(t=this.workId)==null?void 0:t.toString();if(!s)return;const{isFullWork:i,replaceId:n,isDrawLabel:a}=e;this.oldRect=n&&((r=this.vNodes.get(n))==null?void 0:r.rect)||void 0;const l=i?this.fullLayer:this.drawLayer||this.fullLayer,c=this.draw({workId:s,layer:l,isDrawLabel:a});return this.vNodes.setInfo(s,{rect:c,op:[],opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:c&&x.getCenterPos(c,l)}),c}updataOptService(e){if(!this.workId)return;const t=this.workId.toString(),{fontColor:r,fontBgColor:s,bold:i,italic:n,lineThrough:a,underline:l,zIndex:c}=e,h=this.vNodes.get(t);if(!h)return;r&&(h.opt.fontColor=r),s&&(h.opt.fontBgColor=s),i&&(h.opt.bold=i),n&&(h.opt.italic=n),me(a)&&(h.opt.lineThrough=a),me(l)&&(h.opt.underline=l),s&&(h.opt.fontBgColor=s),ue(c)&&(h.opt.zIndex=c),this.oldRect=h.rect;const d=this.draw({workId:t,layer:this.fullLayer,isDrawLabel:!1});return this.vNodes.setInfo(t,{rect:d,op:[],opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:d&&x.getCenterPos(d,this.fullLayer)}),d}clearTmpPoints(){this.tmpPoints.length=0}static getFontWidth(e){const{ctx:t,opt:r,text:s}=e,{bold:i,italic:n,fontSize:a,fontFamily:l}=r;return t.font=`${i} ${n} ${a}px ${l}`,t.measureText(s).width}static createLabels(e,t){const r=[],s=e.text.split(","),i=s.length;for(let n=0;n<i;n++){const a=s[n],{fontSize:l,lineHeight:c,bold:h,textAlign:d,italic:u,boxSize:p,fontFamily:w,verticalAlign:y,fontColor:v,underline:S,lineThrough:T}=e,O=c||l*1.2,P=t&&t.parent.canvas.getContext("2d"),g=P&&Be.getFontWidth({text:a,opt:e,ctx:P,worldScaling:t.worldScaling});if(g){const b={anchor:[0,.5],text:a,fontSize:l,lineHeight:O,fontFamily:w,fontWeight:h,fillColor:v,textAlign:d,fontStyle:u,name:n.toString(),className:"label"},C=[0,0];if(y==="middle"){const R=(i-1)/2;C[1]=(n-R)*O}d==="left"&&(C[0]=p&&-p[0]/2+5||0),b.pos=C;const I=new _.Label(b);if(r.push(I),S){const R={normalize:!1,pos:[b.pos[0],b.pos[1]+l/2],lineWidth:2*t.worldScaling[0],points:[0,0,g,0],strokeColor:v,name:`${n}_underline`,className:"underline"},A=new _.Polyline(R);r.push(A)}if(T){const R={normalize:!1,pos:b.pos,lineWidth:2*t.worldScaling[0],points:[0,0,g,0],strokeColor:v,name:`${n}_lineThrough`,className:"lineThrough"},A=new _.Polyline(R);r.push(A)}}}return r}static updateNodeOpt(e){const{node:t,opt:r,vNodes:s,targetNode:i}=e,{fontBgColor:n,fontColor:a,translate:l,box:c,boxScale:h,boxTranslate:d,bold:u,italic:p,lineThrough:w,underline:y,fontSize:v,textInfos:S}=r,T=i&&te(i)||s.get(t.name);if(!T)return;const O=t.parent;if(!O)return;const P=T.opt;if(a&&P.fontColor&&(P.fontColor=a),n&&P.fontBgColor&&(P.fontBgColor=n),u&&(P.bold=u),p&&(P.italic=p),me(w)&&(P.lineThrough=w),me(y)&&(P.underline=y),v&&(P.fontSize=v),c&&d&&h){const g=S==null?void 0:S.get(t.name);if(g){const{fontSize:I,boxSize:R}=g;P.boxSize=R||P.boxSize,P.fontSize=I||P.fontSize}const b=T.rect,C=Ae(Rr(b,h),d);P.boxPoint=C&&[(C.x-O.worldPosition[0])/O.worldScaling[0],(C.y-O.worldPosition[1])/O.worldScaling[1]]}else if(l&&P.boxPoint){const g=[l[0]/O.worldScaling[0],l[1]/O.worldScaling[1]];P.boxPoint=[P.boxPoint[0]+g[0],P.boxPoint[1]+g[1]],T.centerPos=[T.centerPos[0]+g[0],T.centerPos[1]+g[1]],T.rect=Ae(T.rect,g)}return T&&s.setInfo(t.name,T),T==null?void 0:T.rect}static getRectFromLayer(e,t){const r=e.getElementsByName(t)[0];if(r){const s=r.getBoundingClientRect();return{x:Math.floor(s.x),y:Math.floor(s.y),w:Math.floor(s.width),h:Math.floor(s.height)}}}}function no(o){switch(o){case k.Arrow:return Jr;case k.Pencil:return Br;case k.Straight:return io;case k.Ellipse:return Kr;case k.Polygon:case k.Triangle:return ro;case k.Star:case k.Rhombus:return to;case k.Rectangle:return eo;case k.SpeechBalloon:return oo;case k.Text:return Be;case k.LaserPen:return Dr;case k.Eraser:return ne;case k.Selector:return U;case k.Image:return so}}function Tt(o,e){const{toolsType:t,...r}=o;switch(t){case k.Arrow:return new Jr(r);case k.Pencil:return new Br(r);case k.Straight:return new io(r);case k.Ellipse:return new Kr(r);case k.Polygon:case k.Triangle:return new ro(r);case k.Star:case k.Rhombus:return new to(r);case k.Rectangle:return new eo(r);case k.SpeechBalloon:return new oo(r);case k.Text:return new Be(r);case k.LaserPen:return new Dr(r);case k.Eraser:return new ne(r,e);case k.Selector:return new U(r);case k.Image:return new so(r);default:return}}function ao(o){const e=[],t=["PATH","SPRITE","POLYLINE","RECT","ELLIPSE"];for(const r of o){if(r.tagName==="GROUP"&&r.children.length)return ao(r.children);r.tagName&&t.includes(r.tagName)&&e.push(r)}return e}class fp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.ZIndexActive})}consume(e){const{msgType:t,dataType:r,emitEventType:s}=e;if(t===m.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e),!0}consumeForLocalWorker(e){var t,r,s,i,n;const{workId:a,isActiveZIndex:l,willRefreshSelector:c}=e;if(a!==U.selectorId)return;const h=(t=this.localWork)==null?void 0:t.workShapes.get(U.selectorId);if(!h)return;const d=h.oldSelectRect;if(l&&d&&this.localWork){const u=new Set;if(this.localWork.vNodes.curNodeMap.forEach((p,w)=>{Te(d,p.rect)&&u.add(w)}),u.size){const p=[];u.forEach(w=>{var y;(y=this.localWork)==null||y.fullLayer.getElementsByName(w).forEach(v=>{var S,T;const O=v.cloneNode(!0);Qe(v)&&O.seal(),(T=(S=this.localWork)==null?void 0:S.drawLayer)!=null&&T.getElementsByName(w).length||p.push(O)})}),p.length&&((r=this.localWork.drawLayer)==null||r.append(...p))}}else(i=(s=this.localWork)==null?void 0:s.drawLayer)==null||i.children.filter(u=>{var p;return!((p=h.selectIds)!=null&&p.includes(u.name))}).forEach(u=>u.remove());c&&((n=this.localWork)==null||n._post({render:[{rect:d,drawCanvas:L.Selector,clearCanvas:L.Selector,isClear:!0,isFullWork:!1,viewId:this.localWork.viewId}],sp:[{type:m.Select,selectIds:h.selectIds,opt:h.getWorkOptions(),selectRect:d,strokeColor:h.strokeColor,fillColor:h.fillColor,willSyncService:!1,isSync:!0}]}))}}class yp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.CopyNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===m.FullWork&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:m.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r}=e;r&&await((t=this.localWork)==null?void 0:t.consumeFull(e,this.scene))}}class wp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.SetColorNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===m.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:m.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,textUpdateForWoker:l}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s}=e,{willSyncService:i,isSync:n,textUpdateForWoker:a}=t,l=r.render||[],c=r.sp||[];if(i)for(const[h,d]of s.entries())a&&d.toolsType===k.Text?c.push({...d,workId:h,type:m.TextUpdate,dataType:M.Local,willSyncService:!0}):c.push({...d,workId:h,type:m.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n});return{render:l,sp:c}}}class vp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.ZIndexNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s}=e;if(t===m.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s}=e,{willSyncService:i,isSync:n}=t,a=r.render||[],l=r.sp||[];if(i&&l)for(const[c,h]of s.entries())l.push({...h,workId:c,type:m.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n});return{render:a,sp:l}}}class mp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.TranslateNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===m.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:m.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t,r;const{workId:s,updateNodeOpt:i,willRefreshSelector:n,willSyncService:a,willSerializeData:l,textUpdateForWoker:c,emitEventType:h}=e;s===U.selectorId&&i&&(i.workState===E.Done&&i!=null&&i.translate&&(i.translate[0]||i.translate[1])||i.workState!==E.Done?await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:i,willRefreshSelector:n,willSyncService:a,willSerializeData:l,isSync:!0,textUpdateForWoker:c,emitEventType:h,scene:this.scene,callback:this.updateSelectorCallback})):i.workState===E.Done&&((r=this.localWork)==null||r.vNodes.deleteLastTarget()))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s,workShapeNode:i,res:n}=e,{willSyncService:a,isSync:l,updateSelectorOpt:c,willSerializeData:h,textUpdateForWoker:d}=t,u=c.workState,p=r.render||[],w=r.sp||[];if(u===E.Start)return{sp:[],render:[]};const y=n==null?void 0:n.selectRect;if(a){if(h){const v=i.getChildrenPoints();v&&w.push({type:m.Select,selectIds:i.selectIds,selectRect:y,willSyncService:!1,isSync:l,points:v})}for(const[v,S]of s.entries())d&&S.toolsType===k.Text?w.push({...S,workId:v,type:m.TextUpdate,dataType:M.Local,willSyncService:!0}):w.push({...S,workId:v,type:m.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l})}return{render:p,sp:w}}}class gp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.DeleteNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s}=e;if(t===m.RemoveNode){if(r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e),!0;if(r===M.Service&&s===this.emitEventType)return this.consumeForServiceWorker(e),!0}}consumeForLocalWorker(e){if(!this.localWork)return;const{removeIds:t,willRefresh:r,willSyncService:s,viewId:i}=e;if(!(t!=null&&t.length))return;let n;const a=[],l=[],c=[];for(const h of t){if(h===U.selectorId){const u=this.localWork.workShapes.get(U.selectorId);if(!u)return;const p=u.selectIds&&[...u.selectIds]||[];for(const y of p){if(this.localWork.vNodes.get(y)){const v=this.commandDeleteText(y);v&&a.push(v)}n=j(n,this.localWork.removeNode(y)),c.push(y)}const w=u==null?void 0:u.updateSelectIds([]);n=j(n,w.bgRect),this.localWork.clearWorkShapeNodeCache(U.selectorId),this.localWork.workShapes.delete(U.selectorId),a.push({type:m.Select,selectIds:[],willSyncService:s});continue}const d=this.commandDeleteText(h);d&&a.push(d),n=j(n,this.localWork.removeNode(h)),c.push(h)}s&&a.push({type:m.RemoveNode,removeIds:c,undoTickerId:e.undoTickerId}),n&&r&&l.push({rect:n,drawCanvas:L.Bg,clearCanvas:L.Bg,isClear:!0,isFullWork:!0,viewId:i}),(l.length||a.length)&&this.localWork._post({render:l,sp:a})}consumeForServiceWorker(e){this.serviceWork&&this.serviceWork.removeSelectWork(e)}commandDeleteText(e){var t;const r=(t=this.localWork)==null?void 0:t.vNodes.get(e);if(r&&r.toolsType===k.Text)return{type:m.TextUpdate,toolsType:k.Text,workId:e,dataType:M.Local}}}class bp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.ScaleNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===m.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:m.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willSyncService:i,willSerializeData:n}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willSyncService:i,willSerializeData:n,isSync:!0,scene:this.scene,callback:this.updateSelectorCallback.bind(this)}))}updateSelectorCallback(e){const{param:t,postData:r,workShapeNode:s,res:i,newServiceStore:n}=e,{updateSelectorOpt:a,willSyncService:l,willSerializeData:c}=t,h=a.workState,d=r.render||[],u=r.sp||[],p=i==null?void 0:i.selectRect,w=i==null?void 0:i.renderRect;if(h===E.Start)return{sp:[],render:[]};if(this.localWork){d.push({isClearAll:!0,isFullWork:!1,clearCanvas:L.Selector,viewId:this.localWork.viewId});const y={rect:w,isFullWork:!1,drawCanvas:L.Selector,viewId:this.localWork.viewId};d.push(y)}if(l){h===E.Doing&&u.push({type:m.Select,selectIds:s.selectIds,selectRect:p,willSyncService:!0,isSync:!0,points:s.getChildrenPoints(),textOpt:s.textOpt}),c&&h===E.Done&&u.push({type:m.Select,selectIds:s.selectIds,selectRect:p,willSyncService:!1,isSync:!0,points:s.getChildrenPoints(),textOpt:s.textOpt});for(const[y,v]of n.entries())v.toolsType===k.Text?u.push({...v,workId:y,type:m.TextUpdate,dataType:M.Local,willSyncService:!0}):u.push({...v,workId:y,type:m.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:!0})}return{render:d,sp:u}}}class kp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.RotateNode})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===m.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:m.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,emitEventType:l}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,emitEventType:l,isSync:!0,scene:this.scene,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,workShapeNode:s,res:i,newServiceStore:n}=e,{updateSelectorOpt:a,willSyncService:l,willSerializeData:c,isSync:h}=t,d=a.workState,u=r.render||[],p=r.sp||[],w=i==null?void 0:i.selectRect;if(l){c&&d===E.Done&&p.push({type:m.Select,selectIds:s.selectIds,selectRect:w,willSyncService:!0,isSync:h,points:s.getChildrenPoints()});for(const[y,v]of n.entries())p.push({...v,workId:y,type:m.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:h})}return{render:u,sp:p}}}class Sp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.SetFontStyle})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===m.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:m.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,textUpdateForWoker:l}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s,workShapeNode:i,res:n}=e,{willSyncService:a,isSync:l,updateSelectorOpt:c,textUpdateForWoker:h}=t,d=r.render||[],u=r.sp||[],p=n==null?void 0:n.selectRect;if(a&&u){c.fontSize&&u.push({type:m.Select,selectIds:i.selectIds,selectRect:p,willSyncService:a,isSync:l,points:i.getChildrenPoints()});for(const[w,y]of s.entries())h&&y.toolsType===k.Text?u.push({...y,workId:w,type:m.TextUpdate,dataType:M.Local,willSyncService:!0}):u.push({...y,workId:w,type:m.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l})}return{render:d,sp:u}}}class Pp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.SetPoint})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===m.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:m.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,textUpdateForWoker:l}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,emitEventType:this.emitEventType,willSerializeData:a,isSync:!0,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s,workShapeNode:i,res:n}=e,{willSyncService:a,isSync:l}=t,c=r.render||[],h=r.sp||[],d=n==null?void 0:n.selectRect;if(a&&h){for(const[u,p]of s.entries())h.push({...p,workId:u,type:m.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l});h.push({type:m.Select,selectIds:i.selectIds,selectRect:d,willSyncService:a,isSync:l,points:i.getChildrenPoints()})}return{render:c,sp:h}}}class Ip extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.SetLock})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===m.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:m.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s,workShapeNode:i,res:n}=e,{willSyncService:a,isSync:l,updateSelectorOpt:c}=t,h=r.render||[],d=r.sp||[],u=n==null?void 0:n.selectRect;if(a&&d){for(const[p,w]of s.entries())d.push({...w,workId:p,type:m.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l});d.push({isLocked:c.isLocked,selectorColor:i.selectorColor,scaleType:i.scaleType,canRotate:i.canRotate,type:m.Select,selectIds:i.selectIds,selectRect:u,willSyncService:a,isSync:l})}return{render:h,sp:d}}}class Tp extends se{constructor(){super(...arguments),Object.defineProperty(this,"emitEventType",{enumerable:!0,configurable:!0,writable:!0,value:z.SetShapeOpt})}consume(e){const{msgType:t,dataType:r,emitEventType:s,undoTickerId:i}=e;if(t===m.UpdateNode&&r===M.Local&&s===this.emitEventType)return this.consumeForLocalWorker(e).finally(()=>{i&&setTimeout(()=>{var n;(n=this.localWork)==null||n._post({sp:[{type:m.None,undoTickerId:i}]})},0)}),!0}async consumeForLocalWorker(e){var t;const{workId:r,updateNodeOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a}=e;r===U.selectorId&&s&&await((t=this.localWork)==null?void 0:t.updateSelector({updateSelectorOpt:s,willRefreshSelector:i,willSyncService:n,willSerializeData:a,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:t,postData:r,newServiceStore:s}=e,{willSyncService:i,isSync:n}=t,a=r.render||[],l=r.sp||[];if(i&&l)for(const[c,h]of s.entries())l.push({...h,workId:c,type:m.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:n});return{render:a,sp:l}}}class xp{constructor(e){Object.defineProperty(this,"builders",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),this.builders=new Map(e.map(t=>[t,this.build(t)]))}build(e){switch(e){case z.TranslateNode:return new mp;case z.ZIndexNode:return new vp;case z.ZIndexActive:return new fp;case z.CopyNode:return new yp;case z.SetColorNode:return new wp;case z.DeleteNode:return new gp;case z.ScaleNode:return new bp;case z.RotateNode:return new kp;case z.SetFontStyle:return new Sp;case z.SetPoint:return new Pp;case z.SetLock:return new Ip;case z.SetShapeOpt:return new Tp}}registerForWorker(e,t,r){return this.builders.forEach(s=>{s&&s.registerForWorker(e,t,r)}),this}consumeForWorker(e){for(const t of this.builders.values())if(t!=null&&t.consume(e))return!0;return!1}}const ot="cursorhover";class Op{constructor(e,t){Object.defineProperty(this,"viewId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"scene",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"scenePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"curNodeMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"targetNodeMap",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.viewId=e,this.scene=t}init(e,t){this.fullLayer=e,this.drawLayer=t}get(e){return this.curNodeMap.get(e)}hasRenderNodes(){let e=!1;for(const t of this.curNodeMap.values())jr(t.toolsType)&&(e=!0);return e}has(e){this.curNodeMap.has(e)}setInfo(e,t){const r=this.curNodeMap.get(e)||{name:e,rect:t.rect};t.rect&&(r.rect=te(t.rect)),t.op&&(r.op=te(t.op)),t.canRotate&&(r.canRotate=t.canRotate),t.scaleType&&(r.scaleType=t.scaleType),t.opt&&(r.opt=te(t.opt)),t.toolsType&&(r.toolsType=t.toolsType),t.centerPos&&(r.centerPos=te(t.centerPos)),r.rect?this.curNodeMap.set(e,r):this.curNodeMap.delete(e)}delete(e){this.curNodeMap.delete(e)}clear(){this.curNodeMap.clear(),this.targetNodeMap.length=0}hasRectIntersectRange(e,t=!0){for(const r of this.curNodeMap.values())if(Te(e,r.rect)){if(t&&r.toolsType===k.Image&&r.opt.locked||t&&r.toolsType===k.Text&&(r.opt.workState===E.Doing||r.opt.workState===E.Start))continue;return!0}return!1}getRectIntersectRange(e,t=!0){let r;const s=new Map;for(const[i,n]of this.curNodeMap.entries())if(Te(e,n.rect)){if(t&&n.toolsType===k.Image&&n.opt.locked||t&&n.toolsType===k.Text&&(n.opt.workState===E.Doing||n.opt.workState===E.Start))continue;r=j(r,n.rect),s.set(i,n)}return{rectRange:r,nodeRange:s}}getNodeRectFormShape(e,t){const r=no(t.toolsType);let s=this.fullLayer&&(r==null?void 0:r.getRectFromLayer(this.fullLayer,e));return!s&&this.drawLayer&&(s=r==null?void 0:r.getRectFromLayer(this.drawLayer,e)),s}updateNodesRect(){this.curNodeMap.forEach((e,t)=>{const r=this.getNodeRectFormShape(t,e);r?(e.rect=r,this.curNodeMap.set(t,e)):this.curNodeMap.delete(t)})}combineIntersectRect(e){let t=e;return this.curNodeMap.forEach(r=>{Te(t,r.rect)&&(t=j(t,r.rect))}),t}setTarget(){return this.targetNodeMap.push(te(this.curNodeMap)),this.targetNodeMap.length-1}getLastTarget(){return this.targetNodeMap[this.targetNodeMap.length-1]}deleteLastTarget(){this.targetNodeMap.length=this.targetNodeMap.length-1}getTarget(e){return this.targetNodeMap[e]}deleteTarget(e){this.targetNodeMap.length=e}}class lo{constructor(e,t){Object.defineProperty(this,"viewId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vNodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dpr",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"opt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cameraOpt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"scene",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isSafari",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.viewId=e,this.opt=t,this.dpr=t.dpr,this.scene=this.createScene(t.offscreenCanvasOpt),this.fullLayer=this.createLayer("fullLayer",this.scene,{...t.layerOpt,bufferSize:this.viewId==="mainView"?6e3:3e3}),this.vNodes=new Op(e,this.scene)}setIsSafari(e){this.isSafari=e}on(e){const{msgType:t,toolsType:r,opt:s,workId:i,workState:n,dataType:a}=e;switch(t){case m.Destroy:this.destroy();break;case m.Clear:this.clearAll();break;case m.UpdateTools:if(r&&s){const l={toolsType:r,toolsOpt:s};this.localWork.setToolsOpt(l)}break;case m.CreateWork:i&&s&&(!this.localWork.getTmpWorkShapeNode()&&r&&this.setToolsOpt({toolsType:r,toolsOpt:s}),this.setWorkOpt({workId:i,toolsOpt:s}));break;case m.DrawWork:n===E.Done&&a===M.Local?this.consumeDrawAll(a,e):this.consumeDraw(a,e);break}}updateScene(e){this.scene.attr({...e});const{width:t,height:r}=e;this.scene.container.width=t,this.scene.container.height=r,this.scene.width=t,this.scene.height=r,this.updateLayer({width:t,height:r})}updateLayer(e){const{width:t,height:r}=e;this.fullLayer&&(this.fullLayer.parent.setAttribute("width",t),this.fullLayer.parent.setAttribute("height",r),this.fullLayer.setAttribute("size",[t,r]),this.fullLayer.setAttribute("pos",[t*.5,r*.5])),this.drawLayer&&(this.drawLayer.parent.setAttribute("width",t),this.drawLayer.parent.setAttribute("height",r),this.drawLayer.setAttribute("size",[t,r]),this.drawLayer.setAttribute("pos",[t*.5,r*.5])),this.snapshotFullLayer&&(this.snapshotFullLayer.parent.setAttribute("width",t),this.snapshotFullLayer.parent.setAttribute("height",r),this.snapshotFullLayer.setAttribute("size",[t,r]),this.snapshotFullLayer.setAttribute("pos",[t*.5,r*.5]))}createScene(e){const{width:t,height:r}=e,s=new OffscreenCanvas(t,r);return new _.Scene({container:s,displayRatio:this.dpr,depth:!1,desynchronized:!0,...e})}createLayer(e,t,r){const{width:s,height:i}=r,n=`offscreen-${e}`,a=t.layer(n,r),l=new _.Group({anchor:[.5,.5],pos:[s*.5,i*.5],size:[s,i],name:"viewport",id:e});return a.append(l),l}clearAll(){var e;this.fullLayer&&(this.fullLayer.parent.children.forEach(t=>{t.name!=="viewport"&&t.remove()}),this.fullLayer.removeAllChildren()),this.drawLayer&&(this.drawLayer.parent.children.forEach(t=>{t.name!=="viewport"&&t.remove()}),this.drawLayer.removeAllChildren()),this.localWork.clearAllWorkShapesCache(),(e=this.serviceWork)==null||e.clearAllWorkShapesCache()}setToolsOpt(e){this.localWork.setToolsOpt(e)}setWorkOpt(e){const{workId:t,toolsOpt:r}=e;t&&r&&this.localWork.setWorkOptions(t,r)}destroy(){var e;this.vNodes.clear(),this.scene.remove(),this.fullLayer.remove(),this.localWork.destroy(),(e=this.serviceWork)==null||e.destroy()}}class co{constructor(e){Object.defineProperty(this,"viewId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vNodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"thread",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_post",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tmpWorkShapeNode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tmpOpt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workShapes",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"workShapeState",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"effectWorkId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.thread=e.thread,this.viewId=e.viewId,this.vNodes=e.vNodes,this.fullLayer=e.fullLayer,this.drawLayer=e.drawLayer,this._post=e.post}destroy(){this.workShapeState.clear(),this.workShapes.clear()}getWorkShape(e){return this.workShapes.get(e)}getTmpWorkShapeNode(){return this.tmpWorkShapeNode}setTmpWorkId(e){if(e&&this.tmpWorkShapeNode){this.tmpWorkShapeNode.setWorkId(e),this.workShapes.set(e,this.tmpWorkShapeNode),this.tmpOpt&&this.setToolsOpt(this.tmpOpt);return}}setTmpWorkOptions(e){var t;(t=this.tmpWorkShapeNode)==null||t.setWorkOptions(e)}setWorkOptions(e,t){var r;this.workShapes.get(e)||this.setTmpWorkId(e),(r=this.workShapes.get(e))==null||r.setWorkOptions(t)}createWorkShapeNode(e){var t;const{toolsType:r,workId:s}=e;return r===k.Selector&&s===ot?Tt({...e,vNodes:this.vNodes,fullLayer:this.fullLayer,drawLayer:this.fullLayer}):Tt({...e,vNodes:this.vNodes,fullLayer:this.fullLayer,drawLayer:this.drawLayer},(t=this.thread)==null?void 0:t.serviceWork)}setToolsOpt(e){var t,r;((t=this.tmpOpt)==null?void 0:t.toolsType)!==e.toolsType&&(r=this.tmpOpt)!=null&&r.toolsType&&this.clearAllWorkShapesCache(),this.tmpOpt=e,this.tmpWorkShapeNode=this.createWorkShapeNode(e)}clearWorkShapeNodeCache(e){var t;(t=this.getWorkShape(e))==null||t.clearTmpPoints(),this.workShapes.delete(e),this.workShapeState.delete(e)}clearAllWorkShapesCache(){this.workShapes.forEach(e=>e.clearTmpPoints()),this.workShapes.clear(),this.workShapeState.clear()}setFullWork(e){const{workId:t,opt:r,toolsType:s}=e;if(t&&r&&s){const i=t&&this.workShapes.get(t)||this.createWorkShapeNode({toolsOpt:r,toolsType:s,workId:t});return i?(i.setWorkId(t),this.workShapes.set(t,i),i):void 0}}}var Cp=ie,Np=function(){return Cp.Date.now()},Lp=Np,Wp=/\s/;function Rp(o){for(var e=o.length;e--&&Wp.test(o.charAt(e)););return e}var Mp=Rp,jp=Mp,Ap=/^\s+/;function Bp(o){return o&&o.slice(0,jp(o)+1).replace(Ap,"")}var Dp=Bp,Fp=ye,Ep=ce,zp="[object Symbol]";function Up(o){return typeof o=="symbol"||Ep(o)&&Fp(o)==zp}var _p=Up,$p=Dp,ho=he,Yp=_p,uo=NaN,Xp=/^[-+]0x[0-9a-f]+$/i,Gp=/^0b[01]+$/i,Vp=/^0o[0-7]+$/i,Hp=parseInt;function Zp(o){if(typeof o=="number")return o;if(Yp(o))return uo;if(ho(o)){var e=typeof o.valueOf=="function"?o.valueOf():o;o=ho(e)?e+"":e}if(typeof o!="string")return o===0?o:+o;o=$p(o);var t=Gp.test(o);return t||Vp.test(o)?Hp(o.slice(2),t?2:8):Xp.test(o)?uo:+o}var qp=Zp,Qp=he,xt=Lp,po=qp,Jp="Expected a function",Kp=Math.max,ef=Math.min;function tf(o,e,t){var r,s,i,n,a,l,c=0,h=!1,d=!1,u=!0;if(typeof o!="function")throw new TypeError(Jp);e=po(e)||0,Qp(t)&&(h=!!t.leading,d="maxWait"in t,i=d?Kp(po(t.maxWait)||0,e):i,u="trailing"in t?!!t.trailing:u);function p(b){var C=r,I=s;return r=s=void 0,c=b,n=o.apply(I,C),n}function w(b){return c=b,a=setTimeout(S,e),h?p(b):n}function y(b){var C=b-l,I=b-c,R=e-C;return d?ef(R,i-I):R}function v(b){var C=b-l,I=b-c;return l===void 0||C>=e||C<0||d&&I>=i}function S(){var b=xt();if(v(b))return T(b);a=setTimeout(S,y(b))}function T(b){return a=void 0,u&&r?p(b):(r=s=void 0,n)}function O(){a!==void 0&&clearTimeout(a),c=0,r=l=s=a=void 0}function P(){return a===void 0?n:T(xt())}function g(){var b=xt(),C=v(b);if(r=arguments,s=this,l=b,C){if(a===void 0)return w(l);if(d)return clearTimeout(a),a=setTimeout(S,e),p(l)}return a===void 0&&(a=setTimeout(S,e)),n}return g.cancel=O,g.flush=P,g}var rf=tf,of=rf,sf=he,nf="Expected a function";function af(o,e,t){var r=!0,s=!0;if(typeof o!="function")throw new TypeError(nf);return sf(t)&&(r="leading"in t?!!t.leading:r,s="trailing"in t?!!t.trailing:s),of(o,e,{leading:r,maxWait:e,trailing:s})}var lf=af,cf=ge(lf);class hf extends co{constructor(e){super(e),Object.defineProperty(this,"combineUnitTime",{enumerable:!0,configurable:!0,writable:!0,value:600}),Object.defineProperty(this,"combineTimerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"effectSelectNodeData",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"batchEraserWorks",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"batchEraserRemoveNodes",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"batchEraserCombine",{enumerable:!0,configurable:!0,writable:!0,value:cf(()=>{const t=this.updateBatchEraserCombineNode(this.batchEraserWorks,this.batchEraserRemoveNodes);this.batchEraserWorks.clear(),this.batchEraserRemoveNodes.clear(),t.length&&this._post({render:t})},100,{leading:!1})})}consumeDraw(e,t){const{op:r,workId:s}=e;if(r!=null&&r.length&&s){const i=this.workShapes.get(s);if(!i)return;const n=i.toolsType;if(n===k.LaserPen)return;const a=i.consume({data:e,isFullWork:!0});switch(n){case k.Selector:a.type===m.Select&&(a.selectIds&&t.runReverseSelectWork(a.selectIds),this.drawSelector(a,!0));break;case k.Eraser:a!=null&&a.rect&&this.drawEraser(a);break;case k.Arrow:case k.Straight:case k.Ellipse:case k.Rectangle:case k.Star:case k.Polygon:case k.SpeechBalloon:a&&(this.drawCount++,this.drawPencil(a));break;case k.Pencil:this.combineTimerId||(this.combineTimerId=setTimeout(()=>{this.combineTimerId=void 0,this.drawPencilCombine(s)},Math.floor(i.getWorkOptions().syncUnitTime||this.combineUnitTime/2))),a&&(this.drawCount++,this.drawPencil(a));break}}}consumeDrawAll(e,t){var r,s,i;this.combineTimerId&&(clearTimeout(this.combineTimerId),this.combineTimerId=void 0);const{workId:n,undoTickerId:a}=e;if(n){a&&setTimeout(()=>{this._post({sp:[{type:m.None,undoTickerId:a}]})},0);const l=this.workShapes.get(n);if(!l)return;const c=l.toolsType;if(c===k.LaserPen)return;const h=this.workShapes.get(ot),d=(r=h==null?void 0:h.selectIds)==null?void 0:r[0],u=l.consumeAll({data:e,hoverId:d}),p=this.workShapeState.get(n);switch(c){case k.Selector:u.selectIds&&d&&(s=u.selectIds)!=null&&s.includes(d)&&h.cursorBlur(),u.selectIds&&t.runReverseSelectWork(u.selectIds),this.drawSelector(u,!1),(i=l.selectIds)!=null&&i.length?l.clearTmpPoints():this.clearWorkShapeNodeCache(n);break;case k.Eraser:u!=null&&u.rect&&this.drawEraser(u),l.clearTmpPoints();break;case k.Arrow:case k.Straight:case k.Ellipse:case k.Rectangle:case k.Star:case k.Polygon:case k.SpeechBalloon:this.drawPencilFull(u,l.getWorkOptions(),p),this.drawCount=0,this.clearWorkShapeNodeCache(n);break;case k.Pencil:u!=null&&u.rect&&(this.drawPencilFull(u,l.getWorkOptions(),p),this.drawCount=0),this.clearWorkShapeNodeCache(n);break}}}async consumeFull(e,t){var r,s;const i=this.setFullWork(e),n=e.ops&&Ke(e.ops),a=(r=e.workId)==null?void 0:r.toString();if(a&&i){const l=(s=this.vNodes.get(a))==null?void 0:s.rect;let c;i.toolsType===k.Image&&t?c=await i.consumeServiceAsync({scene:t,isFullWork:!0,replaceId:a}):c=i.consumeService({op:n,isFullWork:!0,replaceId:a});const h=(e==null?void 0:e.updateNodeOpt)&&i.updataOptService(e.updateNodeOpt);c=j(c,h);const d=[],u=[];if(c&&e.willRefresh&&(l&&d.push({rect:c,isClear:!0,clearCanvas:L.Bg,isFullWork:!0,viewId:this.viewId}),d.push({rect:c,drawCanvas:L.Bg,isFullWork:!0,viewId:this.viewId})),e.willSyncService&&u.push({opt:e.opt,toolsType:e.toolsType,type:m.FullWork,workId:e.workId,ops:e.ops,updateNodeOpt:e.updateNodeOpt,undoTickerId:e.undoTickerId,viewId:this.viewId}),d.length||u.length){const p={render:d,sp:u};this._post(p)}e.workId&&this.workShapes.delete(e.workId)}}removeWork(e){const{workId:t}=e,r=t==null?void 0:t.toString();if(r){const s=this.removeNode(r);s&&this._post({render:[{rect:s,isClear:!0,isFullWork:!0,clearCanvas:L.Bg,drawCanvas:L.Bg,viewId:this.viewId}]})}}removeNode(e){var t;this.workShapes.has(e)&&this.clearWorkShapeNodeCache(e);let r;const s=this.vNodes.get(e);return s&&(this.fullLayer.getElementsByName(e).concat(((t=this.drawLayer)==null?void 0:t.getElementsByName(e))||[]).forEach(i=>{i.remove()}),r=j(r,s.rect),this.vNodes.delete(e)),r}async checkTextActive(e){const{op:t,viewId:r,dataType:s}=e;if(t!=null&&t.length){let i;for(const n of this.vNodes.curNodeMap.values()){const{rect:a,name:l,toolsType:c,opt:h}=n,d=t[0]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],u=t[1]*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1];if(c===k.Text&&Xu([d,u],a)&&h.workState===E.Done){i=l;break}}i&&(await this.blurSelector({viewId:r,msgType:m.Select,dataType:s,isSync:!0}),await this._post({sp:[{type:m.GetTextActive,toolsType:k.Text,workId:i}]}))}}async colloctEffectSelectWork(e){const t=this.workShapes.get(U.selectorId),{workId:r,msgType:s}=e;if(t&&r&&t.selectIds&&t.selectIds.includes(r.toString())){s===m.RemoveNode?t.selectIds=t.selectIds.filter(i=>i!==r.toString()):this.effectSelectNodeData.add(e),await new Promise(i=>{setTimeout(()=>{i(!0)},0)}),await this.runEffectSelectWork(!0).then(()=>{var i;(i=this.effectSelectNodeData)==null||i.clear()});return}return e}async updateSelector(e){var t;const r=this.workShapes.get(U.selectorId);if(!((t=r==null?void 0:r.selectIds)!=null&&t.length))return;const{callback:s,...i}=e,{updateSelectorOpt:n,willRefreshSelector:a,willSerializeData:l,emitEventType:c,scene:h}=i,d=n.workState,u=await(r==null?void 0:r.updateSelector({updateSelectorOpt:n,selectIds:r.selectIds,vNodes:this.vNodes,willSerializeData:l,worker:this,scene:h})),p=u==null?void 0:u.selectRect,w=new Map;r.selectIds.forEach(T=>{const O=this.vNodes.get(T);if(O){const{toolsType:P,op:g,opt:b}=O;w.set(T,{opt:b,toolsType:P,ops:(g==null?void 0:g.length)&&le(g)||void 0})}});const y=[],v=[];if(a){y.push({isClearAll:!0,isFullWork:!1,clearCanvas:L.Selector,viewId:this.viewId});const T={rect:p,isFullWork:!1,drawCanvas:L.Selector,viewId:this.viewId};n.translate&&c===z.TranslateNode&&d===E.Doing&&(T.translate=n.translate),y.push(T)}const S=s&&s({res:u,workShapeNode:r,param:i,postData:{render:y,sp:v},newServiceStore:w})||{render:y,sp:v};(S.render.length||S.sp.length)&&this._post(S)}async blurSelector(e){var t;const r=this.workShapes.get(U.selectorId),s=r==null?void 0:r.blurSelector();if(this.clearWorkShapeNodeCache(U.selectorId),((t=this.drawLayer)==null?void 0:t.parent).children.forEach(i=>{i.name===U.selectorId&&i.remove()}),s){const i=[];i.push({...s,undoTickerId:e==null?void 0:e.undoTickerId,isSync:e==null?void 0:e.isSync}),await this._post({render:(s==null?void 0:s.rect)&&[{rect:s.rect,drawCanvas:L.Bg,isClear:!0,clearCanvas:L.Bg,isFullWork:!0,viewId:this.viewId}],sp:i})}}reRenderSelector(e=!1){var t;const r=this.workShapes.get(U.selectorId);if(r){if(r&&!((t=r.selectIds)!=null&&t.length))return this.blurSelector();if(this.drawLayer){const s=r.reRenderSelector();s&&this._post({render:[{rect:s,isClear:!0,isFullWork:!1,clearCanvas:L.Selector,drawCanvas:L.Selector,viewId:this.viewId}],sp:[{type:m.Select,selectIds:r.selectIds,selectRect:s,willSyncService:e,viewId:this.viewId,points:r.getChildrenPoints(),textOpt:r.textOpt}]})}}}updateFullSelectWork(e){var t,r,s,i,n,a,l,c;const h=this.workShapes.get(U.selectorId),{selectIds:d}=e;if(!(d!=null&&d.length)){this.blurSelector(e);return}if(!h){!this.setFullWork(e)&&e.workId&&((t=this.tmpWorkShapeNode)==null?void 0:t.toolsType)===k.Selector&&this.setTmpWorkId(e.workId),this.updateFullSelectWork(e);return}if(h&&d!=null&&d.length){const{bgRect:u,selectRect:p}=h.updateSelectIds(d),w={render:[],sp:[]};u&&((r=w.render)==null||r.push({rect:J(u),isClear:!0,isFullWork:!0,clearCanvas:L.Bg,drawCanvas:L.Bg,viewId:this.viewId})),(s=w.render)==null||s.push({rect:p,isClear:!0,isFullWork:!1,clearCanvas:L.Selector,drawCanvas:L.Selector,viewId:this.viewId}),(c=w.sp)==null||c.push({...e,selectorColor:((i=e.opt)==null?void 0:i.strokeColor)||h.selectorColor,strokeColor:((n=e.opt)==null?void 0:n.strokeColor)||h.strokeColor,fillColor:((a=e.opt)==null?void 0:a.fillColor)||h.fillColor,textOpt:((l=e.opt)==null?void 0:l.textOpt)||h.textOpt,canTextEdit:h.canTextEdit,canRotate:h.canRotate,scaleType:h.scaleType,type:m.Select,selectRect:p,points:h.getChildrenPoints(),willSyncService:(e==null?void 0:e.willSyncService)||!1,opt:(e==null?void 0:e.willSyncService)&&h.getWorkOptions()||void 0,canLock:h.canLock,isLocked:h.isLocked,toolsTypes:h.toolsTypes,shapeOpt:h.shapeOpt}),this._post(w)}}destroy(){super.destroy(),this.effectSelectNodeData.clear(),this.batchEraserWorks.clear(),this.batchEraserRemoveNodes.clear()}drawPencilCombine(e){var t,r;const s=(t=this.workShapes.get(e))==null?void 0:t.combineConsume();if(s){const i={render:[],drawCount:this.drawCount};(r=i.render)==null||r.push({rect:(s==null?void 0:s.rect)&&J(s.rect),isClear:!0,drawCanvas:L.Float,clearCanvas:L.Float,isFullWork:!1,viewId:this.viewId}),this._post(i)}}drawSelector(e,t){var r,s;const i={render:[],sp:[e]};e.type===m.Select&&!t&&((r=i.render)==null||r.push({rect:e.selectRect,drawCanvas:L.Selector,isClear:!0,clearCanvas:L.Selector,isFullWork:!1,viewId:this.viewId},{rect:e.rect&&J(e.rect),isClear:!0,clearCanvas:L.Float,isFullWork:!1,viewId:this.viewId},{rect:e.rect&&J(e.rect),drawCanvas:L.Bg,isClear:!0,clearCanvas:L.Bg,isFullWork:!0,viewId:this.viewId})),t&&((s=i.render)==null||s.push({rect:e.rect&&J(e.rect),drawCanvas:L.Float,isClear:!0,clearCanvas:L.Float,isFullWork:!1,viewId:this.viewId},{rect:e.rect&&J(e.rect),drawCanvas:L.Bg,isClear:!0,clearCanvas:L.Bg,isFullWork:!0,viewId:this.viewId})),this._post(i)}async drawEraser(e){var t,r;const s=[];if((t=e.newWorkDatas)!=null&&t.size){for(const i of e.newWorkDatas.values()){const n=i.workId.toString();this.batchEraserWorks.add(n),s.push({type:m.FullWork,workId:n,ops:le(i.op),opt:i.opt,toolsType:i.toolsType,updateNodeOpt:{useAnimation:!1}})}delete e.newWorkDatas}(r=e.removeIds)==null||r.forEach(i=>{this.batchEraserRemoveNodes.add(i)}),s.push(e),this._post({sp:s}),this.batchEraserCombine()}drawPencil(e){this._post({drawCount:this.drawCount,sp:(e==null?void 0:e.op)&&[e]})}drawPencilFull(e,t,r){var s;let i=(r==null?void 0:r.willClear)||(t==null?void 0:t.isOpacity)||!1;!i&&e.rect&&(i=this.vNodes.hasRectIntersectRange(e.rect));const n={drawCount:1/0,render:[{rect:e.rect,drawCanvas:L.Bg,isClear:i,clearCanvas:L.Bg,isFullWork:!0,viewId:this.viewId}],sp:[e]};(s=n.render)==null||s.push({isClearAll:!0,clearCanvas:L.Float,isFullWork:!1,viewId:this.viewId}),this._post(n)}updateBatchEraserCombineNode(e,t){const r=[];let s;for(const i of t.keys())this.fullLayer.getElementsByName(i).forEach(n=>{const a=n.getBoundingClientRect();s=j(s,{x:a.x-ne.SafeBorderPadding,y:a.y-ne.SafeBorderPadding,w:a.width+ne.SafeBorderPadding*2,h:a.height+ne.SafeBorderPadding*2}),n.remove()});return e.forEach(i=>{const n=this.vNodes.get(i);if(n)if(this.fullLayer.getElementsByName(i)[0])s=j(s,n.rect);else{const a=this.setFullWork({...n,workId:i}),l=a&&a.consumeService({op:n.op,isFullWork:!0});l&&(n.rect=l,s=j(s,l))}}),s&&r.push({rect:s,isClear:!0,isFullWork:!0,clearCanvas:L.Bg,drawCanvas:L.Bg,viewId:this.viewId}),r}async runEffectSelectWork(e){var t,r,s,i;for(const n of this.effectSelectNodeData.values()){const a=this.setFullWork(n);if(a){if(a.toolsType===k.Image)await a.consumeServiceAsync({scene:(r=(t=this.drawLayer)==null?void 0:t.parent)==null?void 0:r.parent,isFullWork:!1,replaceId:(s=a.getWorkId())==null?void 0:s.toString()});else{const l=n.ops&&Ke(n.ops);a.consumeService({op:l,isFullWork:!1,replaceId:(i=a.getWorkId())==null?void 0:i.toString()})}n!=null&&n.updateNodeOpt&&a.updataOptService(n.updateNodeOpt),n.workId&&this.workShapes.delete(n.workId)}}this.reRenderSelector(e)}cursorHover(e){var t;const{opt:r,toolsType:s,point:i}=e,n=this.setFullWork({workId:ot,toolsType:s,opt:r});if(n&&i){const a=n.cursorHover(i),l={render:[]};a&&a.type===m.CursorHover&&((t=l.render)==null||t.push({rect:a.rect&&J(a.rect),isClear:!0,clearCanvas:L.Bg,drawCanvas:L.Bg,isFullWork:!0,viewId:this.viewId}),this._post(l))}}}class uf{constructor(e){Object.defineProperty(this,"viewId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vNodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workShapes",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"selectorWorkShapes",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"animationId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"willRunEffectSelectorIds",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"runEffectId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"noAnimationRect",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"post",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.viewId=e.viewId,this.vNodes=e.vNodes,this.fullLayer=e.fullLayer,this.drawLayer=e.drawLayer,this.post=e.post}destroy(){this.workShapes.clear(),this.selectorWorkShapes.clear(),this.willRunEffectSelectorIds.clear()}consumeDraw(e){this.activeWorkShape(e),this.runAnimation()}consumeFull(e){this.activeWorkShape(e),this.runAnimation()}clearAllWorkShapesCache(){this.workShapes.forEach((e,t)=>{e.toolsType===k.LaserPen?setTimeout(()=>{this.workShapes.delete(t)},2e3):this.workShapes.delete(t)})}runSelectWork(e){this.activeSelectorShape(e);const{workId:t}=e,r=t==null?void 0:t.toString();r&&this.willRunEffectSelectorIds.add(r),this.runEffect()}setNodeKey(e,t,r){return e.toolsType=t,e.node=Tt({toolsType:t,toolsOpt:r,vNodes:this.vNodes,fullLayer:this.fullLayer,drawLayer:this.drawLayer},this),e}runReverseSelectWork(e){e.forEach(t=>{this.selectorWorkShapes.forEach((r,s)=>{var i;if((i=r.selectIds)!=null&&i.length){const n=r.selectIds.indexOf(t);n>-1&&(r.selectIds.splice(n,1),this.willRunEffectSelectorIds.add(s))}})}),this.willRunEffectSelectorIds.size&&this.runEffect()}removeWork(e){const{workId:t}=e,r=t==null?void 0:t.toString();if(r){const s=this.workShapes.get(r);if(s){this.workShapes.delete(r),this.removeNode(r,e,s==null?void 0:s.totalRect,!1);return}this.removeNode(r,e)}}removeSelectWork(e){const{workId:t}=e,r=t==null?void 0:t.toString();r&&(this.activeSelectorShape(e),this.willRunEffectSelectorIds.add(r)),this.runEffect()}removeNode(e,t,r,s=!0){var i;const n=this.fullLayer.getElementsByName(e).concat(this.drawLayer.getElementsByName(e));e.indexOf(U.selectorId)>-1&&this.removeSelectWork(t);const a=[];let l=r;const c=(i=this.vNodes.get(e))==null?void 0:i.rect;c&&(l=j(c,l)),n.forEach(h=>{a.push(h)}),a.length&&a.forEach(h=>h.remove()),l&&(this.post({render:[{rect:J(l),isClear:!0,isFullWork:s,clearCanvas:s?L.Bg:L.Float,drawCanvas:s?L.Bg:L.Float,viewId:this.viewId}]}),this.vNodes.delete(e))}activeWorkShape(e){var t,r,s,i;const{workId:n,opt:a,toolsType:l,type:c,updateNodeOpt:h,ops:d,op:u,useAnimation:p}=e;if(!n)return;const w=n.toString();if(!((t=this.workShapes)!=null&&t.has(w))){let v={toolsType:l,animationWorkData:u||[],animationIndex:0,type:c,updateNodeOpt:h,ops:d,useAnimation:typeof p<"u"?p:typeof(h==null?void 0:h.useAnimation)<"u"?h==null?void 0:h.useAnimation:!0,oldRect:(r=this.vNodes.get(w))==null?void 0:r.rect,isDiff:!1};l&&a&&(v=this.setNodeKey(v,l,a)),(s=this.workShapes)==null||s.set(w,v)}const y=(i=this.workShapes)==null?void 0:i.get(w);c&&(y.type=c),d&&(y.animationWorkData=Ke(d),y.ops=d),h&&(y.updateNodeOpt=h),u&&(y.isDiff=this.hasDiffData(y.animationWorkData||[],u,y.toolsType),y.animationWorkData=u),y.node&&y.node.getWorkId()!==w&&y.node.setWorkId(w),l&&a&&(y.toolsType!==l&&l&&a&&this.setNodeKey(y,l,a),y.node&&y.node.setWorkOptions(a))}hasDiffData(e,t,r){const s=e.length;if(t.length<s)return!0;switch(r){case k.Pencil:{for(let i=0;i<s;i+=3)if(t[i]!==e[i]||t[i+1]!==e[i+1])return!0;break}case k.LaserPen:{for(let i=0;i<s;i+=2)if(t[i]!==e[i]||t[i+1]!==e[i+1])return!0;break}}return!1}async animationDraw(){var e,t,r,s,i,n,a,l,c,h,d,u,p,w,y,v,S,T,O,P,g,b,C,I,R,A,B,G,K,re;this.animationId=void 0;let oe=!1;const de=new Map,Le=[],We=[],Re=[],Me=[];for(const[D,N]of this.workShapes.entries())switch(N.toolsType){case k.Image:{const F=N.oldRect;F&&Re.push({rect:F,isClear:!0,clearCanvas:L.Bg,viewId:this.viewId});const Q=await((t=N.node)==null?void 0:t.consumeServiceAsync({isFullWork:!0,scene:(e=this.fullLayer.parent)==null?void 0:e.parent}));this.selectorWorkShapes.forEach((q,H)=>{var ee;(ee=q.selectIds)!=null&&ee.includes(D)&&(this.willRunEffectSelectorIds.add(H),this.noAnimationRect=j(this.noAnimationRect,F),this.noAnimationRect=j(this.noAnimationRect,Q),this.runEffect())}),this.workShapes.delete(D),Le.push({rect:Q,drawCanvas:L.Bg,isFullWork:!0,viewId:this.viewId});break}case k.Text:{if(N.node){const F=N.oldRect,Q=(r=N.node)==null?void 0:r.consumeService({op:N.animationWorkData||[],isFullWork:!0});this.selectorWorkShapes.forEach((q,H)=>{var ee;(ee=q.selectIds)!=null&&ee.includes(D)&&(this.willRunEffectSelectorIds.add(H),this.noAnimationRect=j(this.noAnimationRect,F),this.noAnimationRect=j(this.noAnimationRect,Q),this.runEffect())}),(s=N.node)==null||s.clearTmpPoints(),this.workShapes.delete(D)}break}case k.Arrow:case k.Straight:case k.Rectangle:case k.Ellipse:case k.Star:case k.Polygon:case k.SpeechBalloon:{const F=!!N.ops;if((i=N.animationWorkData)!=null&&i.length){const Q=N.oldRect,q=N.node.oldRect;Q&&Re.push({rect:Q,isClear:!0,clearCanvas:L.Bg,viewId:this.viewId}),q&&Me.push({rect:q,isClear:!0,clearCanvas:L.Float,viewId:this.viewId});const H=(n=N.node)==null?void 0:n.consumeService({op:N.animationWorkData,isFullWork:F});de.set(D,{workState:Q?N.ops?E.Done:E.Doing:E.Start,op:N.animationWorkData.filter((ee,fe)=>{if(fe%3!==2)return!0}).slice(-2)}),F?(this.selectorWorkShapes.forEach((ee,fe)=>{var st;(st=ee.selectIds)!=null&&st.includes(D)&&(this.willRunEffectSelectorIds.add(fe),this.noAnimationRect=j(this.noAnimationRect,Q),this.noAnimationRect=j(this.noAnimationRect,q),this.noAnimationRect=j(this.noAnimationRect,H),this.runEffect())}),(a=N.node)==null||a.clearTmpPoints(),this.workShapes.delete(D),Le.push({rect:H,drawCanvas:L.Bg,isFullWork:F,viewId:this.viewId}),de.set(D,{workState:E.Done,op:N.animationWorkData.filter((ee,fe)=>{if(fe%3!==2)return!0}).slice(-2)})):We.push({rect:H,drawCanvas:L.Float,isFullWork:F,viewId:this.viewId}),N.animationWorkData.length=0}break}case k.Pencil:{if(!N.useAnimation&&N.ops){let F=(l=N.node)==null?void 0:l.consumeService({op:N.animationWorkData||[],isFullWork:!0,replaceId:D});const Q=(c=N.node)==null?void 0:c.updataOptService(N.updateNodeOpt);F=j(F,Q),Re.push({rect:j(N.oldRect,F),clearCanvas:L.Bg,viewId:this.viewId}),Le.push({rect:j(N.oldRect,F),drawCanvas:L.Bg,viewId:this.viewId}),this.selectorWorkShapes.forEach((q,H)=>{var ee;(ee=q.selectIds)!=null&&ee.includes(D)&&(this.willRunEffectSelectorIds.add(H),this.noAnimationRect=j(this.noAnimationRect,F),this.runEffect())}),(h=N.node)==null||h.clearTmpPoints(),this.workShapes.delete(D)}else if(N.useAnimation){const F=this.computNextAnimationIndex(N,3),Q=N.isDiff?0:Math.max(0,(N.animationIndex||0)-3),q=(N.animationWorkData||[]).slice(Q,F);if(N.isDel)N.isDel&&((T=N.node)==null||T.clearTmpPoints(),this.workShapes.delete(D));else{if((N.animationIndex||0)<F||N.isDiff){const H=(u=N.node)==null?void 0:u.consumeService({op:q,isFullWork:!1,replaceId:(d=N.node.getWorkId())==null?void 0:d.toString()});if(We.push({rect:H,drawCanvas:L.Float,viewId:this.viewId}),N.animationIndex=F,N.isDiff&&(N.isDiff=!1),q.length){const ee=q.filter((fe,st)=>{if(st%3!==2)return!0}).slice(-2);de.set(D,{workState:Q===0?E.Start:F===((p=N.animationWorkData)==null?void 0:p.length)?E.Done:E.Doing,op:ee})}}else if(N.ops){const H=(y=N.node)==null?void 0:y.consumeService({op:N.animationWorkData||[],isFullWork:!0,replaceId:(w=N.node.getWorkId())==null?void 0:w.toString()});N.isDel=!0,Me.push({rect:H,clearCanvas:L.Float,viewId:this.viewId}),(v=N.node)!=null&&v.getWorkOptions().isOpacity&&Re.push({rect:H,clearCanvas:L.Bg,viewId:this.viewId}),Le.push({rect:H,drawCanvas:L.Bg,viewId:this.viewId}),this.vNodes.setInfo(D,{op:N.animationWorkData,opt:(S=N.node)==null?void 0:S.getWorkOptions(),toolsType:N.toolsType,rect:H}),de.set(D,{workState:E.Done,op:q.filter((ee,fe)=>{if(fe%3!==2)return!0}).slice(-2)})}oe=!0}break}break}case k.LaserPen:{const F=this.computNextAnimationIndex(N,2),Q=Math.max(0,(N.animationIndex||0)-2),q=(N.animationWorkData||[]).slice(Q,F);if(N.isDel){if(N.isDel){const H=(I=N.node)==null?void 0:I.consumeService({op:[],isFullWork:!1});N.totalRect=j(N.totalRect,H),Me.push({rect:N.totalRect,clearCanvas:L.Float,viewId:this.viewId}),We.push({rect:N.totalRect,drawCanvas:L.Float,viewId:this.viewId}),(R=N.node)==null||R.clearTmpPoints(),this.workShapes.delete(D)}}else{if((N.animationIndex||0)<F){const H=(P=N.node)==null?void 0:P.consumeService({op:q,isFullWork:!1,replaceId:(O=N.node.getWorkId())==null?void 0:O.toString()});N.totalRect=j(N.totalRect,H),N.timer&&(clearTimeout(N.timer),N.timer=void 0),N.animationIndex=F,q.length&&de.set(D,{workState:Q===0?E.Start:F===((g=N.animationWorkData)==null?void 0:g.length)?E.Done:E.Doing,op:q.slice(-2)})}else{N.timer||(N.timer=setTimeout(()=>{N.timer=void 0,N.isDel=!0,this.runAnimation()},((b=N.node)==null?void 0:b.getWorkOptions()).duration*1e3+100),de.set(D,{workState:E.Done,op:[]}));const H=(C=N.node)==null?void 0:C.consumeService({op:[],isFullWork:!1});N.totalRect=j(N.totalRect,H)}Me.push({rect:N.totalRect,clearCanvas:L.Float,viewId:this.viewId}),We.push({rect:N.totalRect,drawCanvas:L.Float,viewId:this.viewId}),oe=!0}break}}oe&&this.runAnimation();const pe={render:[]};if(Re.length){const D=Re.reduce((N,F)=>(F.rect&&F.clearCanvas===L.Bg&&(N.rect=j(N.rect,F.rect)),N),{isClear:!0,clearCanvas:L.Bg,viewId:this.viewId});D.rect&&(D.rect=D.rect&&J(D.rect),(A=pe.render)==null||A.push(D))}if(Me.length){const D=Me.reduce((N,F)=>(F.rect&&F.clearCanvas===L.Float&&(N.rect=j(N.rect,F.rect)),N),{isClear:!0,clearCanvas:L.Float,viewId:this.viewId});D.rect&&(D.rect=D.rect&&J(D.rect),(B=pe.render)==null||B.push(D))}if(Le.length){const D=Le.reduce((N,F)=>(F.rect&&F.drawCanvas===L.Bg&&(N.rect=j(N.rect,F.rect)),N),{isFullWork:!0,drawCanvas:L.Bg,viewId:this.viewId});D.rect&&(D.rect=D.rect&&J(D.rect),(G=pe.render)==null||G.push(D))}if(We.length){const D=We.reduce((N,F)=>(F.rect&&F.drawCanvas===L.Float&&(N.rect=j(N.rect,F.rect)),N),{isFullWork:!1,drawCanvas:L.Float,viewId:this.viewId});D.rect&&(D.rect=D.rect&&J(D.rect),(K=pe.render)==null||K.push(D))}de.size&&(pe.sp=[],de.forEach((D,N)=>{var F;(F=pe.sp)==null||F.push({type:m.Cursor,uid:N.split(ed)[0],op:D.op,workState:D.workState,viewId:this.viewId})})),(re=pe.render)!=null&&re.length&&this.post(pe)}runAnimation(){this.animationId||(this.animationId=requestAnimationFrame(this.animationDraw.bind(this)))}computNextAnimationIndex(e,t){var r;const s=Math.floor((e.animationWorkData||[]).slice(e.animationIndex).length*32/t/(((r=e.node)==null?void 0:r.syncUnitTime)||1e3))*t;return Math.min((e.animationIndex||0)+(s||t),(e.animationWorkData||[]).length)}runEffect(){this.runEffectId||(this.runEffectId=setTimeout(this.effectRunSelector.bind(this),0))}effectRunSelector(){this.runEffectId=void 0;let e=this.noAnimationRect;this.willRunEffectSelectorIds.forEach(t=>{var r,s;const i=this.selectorWorkShapes.get(t),n=i&&i.selectIds&&((r=i.node)==null?void 0:r.selectServiceNode(t,i,!0));e=j(e,n),(s=i==null?void 0:i.selectIds)!=null&&s.length||this.selectorWorkShapes.delete(t)}),e&&this.post({render:[{rect:J(e),drawCanvas:L.Bg,isClear:!0,clearCanvas:L.Bg,isFullWork:!0,viewId:this.viewId}]}),this.willRunEffectSelectorIds.clear(),this.noAnimationRect=void 0}activeSelectorShape(e){var t,r,s;const{workId:i,opt:n,toolsType:a,type:l,selectIds:c}=e;if(!i)return;const h=i.toString();if(!((t=this.selectorWorkShapes)!=null&&t.has(h))){let u={toolsType:a,selectIds:c,type:l,opt:n};a&&n&&(u=this.setNodeKey(u,a,n)),(r=this.selectorWorkShapes)==null||r.set(h,u)}const d=(s=this.selectorWorkShapes)==null?void 0:s.get(h);l&&(d.type=l),d.node&&d.node.getWorkId()!==h&&d.node.setWorkId(h),d.selectIds=c||[]}}class df extends co{constructor(e){super(e),Object.defineProperty(this,"animationWorkRects",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"combineDrawTimer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"animationId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"closeAnimationTime",{enumerable:!0,configurable:!0,writable:!0,value:1100}),Object.defineProperty(this,"runLaserPenStep",{enumerable:!0,configurable:!0,writable:!0,value:0})}async runFullWork(e,t){var r,s;const i=this.setFullWork(e),n=e.ops&&Ke(e.ops);if(i){let a;i.toolsType===k.Image?a=await i.consumeServiceAsync({isFullWork:!0,scene:(r=this.fullLayer.parent)==null?void 0:r.parent}):a=i.consumeService({op:n,isFullWork:!0,replaceId:(s=i.getWorkId())==null?void 0:s.toString(),isDrawLabel:t});const l=(e==null?void 0:e.updateNodeOpt)&&i.updataOptService(e.updateNodeOpt);return e.workId&&this.workShapes.delete(e.workId),l||a}}runSelectWork(e){var t;const r=this.setFullWork(e);r&&(t=e.selectIds)!=null&&t.length&&e.workId&&r.selectServiceNode(e.workId.toString(),{selectIds:e.selectIds},!1)}consumeDraw(e){var t;const{op:r,workId:s}=e;if(r!=null&&r.length&&s){const i=this.workShapes.get(s);if(!i)return;const n=i.toolsType,a=i.consume({data:e,isFullWork:!1,isClearAll:!0,isSubWorker:!0});switch(n){case k.LaserPen:a!=null&&a.rect&&((t=this.animationWorkRects)==null||t.set(s,{res:a,canDel:!1,isRect:!0})),this.runLaserPenAnimation();break;case k.Arrow:case k.Straight:case k.Ellipse:case k.Rectangle:case k.Star:case k.Polygon:case k.SpeechBalloon:a&&(this.drawCount++,this.drawArrow(a));break;case k.Pencil:a&&(this.drawCount++,this.drawPencil(a));break}}}consumeDrawAll(e){var t,r;const{workId:s}=e;if(s){const i=this.workShapes.get(s);if(!i)return;switch(i.toolsType){case k.LaserPen:if(this.animationId){const n=i.consumeAll({data:e});n!=null&&n.op&&n!=null&&n.rect&&((t=this.animationWorkRects)==null||t.set(s,{res:n,canDel:!1,isRect:!0}),this.runLaserPenAnimation(n));const a=(r=i.getWorkOptions())==null?void 0:r.duration;this.closeAnimationTime=a?a*1e3+100:this.closeAnimationTime,setTimeout(()=>{var l;this.fullLayer.getElementsByName(s.toString()).map(h=>h.remove()),this.clearWorkShapeNodeCache(s);const c=(l=this.animationWorkRects)==null?void 0:l.get(s);c&&(c.canDel=!0),setTimeout(()=>{this._post({sp:[{removeIds:[s.toString()],type:m.RemoveNode}]})},i.getWorkOptions().syncUnitTime||this.closeAnimationTime)},this.closeAnimationTime)}break;case k.Arrow:case k.Straight:case k.Ellipse:case k.Pencil:case k.Rectangle:case k.Star:case k.Polygon:case k.SpeechBalloon:this.drawCount=0,this.fullLayer.removeAllChildren(),this.clearWorkShapeNodeCache(s);break}}}updateLabels(e,t){e.children.forEach(r=>{if(r.tagName==="LABEL"){const s=r.name,{width:i}=r.getBoundingClientRect(),[n]=e.worldScaling,{underline:a,lineThrough:l}=t.opt;a&&e.getElementsByName(`${s}_underline`)[0].attr({points:[0,0,i/n,0]}),l&&e.getElementsByName(`${s}_lineThrough`)[0].attr({points:[0,0,i/n,0]})}})}runLaserPenAnimation(e){this.animationId||(this.animationId=requestAnimationFrame(()=>{var t,r;if(this.animationId=void 0,this.runLaserPenStep++,this.runLaserPenStep>1){this.runLaserPenStep=0,this.runLaserPenAnimation(e);return}let s;const i=[];(t=this.animationWorkRects)==null||t.forEach((n,a,l)=>{n.isRect&&(s=j(s,n.res.rect)),n.res.workId&&i.push(n.res),this.fullLayer.getElementsByName(a.toString()).length?n.isRect=!0:n.isRect=!1,n.canDel&&l.delete(a)}),(r=this.animationWorkRects)!=null&&r.size&&this.runLaserPenAnimation(),s&&(e&&i.push(e),this._post({render:[{rect:J(s),drawCanvas:L.Float,isClear:!0,clearCanvas:L.Float,isFullWork:!1,viewId:this.viewId}],sp:i}))}))}drawPencil(e){this._post({drawCount:this.drawCount,render:[{rect:e==null?void 0:e.rect,drawCanvas:L.Float,isClear:!1,isFullWork:!1,viewId:this.viewId}],sp:(e==null?void 0:e.op)&&[e]})}drawArrow(e){this._post({drawCount:this.drawCount,render:[{rect:(e==null?void 0:e.rect)&&J(e.rect),drawCanvas:L.Float,isClear:!0,clearCanvas:L.Float,isFullWork:!1,viewId:this.viewId}]})}}var De;(function(o){o.Full="full",o.Sub="sub"})(De||(De={}));class pf{constructor(e,t){Object.defineProperty(this,"_self",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workThreadMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),this._self=e,this.type=t,this.register()}init(e){const{viewId:t,dpr:r,offscreenCanvasOpt:s,layerOpt:i,isSafari:n}=e;if(!r||!s||!i)return;let a;this.type===De.Full&&(a=new ff(t,{dpr:r,offscreenCanvasOpt:s,layerOpt:i},this.post.bind(this))),this.type===De.Sub&&(a=new yf(t,{dpr:r,offscreenCanvasOpt:s,layerOpt:i},this.post.bind(this))),a&&n&&a.setIsSafari(n),a&&e.cameraOpt&&a.setCameraOpt(e.cameraOpt),a&&this.workThreadMap.set(t,a)}register(){onmessage=e=>{const t=e.data;if(t)for(const r of t.values()){const{msgType:s,viewId:i,tasksqueue:n,mainTasksqueueCount:a}=r;if(s===m.Init){this.init(r);continue}if(s===m.TasksQueue&&n!=null&&n.size&&a){this.workThreadMap.forEach((c,h)=>{const d=n.get(h);d&&c.on(d),this.post({workerTasksqueueCount:a})});continue}if(i===rd){this.workThreadMap.forEach(c=>{c.on(r),s===m.Destroy&&this.workThreadMap.delete(i)});continue}const l=this.workThreadMap.get(i);l&&(l.on(r),s===m.Destroy&&this.workThreadMap.delete(i))}}}post(e,t){t?this._self.postMessage(e,t):this._self.postMessage(e)}}class ff extends lo{constructor(e,t,r){super(e,t),Object.defineProperty(this,"drawLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"snapshotFullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"methodBuilder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serviceWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_post",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._post=r,this.drawLayer=this.createLayer("drawLayer",this.scene,{...t.layerOpt,bufferSize:1e3});const s={thread:this,viewId:this.viewId,vNodes:this.vNodes,fullLayer:this.fullLayer,drawLayer:this.drawLayer,post:this.post.bind(this)};this.localWork=new hf(s),this.serviceWork=new uf(s),this.methodBuilder=new xp([z.CopyNode,z.SetColorNode,z.DeleteNode,z.RotateNode,z.ScaleNode,z.TranslateNode,z.ZIndexActive,z.ZIndexNode,z.SetFontStyle,z.SetPoint,z.SetLock,z.SetShapeOpt]).registerForWorker(this.localWork,this.serviceWork,this.scene),this.vNodes.init(this.fullLayer,this.drawLayer)}async post(e,t){var r,s,i;const n=e.render,a=[];let l=t;if(n!=null&&n.length){for(const h of n){if(h.isClearAll&&(h.rect=this.getSceneRect(),h.isClear=!0,delete h.isClearAll),h.isDrawAll&&(h.rect=this.getSceneRect(),delete h.isDrawAll),h.drawCanvas){const d=h.isFullWork?this.fullLayer:this.drawLayer;(d==null?void 0:d.parent).render()}if(h.rect){h.clearCanvas===h.drawCanvas&&h.drawCanvas===L.Bg&&(h.rect=this.checkRightRectBoundingBox(h.rect));const d=h.drawCanvas===L.Selector&&h.rect;if(h.rect=this.safariFixRect(te(h.rect)),!h.rect)continue;if(h.drawCanvas===L.Selector){const u=(r=e.sp)==null?void 0:r.find(p=>p.type===m.Select);u&&(u.rect=h.rect),d&&(h.offset={x:h.rect.x-d.x,y:h.rect.y-d.y})}if(h.drawCanvas){const u=await this.getRectImageBitmap(h.rect,!!h.isFullWork);h.imageBitmap=u,l||(l=[]),l.push(u)}a.push(h)}}e.render=a}const c=(s=e.sp)==null?void 0:s.filter(h=>h.type!==m.None||Object.keys(h).filter(d=>d==="type").length);if(c!=null&&c.length&&(e.sp=c.map(h=>({...h,viewId:this.viewId}))),(e.drawCount||e.workerTasksqueueCount||(i=e.sp)!=null&&i.length||a!=null&&a.length)&&(this._post(e,l),l!=null&&l.length))for(const h of l)h instanceof ImageBitmap&&h.close()}on(e){if(this.methodBuilder.consumeForWorker(e))return;const{msgType:t,dataType:r,workId:s}=e;switch(t){case m.UpdateCamera:this.updateCamera(e);break;case m.Select:r===M.Service&&(s===U.selectorId?this.localWork.updateFullSelectWork(e):this.serviceWork.runSelectWork(e));break;case m.UpdateNode:case m.FullWork:this.consumeFull(r,e);break;case m.RemoveNode:this.removeNode(e);break;case m.GetTextActive:this.checkTextActive(e);break;case m.CursorHover:this.cursorHover(e)}super.on(e)}async removeNode(e){const{dataType:t,workId:r}=e;if(r===U.selectorId){this.localWork.blurSelector(e);return}t===M.Local&&(this.localWork.removeWork(e),this.localWork.colloctEffectSelectWork(e)),t===M.Service&&(this.serviceWork.removeWork(e),this.localWork.colloctEffectSelectWork(e))}checkTextActive(e){const{dataType:t}=e;t===M.Local&&this.localWork.checkTextActive(e)}clearAll(){this.vNodes.clear(),super.clearAll(),this.post({render:[{isClearAll:!0,clearCanvas:L.Bg,isFullWork:!0,viewId:this.viewId},{isClearAll:!0,clearCanvas:L.Float,isFullWork:!1,viewId:this.viewId}],sp:[{type:m.Clear}]})}setCameraOpt(e){this.cameraOpt=e;const{scale:t,centerX:r,centerY:s,width:i,height:n}=e;(i!==this.scene.width||n!==this.scene.height)&&this.updateScene({width:i,height:n}),this.fullLayer&&(this.fullLayer.setAttribute("scale",[t,t]),this.fullLayer.setAttribute("translate",[-r,-s])),this.drawLayer&&(this.drawLayer.setAttribute("scale",[t,t]),this.drawLayer.setAttribute("translate",[-r,-s]))}getOffscreen(e){return(e?this.fullLayer.parent:this.drawLayer.parent).canvas}async consumeFull(e,t){const r=await this.localWork.colloctEffectSelectWork(t);r&&e===M.Local&&await this.localWork.consumeFull(r,this.scene),r&&e===M.Service&&this.serviceWork.consumeFull(r)}consumeDraw(e,t){e===M.Local&&this.localWork.consumeDraw(t,this.serviceWork),e===M.Service&&this.serviceWork.consumeDraw(t)}consumeDrawAll(e,t){e===M.Local&&this.localWork.consumeDrawAll(t,this.serviceWork)}updateCamera(e){var t;const r=[],{cameraOpt:s}=e;if(s&&(this.setCameraOpt(s),this.localWork.workShapes.forEach((i,n)=>{(i.toolsType===k.Pencil||i.toolsType===k.Arrow||i.toolsType===k.Straight||i.toolsType===k.Ellipse||i.toolsType===k.Rectangle||i.toolsType===k.Star||i.toolsType===k.Polygon||i.toolsType===k.SpeechBalloon||i.toolsType===k.Text)&&this.localWork.workShapeState.set(n,{willClear:!0})}),this.vNodes.curNodeMap.size)){if(this.vNodes.updateNodesRect(),this.localWork.reRenderSelector(),this.serviceWork.selectorWorkShapes.size)for(const[a,l]of this.serviceWork.selectorWorkShapes.entries())this.serviceWork.runSelectWork({workId:a,selectIds:l.selectIds,msgType:m.Select,dataType:M.Service,viewId:this.viewId});let i;const n=this.localWork.getWorkShape(ot);if(n&&(t=n.selectIds)!=null&&t.length&&(i=n.oldSelectRect,n.cursorBlur()),this.vNodes.hasRenderNodes()){r.push({isClearAll:!0,clearCanvas:L.Bg,isFullWork:!0,viewId:this.viewId},{isClearAll:!0,clearCanvas:L.Float,isFullWork:!1,viewId:this.viewId});for(const a of this.vNodes.curNodeMap.values())jr(a.toolsType)&&(i=j(i,a.rect));i&&r.push({rect:J(i,20),drawCanvas:L.Bg,isClear:!1,isFullWork:!0,viewId:this.viewId})}r.length&&this.post({render:r})}}getRectImageBitmap(e,t){const r=e.x*this.dpr,s=e.y*this.dpr,i=e.w*this.dpr,n=e.h*this.dpr;return createImageBitmap(this.getOffscreen(t),r,s,i,n)}safariFixRect(e){if(e.w+e.x<=0||e.h+e.y<=0||e.w<=0||e.h<=0)return;const t={x:0,y:0,w:Math.floor(this.scene.width),h:Math.floor(this.scene.height)};if(e.x<0?e.w+e.x<this.scene.width&&(t.w=e.w+e.x):e.w+e.x>0&&(t.x=e.x,t.w=Math.floor(this.scene.width-e.x)),e.y<0?e.h+e.y<this.scene.height&&(t.h=e.h+e.y):e.h+e.y>0&&(t.y=e.y,t.h=Math.floor(this.scene.height-e.y)),!(t.w<=0||t.h<=0))return t}getSceneRect(){const{width:e,height:t}=this.scene;return{x:0,y:0,w:Math.floor(e),h:Math.floor(t)}}checkRightRectBoundingBox(e){return this.vNodes.combineIntersectRect(e)}cursorHover(e){this.localWork.cursorHover(e)}}class yf extends lo{constructor(e,t,r){super(e,t),Object.defineProperty(this,"_post",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drawLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"snapshotFullLayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serviceWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localWork",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._post=r;const s={thread:this,viewId:this.viewId,vNodes:this.vNodes,fullLayer:this.fullLayer,drawLayer:this.drawLayer,post:this.post.bind(this)};this.localWork=new df(s),this.vNodes.init(this.fullLayer,this.drawLayer)}async post(e,t){var r,s;const i=e.render,n=[];let a=t;if(i!=null&&i.length){for(const c of i)if(c.drawCanvas&&this.fullLayer.parent.render(),c.rect){if(c.rect=this.safariFixRect(te(c.rect)),!c.rect)continue;if(c.drawCanvas){const h=await this.getRectImageBitmap(c.rect,!!c.isFullWork);c.imageBitmap=h,a||(a=[]),a.push(h)}n.push(c)}e.render=n}const l=(r=e.sp)==null?void 0:r.filter(c=>c.type!==m.None||Object.keys(c).filter(h=>h==="type").length);if(l!=null&&l.length&&(e.sp=l.map(c=>({...c,viewId:this.viewId}))),((s=e.sp)!=null&&s.length||e.drawCount||n!=null&&n.length)&&(this._post(e,a),a!=null&&a.length))for(const c of a)c instanceof ImageBitmap&&c.close()}on(e){const{msgType:t}=e;switch(t){case m.UpdateCamera:this.updateCamera(e);break;case m.Snapshot:this.snapshotFullLayer=this.createLayer("snapshotFullLayer",this.scene,{...this.opt.layerOpt,bufferSize:this.viewId==="mainView"?6e3:3e3}),this.snapshotFullLayer&&this.getSnapshot(e).then(()=>{this.snapshotFullLayer=void 0});break;case m.BoundingBox:this.snapshotFullLayer=this.createLayer("snapshotFullLayer",this.scene,{...this.opt.layerOpt,bufferSize:this.viewId==="mainView"?6e3:3e3}),this.snapshotFullLayer&&this.getBoundingRect(e).then(()=>{this.snapshotFullLayer=void 0});break}super.on(e)}getOffscreen(e){var t;return(t=(e&&this.snapshotFullLayer||this.fullLayer).parent)==null?void 0:t.canvas}consumeDraw(e,t){e===M.Local&&this.localWork.consumeDraw(t)}consumeDrawAll(e,t){this.localWork.consumeDrawAll(t)}getRectImageBitmap(e,t=!1,r){const s=e.x*this.dpr,i=e.y*this.dpr,n=e.w*this.dpr,a=e.h*this.dpr;return createImageBitmap(this.getOffscreen(t),s,i,n,a,r)}safariFixRect(e){if(e.w+e.x<=0||e.h+e.y<=0||e.w<=0||e.h<=0)return;const t={x:0,y:0,w:Math.floor(this.scene.width),h:Math.floor(this.scene.height)};if(e.x<0?e.w+e.x<this.scene.width&&(t.w=e.w+e.x):e.w+e.x>0&&(t.x=e.x,t.w=Math.floor(this.scene.width-e.x)),e.y<0?e.h+e.y<this.scene.height&&(t.h=e.h+e.y):e.h+e.y>0&&(t.y=e.y,t.h=Math.floor(this.scene.height-e.y)),!(t.w<=0||t.h<=0))return t}updateCamera(e){const{cameraOpt:t}=e;t&&this.setCameraOpt(t)}setCameraOpt(e,t){this.cameraOpt=e;const{scale:r,centerX:s,centerY:i,width:n,height:a}=e;(n!==this.scene.width||a!==this.scene.height)&&this.updateScene({width:n,height:a}),t?(t.setAttribute("scale",[r,r]),t.setAttribute("translate",[-s,-i])):(this.fullLayer.setAttribute("scale",[r,r]),this.fullLayer.setAttribute("translate",[-s,-i]))}async getSnapshot(e){const{scenePath:t,scenes:r,cameraOpt:s,w:i,h:n,maxZIndex:a}=e;if(t&&r&&s&&this.snapshotFullLayer){const l=te(this.cameraOpt);this.setCameraOpt(s,this.snapshotFullLayer),this.localWork.fullLayer=this.snapshotFullLayer,this.localWork.drawLayer=this.fullLayer;let c;const h=new Map;for(const[u,p]of Object.entries(r))if(p!=null&&p.type)switch(p==null?void 0:p.type){case m.UpdateNode:case m.FullWork:{const{toolsType:w,opt:y}=p;w===k.Text&&y&&(y.zIndex=y.zIndex+(a||0),(y.lineThrough||y.underline)&&h.set(u,p));const v=await this.localWork.runFullWork({...p,opt:y,workId:u,msgType:m.FullWork,dataType:M.Service,viewId:this.viewId},w===k.Text);c=j(c,v);break}}this.localWork.fullLayer=this.fullLayer,this.localWork.drawLayer=void 0;let d;i&&n&&(d={resizeWidth:i,resizeHeight:n}),h.size&&(await new Promise(u=>{setTimeout(u,500)}),this.willRenderSpecialLabel(h)),await this.getSnapshotRender({scenePath:t,curCameraOpt:l,options:d})}}willRenderSpecialLabel(e){var t;for(const[r,s]of e.entries()){const i=(t=this.snapshotFullLayer)==null?void 0:t.getElementsByName(r)[0];i&&s.opt&&this.localWork.updateLabels(i,s)}}async getSnapshotRender(e){var t,r;const{scenePath:s,curCameraOpt:i,options:n}=e;((t=this.snapshotFullLayer)==null?void 0:t.parent).render();const a=await this.getRectImageBitmap({x:0,y:0,w:this.scene.width,h:this.scene.height},!0,n);a&&(await this.post({sp:[{type:m.Snapshot,scenePath:s,imageBitmap:a}]},[a]),a.close(),(r=this.snapshotFullLayer)==null||r.removeAllChildren(),this.setCameraOpt(i,this.fullLayer))}async getBoundingRect(e){const{scenePath:t,scenes:r,cameraOpt:s}=e;if(t&&r&&s&&this.snapshotFullLayer){const i=te(this.cameraOpt);this.setCameraOpt(s,this.snapshotFullLayer),this.localWork.fullLayer=this.snapshotFullLayer,this.localWork.drawLayer=this.drawLayer;let n;for(const[a,l]of Object.entries(r))if(l!=null&&l.type)switch(l==null?void 0:l.type){case m.UpdateNode:case m.FullWork:{const c=await this.localWork.runFullWork({...l,workId:a,msgType:m.FullWork,dataType:M.Service,viewId:this.viewId});n=j(n,c);break}}n&&await this.post({sp:[{type:m.BoundingBox,scenePath:t,rect:n}]}),this.localWork.fullLayer=this.fullLayer,this.localWork.drawLayer=void 0,this.snapshotFullLayer.removeAllChildren(),this.setCameraOpt(i,this.fullLayer)}}}const wf=self;new pf(wf,De.Sub)}(spritejs)})();
