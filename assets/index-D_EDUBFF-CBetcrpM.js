import{A as w,d as Ft,z as ve,o as Ot,G as ht,w as ut,D as E,J as R,P as B,j as D,l as ct,m as T,e as Rt,t as Ut,X as Wt,T as $t,_ as Jt,a as H,W as pt,Q as z,R as q,b as Te,$ as ft,H as xt,c as Pe,f as Z,g as Ie,Z as Mt,F as Le,V as Qt,B as Ne,x as $,M as A,h as x,i as g,k as nt,n as U,p as We,q as Xt,r as it,s as be,u as _t,v as Re,y as Ce,C as Oe,E as te,I as Dt,K as at,L as lt,N as xe,O as Me,S as De,U as Ae,Y as Ee,a0 as ze,a1 as Be,a2 as Fe}from"./index-KRhDfh35.js";var Ue=Object.defineProperty,$e=(I,t,e)=>t in I?Ue(I,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):I[t]=e,u=(I,t,e)=>$e(I,typeof t!="symbol"?t+"":t,e),Xe=te,Ye=Dt,Ge="[object Number]";function He(I){return typeof I=="number"||Ye(I)&&Xe(I)==Ge}var je=He;const K=Ot(je),ee=class j{constructor(t){u(this,"syncUnitTime",ht.syncOpt.interval),u(this,"vNodes"),u(this,"drawLayer"),u(this,"fullLayer"),u(this,"workId");const{vNodes:e,fullLayer:s,drawLayer:o,workId:i,toolsOpt:r}=t;this.vNodes=e,this.fullLayer=s,this.drawLayer=o,this.workId=i,this.syncUnitTime=r.syncUnitTime||this.syncUnitTime}get baseConsumeResult(){return{workId:this.workId,toolsType:this.toolsType,opt:this.workOptions}}filterSamePoints(t,e=.01){return t.reduce((s,o)=>{const i=s[s.length-1];return(o&&!i||o&&i&&!o.isNear(i,e))&&s.push(o),s},[])}setWorkId(t){this.workId=t}getWorkId(){return this.workId}getWorkOptions(){return this.workOptions}setWorkOptions(t){var e,s,o;this.workOptions=t,this.syncUnitTime=t.syncUnitTime||this.syncUnitTime;const i=(e=this.workId)==null?void 0:e.toString(),r=i&&((s=this.vNodes)==null?void 0:s.get(i))||void 0;i&&r&&(r.opt=t,(o=this.vNodes)==null||o.setInfo(i,r))}updataOptService(t){var e,s;let o;const i=(e=this.workId)==null?void 0:e.toString();if(i&&t){const r=this.fullLayer.getElementsByName(i)||this.drawLayer&&this.drawLayer.getElementsByName(i)||[];if(r.length!==1)return;const n=r[0],{pos:l,zIndex:a,scale:c,angle:h,translate:p}=t,d={};K(a)&&(d.zIndex=a),l&&(d.pos=[l[0],l[1]]),c&&(d.scale=c),h&&(d.rotate=h),p&&(d.translate=p),n.attr(d);const y=n==null?void 0:n.getBoundingClientRect();return y&&(o=z(o,{x:Math.floor(y.x-j.SafeBorderPadding),y:Math.floor(y.y-j.SafeBorderPadding),w:Math.floor(y.width+j.SafeBorderPadding*2),h:Math.floor(y.height+j.SafeBorderPadding*2)})),(s=this.vNodes)==null||s.setInfo(i,{rect:o,centerPos:l}),o}}replace(t,e,s){var o;const i=t.getElementsByName(e),r=i.length;if(r){if(r>1)for(let n=1;n<i.length;n++)t.removeChild(i[n]),i[n].disconnect();s?t.replaceChild(s,i[0]):t.removeChild(i[0]),i[0].disconnect()}else s&&t.append(s);this.fullLayer===t?(o=this.drawLayer)==null||o.getElementsByName(e).forEach(n=>{var l;(l=this.drawLayer)==null||l.removeChild(n),n.disconnect()}):this.fullLayer.getElementsByName(e).forEach(n=>{this.fullLayer.removeChild(n),n.disconnect()})}static updateNodeOpt(t){var e;const{node:s,opt:o,vNodes:i,willSerializeData:r,targetNode:n}=t,{zIndex:l,translate:a,angle:c,originPoint:h,scenePoint:p,scale:d,pointMap:y,thickness:m}=o;let S;const k=n&&q(n)||i.get(s.name);if(!k)return;K(l)&&(s.setAttribute("zIndex",l),k.opt.zIndex=l);const N=s.parent;if(N){if(h&&d&&n){const v=[k.op[0],k.op[1]];Mt(k.op,p,d,a);const f=[k.op[0],k.op[1]],P=[f[0]-v[0],f[1]-v[1]];k.centerPos=[k.centerPos[0]+P[0],k.centerPos[1]+P[1]],k.opt.translate=void 0,k.opt.scale=void 0}else if(a)if(s.setAttribute("translate",a),k.opt.translate=a,n){const v=[a[0]*N.worldScaling[0],a[1]*N.worldScaling[1]];S=Le(k.rect,v),k.rect=S}else{const v=j.getRectFromLayer(N,s.name);k.rect=v||k.rect}else if(K(c))if(s.setAttribute("rotate",c),k.opt.rotate=c,n)S=Qt(k.rect,c),k.rect=S;else{const v=j.getRectFromLayer(N,s.name);k.rect=v||k.rect}if(y){const v=y.get(s.name);if(v)for(let f=0,P=0;f<k.op.length;f+=3,P++)k.op[f]=v[P][0],k.op[f+1]=v[P][1]}if(m&&(e=k==null?void 0:k.opt)!=null&&e.thickness&&(k.opt.thickness=m),r&&!(h&&d&&n)){if(a){const v=k.op.map((f,P)=>{const O=P%3;return O===0?f+a[0]:O===1?f+a[1]:f});k.op=v,k.centerPos=[k.centerPos[0]+a[0],k.centerPos[1]+a[1]],k!=null&&k.opt&&(k.opt.translate=void 0)}else if(K(c)){const v=k.op;Ne(v,k.centerPos,c),k.op=v,k!=null&&k.opt&&(k.opt.rotate=void 0)}}k&&i.setInfo(s.name,k)}}static getCenterPos(t,e){const{worldPosition:s,worldScaling:o}=e;return[(t.x+t.w/2-s[0])/o[0],(t.y+t.h/2-s[1])/o[1]]}static getRectFromLayer(t,e){const s=t.getElementsByName(e)[0];if(s){const o=s.getBoundingClientRect();return{x:Math.floor(o.x-j.SafeBorderPadding),y:Math.floor(o.y-j.SafeBorderPadding),w:Math.floor(o.width+j.SafeBorderPadding*2),h:Math.floor(o.height+j.SafeBorderPadding*2)}}}};u(ee,"SafeBorderPadding",10);let L=ee;function rt(I,t=!0){const e=I.length;if(e<2)return"";let s=I[0],o=I[1];if(e===2)return`M${at(s)}L${at(o)}`;let i="";for(let r=2,n=e-1;r<n;r++)s=I[r],o=I[r+1],i+=lt(s,o);return t?`M${lt(I[0],I[1])}Q${at(I[1])}${lt(I[1],I[2])}T${i}${lt(I[e-1],I[0])}${lt(I[0],I[1])}Z`:`M${at(I[0])}Q${at(I[1])}${lt(I[1],I[2])}${I.length>3?"T":""}${i}L${at(I[e-1])}`}class se extends L{constructor(t){super(t),u(this,"canRotate",!0),u(this,"scaleType",$.all),u(this,"toolsType",T.Pencil),u(this,"syncTimestamp"),u(this,"syncIndex",0),u(this,"tmpPoints",[]),u(this,"MAX_REPEAR",10),u(this,"uniThickness"),u(this,"workOptions"),u(this,"centerPos",[0,0]),this.workOptions=t.toolsOpt,this.uniThickness=this.MAX_REPEAR/this.workOptions.thickness/10,this.syncTimestamp=0}combineConsume(){var t;const e=(t=this.workId)==null?void 0:t.toString();if(this.tmpPoints.length<2)return{type:w.None};const s=this.transformDataAll(!0),o={name:e};let i;const r=this.drawLayer||this.fullLayer;return s.length&&(i=this.draw({attrs:o,tasks:s,replaceId:e,layer:r})),{rect:i,type:w.DrawWork,dataType:R.Local}}setWorkOptions(t){super.setWorkOptions(t),this.syncTimestamp=Date.now()}consume(t){const{data:e,isFullWork:s,isSubWorker:o,isMainThread:i,drawCount:r,replaceId:n}=t,{workId:l}=e,{tasks:a,effects:c,consumeIndex:h}=this.transformData(e,!1);this.syncIndex=Math.min(this.syncIndex,h,Math.max(0,this.tmpPoints.length-2));const p={name:l,id:r==null?void 0:r.toString()};let d,y=!1;const m=this.syncIndex;if(this.syncTimestamp===0&&(this.syncTimestamp=Date.now()),a.length&&(a[0].taskId-this.syncTimestamp>this.syncUnitTime&&(y=!0,this.syncTimestamp=a[0].taskId,this.syncIndex=this.tmpPoints.length),o||i)){const k=s?this.fullLayer:this.drawLayer||this.fullLayer;d=this.draw({attrs:p,tasks:a,effects:c,layer:k,replaceId:n})}if(o)return h>10&&this.tmpPoints.splice(0,h-10),{rect:d,type:w.DrawWork,dataType:R.Local};const S=[];return this.tmpPoints.slice(m).forEach(k=>{S.push(k.x,k.y,this.computRadius(k.z,this.workOptions.thickness))}),{...this.baseConsumeResult,type:w.DrawWork,dataType:R.Local,rect:d,op:y?S:void 0,index:y?m*3:void 0,updateNodeOpt:{useAnimation:!0}}}consumeAll(t){var e;const s=this.workId;if(t.data){const{op:c,workState:h}=t.data;c!=null&&c.length&&h===D.Done&&this.workOptions.strokeType===A.Stroke&&this.updateTempPointsWithPressureWhenDone(c)}const o=this.transformDataAll(!0),i={name:s};let r;const n=this.fullLayer;if(o.length&&(r=this.draw({attrs:i,tasks:o,replaceId:s,layer:n})),this.tmpPoints.length<2)return this.replace(n,s),{type:w.RemoveNode,removeIds:[s],rect:r};const l=[];this.tmpPoints.map(c=>{l.push(c.x,c.y,c.z)}),this.syncTimestamp=0,delete this.workOptions.syncUnitTime;const a=Z(l);return(e=this.vNodes)==null||e.setInfo(s,{rect:r,op:l,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:r&&L.getCenterPos(r,n)}),{...this.baseConsumeResult,rect:r,type:w.FullWork,dataType:R.Local,ops:a,updateNodeOpt:{pos:this.centerPos,useAnimation:!0}}}clearTmpPoints(){this.tmpPoints.length=0,this.syncTimestamp=0,this.syncIndex=0}consumeService(t){var e,s;const{op:o,isFullWork:i,replaceId:r}=t;this.tmpPoints.length=0;for(let h=0;h<o.length;h+=3){const p=new x(o[h],o[h+1],o[h+2]);if(this.tmpPoints.length>0){const d=this.tmpPoints[this.tmpPoints.length-1],y=g.Sub(p,d).uni();p.setv(y)}this.tmpPoints.push(p)}if(this.tmpPoints.length<2)return;const n=this.transformDataAll(!0),l=(e=this.workId)==null?void 0:e.toString(),a={name:l};let c;if(l&&n.length){const h=i?this.fullLayer:this.drawLayer||this.fullLayer;c=this.draw({attrs:a,tasks:n,replaceId:r,layer:h}),(s=this.vNodes)==null||s.setInfo(l,{rect:c,op:o,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:c&&L.getCenterPos(c,h)})}return c}transformDataAll(t=!0){const e=this.filterSamePoints(this.tmpPoints,this.workOptions.thickness);return this.getTaskPoints(e,t&&this.workOptions.thickness||void 0)}draw(t){const{attrs:e,tasks:s,replaceId:o,effects:i,layer:r}=t,{strokeColor:n,strokeType:l,thickness:a,zIndex:c,scale:h,rotate:p,translate:d}=this.workOptions;i!=null&&i.size&&(i.forEach(v=>{var f;(f=r.getElementById(v+""))==null||f.remove()}),i.clear());let y;const m=[],S=r.worldPosition,k=r.worldScaling;for(let v=0;v<s.length;v++){const{pos:f,points:P}=s[v],{ps:O,rect:b}=this.computDrawPoints(P);let W;const C=P.length===1;l===A.Stroke||C?W=rt(O,!0):W=rt(O,!1);const M={pos:f,d:W,fillColor:l===A.Stroke||C?n:void 0,lineDash:l===A.Dotted&&!C?[1,a*2]:l===A.LongDotted&&!C?[a,a*2]:void 0,strokeColor:n,lineCap:l===A.Stroke||C?void 0:"round",lineWidth:l===A.Stroke||C?0:a};y=z(y,{x:Math.floor((b.x+f[0])*k[0]+S[0]-L.SafeBorderPadding),y:Math.floor((b.y+f[1])*k[1]+S[1]-L.SafeBorderPadding),w:Math.floor(b.w*k[0]+2*L.SafeBorderPadding),h:Math.floor(b.h*k[1]+2*L.SafeBorderPadding)}),m.push(M)}h&&(e.scale=h),p&&(e.rotate=p),d&&(e.translate=d);const N=new H;if(y){this.centerPos=L.getCenterPos(y,r),N.attr({...e,normalize:!0,anchor:[.5,.5],bgcolor:l===A.Stroke?n:void 0,pos:this.centerPos,size:[(y.w-2*L.SafeBorderPadding)/k[0],(y.h-2*L.SafeBorderPadding)/k[1]],zIndex:c});const v=m.map(f=>(f.pos=[f.pos[0]-this.centerPos[0],f.pos[1]-this.centerPos[1]],new nt(f)));N.append(...v),l===A.Stroke&&N.seal(),this.replace(r,o||e.workId,N)}if(h||p||d){const v=N==null?void 0:N.getBoundingClientRect();if(v)return{x:Math.floor(v.x-L.SafeBorderPadding),y:Math.floor(v.y-L.SafeBorderPadding),w:Math.floor(v.width+L.SafeBorderPadding*2),h:Math.floor(v.height+L.SafeBorderPadding*2)}}return y}computDrawPoints(t){return this.workOptions.strokeType===A.Stroke||t.length===1?this.computStroke(t):this.computNomal(t)}computNomal(t){let e=this.workOptions.thickness;const s=t.map(o=>(e=Math.max(e,o.radius),o.point));return{ps:s,rect:U(s,e)}}computStroke(t){return t.length===1?this.computDotStroke(t[0]):this.computLineStroke(t)}computLineStroke(t){const e=[],s=[];for(let l=0;l<t.length;l++){const{point:a,radius:c}=t[l];let h=a.v;l===0&&t.length>1&&(h=t[l+1].point.v);const p=g.Per(h).mul(c);e.push(x.Sub(a,p)),s.push(x.Add(a,p))}const o=t[t.length-1],i=x.GetSemicircleStroke(o.point,e[e.length-1],-1,8),r=x.GetSemicircleStroke(t[0].point,s[0],-1,8),n=e.concat(i,s.reverse(),r);return{ps:n,rect:U(n)}}computDotStroke(t){const{point:e,radius:s}=t,o={x:e.x-s,y:e.y-s,w:s*2,h:s*2};return{ps:x.GetDotStroke(e,s,8),rect:o}}transformData(t,e){const{op:s,workState:o}=t;let i=this.tmpPoints.length-1,r=[];if(s!=null&&s.length&&o){const{strokeType:n,thickness:l}=this.workOptions,a=new Set;i=n===A.Stroke?this.updateTempPointsWithPressure(s,l,a):this.updateTempPoints(s,l,a);const c=e?this.tmpPoints:this.tmpPoints.slice(i);return r=this.getTaskPoints(c,l),{tasks:r,effects:a,consumeIndex:i}}return{tasks:r,consumeIndex:i}}computRadius(t,e){return t*.03*e+e*.5}getMinZ(t,e){return((e||Math.max(1,Math.floor(t*.3)))-t*.5)*100/t/3}getTaskPoints(t,e){var s;const o=[];if(t.length===0)return[];let i=0,r=t[0].x,n=t[0].y,l=[r,n],a=[],c=t[0].t;for(;i<t.length;){const h=t[i],p=h.x-r,d=h.y-n,y=h.z,m=e?this.computRadius(y,e):y;if(a.push({point:new x(p,d,y,t[i].v),radius:m}),i>0&&i<t.length-1){const S=t[i].getAngleByPoints(t[i-1],t[i+1]);if(S<90||S>270){const k=(s=a.pop())==null?void 0:s.point.clone();k&&o.push({taskId:c,pos:l,points:[...a,{point:k,radius:m}]}),r=t[i].x,n=t[i].y,l=[r,n];const N=h.x-r,v=h.y-n;a=[{point:new x(N,v,y),radius:m}],c=Date.now()}}i++}return o.push({taskId:c,pos:l,points:a}),o}updateTempPointsWithPressure(t,e,s){const o=Date.now(),i=this.tmpPoints.length;let r=i;for(let l=0;l<t.length;l+=2){r=Math.min(r,i);const a=this.tmpPoints.length,c=new x(t[l],t[l+1]);if(a===0){this.tmpPoints.push(c);continue}const h=a-1,p=this.tmpPoints[h],d=g.Sub(c,p).uni();if(c.isNear(p,e)){if(p.z<this.MAX_REPEAR){if(p.setz(Math.min(p.z+1,this.MAX_REPEAR)),r=Math.min(r,h),a>1){let S=a-1;for(;S>0;){const k=this.tmpPoints[S].distance(this.tmpPoints[S-1]),N=Math.max(this.tmpPoints[S].z-this.uniThickness*k,0);if(this.tmpPoints[S-1].z>=N)break;this.tmpPoints[S-1].setz(N),r=Math.min(r,S-1),S--}}}else r=1/0;continue}c.setv(d);const y=c.distance(p),m=Math.max(p.z-this.uniThickness*y,0);a>1&&g.Equals(d,p.v,.02)&&(m>0||p.z<=0)&&(s&&p.t&&s.add(p.t),this.tmpPoints.pop(),r=Math.min(h,r)),c.setz(m),this.tmpPoints.push(c)}if(r===1/0)return this.tmpPoints.length;let n=i;if(r===i){n=Math.max(n-1,0);const l=this.tmpPoints[n].t;l&&(s==null||s.add(l))}else{let l=i-1;for(n=r;l>=0;){const a=this.tmpPoints[l].t;if(a&&(s==null||s.add(a),l<=r)){n=l,l=-1;break}l--}}return this.tmpPoints[n].setT(o),n}updateTempPoints(t,e,s){var o;const i=Date.now(),r=this.tmpPoints.length;let n=r;for(let a=0;a<t.length;a+=2){const c=this.tmpPoints.length,h=new x(t[a],t[a+1]);if(c===0){this.tmpPoints.push(h);continue}const p=c-1,d=this.tmpPoints[p],y=g.Sub(h,d).uni();if(h.isNear(d,e/2)){n=Math.min(p,n);continue}g.Equals(y,d.v,.02)&&(s&&d.t&&s.add(d.t),this.tmpPoints.pop(),n=Math.min(p,n)),h.setv(y),this.tmpPoints.push(h)}let l=r;if(n===r){l=Math.max(l-1,0);const a=this.tmpPoints[l].t;a&&(s==null||s.add(a))}else{let a=Math.min(r-1,n);for(l=n;a>=0;){const c=(o=this.tmpPoints[a])==null?void 0:o.t;if(c&&(s==null||s.add(c),a<=n)){l=a,a=-1;break}a--}}return this.tmpPoints[l].setT(i),l}updateTempPointsWithPressureWhenDone(t){const{thickness:e}=this.workOptions,s=t.length,o=this.getMinZ(e);for(let i=0;i<s;i+=2){const r=this.tmpPoints.length,n=new x(t[i],t[i+1]);if(r===0){this.tmpPoints.push(n);continue}const l=r-1,a=this.tmpPoints[l],c=g.Sub(n,a).uni(),h=n.distance(a);if(r>1&&a.z===o)break;if(n.isNear(a,e/2)){if(s<3&&a.z<this.MAX_REPEAR&&(a.setz(Math.min(a.z+1,this.MAX_REPEAR)),r>1)){let d=r-1;for(;d>0;){const y=this.tmpPoints[d].distance(this.tmpPoints[d-1]),m=Math.max(this.tmpPoints[d].z-this.uniThickness*y,-e/4);if(this.tmpPoints[d-1].z>=m)break;this.tmpPoints[d-1].setz(m),d--}}continue}n.setv(c);const p=Math.max(a.z-this.uniThickness*h,o);r>1&&g.Equals(c,a.v,.02)&&a.z<=0&&this.tmpPoints.pop(),n.setz(p),this.tmpPoints.push(n)}}static updateNodeOpt(t){var e,s;const{node:o,opt:i,vNodes:r}=t,{strokeColor:n,strokeType:l}=i,a=r.get(o.name);return n&&(o.tagName==="GROUP"?fs(o)?o.setAttribute("bgcolor",n):o.children.forEach(c=>{c.setAttribute("strokeColor",n),c.getAttribute("fillColor")&&c.setAttribute("fillColor",n)}):(o.setAttribute("strokeColor",n),o.setAttribute("fillColor",n)),(e=a==null?void 0:a.opt)!=null&&e.strokeColor&&(a.opt.strokeColor=n)),l&&a!=null&&a.opt&&(s=a.opt)!=null&&s.strokeType&&(a.opt.strokeType=l),a&&r.setInfo(o.name,a),L.updateNodeOpt(t)}}class oe extends L{constructor(t){super(t),u(this,"toolsType",T.LaserPen),u(this,"canRotate",!1),u(this,"scaleType",$.none),u(this,"syncTimestamp"),u(this,"syncIndex",0),u(this,"tmpPoints",[]),u(this,"workOptions"),u(this,"consumeIndex",0),this.workOptions=t.toolsOpt,this.syncTimestamp=0}combineConsume(){}setWorkOptions(t){super.setWorkOptions(t),this.syncTimestamp=Date.now()}consume(t){const{data:e,isSubWorker:s}=t,{workId:o,op:i}=e;if((i==null?void 0:i.length)===0)return{type:w.None};if(this.updateTempPoints(i||[]),this.consumeIndex>this.tmpPoints.length-4)return{type:w.None};const{strokeColor:r,thickness:n,strokeType:l}=this.workOptions,a=U(this.tmpPoints,n);let c=!1;const h=this.syncIndex,p=this.tmpPoints.slice(this.consumeIndex);this.consumeIndex=this.tmpPoints.length-1,this.syncTimestamp===0&&(this.syncTimestamp=Date.now());const d={name:o==null?void 0:o.toString(),opacity:1,lineDash:l===A.Dotted?[1,n*2]:l===A.LongDotted?[n,n*2]:void 0,strokeColor:r,lineCap:"round",lineWidth:n,anchor:[.5,.5]},y=this.getTaskPoints(p);if(y.length){const S=Date.now();S-this.syncTimestamp>this.syncUnitTime&&(c=!0,this.syncTimestamp=S,this.syncIndex=this.tmpPoints.length),s&&this.draw({attrs:d,tasks:y,isDot:!1,layer:this.drawLayer||this.fullLayer})}const m=[];return this.tmpPoints.slice(h).forEach(S=>{m.push(S.x,S.y)}),{rect:{x:a.x*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],y:a.y*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1],w:a.w*this.fullLayer.worldScaling[0],h:a.h*this.fullLayer.worldScaling[1]},type:w.DrawWork,dataType:R.Local,op:c?m:void 0,index:c?h*2:void 0,...this.baseConsumeResult}}consumeAll(){var t;const e=(t=this.workId)==null?void 0:t.toString();let s;if(this.tmpPoints.length-1>this.consumeIndex){let r=this.tmpPoints.slice(this.consumeIndex);const n=r.length===1,{strokeColor:l,thickness:a,strokeType:c}=this.workOptions;if(n){const d=this.computDotStroke({point:r[0],radius:a/2});r=d.ps,s=d.rect}else s=U(this.tmpPoints,a);const h={name:e==null?void 0:e.toString(),fillColor:n?l:void 0,opacity:1,lineDash:c===A.Dotted&&!n?[1,a*2]:c===A.LongDotted&&!n?[a,a*2]:void 0,strokeColor:l,lineCap:n?void 0:"round",lineWidth:n?0:a,anchor:[.5,.5]},p=this.getTaskPoints(r);p.length&&this.draw({attrs:h,tasks:p,isDot:n,layer:this.drawLayer||this.fullLayer})}const o=[];this.tmpPoints.forEach(r=>{o.push(r.x,r.y)});const i=Z(o);return{rect:s&&{x:s.x*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],y:s.y*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1],w:s.w*this.fullLayer.worldScaling[0],h:s.h*this.fullLayer.worldScaling[1]},type:w.FullWork,dataType:R.Local,ops:i,index:this.syncIndex*2,...this.baseConsumeResult}}clearTmpPoints(){this.tmpPoints.length=0,this.syncTimestamp=0,this.syncIndex=0}consumeService(t){var e;const{op:s,replaceId:o,isFullWork:i}=t,{strokeColor:r,thickness:n,strokeType:l}=this.workOptions;if(!s.length){const m=U(this.tmpPoints,n);return{x:m.x*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],y:m.y*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1],w:m.w*this.fullLayer.worldScaling[0],h:m.h*this.fullLayer.worldScaling[1]}}const a=Math.max(0,this.tmpPoints.length-1);this.updateTempPoints(s||[]);let c,h=this.tmpPoints.slice(a);const p=h.length===1;if(p){const m=this.computDotStroke({point:h[0],radius:n/2});h=m.ps,c=m.rect}else c=U(this.tmpPoints,n);const d={name:(e=this.workId)==null?void 0:e.toString(),fillColor:p?r:void 0,opacity:1,lineDash:l===A.Dotted&&!p?[1,n*2]:l===A.LongDotted&&!p?[n,n*2]:void 0,strokeColor:r,lineCap:p?void 0:"round",lineWidth:p?0:n,anchor:[.5,.5]},y=this.getTaskPoints(h);if(y.length){const m=i?this.fullLayer:this.drawLayer||this.fullLayer;this.draw({attrs:d,tasks:y,isDot:p,replaceId:o,layer:m})}return{x:c.x*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],y:c.y*this.fullLayer.worldScaling[1]+this.fullLayer.worldPosition[1],w:c.w*this.fullLayer.worldScaling[0],h:c.h*this.fullLayer.worldScaling[1]}}computDotStroke(t){const{point:e,radius:s}=t,o={x:e.x-s,y:e.y-s,w:s*2,h:s*2};return{ps:x.GetDotStroke(e,s,8),rect:o}}updateTempPoints(t){const e=this.tmpPoints.length;for(let s=0;s<t.length;s+=2){if(e){const o=this.tmpPoints.slice(-1)[0];o&&o.x===t[s]&&o.y===t[s+1]&&this.tmpPoints.pop()}this.tmpPoints.push(new x(t[s],t[s+1]))}}async draw(t){const{attrs:e,tasks:s,isDot:o,layer:i}=t,{duration:r}=this.workOptions;for(const n of s){const l=new nt,{pos:a,points:c}=n;let h;o?h=rt(c,!0):h=rt(c,!1),l.attr({...e,pos:a,d:h});const{vertex:p,fragment:d}=this.workOptions;if(p&&d){const y=i.renderer.createProgram({vertex:p,fragment:d}),{width:m,height:S}=i.getResolution();l.setUniforms({u_time:0,u_resolution:[m,S]}),l.setProgram(y)}i.appendChild(l),l.transition(r).attr({scale:o?[.1,.1]:[1,1],lineWidth:o?0:1}).then(()=>{l.remove()})}}getTaskPoints(t){var e;const s=[];if(t.length===0)return[];let o=0,i=t[0].x,r=t[0].y,n=[i,r],l=[];for(;o<t.length;){const a=t[o],c=a.x-i,h=a.y-r;if(l.push(new x(c,h)),o>0&&o<t.length-1){const p=t[o].getAngleByPoints(t[o-1],t[o+1]);if(p<90||p>270){const d=(e=l.pop())==null?void 0:e.clone();d&&s.push({pos:n,points:[...l,d]}),i=t[o].x,r=t[o].y,n=[i,r];const y=a.x-i,m=a.y-r;l=[new x(y,m)]}}o++}return s.push({pos:n,points:l}),s}removeLocal(){}removeService(t){let e;const s=[];return this.fullLayer.getElementsByName(t).forEach(o=>{if(o.name===t){const i=o.getBoundingClientRect();e=z(e,{x:i.x,y:i.y,w:i.width,h:i.height}),s.push(o)}}),s.length&&s.forEach(o=>o.remove()),e}}const ie=class It extends L{constructor(t,e){super(t),u(this,"canRotate",!1),u(this,"scaleType",$.none),u(this,"toolsType",T.Eraser),u(this,"serviceWork"),u(this,"tmpPoints",[]),u(this,"workOptions"),u(this,"worldPosition"),u(this,"worldScaling"),u(this,"eraserRect"),u(this,"eraserPolyline"),this.serviceWork=e,this.workOptions=t.toolsOpt,this.worldPosition=this.fullLayer.worldPosition,this.worldScaling=this.fullLayer.worldScaling}combineConsume(){}consumeService(){}setWorkOptions(t){super.setWorkOptions(t)}createEraserRect(t){const e=t[0]*this.worldScaling[0]+this.worldPosition[0],s=t[1]*this.worldScaling[1]+this.worldPosition[1],{width:o,height:i}=It.eraserSizes[this.workOptions.thickness];this.eraserRect={x:e-o*.5,y:s-i*.5,w:o,h:i},this.eraserPolyline=[this.eraserRect.x,this.eraserRect.y,this.eraserRect.x+this.eraserRect.w,this.eraserRect.y+this.eraserRect.h]}computRectCenterPoints(){const t=this.tmpPoints.slice(-2);if(this.tmpPoints.length===4){const e=new g(this.tmpPoints[0],this.tmpPoints[1]),s=new g(this.tmpPoints[2],this.tmpPoints[3]),o=g.Sub(s,e).uni(),i=g.Dist(e,s),{width:r,height:n}=It.eraserSizes[this.workOptions.thickness],l=Math.min(r,n),a=Math.round(i/l);if(a>1){const c=[];for(let h=0;h<a;h++){const p=g.Mul(o,h*l);c.push(this.tmpPoints[0]+p.x,this.tmpPoints[1]+p.y)}return c.concat(t)}}return t}isNear(t,e){const s=new g(t[0],t[1]),o=new g(e[0],e[1]),{width:i,height:r}=It.eraserSizes[this.workOptions.thickness];return g.Dist(s,o)<Math.hypot(i,r)*.5}cutPolyline(t,e){let s=[e],o=0;for(;o<t.length;){const n=t[o];if(n.length<2)break;s=i(s,n),o++}return s;function i(n,l){const a=n;for(let c=0;c<n.length;c++){const h=n[c],p=h.findIndex((d,y)=>y<h.length-1?r([d,h[y+1]],[l[0],l[1]]):!1);if(p!==-1&&p>-1){const d=[],y=h.slice(0,p+1);if(g.Equals(h[p],l[0])||y.push(l[0].clone().setz(h[p].z)),y.length>1&&d.push(y),p+l.length-1<h.length-1){const m=p+l.length-1,S=h.slice(m),k=l[l.length-1];g.Equals(h[m],k)||S.unshift(k.clone().setz(h[m].z)),S.length>1&&d.push(S)}return a.splice(c,1,...d),a}}return a}function r(n,l){const a=g.Sub(n[1],n[0]),c=g.Sub(l[1],l[0]),h=g.Sub(l[0],n[0]);return Math.abs(g.Cpr(a,c))<.1&&Math.abs(g.Cpr(a,h))<.1}}isSamePoint(t,e){return t[0]===e[0]&&t[1]===e[1]}translateIntersect(t){const e=[];for(let s=0;s<t.length;s++){const o=t[s].filter((n,l,a)=>!(l>0&&this.isSamePoint(n,a[l-1]))),i=[];let r=0;for(;r<o.length;){const n=o[r],l=new g(n[0],n[1]);i.push(l),r++}e.push(i)}return e}isLineEraser(t,e){return!(t===T.Pencil&&!e)}remove(t){const{curNodeMap:e,removeIds:s,newWorkDatas:o}=t,{isLine:i}=this.workOptions;let r;for(const[n,l]of e.entries())if(l.rect&&this.eraserRect&&this.eraserPolyline&&ft(this.eraserRect,l.rect)){const{op:a,toolsType:c}=l,h=this.isLineEraser(c,i),p=[],d=[];for(let m=0;m<a.length;m+=3){const S=new g(a[m]*this.worldScaling[0]+this.worldPosition[0],a[m+1]*this.worldScaling[1]+this.worldPosition[1],a[m+2]);d.push(S),p.push(new x(S.x,S.y))}const y=p.length&&U(p)||l.rect;if(ft(y,this.eraserRect)){if(d.length>1){const m=We.polyline(d.map(S=>S.XY),this.eraserPolyline);if(m.length&&(s.add(l.name),!h)){const S=this.translateIntersect(m),k=this.cutPolyline(S,d);for(let N=0;N<k.length;N++){const v=`${n}_s_${N}`,f=[];k[N].forEach(P=>{f.push((P.x-this.worldPosition[0])/this.worldScaling[0],(P.y-this.worldPosition[1])/this.worldScaling[1],P.z)}),l.opt&&l.toolsType&&this.vNodes&&(this.vNodes.setInfo(v,{rect:y,op:f,opt:l.opt,canRotate:l.canRotate,scaleType:l.scaleType,toolsType:l.toolsType}),o.set(v,{workId:v,op:f,opt:l.opt,toolsType:l.toolsType}))}}}else s.add(l.name);r=z(r,y)}}return s.forEach(n=>{var l;return(l=this.vNodes)==null?void 0:l.delete(n)}),r&&(r.x-=L.SafeBorderPadding,r.y-=L.SafeBorderPadding,r.w+=L.SafeBorderPadding*2,r.h+=L.SafeBorderPadding*2),r}consume(t){const{op:e}=t.data;if(!e||e.length===0)return{type:w.None,...this.baseConsumeResult};const s=this.tmpPoints.length;if(s>1&&this.isNear([e[0],e[1]],[this.tmpPoints[s-2],this.tmpPoints[s-1]]))return{type:w.None,...this.baseConsumeResult};s===4&&(this.tmpPoints.shift(),this.tmpPoints.shift()),this.tmpPoints.push(e[0],e[1]);const o=this.computRectCenterPoints();let i;const r=new Set,n=new Map;if(!this.vNodes)return{type:w.None,...this.baseConsumeResult};this.vNodes.setTarget();const l=this.getUnLockNodeMap(this.vNodes.getLastTarget());for(let a=0;a<o.length-1;a+=2){this.createEraserRect(o.slice(a,a+2));const c=this.remove({curNodeMap:l,removeIds:r,newWorkDatas:n});i=z(i,c)}if(this.vNodes.deleteLastTarget(),i&&r.size){for(const a of n.keys())r.has(a)&&n.delete(a);return{type:w.RemoveNode,rect:i,removeIds:[...r],newWorkDatas:n}}return{type:w.None,...this.baseConsumeResult}}consumeAll(t){return this.consume(t)}clearTmpPoints(){this.tmpPoints.length=0}getUnLockNodeMap(t){var e;if(this.serviceWork){const s=q(t),o=this.serviceWork.selectorWorkShapes,i=this.serviceWork.workShapes;for(const r of o.values())if((e=r.selectIds)!=null&&e.length)for(const n of r.selectIds)s.delete(n);for(const r of i.keys())s.delete(r);return s}return t}};u(ie,"eraserSizes",Object.freeze([Object.freeze({width:18,height:26}),Object.freeze({width:26,height:34}),Object.freeze({width:34,height:50})]));let re=ie;var Yt=Fe,qe=1,Ve=Object.prototype,Ke=Ve.hasOwnProperty;function Ze(I,t,e,s,o,i){var r=e&qe,n=Yt(I),l=n.length,a=Yt(t),c=a.length;if(l!=c&&!r)return!1;for(var h=l;h--;){var p=n[h];if(!(r?p in t:Ke.call(t,p)))return!1}var d=i.get(I),y=i.get(t);if(d&&y)return d==t&&y==I;var m=!0;i.set(I,t),i.set(t,I);for(var S=r;++h<l;){p=n[h];var k=I[p],N=t[p];if(s)var v=r?s(N,k,p,t,I,i):s(k,N,p,I,t,i);if(!(v===void 0?k===N||o(k,N,e,s,i):v)){m=!1;break}S||(S=p=="constructor")}if(m&&!S){var f=I.constructor,P=t.constructor;f!=P&&"constructor"in I&&"constructor"in t&&!(typeof f=="function"&&f instanceof f&&typeof P=="function"&&P instanceof P)&&(m=!1)}return i.delete(I),i.delete(t),m}var Je=Ze,bt=xe,Qe=Me,_e=De,ts=Je,Gt=Ae,Ht=Be,jt=Ee,es=ze,ss=1,qt="[object Arguments]",Vt="[object Array]",Pt="[object Object]",os=Object.prototype,Kt=os.hasOwnProperty;function is(I,t,e,s,o,i){var r=Ht(I),n=Ht(t),l=r?Vt:Gt(I),a=n?Vt:Gt(t);l=l==qt?Pt:l,a=a==qt?Pt:a;var c=l==Pt,h=a==Pt,p=l==a;if(p&&jt(I)){if(!jt(t))return!1;r=!0,c=!1}if(p&&!c)return i||(i=new bt),r||es(I)?Qe(I,t,e,s,o,i):_e(I,t,l,e,s,o,i);if(!(e&ss)){var d=c&&Kt.call(I,"__wrapped__"),y=h&&Kt.call(t,"__wrapped__");if(d||y){var m=d?I.value():I,S=y?t.value():t;return i||(i=new bt),o(m,S,e,s,i)}}return p?(i||(i=new bt),ts(I,t,e,s,o,i)):!1}var rs=is,ns=rs,Zt=Dt;function ne(I,t,e,s,o){return I===t?!0:I==null||t==null||!Zt(I)&&!Zt(t)?I!==I&&t!==t:ns(I,t,e,s,ne,o)}var as=ne,ls=as;function cs(I,t){return ls(I,t)}var hs=cs;const yt=Ot(hs),ae=class le extends L{constructor(t){super(t),u(this,"toolsType",T.Selector),u(this,"tmpPoints",[]),u(this,"workOptions"),u(this,"vNodes"),u(this,"selectIds"),u(this,"selectorColor"),u(this,"strokeColor"),u(this,"fillColor"),u(this,"oldSelectRect"),u(this,"canRotate",!1),u(this,"canTextEdit",!1),u(this,"canLock",!1),u(this,"scaleType",$.all),u(this,"toolsTypes"),u(this,"shapeOpt"),u(this,"textOpt"),u(this,"isLocked"),u(this,"thickness"),u(this,"strokeType"),u(this,"useStroke"),this.workOptions=t.toolsOpt,this.vNodes=t.vNodes}computSelector(t=!0){const e=U(this.tmpPoints);if(e.w===0||e.h===0)return{selectIds:[],intersectRect:void 0,subNodeMap:new Map};const{rectRange:s,nodeRange:o}=this.vNodes.getRectIntersectRange(e,t);return{selectIds:[...o.keys()],intersectRect:s,subNodeMap:o}}updateTempPoints(t){const e=this.tmpPoints.length,s=t.length;if(s>1){const o=new x(t[s-2]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],t[s-1]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[1]);e===2?this.tmpPoints.splice(1,1,o):this.tmpPoints.push(o)}}drawSelector(t){const{drawRect:e,subNodeMap:s,selectorId:o,layer:i,isService:r}=t,n=new H({pos:[e.x,e.y],anchor:[0,0],size:[e.w,e.h],id:o,name:o,zIndex:9999}),l=[];if(r){const a=new Xt({normalize:!0,pos:[e.w/2,e.h/2],lineWidth:1,strokeColor:this.selectorColor||this.workOptions.strokeColor,width:e.w,height:e.h,name:le.selectorBorderId});l.push(a)}s.forEach((a,c)=>{const h=[a.rect.x+a.rect.w/2-e.x,a.rect.y+a.rect.h/2-e.y],p=new Xt({normalize:!0,pos:h,lineWidth:1,strokeColor:s.size>1?this.selectorColor||this.workOptions.strokeColor:void 0,width:a.rect.w,height:a.rect.h,id:`selector-${c}`,name:`selector-${c}`});l.push(p)}),l&&n.append(...l),(i==null?void 0:i.parent).appendChild(n)}draw(t,e,s,o=!1){var i,r;const{intersectRect:n,subNodeMap:l}=s;(r=(i=e.parent)==null?void 0:i.getElementById(t))==null||r.remove(),n&&this.drawSelector({drawRect:n,subNodeMap:l,selectorId:t,layer:e,isService:o})}getSelecteorInfo(t){this.scaleType=$.all,this.canRotate=!1,this.textOpt=void 0,this.strokeColor=void 0,this.fillColor=void 0,this.canTextEdit=!1,this.canLock=!1,this.isLocked=!1,this.toolsTypes=void 0,this.shapeOpt=void 0,this.thickness=void 0,this.strokeType=void 0,this.useStroke=!1;const e=new Set;let s,o=!0;for(const i of t.values()){const{opt:r,canRotate:n,scaleType:l,toolsType:a}=i;this.selectorColor=this.workOptions.strokeColor,r.strokeColor&&(this.strokeColor=r.strokeColor),r.fillColor&&(this.fillColor=r.fillColor),r.textOpt&&(this.textOpt=r.textOpt),r.thickness&&(this.thickness=r.thickness),a!==T.Pencil&&(o=!1),r.strokeType&&(this.strokeType=r.strokeType),a===T.SpeechBalloon&&(e.add(a),this.shapeOpt||(this.shapeOpt={}),this.shapeOpt.placement=r.placement),a===T.Polygon&&(e.add(a),this.shapeOpt||(this.shapeOpt={}),this.shapeOpt.vertices=r.vertices),a===T.Star&&(e.add(a),this.shapeOpt||(this.shapeOpt={}),this.shapeOpt.vertices=r.vertices,this.shapeOpt.innerRatio=r.innerRatio,this.shapeOpt.innerVerticeStep=r.innerVerticeStep),a===T.Text&&(this.textOpt=r),t.size===1&&(this.textOpt&&(this.canTextEdit=!0),this.canRotate=n,this.scaleType=l),l===$.none&&(this.scaleType=l),a===T.Image&&(s=i)}o&&(this.useStroke=!0),e.size&&(this.toolsTypes=[...e]),s&&(t.size===1?(this.canLock=!0,s.opt.locked&&(this.isLocked=!0,this.scaleType=$.none,this.canRotate=!1,this.textOpt=void 0,this.fillColor=void 0,this.selectorColor="rgb(177,177,177)",this.strokeColor=void 0,this.canTextEdit=!1,this.thickness=void 0,this.strokeType=void 0,this.useStroke=void 0)):t.size>1&&!s.opt.locked&&(this.canLock=!1,this.canRotate=!1))}getChildrenPoints(){var t,e;if(this.scaleType===$.both&&((t=this.selectIds)==null?void 0:t.length)===1){const s=this.selectIds[0],o=(e=this.vNodes.get(s))==null?void 0:e.op;if(o){const i=[];for(let r=0;r<o.length;r+=3)i.push([o[r],o[r+1]]);return i}}}consume(t){const{op:e,workState:s}=t.data;let o=this.oldSelectRect;if(s===D.Start&&(o=this.unSelectedAllIds()),!(e!=null&&e.length)||!this.vNodes.curNodeMap.size)return{type:w.None};this.updateTempPoints(e);const i=this.computSelector();if(this.selectIds&&yt(this.selectIds,i.selectIds))return{type:w.None};this.selectIds=i.selectIds;const r=i.intersectRect;this.getSelecteorInfo(i.subNodeMap),this.draw(B,this.fullLayer,i),this.oldSelectRect=r;const n=this.getChildrenPoints();return{type:w.Select,dataType:R.Local,rect:z(r,o),selectIds:i.selectIds,selectRect:r,selectorColor:this.selectorColor,strokeColor:this.strokeColor,fillColor:this.fillColor,textOpt:this.textOpt,canTextEdit:this.canTextEdit,canRotate:this.canRotate,canLock:this.canLock,scaleType:this.scaleType,willSyncService:!0,points:n,isLocked:this.isLocked,toolsTypes:this.toolsTypes,shapeOpt:this.shapeOpt,thickness:this.thickness,useStroke:this.useStroke,strokeType:this.strokeType,...this.baseConsumeResult}}consumeAll(){var t,e;let s=this.oldSelectRect;if(!((t=this.selectIds)!=null&&t.length)&&this.tmpPoints[0]&&this.selectSingleTool(this.tmpPoints[0].XY,B,!1),(e=this.selectIds)!=null&&e.length&&(s=this.selectedByIds(this.selectIds)),s){const o=this.getChildrenPoints();return{type:w.Select,dataType:R.Local,rect:this.oldSelectRect,selectIds:this.selectIds,selectorColor:this.selectorColor,selectRect:this.oldSelectRect,strokeColor:this.strokeColor,fillColor:this.fillColor,textOpt:this.textOpt,canTextEdit:this.canTextEdit,canRotate:this.canRotate,canLock:this.canLock,scaleType:this.scaleType,willSyncService:!0,points:o,isLocked:this.isLocked,toolsTypes:this.toolsTypes,shapeOpt:this.shapeOpt,thickness:this.thickness,useStroke:this.useStroke,strokeType:this.strokeType,...this.baseConsumeResult}}return{type:w.None}}consumeService(){}clearTmpPoints(){this.tmpPoints.length=0}clearSelectData(){this.selectIds=void 0,this.oldSelectRect=void 0}selectSingleTool(t,e=B,s=!1){if(t.length===2){const o=t[0],i=t[1];let r;const{nodeRange:n}=this.vNodes.getRectIntersectRange({x:o,y:i,w:0,h:0},!1),l=[...n.values()].sort((a,c)=>(c.opt.zIndex||0)-(a.opt.zIndex||0));for(const a of l){const c=this.fullLayer.getElementsByName(a.name);if(Se(c).find(h=>h.isPointCollision(o,i))){r=a;break}}if(r){const a=r.name;if(!yt(this.oldSelectRect,r.rect)){const c=new Map([[a,r]]);this.getSelecteorInfo(c),this.draw(e,this.fullLayer,{intersectRect:r.rect,subNodeMap:c,selectIds:this.selectIds||[]},s)}this.selectIds=[a],this.oldSelectRect=r.rect}}}unSelectedAllIds(){let t;for(const[e,s]of this.vNodes.curNodeMap.entries())s.isSelected&&(t=z(t,s.rect),this.vNodes.unSelected(e));return t}unSelectedByIds(t){let e;for(const s of t){const o=this.vNodes.get(s);o&&o.isSelected&&(e=z(e,o.rect),this.vNodes.unSelected(s))}return e}selectedByIds(t){let e;for(const s of t){const o=this.vNodes.get(s);o&&(e=z(e,o.rect),this.vNodes.selected(s))}return e}getSelectorRect(t,e){var s;let o;const i=(s=t.parent)==null?void 0:s.getElementById(e),r=i==null?void 0:i.getBoundingClientRect();return r&&(o=z(o,{x:Math.floor(r.x),y:Math.floor(r.y),w:Math.floor(r.width+1),h:Math.floor(r.height+1)})),o}isCanFillColor(t){return t===T.Ellipse||t===T.Triangle||t===T.Rectangle||t===T.Polygon||t===T.Star||t===T.SpeechBalloon}async updateSelector(t){var e;const{updateSelectorOpt:s,selectIds:o,vNodes:i,willSerializeData:r,worker:n,scene:l,isMainThread:a,offset:c}=t,h=this.fullLayer;if(!h)return;let p;const d=new Map,{originPoint:y,workState:m,angle:S,translate:k,dir:N,scale:v}=s;c&&(k?s.translate=[k[0]+c[0],k[1]+c[1]]:s.translate=c);let f;if(y||k||K(S)){if(m===D.Start&&o)return i.setTargetAssignKeys(o),{type:w.Select,dataType:R.Local,selectRect:this.oldSelectRect,rect:this.oldSelectRect};f=i.getLastTarget()}if(o)for(const b of o){const W=i.get(b);if(W){const{toolsType:C}=W,M=(h==null?void 0:h.getElementsByName(b))[0];if(M){let Q=!1,tt=!1;const F={...s};let kt;if(C){F.thickness&&W.opt.thickness&&(Q=W.opt.thickness!==F.thickness),F.strokeType&&(e=W.opt)!=null&&e.strokeType&&(tt=W.opt.strokeType!==F.strokeType),kt=f==null?void 0:f.get(b);const Y=ke(C);if(Y==null||Y.updateNodeOpt({node:M,opt:F,vNodes:i,willSerializeData:r,targetNode:kt}),W&&n&&(r&&(F.angle||F.translate)||F.originPoint&&F.scenePoint&&F.scale||F.pointMap&&F.pointMap.has(b)||C===T.Text&&(F.fontSize||F.translate||F.textInfos&&F.textInfos.get(b))||C===T.Image&&(F.angle||F.translate||F.scale)||C===F.toolsType&&F.willRefresh||Q||tt)){const X=n.createWorkShapeNode({workId:b,toolsType:C,toolsOpt:W.opt});X==null||X.setWorkId(b);let G;if(C===T.Image&&l)G=await X.consumeServiceAsync({isFullWork:!0,replaceId:b,scene:l,isMainThread:a});else if(C===T.Text)G=await X.consumeServiceAsync({isFullWork:!0,replaceId:b});else try{G=X==null?void 0:X.consumeService({op:W.op,isFullWork:!0,replaceId:b})}catch{continue}G&&(W.rect=G)}W&&(d.set(b,W),p=z(p,W.rect))}}}}f&&m===D.Done&&(i.deleteLastTarget(),f=void 0);const P=p;if(y&&k&&v&&N&&P&&!c){const b=[[P.x,P.y],[P.x+P.w,P.y],[P.x+P.w,P.y+P.h],[P.x,P.y+P.h]];let W;switch(N){case"top":case"topLeft":case"left":k[0]>0&&k[1]>0?W=b[0]:k[0]>0?W=b[3]:k[1]>0?W=b[1]:W=b[2];break;case"topRight":k[0]<0&&k[1]>0?W=b[1]:k[0]<0?W=b[2]:k[1]>0?W=b[0]:W=b[3];break;case"right":case"bottomRight":case"bottom":k[0]<0&&k[1]<0?W=b[2]:k[0]<0?W=b[1]:k[1]<0?W=b[3]:W=b[0];break;case"bottomLeft":k[0]>0&&k[1]<0?W=b[3]:k[0]>0?W=b[0]:k[1]<0?W=b[2]:W=b[1];break}const C=W&&[y[0]-W[0],y[1]-W[1]]||[0,0];if(!yt(C,[0,0]))return await this.updateSelector({...t,updateSelectorOpt:{},offset:C})}this.getSelecteorInfo(d),this.draw(B,h,{selectIds:o||[],subNodeMap:d,intersectRect:P});const O=z(this.oldSelectRect,P);return this.oldSelectRect=P,{type:w.Select,dataType:R.Local,selectRect:P,renderRect:p,rect:z(O,P),selectIds:o}}blurSelector(){const t=this.unSelectedAllIds();return{type:w.Select,dataType:R.Local,rect:t,selectIds:[],willSyncService:!0}}getRightServiceId(t){return t.replace(xt,"-")}selectServiceNode(t,e,s){const{selectIds:o}=e,i=this.getRightServiceId(t),r=this.getSelectorRect(this.fullLayer,i);let n;const l=new Map;return o==null||o.forEach(a=>{const c=this.vNodes.get(a);c&&(n=z(n,c.rect),l.set(a,c))}),this.getSelecteorInfo(l),this.draw(i,this.fullLayer,{intersectRect:n,selectIds:o||[],subNodeMap:l},s),z(n,r)}reRenderSelector(){var t;let e;const s=new Map;return(t=this.selectIds)==null||t.forEach(o=>{const i=this.vNodes.get(o);i&&(e=z(e,i.rect),s.set(o,i))},this),this.getSelecteorInfo(s),this.draw(B,this.fullLayer,{intersectRect:e,subNodeMap:s,selectIds:this.selectIds||[]}),this.oldSelectRect=e,e}updateSelectIds(t){var e;let s;const o=(e=this.selectIds)==null?void 0:e.filter(r=>!t.includes(r));if(o!=null&&o.length&&(s=this.unSelectedByIds(o)),t.length){const r=this.selectedByIds(t);s=z(s,r)}this.selectIds=t;const i=this.reRenderSelector();return{bgRect:s,selectRect:i}}cursorHover(t){var e,s;const o=this.oldSelectRect;this.selectIds=[];const i=(e=this.workId)==null?void 0:e.toString(),r=[t[0]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[0],t[1]*this.fullLayer.worldScaling[0]+this.fullLayer.worldPosition[1]];if(this.selectSingleTool(r,i,!0),this.oldSelectRect&&!yt(o,this.oldSelectRect))return{type:w.CursorHover,dataType:R.Local,rect:z(o,this.oldSelectRect),selectorColor:this.selectorColor,willSyncService:!1};if((s=this.selectIds)!=null&&s.length||(this.oldSelectRect=void 0),o&&!this.oldSelectRect)return this.cursorBlur(),{type:w.CursorHover,dataType:R.Local,rect:o,selectorColor:this.selectorColor,willSyncService:!1}}cursorBlur(){var t,e;this.selectIds=[];const s=(t=this.workId)==null?void 0:t.toString();((e=this.fullLayer)==null?void 0:e.parent).children.forEach(o=>{o.name===s&&o.remove()})}};u(ae,"selectorBorderId","selector-border");let ce=ae;class he extends L{constructor(t){super(t),u(this,"canRotate",!1),u(this,"scaleType",$.both),u(this,"toolsType",T.Arrow),u(this,"tmpPoints",[]),u(this,"workOptions"),u(this,"oldRect"),u(this,"arrowTipWidth"),u(this,"syncTimestamp"),this.workOptions=t.toolsOpt,this.arrowTipWidth=this.workOptions.thickness*4,this.syncTimestamp=0,this.syncUnitTime=50}consume(t){const{data:e,isFullWork:s,isSubWorker:o,isMainThread:i}=t,r=this.workId,{op:n}=e,l=n==null?void 0:n.length;if(!l||l<2)return{type:w.None};let a;if(this.tmpPoints.length===0?(this.tmpPoints=[new x(n[0],n[1])],a=!1):a=this.updateTempPoints(n),!a)return{type:w.None};let c;if(o||i){const p=s?this.fullLayer:this.drawLayer||this.fullLayer;c=this.draw({workId:r,layer:p})}if(!o){const p=Date.now();return p-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=p,{...this.baseConsumeResult,type:w.DrawWork,dataType:R.Local,op:this.tmpPoints.map(d=>[...d.XY,0]).flat(1),isSync:!0,index:0}):{type:w.None}}const h=z(c,this.oldRect);return this.oldRect=c,{rect:h,...this.baseConsumeResult,type:w.DrawWork,dataType:R.Local}}consumeAll(){var t;const e=this.workId;if(this.tmpPoints.length<2)return{type:w.RemoveNode,removeIds:[e]};const s=this.fullLayer,o=this.draw({workId:e,layer:s});this.oldRect=o;const i=this.tmpPoints.map(n=>[...n.XY,0]).flat(1),r=Z(i);return(t=this.vNodes)==null||t.setInfo(e,{rect:o,op:i,opt:this.workOptions,toolsType:this.toolsType,canRotate:this.canRotate,scaleType:this.scaleType,centerPos:L.getCenterPos(o,s)}),{rect:o,...this.baseConsumeResult,type:w.FullWork,dataType:R.Local,ops:r,isSync:!0}}draw(t){const{workId:e,layer:s}=t,{strokeColor:o,thickness:i,zIndex:r,scale:n,rotate:l,translate:a,strokeType:c}=this.workOptions,h=s.worldPosition,p=s.worldScaling,{points:d,pos:y,rect:m,isTriangle:S,trianglePoints:k,trianglePos:N}=this.computDrawPoints(i),v=[m.x+m.w/2,m.y+m.h/2],f={pos:v,name:e,id:e,zIndex:r,anchor:[.5,.5],size:[m.w,m.h]};n&&(f.scale=n),l&&(f.rotate=l),a&&(f.translate=a);const P=new H(f),O={points:k,pos:[N[0]-v[0],N[1]-v[1]],fillColor:o,strokeColor:o,lineWidth:0,normalize:!1},b=new it(O);if(P.append(b),!S&&d&&y){const W={points:d,pos:[y[0]-v[0],y[1]-v[1]],fillColor:o,strokeColor:o,lineDash:c===A.Dotted&&!S?[1,i*2]:c===A.LongDotted&&!S?[i,i*2]:void 0,lineCap:c===A.Normal?void 0:"round",lineWidth:i,normalize:!1},C=new it(W);P.append(C)}if(this.replace(s,e,P),n||l||a){const W=P.getBoundingClientRect();return{x:Math.floor(W.x-L.SafeBorderPadding),y:Math.floor(W.y-L.SafeBorderPadding),w:Math.floor(W.width+L.SafeBorderPadding*2),h:Math.floor(W.height+L.SafeBorderPadding*2)}}return{x:Math.floor(m.x*p[0]+h[0]-L.SafeBorderPadding),y:Math.floor(m.y*p[1]+h[1]-L.SafeBorderPadding),w:Math.floor(m.w*p[0]+2*L.SafeBorderPadding),h:Math.floor(m.h*p[1]+2*L.SafeBorderPadding)}}computDrawPoints(t){return this.tmpPoints[1].distance(this.tmpPoints[0])>this.arrowTipWidth?this.computFullArrowPoints(t):this.computTrianglePoints()}computFullArrowPoints(t){const e=g.Sub(this.tmpPoints[1],this.tmpPoints[0]).uni(),s=g.Per(e).mul(t/2),o=x.Sub(this.tmpPoints[0],s),i=x.Add(this.tmpPoints[0],s),r=g.Mul(e,this.arrowTipWidth),n=g.Sub(this.tmpPoints[1],r),l=x.Sub(n,s),a=x.Add(n,s),c=g.Per(e).mul(t*1.5),h=x.Sub(n,c),p=x.Add(n,c),d=[this.tmpPoints[0],n],y=[h,this.tmpPoints[1],p],m=[o,i,...y,l,a];return{trianglePoints:y.map(S=>x.Sub(S,this.tmpPoints[1]).XY).flat(1),trianglePos:this.tmpPoints[1].XY,points:d.map(S=>x.Sub(S,this.tmpPoints[0]).XY).flat(1),rect:U(m),isTriangle:!1,pos:this.tmpPoints[0].XY}}computTrianglePoints(){const t=g.Sub(this.tmpPoints[1],this.tmpPoints[0]).uni(),e=this.tmpPoints[1].distance(this.tmpPoints[0]),s=g.Per(t).mul(Math.floor(e*3/8)),o=x.Sub(this.tmpPoints[0],s),i=x.Add(this.tmpPoints[0],s),r=[o,this.tmpPoints[1],i];return{trianglePoints:r.map(n=>x.Sub(n,this.tmpPoints[1]).XY).flat(1),trianglePos:this.tmpPoints[1].XY,rect:U(r),isTriangle:!0}}updateTempPoints(t){const e=t.slice(-2),s=new x(e[0],e[1]),o=this.tmpPoints[0],{thickness:i}=this.workOptions;if(o.isNear(s,i))return!1;if(this.tmpPoints.length===2){if(s.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=s}else this.tmpPoints.push(s);return!0}consumeService(t){var e,s;const{op:o,isFullWork:i}=t,r=(e=this.workId)==null?void 0:e.toString();if(!r)return;this.tmpPoints.length=0;for(let a=0;a<o.length;a+=3)this.tmpPoints.push(new x(o[a],o[a+1],o[a+2]));const n=i?this.fullLayer:this.drawLayer||this.fullLayer,l=this.draw({workId:r,layer:n});return this.oldRect=l,(s=this.vNodes)==null||s.setInfo(r,{rect:l,op:o,opt:this.workOptions,toolsType:this.toolsType,canRotate:this.canRotate,scaleType:this.scaleType,centerPos:L.getCenterPos(l,n)}),l}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(t){var e,s;const{node:o,opt:i,vNodes:r}=t,{strokeColor:n,strokeType:l}=i,a=r.get(o.name);return n&&(o.setAttribute("strokeColor",n),o.setAttribute("fillColor",n),(e=a==null?void 0:a.opt)!=null&&e.strokeColor&&(a.opt.strokeColor=n),a&&r.setInfo(o.name,a)),l&&a!=null&&a.opt&&(s=a.opt)!=null&&s.strokeType&&(a.opt.strokeType=l),L.updateNodeOpt(t)}}class pe extends L{constructor(t){super(t),u(this,"canRotate",!1),u(this,"scaleType",$.all),u(this,"toolsType",T.Ellipse),u(this,"tmpPoints",[]),u(this,"workOptions"),u(this,"oldRect"),u(this,"syncTimestamp"),this.workOptions=t.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}consume(t){const{data:e,isFullWork:s,isSubWorker:o,isMainThread:i}=t,r=this.workId,{op:n}=e,l=n==null?void 0:n.length;if(!l||l<2)return{type:w.None};let a;if(this.tmpPoints.length===0?(this.tmpPoints=[new x(n[0],n[1])],a=!1):a=this.updateTempPoints(n),!a)return{type:w.None};let c;if(o||i){const p=s?this.fullLayer:this.drawLayer||this.fullLayer;c=this.draw({workId:r,layer:p,isDrawing:!0})}if(!o){const p=Date.now();return p-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=p,{type:w.DrawWork,dataType:R.Local,...this.baseConsumeResult,op:this.tmpPoints.map(d=>[...d.XY,0]).flat(1),isSync:!0,index:0}):{type:w.None}}const h=z(c,this.oldRect);return this.oldRect=c,{rect:h,type:w.DrawWork,dataType:R.Local,...this.baseConsumeResult}}consumeAll(){var t;const e=this.workId;if(this.tmpPoints.length<2)return{type:w.RemoveNode,removeIds:[e]};const s=this.fullLayer,o=this.draw({workId:e,layer:s,isDrawing:!1});this.oldRect=o;const i=this.tmpPoints.map(n=>[...n.XY,0]).flat(1),r=Z(i);return(t=this.vNodes)==null||t.setInfo(e,{rect:o,op:i,opt:this.workOptions,toolsType:this.toolsType,canRotate:this.canRotate,scaleType:this.scaleType,centerPos:o&&L.getCenterPos(o,s)}),{rect:o,type:w.FullWork,dataType:R.Local,...this.baseConsumeResult,ops:r,isSync:!0}}draw(t){const{workId:e,layer:s,isDrawing:o}=t,{strokeColor:i,fillColor:r,thickness:n,zIndex:l,scale:a,rotate:c,translate:h,strokeType:p}=this.workOptions,d=s.worldScaling,{radius:y,rect:m,pos:S}=this.computDrawPoints(n),k={pos:S,name:e,id:e,radius:y,lineWidth:n,fillColor:r!=="transparent"&&r||void 0,strokeColor:i,normalize:!0,lineJoin:"round",lineCap:"round",lineDash:p===A.Dotted?[1,n*2]:p===A.LongDotted?[n,n*2]:void 0},N={name:e,id:e,zIndex:l,pos:S,anchor:[.5,.5],size:[m.w,m.h]};a&&(N.scale=a),c&&(N.rotate=c),h&&(N.translate=h);const v=new H(N);if(o){const O=new nt({d:"M-4,0H4M0,-4V4",normalize:!0,pos:[0,0],strokeColor:i,lineWidth:1,scale:[1/d[0],1/d[1]]});v.append(O)}const f=new be({...k,pos:[0,0]});v.append(f),this.replace(s,e,v);const P=v.getBoundingClientRect();return{x:Math.floor(P.x-L.SafeBorderPadding),y:Math.floor(P.y-L.SafeBorderPadding),w:Math.floor(P.width+L.SafeBorderPadding*2),h:Math.floor(P.height+L.SafeBorderPadding*2)}}computDrawPoints(t){const e=U(this.tmpPoints),s=U(this.tmpPoints,t),o=[Math.floor(e.x+e.w/2),Math.floor(e.y+e.h/2)];return{rect:s,pos:o,radius:[Math.floor(e.w/2),Math.floor(e.h/2)]}}updateTempPoints(t){const e=t.slice(-2),s=new x(e[0],e[1]),o=this.tmpPoints[0],{thickness:i}=this.workOptions;if(o.isNear(s,i))return!1;if(this.tmpPoints.length===2){if(s.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=s}else this.tmpPoints.push(s);return!0}consumeService(t){var e,s;const{op:o,isFullWork:i}=t,r=(e=this.workId)==null?void 0:e.toString();if(!r)return;this.tmpPoints.length=0;for(let a=0;a<o.length;a+=3)this.tmpPoints.push(new x(o[a],o[a+1],o[a+2]));const n=i?this.fullLayer:this.drawLayer||this.fullLayer,l=this.draw({workId:r,layer:n,isDrawing:!1});return this.oldRect=l,(s=this.vNodes)==null||s.setInfo(r,{rect:l,op:o,opt:this.workOptions,toolsType:this.toolsType,canRotate:this.canRotate,scaleType:this.scaleType,centerPos:L.getCenterPos(l,n)}),l}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(t){var e,s,o;const{node:i,opt:r,vNodes:n}=t,{strokeColor:l,fillColor:a,strokeType:c}=r,h=n.get(i.name);let p=i;return i.tagName==="GROUP"&&(p=i.children[0]),l&&(p.setAttribute("strokeColor",l),(e=h==null?void 0:h.opt)!=null&&e.strokeColor&&(h.opt.strokeColor=l)),a&&(a==="transparent"?p.setAttribute("fillColor","rgba(0,0,0,0)"):p.setAttribute("fillColor",a),(s=h==null?void 0:h.opt)!=null&&s.fillColor&&(h.opt.fillColor=a)),c&&h!=null&&h.opt&&(o=h.opt)!=null&&o.strokeType&&(h.opt.strokeType=c),h&&n.setInfo(i.name,h),L.updateNodeOpt(t)}}var ps=te,ds=Dt,us="[object Boolean]";function ys(I){return I===!0||I===!1||ds(I)&&ps(I)==us}var ms=ys;const ot=Ot(ms);class de extends L{constructor(t){super(t),u(this,"canRotate",!0),u(this,"scaleType",$.all),u(this,"toolsType",T.Rectangle),u(this,"tmpPoints",[]),u(this,"workOptions"),u(this,"oldRect"),u(this,"syncTimestamp"),this.workOptions=t.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}transformData(){const t=U(this.tmpPoints);return[[t.x,t.y,0],[t.x+t.w,t.y,0],[t.x+t.w,t.y+t.h,0],[t.x,t.y+t.h,0]]}computDrawPoints(t){const{thickness:e}=this.workOptions,s=[];for(const r of t)s.push(new g(...r));const o=U(s,e),i=[o.x+o.w/2,o.y+o.h/2];return{rect:o,pos:i,points:s.map(r=>r.XY).flat(1)}}consume(t){const{data:e,isFullWork:s,isSubWorker:o,isMainThread:i}=t,r=this.workId,{op:n}=e,l=n==null?void 0:n.length;if(!l||l<2)return{type:w.None};let a;if(this.tmpPoints.length===0?(this.tmpPoints=[new x(n[0],n[1])],a=!1):a=this.updateTempPoints(n),!a)return{type:w.None};const c=this.transformData();let h;if(o||i){const d=s?this.fullLayer:this.drawLayer||this.fullLayer;h=this.draw({ps:c,workId:r,layer:d,isDrawing:!0})}if(!o){const d=Date.now();return d-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=d,{type:w.DrawWork,dataType:R.Local,op:c.flat(1),isSync:!0,index:0,...this.baseConsumeResult}):{type:w.None}}const p=z(h,this.oldRect);return this.oldRect=h,{rect:p,type:w.DrawWork,dataType:R.Local,...this.baseConsumeResult}}consumeAll(){var t;const e=this.workId;if(this.tmpPoints.length<2)return{type:w.RemoveNode,removeIds:[e]};const s=this.transformData(),o=this.fullLayer,i=this.draw({ps:s,workId:e,layer:o,isDrawing:!1});this.oldRect=i;const r=s.flat(1),n=Z(r);return(t=this.vNodes)==null||t.setInfo(e,{rect:i,op:r,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:i&&L.getCenterPos(i,o)}),{rect:i,type:w.FullWork,dataType:R.Local,ops:n,isSync:!0,...this.baseConsumeResult}}draw(t){const{workId:e,layer:s,isDrawing:o,ps:i,replaceId:r}=t,{strokeColor:n,fillColor:l,thickness:a,zIndex:c,scale:h,rotate:p,translate:d,textOpt:y,strokeType:m}=this.workOptions,S=s.worldPosition,k=s.worldScaling,{points:N,rect:v,pos:f}=this.computDrawPoints(i),P={close:!0,normalize:!0,points:N,lineWidth:a,fillColor:l!=="transparent"&&l||void 0,strokeColor:n,lineJoin:"round",lineCap:"round",lineDash:m===A.Dotted?[1,a*2]:m===A.LongDotted?[a,a*2]:void 0},O={x:Math.floor(v.x*k[0]+S[0]-L.SafeBorderPadding),y:Math.floor(v.y*k[1]+S[1]-L.SafeBorderPadding),w:Math.floor(v.w*k[0]+2*L.SafeBorderPadding),h:Math.floor(v.h*k[0]+2*L.SafeBorderPadding)},b=new H({name:e,id:e,zIndex:c,pos:f,anchor:[.5,.5],size:[v.w,v.h],scale:h,rotate:p,translate:d}),W=new it({...P,pos:[0,0]});if(b.appendChild(W),o){const C=new nt({d:"M-4,0H4M0,-4V4",normalize:!0,pos:[0,0],strokeColor:n,lineWidth:1,scale:[1/k[0],1/k[1]]});b.appendChild(C)}if(this.replace(s,r||e,b),h||p||d){const C=b.getBoundingClientRect();return{x:Math.floor(C.x-L.SafeBorderPadding),y:Math.floor(C.y-L.SafeBorderPadding),w:Math.floor(C.width+2*L.SafeBorderPadding),h:Math.floor(C.height+2*L.SafeBorderPadding)}}return O}updateTempPoints(t){const e=t.slice(-2),s=new x(e[0],e[1]),o=this.tmpPoints[0],{thickness:i}=this.workOptions;if(o.isNear(s,i))return!1;if(this.tmpPoints.length===2){if(s.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=s}else this.tmpPoints.push(s);return!0}consumeService(t){var e,s;const{op:o,isFullWork:i,replaceId:r}=t,n=(e=this.workId)==null?void 0:e.toString();if(!n)return;const l=[];for(let h=0;h<o.length;h+=3)l.push([o[h],o[h+1],o[h+2]]);const a=i?this.fullLayer:this.drawLayer||this.fullLayer,c=this.draw({ps:l,workId:n,layer:a,isDrawing:!1,replaceId:r});return this.oldRect=c,(s=this.vNodes)==null||s.setInfo(n,{rect:c,op:o,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:c&&L.getCenterPos(c,a)}),c}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(t){var e,s,o;const{node:i,opt:r,vNodes:n}=t,{strokeColor:l,fillColor:a,fontColor:c,fontBgColor:h,bold:p,italic:d,lineThrough:y,underline:m,fontSize:S,strokeType:k}=r,N=n.get(i.name);let v=i;if(i.tagName==="GROUP"&&(v=i.children[0]),l&&(v.setAttribute("strokeColor",l),(e=N==null?void 0:N.opt)!=null&&e.strokeColor&&(N.opt.strokeColor=l)),a&&(a==="transparent"?v.setAttribute("fillColor","rgba(0,0,0,0)"):v.setAttribute("fillColor",a),(s=N==null?void 0:N.opt)!=null&&s.fillColor&&(N.opt.fillColor=a)),N!=null&&N.opt.textOpt){const f=N.opt.textOpt;c&&f.fontColor&&(f.fontColor=c),h&&f.fontBgColor&&(f.fontBgColor=h),p&&(f.bold=p),d&&(f.italic=d),ot(y)&&(f.lineThrough=y),ot(m)&&(f.underline=m),S&&(f.fontSize=S)}return k&&N!=null&&N.opt&&(o=N.opt)!=null&&o.strokeType&&(N.opt.strokeType=k),N&&n.setInfo(i.name,N),L.updateNodeOpt(t)}}class ue extends L{constructor(t){super(t),u(this,"canRotate",!1),u(this,"scaleType",$.all),u(this,"toolsType",T.Star),u(this,"tmpPoints",[]),u(this,"workOptions"),u(this,"oldRect"),u(this,"syncTimestamp"),this.workOptions=t.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}consume(t){const{data:e,isFullWork:s,isSubWorker:o,isMainThread:i}=t,r=this.workId,{op:n}=e,l=n==null?void 0:n.length;if(!l||l<2)return{type:w.None};let a;if(this.tmpPoints.length===0?(this.tmpPoints=[new x(n[0],n[1])],a=!1):a=this.updateTempPoints(n),!a)return{type:w.None};let c;if(o||i){const p=s?this.fullLayer:this.drawLayer||this.fullLayer;c=this.draw({workId:r,layer:p,isDrawing:!0})}if(!o){const p=Date.now();return p-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=p,{type:w.DrawWork,dataType:R.Local,op:this.tmpPoints.map(d=>[...d.XY,0]).flat(1),isSync:!0,index:0,...this.baseConsumeResult}):{type:w.None}}const h=z(c,this.oldRect);return this.oldRect=c,{rect:h,type:w.DrawWork,dataType:R.Local,...this.baseConsumeResult}}consumeAll(){var t;const e=this.workId;if(this.tmpPoints.length<2)return{type:w.RemoveNode,removeIds:[e]};const s=this.fullLayer,o=this.draw({workId:e,layer:s,isDrawing:!1});this.oldRect=o;const i=this.tmpPoints.map(n=>[...n.XY,0]).flat(1),r=Z(i);return(t=this.vNodes)==null||t.setInfo(e,{rect:o,op:i,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:o&&L.getCenterPos(o,s)}),{rect:o,type:w.FullWork,dataType:R.Local,ops:r,isSync:!0,...this.baseConsumeResult}}draw(t){const{workId:e,layer:s,isDrawing:o}=t,{strokeColor:i,fillColor:r,thickness:n,zIndex:l,vertices:a,innerVerticeStep:c,innerRatio:h,scale:p,rotate:d,translate:y,strokeType:m}=this.workOptions,S=s.worldScaling,{rect:k,pos:N,points:v}=this.computDrawPoints(n,a,c,h),f={close:!0,points:v,lineWidth:n,fillColor:r!=="transparent"&&r||void 0,strokeColor:i,normalize:!0,lineJoin:"round",lineCap:"round",lineDash:m===A.Dotted?[1,n*2]:m===A.LongDotted?[n,n*2]:void 0},P={name:e,id:e,zIndex:l,pos:N,anchor:[.5,.5],size:[k.w,k.h]};p&&(P.scale=p),d&&(P.rotate=d),y&&(P.translate=y);const O=new H(P);if(o){const C=new nt({d:"M-4,0H4M0,-4V4",normalize:!0,pos:[0,0],strokeColor:i,lineWidth:1,scale:[1/S[0],1/S[1]]});O.append(C)}const b=new it({...f,pos:[0,0]});O.append(b),this.replace(s,e,O);const W=O.getBoundingClientRect();return{x:Math.floor(W.x-L.SafeBorderPadding),y:Math.floor(W.y-L.SafeBorderPadding),w:Math.floor(W.width+L.SafeBorderPadding*2),h:Math.floor(W.height+L.SafeBorderPadding*2)}}computDrawPoints(t,e,s,o){const i=U(this.tmpPoints),r=[Math.floor(i.x+i.w/2),Math.floor(i.y+i.h/2)],n=_t(i.w,i.h),l=Math.floor(Math.min(i.w,i.h)/2),a=o*l,c=[],h=2*Math.PI/e;for(let p=0;p<e;p++){const d=p*h-.5*Math.PI;let y,m;p%s===1?(y=a*n[0]*Math.cos(d),m=a*n[1]*Math.sin(d)):(y=l*n[0]*Math.cos(d),m=l*n[1]*Math.sin(d),c.push(y,m)),c.push(y,m)}return{rect:U(this.tmpPoints,t),pos:r,points:c}}updateTempPoints(t){const e=t.slice(-2),s=new x(e[0],e[1]),o=this.tmpPoints[0],{thickness:i}=this.workOptions;if(o.isNear(s,i)||x.Sub(o,s).XY.includes(0))return!1;if(this.tmpPoints.length===2){if(s.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=s}else this.tmpPoints.push(s);return!0}consumeService(t){var e,s;const{op:o,isFullWork:i}=t,r=(e=this.workId)==null?void 0:e.toString();if(!r)return;this.tmpPoints.length=0;for(let a=0;a<o.length;a+=3)this.tmpPoints.push(new x(o[a],o[a+1],o[a+2]));const n=i?this.fullLayer:this.drawLayer||this.fullLayer,l=this.draw({workId:r,layer:n,isDrawing:!1});return this.oldRect=l,(s=this.vNodes)==null||s.setInfo(r,{rect:l,op:o,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:l&&L.getCenterPos(l,n)}),l}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(t){var e;const{node:s,opt:o,vNodes:i}=t,{strokeColor:r,fillColor:n,toolsType:l,vertices:a,innerVerticeStep:c,innerRatio:h,strokeType:p}=o,d=i.get(s.name),y=d==null?void 0:d.opt;let m=s;return s.tagName==="GROUP"&&(m=s.children[0]),r&&(m.setAttribute("strokeColor",r),y!=null&&y.strokeColor&&(y.strokeColor=r)),n&&(n==="transparent"?m.setAttribute("fillColor","rgba(0,0,0,0)"):m.setAttribute("fillColor",n),y!=null&&y.fillColor&&(y.fillColor=n)),l===T.Star&&(a&&(y.vertices=a),c&&(y.innerVerticeStep=c),h&&(y.innerRatio=h)),p&&d!=null&&d.opt&&(e=d.opt)!=null&&e.strokeType&&(d.opt.strokeType=p),d&&i.setInfo(s.name,{...d,opt:y}),L.updateNodeOpt(t)}}class ye extends L{constructor(t){super(t),u(this,"canRotate",!1),u(this,"scaleType",$.all),u(this,"toolsType",T.Polygon),u(this,"tmpPoints",[]),u(this,"workOptions"),u(this,"oldRect"),u(this,"syncTimestamp"),this.workOptions=t.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}consume(t){const{data:e,isFullWork:s,isSubWorker:o,isMainThread:i}=t,{op:r}=e,n=this.workId,l=r==null?void 0:r.length;if(!l||l<2)return{type:w.None};let a;if(this.tmpPoints.length===0?(this.tmpPoints=[new x(r[0],r[1])],a=!1):a=this.updateTempPoints(r),!a)return{type:w.None};let c;if(o||i){const p=s?this.fullLayer:this.drawLayer||this.fullLayer;c=this.draw({workId:n,layer:p,isDrawing:!0})}if(!o){const p=Date.now();return p-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=p,{type:w.DrawWork,dataType:R.Local,op:this.tmpPoints.map(d=>[...d.XY,0]).flat(1),isSync:!0,index:0,...this.baseConsumeResult}):{type:w.None}}const h=z(c,this.oldRect);return this.oldRect=c,{rect:h,type:w.DrawWork,dataType:R.Local,...this.baseConsumeResult}}consumeAll(){var t;const e=this.workId;if(this.tmpPoints.length<2)return{type:w.RemoveNode,removeIds:[e]};const s=this.fullLayer,o=this.draw({workId:e,layer:s,isDrawing:!1});this.oldRect=o;const i=this.tmpPoints.map(n=>[...n.XY,0]).flat(1),r=Z(i);return(t=this.vNodes)==null||t.setInfo(e,{rect:o,op:i,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:o&&L.getCenterPos(o,s)}),{rect:o,type:w.FullWork,dataType:R.Local,ops:r,isSync:!0,...this.baseConsumeResult}}draw(t){const{workId:e,layer:s,isDrawing:o}=t,{strokeColor:i,fillColor:r,thickness:n,zIndex:l,vertices:a,scale:c,rotate:h,translate:p,strokeType:d}=this.workOptions,y=s.worldScaling,{rect:m,pos:S,points:k}=this.computDrawPoints(n,a),N={close:!0,points:k,lineWidth:n,fillColor:r!=="transparent"&&r||void 0,strokeColor:i,normalize:!0,lineJoin:"round",lineCap:"round",lineDash:d===A.Dotted?[1,n*2]:d===A.LongDotted?[n,n*2]:void 0},v={name:e,id:e,zIndex:l,pos:S,anchor:[.5,.5],size:[m.w,m.h]};c&&(v.scale=c),h&&(v.rotate=h),p&&(v.translate=p);const f=new H(v);if(o){const b=new nt({d:"M-4,0H4M0,-4V4",normalize:!0,pos:[0,0],strokeColor:i,lineWidth:1,scale:[1/y[0],1/y[1]]});f.append(b)}const P=new it({...N,pos:[0,0]});f.append(P),this.replace(s,e,f);const O=f.getBoundingClientRect();return{x:Math.floor(O.x-L.SafeBorderPadding),y:Math.floor(O.y-L.SafeBorderPadding),w:Math.floor(O.width+L.SafeBorderPadding*2),h:Math.floor(O.height+L.SafeBorderPadding*2)}}computDrawPoints(t,e){const s=U(this.tmpPoints),o=[Math.floor(s.x+s.w/2),Math.floor(s.y+s.h/2)],i=_t(s.w,s.h),r=Math.floor(Math.min(s.w,s.h)/2),n=[],l=2*Math.PI/e;for(let a=0;a<e;a++){const c=a*l-.5*Math.PI,h=r*i[0]*Math.cos(c),p=r*i[1]*Math.sin(c);n.push(h,p)}return{rect:U(this.tmpPoints,t),pos:o,points:n}}updateTempPoints(t){const e=t.slice(-2),s=new x(e[0],e[1]),o=this.tmpPoints[0],{thickness:i}=this.workOptions;if(o.isNear(s,i)||x.Sub(o,s).XY.includes(0))return!1;if(this.tmpPoints.length===2){if(s.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=s}else this.tmpPoints.push(s);return!0}consumeService(t){var e,s;const{op:o,isFullWork:i}=t,r=(e=this.workId)==null?void 0:e.toString();if(!r)return;this.tmpPoints.length=0;for(let a=0;a<o.length;a+=3)this.tmpPoints.push(new x(o[a],o[a+1],o[a+2]));const n=i?this.fullLayer:this.drawLayer||this.fullLayer,l=this.draw({workId:r,layer:n,isDrawing:!1});return this.oldRect=l,(s=this.vNodes)==null||s.setInfo(r,{rect:l,op:o,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:l&&L.getCenterPos(l,n)}),l}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(t){var e;const{node:s,opt:o,vNodes:i}=t,{strokeColor:r,fillColor:n,toolsType:l,vertices:a,strokeType:c}=o,h=i.get(s.name),p=h==null?void 0:h.opt;let d=s;return s.tagName==="GROUP"&&(d=s.children[0]),r&&(d.setAttribute("strokeColor",r),p!=null&&p.strokeColor&&(p.strokeColor=r)),n&&(n==="transparent"?d.setAttribute("fillColor","rgba(0,0,0,0)"):d.setAttribute("fillColor",n),p!=null&&p.fillColor&&(p.fillColor=n)),l===T.Polygon&&a&&(p.vertices=a),c&&h!=null&&h.opt&&(e=h.opt)!=null&&e.strokeType&&(h.opt.strokeType=c),h&&i.setInfo(s.name,{...h,opt:p}),L.updateNodeOpt(t)}}class V{static bezier(t,e){const s=[];for(let o=0;o<e.length;o+=4){const i=e[o],r=e[o+1],n=e[o+2],l=e[o+3];i&&r&&n&&l?s.push(...V.getBezierPoints(t,i,r,n,l)):i&&r&&n?s.push(...V.getBezierPoints(t,i,r,n)):i&&r?s.push(...V.getBezierPoints(t,i,r)):i&&s.push(i)}return s}static getBezierPoints(t=10,e,s,o,i){let r=null;const n=[];!o&&!i?r=V.oneBezier:o&&!i?r=V.twoBezier:o&&i&&(r=V.threeBezier);for(let l=0;l<t;l++)r&&n.push(r(l/t,e,s,o,i));return i?n.push(i):o&&n.push(o),n}static oneBezier(t,e,s){const o=e.x+(s.x-e.x)*t,i=e.y+(s.y-e.y)*t;return new g(o,i)}static twoBezier(t,e,s,o){const i=(1-t)*(1-t)*e.x+2*t*(1-t)*s.x+t*t*o.x,r=(1-t)*(1-t)*e.y+2*t*(1-t)*s.y+t*t*o.y;return new g(i,r)}static threeBezier(t,e,s,o,i){const r=e.x*(1-t)*(1-t)*(1-t)+3*s.x*t*(1-t)*(1-t)+3*o.x*t*t*(1-t)+i.x*t*t*t,n=e.y*(1-t)*(1-t)*(1-t)+3*s.y*t*(1-t)*(1-t)+3*o.y*t*t*(1-t)+i.y*t*t*t;return new g(r,n)}}class me extends L{constructor(t){super(t),u(this,"canRotate",!1),u(this,"scaleType",$.all),u(this,"toolsType",T.SpeechBalloon),u(this,"ratio",.8),u(this,"tmpPoints",[]),u(this,"workOptions"),u(this,"oldRect"),u(this,"syncTimestamp"),this.workOptions=t.toolsOpt,this.syncTimestamp=0,this.syncUnitTime=50}consume(t){var e;const{data:s,isFullWork:o,isSubWorker:i,isMainThread:r}=t,n=(e=s==null?void 0:s.workId)==null?void 0:e.toString();if(!n)return{type:w.None};const{op:l}=s,a=l==null?void 0:l.length;if(!a||a<2)return{type:w.None};let c;if(this.tmpPoints.length===0?(this.tmpPoints=[new x(l[0],l[1])],c=!1):c=this.updateTempPoints(l),!c)return{type:w.None};let h;if(i||r){const d=o?this.fullLayer:this.drawLayer||this.fullLayer;h=this.draw({workId:n,layer:d,isDrawing:!0})}if(!i){const d=Date.now();return d-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=d,{type:w.DrawWork,dataType:R.Local,op:this.tmpPoints.map(y=>[...y.XY,0]).flat(1),isSync:!0,index:0,...this.baseConsumeResult}):{type:w.None}}const p=z(h,this.oldRect);return this.oldRect=h,{rect:p,type:w.DrawWork,dataType:R.Local,...this.baseConsumeResult}}consumeAll(){var t;const e=this.workId;if(this.tmpPoints.length<2)return{type:w.RemoveNode,removeIds:[e]};const s=this.fullLayer,o=this.draw({workId:e,layer:s,isDrawing:!1});this.oldRect=o;const i=this.tmpPoints.map(n=>[...n.XY,0]).flat(1),r=Z(i);return(t=this.vNodes)==null||t.setInfo(e,{rect:o,op:i,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:o&&L.getCenterPos(o,s)}),{rect:o,type:w.FullWork,dataType:R.Local,ops:r,isSync:!0,...this.baseConsumeResult}}draw(t){const{workId:e,layer:s}=t,{strokeColor:o,fillColor:i,thickness:r,zIndex:n,placement:l,scale:a,rotate:c,translate:h,strokeType:p}=this.workOptions,{rect:d,pos:y,points:m}=this.computDrawPoints(r,l),S={points:m.map(P=>P.XY),lineWidth:r,fillColor:i!=="transparent"&&i||void 0,strokeColor:o,normalize:!0,className:`${y[0]},${y[1]}`,close:!0,lineJoin:"round",lineCap:"round",lineDash:p===A.Dotted?[1,r*2]:p===A.LongDotted?[r,r*2]:void 0},k={name:e,id:e,zIndex:n,pos:y,anchor:[.5,.5],size:[d.w,d.h]};a&&(k.scale=a),c&&(k.rotate=c),h&&(k.translate=h);const N=new H(k),v=new it({...S,pos:[0,0]});N.append(v),this.replace(s,e,N);const f=N.getBoundingClientRect();return{x:Math.floor(f.x-L.SafeBorderPadding),y:Math.floor(f.y-L.SafeBorderPadding),w:Math.floor(f.width+L.SafeBorderPadding*2),h:Math.floor(f.height+L.SafeBorderPadding*2)}}transformControlPoints(t){const e=U(this.tmpPoints);switch(t){case"bottom":case"bottomLeft":case"bottomRight":{const s=e.y+e.h*this.ratio;return[new g(e.x,e.y,0),new g(e.x+e.w,e.y,0),new g(e.x+e.w,s,0),new g(e.x,s,0)]}case"top":case"topLeft":case"topRight":{const s=e.y+e.h*(1-this.ratio);return[new g(e.x,s,0),new g(e.x+e.w,s,0),new g(e.x+e.w,e.y+e.h,0),new g(e.x,e.y+e.h,0)]}case"left":case"leftBottom":case"leftTop":{const s=e.x+e.w*(1-this.ratio);return[new g(s,e.y,0),new g(e.x+e.w,e.y,0),new g(e.x+e.w,e.y+e.h,0),new g(s,e.y+e.h,0)]}case"right":case"rightBottom":case"rightTop":{const s=e.x+e.w*this.ratio;return[new g(e.x,e.y,0),new g(s,e.y,0),new g(s,e.y+e.h,0),new g(e.x,e.y+e.h,0)]}}}computDrawPoints(t,e){const s=U(this.tmpPoints),o=this.transformControlPoints(e),i=Math.floor(s.w*.1),r=Math.floor(s.h*.1),n=[],l=g.Add(o[0],new g(0,r,0)),a=g.Add(o[0],new g(i,0,0)),c=V.getBezierPoints(10,l,o[0],a),h=g.Sub(o[1],new g(i,0,0)),p=g.Add(o[1],new g(0,r,0)),d=V.getBezierPoints(10,h,o[1],p),y=g.Sub(o[2],new g(0,r,0)),m=g.Sub(o[2],new g(i,0,0)),S=V.getBezierPoints(10,y,o[2],m),k=g.Add(o[3],new g(i,0,0)),N=g.Sub(o[3],new g(0,r,0)),v=V.getBezierPoints(10,k,o[3],N),f=i*(1-this.ratio)*10,P=r*(1-this.ratio)*10;switch(e){case"bottom":{const W=g.Sub(o[2],new g(i*5-f/2,0,0)),C=g.Sub(o[2],new g(i*5,-P,0)),M=g.Sub(o[2],new g(i*5+f/2,0,0));n.push(C,M,...v,...c,...d,...S,W);break}case"bottomRight":{const W=g.Sub(o[2],new g(i*1.1,0,0)),C=g.Sub(o[2],new g(i*1.1+f/2,-P,0)),M=g.Sub(o[2],new g(i*1.1+f,0,0));n.push(C,M,...v,...c,...d,...S,W);break}case"bottomLeft":{const W=g.Add(o[3],new g(i*1.1+f,0,0)),C=g.Add(o[3],new g(i*1.1+f/2,P,0)),M=g.Add(o[3],new g(i*1.1,0,0));n.push(C,M,...v,...c,...d,...S,W);break}case"top":{const W=g.Sub(o[1],new g(i*5-f/2,0,0)),C=g.Sub(o[1],new g(i*5,P,0)),M=g.Sub(o[1],new g(i*5+f/2,0,0));n.push(C,W,...d,...S,...v,...c,M);break}case"topRight":{const W=g.Sub(o[1],new g(i*1.1,0,0)),C=g.Sub(o[1],new g(i*1.1+f/2,P,0)),M=g.Sub(o[1],new g(i*1.1+f,0,0));n.push(C,W,...d,...S,...v,...c,M);break}case"topLeft":{const W=g.Add(o[0],new g(i*1.1+f,0,0)),C=g.Add(o[0],new g(i*1.1+f/2,-P,0)),M=g.Add(o[0],new g(i*1.1,0,0));n.push(C,W,...d,...S,...v,...c,M);break}case"left":{const W=g.Add(o[0],new g(0,r*5-P/2,0)),C=g.Add(o[0],new g(-f,r*5,0)),M=g.Add(o[0],new g(0,r*5+P/2,0));n.push(C,W,...c,...d,...S,...v,M);break}case"leftTop":{const W=g.Add(o[0],new g(0,r*1.1,0)),C=g.Add(o[0],new g(-f,r*1.1+P/2,0)),M=g.Add(o[0],new g(0,r*1.1+P,0));n.push(C,W,...c,...d,...S,...v,M);break}case"leftBottom":{const W=g.Sub(o[3],new g(0,r*1.1+P,0)),C=g.Sub(o[3],new g(f,r*1.1+P/2,0)),M=g.Sub(o[3],new g(0,r*1.1,0));n.push(C,W,...c,...d,...S,...v,M);break}case"right":{const W=g.Add(o[1],new g(0,r*5-P/2,0)),C=g.Add(o[1],new g(f,r*5,0)),M=g.Add(o[1],new g(0,r*5+P/2,0));n.push(C,M,...S,...v,...c,...d,W);break}case"rightTop":{const W=g.Add(o[1],new g(0,r*1.1,0)),C=g.Add(o[1],new g(f,r*1.1+P/2,0)),M=g.Add(o[1],new g(0,r*1.1+P,0));n.push(C,M,...S,...v,...c,...d,W);break}case"rightBottom":{const W=g.Sub(o[2],new g(0,r*1.1+P,0)),C=g.Sub(o[2],new g(-f,r*1.1+P/2,0)),M=g.Sub(o[2],new g(0,r*1.1,0));n.push(C,M,...S,...v,...c,...d,W);break}}const O=U(this.tmpPoints,t),b=[Math.floor(O.x+O.w/2),Math.floor(O.y+O.h/2)];return{rect:O,pos:b,points:n}}updateTempPoints(t){const e=t.slice(-2),s=new x(e[0],e[1]),o=this.tmpPoints[0],{thickness:i}=this.workOptions;if(o.isNear(s,i)||x.Sub(o,s).XY.includes(0))return!1;if(this.tmpPoints.length===2){if(s.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=s}else this.tmpPoints.push(s);return!0}consumeService(t){var e,s;const{op:o,isFullWork:i}=t,r=(e=this.workId)==null?void 0:e.toString();if(!r)return;this.tmpPoints.length=0;for(let a=0;a<o.length;a+=3)this.tmpPoints.push(new x(o[a],o[a+1],o[a+2]));const n=i?this.fullLayer:this.drawLayer||this.fullLayer,l=this.draw({workId:r,layer:n,isDrawing:!1});return this.oldRect=l,(s=this.vNodes)==null||s.setInfo(r,{rect:l,op:o,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:l&&L.getCenterPos(l,n)}),l}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(t){var e;const{node:s,opt:o,vNodes:i}=t,{strokeColor:r,fillColor:n,toolsType:l,placement:a,strokeType:c}=o,h=i.get(s.name),p=h==null?void 0:h.opt;let d=s;return s.tagName==="GROUP"&&(d=s.children[0]),r&&(d.setAttribute("strokeColor",r),p!=null&&p.strokeColor&&(p.strokeColor=r)),n&&(n==="transparent"?d.setAttribute("fillColor","rgba(0,0,0,0)"):d.setAttribute("fillColor",n),p!=null&&p.fillColor&&(p.fillColor=n)),l===T.SpeechBalloon&&a&&(p.placement=a),c&&h!=null&&h.opt&&(e=h.opt)!=null&&e.strokeType&&(h.opt.strokeType=c),h&&i.setInfo(s.name,{...h,opt:p}),L.updateNodeOpt(t)}}class wt extends L{constructor(t){super(t),u(this,"canRotate",!0),u(this,"scaleType",$.all),u(this,"toolsType",T.Image),u(this,"tmpPoints",[]),u(this,"workOptions"),u(this,"oldRect"),this.workOptions=t.toolsOpt,this.scaleType=wt.getScaleType(this.workOptions)}consume(){return{type:w.None}}consumeAll(){return{type:w.None}}draw(t){const{layer:e,workId:s,replaceId:o,imageBitmap:i,isMainThread:r}=t,{centerX:n,centerY:l,width:a,height:c,rotate:h,zIndex:p}=this.workOptions,d=!!e.parent.gl,y={anchor:[.5,.5],pos:[n,l],name:s,size:[a,c],zIndex:p,rotate:!r&&!d&&180+(h||0)||h,texture:i},m=new Re(y);this.replace(e,o||s,m);const S=m.getBoundingClientRect();if(S)return{x:Math.floor(S.x-L.SafeBorderPadding),y:Math.floor(S.y-L.SafeBorderPadding),w:Math.floor(S.width+L.SafeBorderPadding*2),h:Math.floor(S.height+L.SafeBorderPadding*2)}}consumeService(){}async consumeServiceAsync(t){var e,s,o,i;const{isFullWork:r,replaceId:n,scene:l,isMainThread:a}=t,{src:c,uuid:h}=this.workOptions,p=((e=this.workId)==null?void 0:e.toString())||h,d=r?this.fullLayer:this.drawLayer||this.fullLayer;if(c){const y=await l.preload({id:h,src:this.workOptions.src}),m=this.draw({workId:p,layer:d,replaceId:n,imageBitmap:y[0],isMainThread:a});return this.oldRect=p&&((o=(s=this.vNodes)==null?void 0:s.get(p))==null?void 0:o.rect)||void 0,(i=this.vNodes)==null||i.setInfo(p,{rect:m,op:[],opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:m&&L.getCenterPos(m,d)}),m}}clearTmpPoints(){this.tmpPoints.length=0}static getScaleType(t){const{uniformScale:e,rotate:s}=t;return e!==!1?$.proportional:s&&Math.abs(s)%90>0?$.proportional:$.all}static updateNodeOpt(t){const{node:e,opt:s,vNodes:o,targetNode:i}=t,{translate:r,originPoint:n,scenePoint:l,scale:a,angle:c,isLocked:h,zIndex:p}=s,d=i&&q(i)||o.get(e.name);if(!d)return;const y=e.parent;if(y){if(K(p)&&(e.setAttribute("zIndex",p),d.opt.zIndex=p),ot(h)&&(d.opt.locked=h),n&&l&&a){const{centerX:m,centerY:S,width:k,height:N,uniformScale:v}=d.opt,f=v!==!1?[a[0],a[0]]:a,P=[m,S],O=[m,S];Mt(O,l,f,r);const b=[O[0]-P[0],O[1]-P[1]];d.centerPos=[d.centerPos[0]+b[0],d.centerPos[1]+b[1]],d.opt.width=Math.round(k*f[0]),d.opt.height=Math.round(N*f[1]),d.opt.centerX=O[0],d.opt.centerY=O[1]}else if(r)d.opt.centerX=d.opt.centerX+r[0],d.opt.centerY=d.opt.centerY+r[1],d.centerPos=[d.centerPos[0]+r[0],d.centerPos[1]+r[1]];else if(K(c))if(d.opt.rotate=c,d.scaleType=wt.getScaleType(d.opt),i){const m=Qt(d.rect,c);d.rect=m}else{const m=L.getRectFromLayer(y,e.name);d.rect=m||d.rect}return d&&o.setInfo(e.name,d),d==null?void 0:d.rect}}}class fe extends L{constructor(t){super(t),u(this,"canRotate",!1),u(this,"scaleType",$.both),u(this,"toolsType",T.Straight),u(this,"tmpPoints",[]),u(this,"workOptions"),u(this,"oldRect"),u(this,"straightTipWidth"),u(this,"syncTimestamp"),this.workOptions=t.toolsOpt,this.straightTipWidth=this.workOptions.thickness/2,this.syncTimestamp=0,this.syncUnitTime=50}consume(t){const{data:e,isFullWork:s,isSubWorker:o,isMainThread:i}=t,r=this.workId,{op:n}=e,l=n==null?void 0:n.length;if(!l||l<2)return{type:w.None};let a;if(this.tmpPoints.length===0?(this.tmpPoints=[new x(n[0],n[1])],a=!1):a=this.updateTempPoints(n),!a)return{type:w.None};let c;if(o||i){const p=s?this.fullLayer:this.drawLayer||this.fullLayer;c=this.draw({workId:r,layer:p})}if(!o){const p=Date.now();return p-this.syncTimestamp>this.syncUnitTime?(this.syncTimestamp=p,{type:w.DrawWork,dataType:R.Local,op:this.tmpPoints.map(d=>[...d.XY,0]).flat(1),isSync:!0,index:0,...this.baseConsumeResult}):{type:w.None}}const h=z(c,this.oldRect);return this.oldRect=c,{rect:h,type:w.DrawWork,dataType:R.Local,...this.baseConsumeResult}}consumeAll(){var t;const e=this.workId;if(this.tmpPoints.length<2)return{type:w.RemoveNode,removeIds:[e]};const s=this.fullLayer,o=this.draw({workId:e,layer:s});this.oldRect=o;const i=this.tmpPoints.map(n=>[...n.XY,0]).flat(1),r=Z(i);return(t=this.vNodes)==null||t.setInfo(e,{rect:o,op:i,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:o&&L.getCenterPos(o,s)}),{rect:o,type:w.FullWork,dataType:R.Local,ops:r,isSync:!0,...this.baseConsumeResult}}draw(t){const{workId:e,layer:s}=t,{strokeColor:o,thickness:i,zIndex:r,scale:n,rotate:l,translate:a,strokeType:c}=this.workOptions,h=s.worldPosition,p=s.worldScaling,{d,rect:y,isDot:m}=this.computDrawPoints(i,c),S=[y.x+y.w/2,y.y+y.h/2],k={pos:S,name:e,id:e,d,fillColor:o,strokeColor:o,lineDash:c===A.Dotted&&!m?[1,i*2]:c===A.LongDotted&&!m?[i,i*2]:void 0,lineCap:c===A.Normal||m?void 0:"round",lineWidth:c===A.Normal||m?0:i,className:`${S[0]},${S[1]}`,normalize:!0,zIndex:r};n&&(k.scale=n),l&&(k.rotate=l),a&&(k.translate=a);const N=new nt(k);if(this.replace(s,e,N),l||n||a){const v=N.getBoundingClientRect();return{x:Math.floor(v.x-L.SafeBorderPadding),y:Math.floor(v.y-L.SafeBorderPadding),w:Math.floor(v.width+L.SafeBorderPadding*2),h:Math.floor(v.height+L.SafeBorderPadding*2)}}return{x:Math.floor(y.x*p[0]+h[0]-L.SafeBorderPadding),y:Math.floor(y.y*p[1]+h[1]-L.SafeBorderPadding),w:Math.floor(y.w*p[0]+2*L.SafeBorderPadding),h:Math.floor(y.h*p[1]+2*L.SafeBorderPadding)}}computDrawPoints(t,e){return this.tmpPoints[1].distance(this.tmpPoints[0])>this.straightTipWidth?this.computFullPoints(t,e):this.computDotPoints(t)}computFullPoints(t,e){const s=g.Sub(this.tmpPoints[1],this.tmpPoints[0]).uni(),o=g.Per(s).mul(t/2),i=x.Sub(this.tmpPoints[0],o),r=x.Add(this.tmpPoints[0],o),n=x.Sub(this.tmpPoints[1],o),l=x.Add(this.tmpPoints[1],o),a=x.GetSemicircleStroke(this.tmpPoints[1],n,-1,8),c=x.GetSemicircleStroke(this.tmpPoints[0],r,-1,8),h=[i,n,...a,l,r,...c];let p;return e!==A.Normal?p=rt(this.tmpPoints,!1):p=rt(h,!0),{d:p,rect:U(h),isDot:!1,pos:this.tmpPoints[0].XY}}computDotPoints(t){const e=x.GetDotStroke(this.tmpPoints[0],t/2,8);return{d:rt(e,!0),rect:U(e),isDot:!0,pos:this.tmpPoints[0].XY}}updateTempPoints(t){const e=t.slice(-2),s=new x(e[0],e[1]),o=this.tmpPoints[0],{thickness:i}=this.workOptions;if(o.isNear(s,i))return!1;if(this.tmpPoints.length===2){if(s.isNear(this.tmpPoints[1],1))return!1;this.tmpPoints[1]=s}else this.tmpPoints.push(s);return!0}consumeService(t){var e,s;const{op:o,isFullWork:i}=t,r=(e=this.workId)==null?void 0:e.toString();if(!r)return;this.tmpPoints.length=0;for(let a=0;a<o.length;a+=3)this.tmpPoints.push(new x(o[a],o[a+1],o[a+2]));const n=i?this.fullLayer:this.drawLayer||this.fullLayer,l=this.draw({workId:r,layer:n});return this.oldRect=l,(s=this.vNodes)==null||s.setInfo(r,{rect:l,op:o,opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:l&&L.getCenterPos(l,n)}),l}clearTmpPoints(){this.tmpPoints.length=0}static updateNodeOpt(t){var e,s;const{node:o,opt:i,vNodes:r}=t,{strokeColor:n,strokeType:l}=i,a=r.get(o.name);return n&&(o.setAttribute("strokeColor",n),o.setAttribute("fillColor",n),(e=a==null?void 0:a.opt)!=null&&e.strokeColor&&(a.opt.strokeColor=n)),l&&a!=null&&a.opt&&(s=a.opt)!=null&&s.strokeType&&(a.opt.strokeType=l),a&&r.setInfo(o.name,a),L.updateNodeOpt(t)}}const Ct=class mt extends L{constructor(t){super(t),u(this,"canRotate",!1),u(this,"scaleType",$.proportional),u(this,"toolsType",T.Text),u(this,"tmpPoints",[]),u(this,"workOptions"),u(this,"oldRect"),this.workOptions=t.toolsOpt}consume(){return{type:w.None}}consumeAll(){return{type:w.None}}consumeService(){}async draw(t){const{workId:e,layer:s,isDrawLabel:o}=t,{boxSize:i,boxPoint:r,zIndex:n}=this.workOptions,l=s.worldPosition,a=s.worldScaling;if(!r||!i)return;const c={name:e,id:e,pos:[r[0],r[1]],anchor:[0,0],size:i,zIndex:n},h=new H(c),p={x:r[0],y:r[1],w:i[0],h:i[1]},d={x:Math.floor(p.x*a[0]+l[0]),y:Math.floor(p.y*a[1]+l[1]),w:Math.floor(p.w*a[0])+2,h:Math.floor(p.h*a[1])+2};if(this.replace(s,e,h),o&&s&&this.workOptions.text){const y=await mt.createLabels(this.workOptions,s,d),{labels:m,maxWidth:S}=y;h.append(...m),d.w=Math.ceil(Math.max(S*s.worldScaling[0],d.w))}return d}async consumeServiceAsync(t){var e,s,o,i;const r=(e=this.workId)==null?void 0:e.toString();if(!r)return;const{isFullWork:n,replaceId:l,isDrawLabel:a}=t;this.oldRect=l&&((o=(s=this.vNodes)==null?void 0:s.get(l))==null?void 0:o.rect)||void 0;const c=n?this.fullLayer:this.drawLayer||this.fullLayer,h=await this.draw({workId:r,layer:c,isDrawLabel:typeof a>"u"&&this.workOptions.workState===D.Done||a});return(i=this.vNodes)==null||i.setInfo(r,{rect:h,op:[],opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:h&&L.getCenterPos(h,c)}),h}updataOptService(){}async updataOptServiceAsync(t,e){var s,o;if(!this.workId)return;const i=this.workId.toString(),{fontColor:r,fontBgColor:n,bold:l,italic:a,lineThrough:c,underline:h,zIndex:p}=t,d=(s=this.vNodes)==null?void 0:s.get(i);if(!d)return;r&&(d.opt.fontColor=r),n&&(d.opt.fontBgColor=n),l&&(d.opt.bold=l),a&&(d.opt.italic=a),ot(c)&&(d.opt.lineThrough=c),ot(h)&&(d.opt.underline=h),K(p)&&(d.opt.zIndex=p),this.oldRect=d.rect;const y=await this.draw({workId:i,layer:this.fullLayer,isDrawLabel:typeof e>"u"&&this.workOptions.workState===D.Done||e});return(o=this.vNodes)==null||o.setInfo(i,{rect:y,op:[],opt:this.workOptions,toolsType:this.toolsType,scaleType:this.scaleType,canRotate:this.canRotate,centerPos:y&&L.getCenterPos(y,this.fullLayer)}),y}clearTmpPoints(){this.tmpPoints.length=0}static getSafetySnippetRatio(t){const e=(t==null?void 0:t.parent).displayRatio||1,s=Math.ceil(t.worldScaling[0]*10)/10;let o=s;return s>=.2&&s<1?o=s*e:s<=2&&s>=1?o=s*e*1.6:s>2&&s<=3?o=s*e*1.4:s>3&&s<=4?o=s*e*.8:s>4&&(o=s*e*.6),Math.floor(o*1e3)/1e3}static getSafetySnippetFontLength(t){return Math.floor(mt.textImageSnippetSize*3/4/t)||1}static async createLabels(t,e,s){var o;const i=[],{x:r,y:n}=s,{width:l,height:a}=(o=e.parent)==null?void 0:o.parent,c=pt(t.text),h=c.length,{fontSize:p,lineHeight:d,bold:y,textAlign:m,italic:S,fontFamily:k,verticalAlign:N,fontColor:v,fontBgColor:f,underline:P,lineThrough:O}=t,b=mt.getSafetySnippetRatio(e)||1,W=Math.floor(p*b),C=mt.getSafetySnippetFontLength(W);let M=0;for(let Q=0;Q<h;Q++){const tt=c[Q],F=d||W*1.5;if(tt){const kt=Ce(tt),Y=[0,0],X=[0,p*1.2];N==="middle"&&(Y[1]=Q*p*1.2+5);const G=[0,-p*.15];Y[0]=5;const St=Math.sin(Math.PI/180*20);let et=0;const gt=[];let dt=0;for(;dt<kt;){m==="left"&&(G[0]=et),dt===0&&S==="italic"&&(G[0]=G[0]-St/2*p);const Nt=tt.slice(dt,dt+C),vt={anchor:[0,0],pos:G,text:Nt,fontFamily:k,fontSize:W,lineHeight:F,strokeColor:v,fontWeight:y,fillColor:v,textAlign:m,fontStyle:S,scale:[1/b,1/b]},st=new Oe(vt),_=await st.textImageReady;let Tt=!0;if(_){const Et=_.rect&&_.rect[2],zt=_.rect&&_.rect[3];if(Et&&zt){const Bt=Et/b,ge=zt/b;et=Bt+et,S==="italic"&&(y==="bold"?et=et-St*p*1.2:et=et-St*p),((G[0]+Y[0]+Bt)*e.worldScaling[0]+r<=0||(G[0]+Y[0])*e.worldScaling[0]+r>=l||(G[1]+Y[1]+ge)*e.worldScaling[1]+n<=0||(G[1]+Y[1])*e.worldScaling[1]+n>=a)&&(st.disconnect(),Tt=!1),Tt&&gt.push(st)}}dt+=C}X[0]=et,S==="italic"&&(X[0]=X[0]+St*p),M=Math.max(M,X[0]);let At=!0;if(((Y[0]+X[0])*e.worldScaling[0]+r<=0||Y[0]*e.worldScaling[0]+r>=l||(Y[1]+X[1])*e.worldScaling[0]+n<=0||Y[1]*e.worldScaling[1]+n>=a)&&(At=!1),At){if(P){const st=Math.floor(p/10),_={normalize:!1,pos:[0,p*1.1+st/2],lineWidth:st,points:[0,0,Math.ceil(X[0]),0],strokeColor:v,className:"underline"},Tt=new it(_);gt.push(Tt)}if(O){const st={normalize:!1,pos:[0,p*1.2/2],lineWidth:Math.floor(p/10),points:[0,0,Math.ceil(X[0]),0],strokeColor:v,className:"lineThrough"},_=new it(st);gt.push(_)}const Nt={pos:Y,anchor:[0,0],size:X,bgcolor:f},vt=new H(Nt);vt.append(...gt),i.push(vt)}}}return{labels:i,maxWidth:M}}static updateNodeOpt(t){const{node:e,opt:s,vNodes:o,targetNode:i}=t,{fontBgColor:r,fontColor:n,translate:l,originPoint:a,scenePoint:c,scale:h,bold:p,italic:d,lineThrough:y,underline:m,fontSize:S,textInfos:k,zIndex:N}=s,v=i&&q(i)||o.get(e.name);if(!v||!e.parent)return;const f=v.opt;if(K(N)&&(e.setAttribute("zIndex",N),v.opt.zIndex=N),n&&f.fontColor&&(f.fontColor=n,e.children.forEach(P=>{P.tagName==="GROUP"&&P.children.forEach(O=>{O.tagName==="LABEL"?(O.setAttribute("fillColor",n),O.setAttribute("strokeColor",n)):O.tagName==="POLYLINE"&&O.setAttribute("strokeColor",n)})})),r&&f.fontBgColor&&(f.fontBgColor=r,e.children.forEach(P=>{P.tagName==="GROUP"&&P.setAttribute("bgcolor",r)})),p&&(f.bold=p),d&&(f.italic=d),ot(y)&&(f.lineThrough=y),ot(m)&&(f.underline=m),S&&(f.fontSize=S),a&&c&&h&&i&&f.boxPoint){const P=k==null?void 0:k.get(e.name);if(P){const{fontSize:C,boxSize:M}=P;f.boxSize=M||f.boxSize,f.fontSize=C||f.fontSize}const O=[f.boxPoint[0],f.boxPoint[1]];Mt(f.boxPoint,c,h,l);const b=[v.op[0],v.op[1]],W=[b[0]-O[0],b[1]-O[1]];v.centerPos=[v.centerPos[0]+W[0],v.centerPos[1]+W[1]]}else l&&f.boxPoint&&(f.boxPoint=[f.boxPoint[0]+l[0],f.boxPoint[1]+l[1]],v.centerPos=[v.centerPos[0]+l[0],v.centerPos[1]+l[1]]);return v&&o.setInfo(e.name,v),v==null?void 0:v.rect}static getRectFromLayer(t,e){const s=t.getElementsByName(e)[0];if(s){const o=s.getBoundingClientRect();let i={x:Math.floor(o.x),y:Math.floor(o.y),w:Math.floor(o.width+2),h:Math.floor(o.height+2)};return s.children.forEach(r=>{if(r.tagName==="GROUP"){const n=s.getBoundingClientRect();i=z(i,{x:Math.floor(n.x),y:Math.floor(n.y),w:Math.floor(n.width+2),h:Math.floor(n.height+2)})}}),i}}};u(Ct,"textImageSnippetSize",1024*4),u(Ct,"SafeBorderPadding",30);let we=Ct;function ke(I){switch(I){case T.Arrow:return he;case T.Pencil:return se;case T.Straight:return fe;case T.Ellipse:return pe;case T.Polygon:case T.Triangle:return ye;case T.Star:case T.Rhombus:return ue;case T.Rectangle:return de;case T.SpeechBalloon:return me;case T.Text:return we;case T.LaserPen:return oe;case T.Eraser:return re;case T.Selector:return ce;case T.Image:return wt}}function Lt(I,t){const{toolsType:e,...s}=I;switch(e){case T.Arrow:return new he(s);case T.Pencil:return new se(s);case T.Straight:return new fe(s);case T.Ellipse:return new pe(s);case T.Polygon:case T.Triangle:return new ye(s);case T.Star:case T.Rhombus:return new ue(s);case T.Rectangle:return new de(s);case T.SpeechBalloon:return new me(s);case T.Text:return new we(s);case T.LaserPen:return new oe(s);case T.Eraser:return new re(s,t);case T.Selector:return s.vNodes?new ce({...s,vNodes:s.vNodes,drawLayer:s.fullLayer}):void 0;case T.Image:return new wt(s);default:return}}function Se(I){const t=[],e=["PATH","SPRITE","POLYLINE","RECT","ELLIPSE","LABEL"];for(const s of I){if(s.tagName==="GROUP"&&s.children.length)return Se(s.children);s.tagName&&e.includes(s.tagName)&&t.push(s)}return t}const fs=I=>{if(I.tagName==="GROUP"){const t=Object.getOwnPropertySymbols(I).find(e=>e.toString()==="Symbol(sealed)");if(t&&I[t])return!0}return!1},ws=I=>!I.isHid;class ks{constructor(t,e){u(this,"viewId"),u(this,"scene"),u(this,"fullLayer"),u(this,"curNodeMap",new Map),u(this,"targetNodeMap",[]),u(this,"highLevelIds"),this.viewId=t,this.scene=e}init(t){this.fullLayer=t}get(t){return this.curNodeMap.get(t)}getNodesByType(t){const e=new Map;return this.curNodeMap.forEach((s,o)=>{s.toolsType===t&&e.set(o,s)}),e}hasRenderNodes(){let t=!1;for(const e of this.curNodeMap.values())ws(e)&&(t=!0);return t}has(t){return this.curNodeMap.has(t)}setInfo(t,e){const s=this.curNodeMap.get(t)||{name:t,rect:e.rect};e.rect&&(s.rect=q(e.rect)),e.op&&Te(e.op)&&(s.op=q(e.op)),e.canRotate&&(s.canRotate=e.canRotate),e.scaleType&&(s.scaleType=e.scaleType),e.opt&&(s.opt=q(e.opt)),e.toolsType&&(s.toolsType=e.toolsType),e.centerPos&&(s.centerPos=q(e.centerPos)),ot(e.isSelected)&&(s.isSelected=e.isSelected),s.rect?this.curNodeMap.set(t,s):this.curNodeMap.delete(t)}selected(t){this.setInfo(t,{isSelected:!0})}unSelected(t){this.setInfo(t,{isSelected:!1})}delete(t){this.curNodeMap.delete(t)}clear(){this.curNodeMap.clear(),this.targetNodeMap.length=0}hasRectIntersectRange(t,e=!0){for(const s of this.curNodeMap.values())if(ft(t,s.rect)){if(e&&s.toolsType===T.Image&&s.opt.locked||e&&s.toolsType===T.Text&&(s.opt.workState===D.Doing||s.opt.workState===D.Start))continue;return!0}return!1}getRectIntersectRange(t,e=!0,s=!0){let o;const i=new Map;for(const[r,n]of this.curNodeMap.entries())if(ft(t,n.rect)){if(e&&n.toolsType===T.Image&&n.opt.locked||s&&n.toolsType===T.Text&&(n.opt.workState===D.Doing||n.opt.workState===D.Start))continue;o=z(o,n.rect),i.set(r,n)}return{rectRange:o,nodeRange:i}}getNodeRectFormShape(t,e){const s=ke(e.toolsType);return this.fullLayer&&(s==null?void 0:s.getRectFromLayer(this.fullLayer,t))}updateNodeRect(t){const e=this.curNodeMap.get(t);if(e){const s=this.getNodeRectFormShape(t,e);if(!s){this.curNodeMap.delete(t);return}e.rect=s,this.curNodeMap.set(t,e)}}updateHighLevelNodesRect(t){this.highLevelIds=t;for(const e of this.highLevelIds.keys())this.updateNodeRect(e)}updateLowLevelNodesRect(){var t;for(const e of this.curNodeMap.keys())(t=this.highLevelIds)!=null&&t.has(e)||this.updateNodeRect(e)}clearHighLevelIds(){this.highLevelIds=void 0}combineIntersectRect(t){let e=t;return this.curNodeMap.forEach(s=>{ft(e,s.rect)&&(e=z(e,s.rect))}),e}setTargetAssignKeys(t){const e=new Map;for(const s of t){const o=this.curNodeMap.get(s);o&&e.set(s,q(o))}return this.targetNodeMap.push(q(e)),this.targetNodeMap.length-1}setTarget(){return this.targetNodeMap.push(q(this.curNodeMap)),this.targetNodeMap.length-1}getLastTarget(){return this.targetNodeMap[this.targetNodeMap.length-1]}deleteLastTarget(){this.targetNodeMap.length&&(this.targetNodeMap.length=this.targetNodeMap.length-1)}getTarget(t){return this.targetNodeMap[t]}deleteTarget(t){this.targetNodeMap.length=t}clearTarget(){this.targetNodeMap.length=0}}class Ss{constructor(t){u(this,"vNodes"),u(this,"thread"),u(this,"serviceWorkShapes",new Map),u(this,"localWorkShapes",new Map),u(this,"tmpOpt"),u(this,"animationId"),u(this,"syncUnitTime",ht.syncOpt.interval),this.vNodes=t.vNodes,this.thread=t.thread}createLocalWork(t){const{workId:e,opt:s,toolsType:o}=t;if(e&&s){const i=e.toString();!this.getToolsOpt()&&o&&this.setToolsOpt({toolsType:o,toolsOpt:s}),this.setWorkOptions(i,s)}}getLocalWorkShape(t){return this.localWorkShapes.get(t)}createLocalWorkShape(t,e){if(t&&this.tmpOpt){const s={toolsType:this.tmpOpt.toolsType,toolsOpt:e||this.tmpOpt.toolsOpt},o=this.createWorkShapeNode({...s,workId:t});return o&&this.localWorkShapes.set(t,{node:o,toolsType:o.toolsType,workState:D.Start}),o}}canUseTopLayer(t){return t===T.LaserPen}destroy(){this.clearAll()}clearAll(){this.thread.topLayer.children.length&&(this.thread.topLayer.parent.children.forEach(t=>{t.name!=="viewport"&&t.remove()}),this.thread.serviceLayer.removeAllChildren()),this.serviceWorkShapes.clear(),this.localWorkShapes.clear()}consumeDraw(t){const{workId:e,dataType:s}=t;if(s===R.Service)this.activeServiceWorkShape(t);else{const o=e==null?void 0:e.toString(),i=o&&this.localWorkShapes.get(o);if(!i)return;const r=i.node.consume({data:t,isFullWork:!1,isSubWorker:!0});r.rect&&(i.result=r,i.workState=D.Doing,o&&this.localWorkShapes.set(o,i))}this.runAnimation()}setToolsOpt(t){var e;this.tmpOpt=t,(e=t.toolsOpt)!=null&&e.syncUnitTime&&(this.syncUnitTime=t.toolsOpt.syncUnitTime)}getToolsOpt(){return this.tmpOpt}createWorkShapeNode(t){const{toolsType:e}=t;if(e===T.LaserPen)return Lt({...t,vNodes:this.vNodes,fullLayer:this.thread.topLayer,drawLayer:this.thread.topLayer})}setNodeKey(t,e,s,o){return e.toolsType=s,e.node=this.createWorkShapeNode({workId:t,toolsType:s,toolsOpt:o}),e}activeServiceWorkShape(t){var e,s;const{workId:o,opt:i,toolsType:r,type:n,updateNodeOpt:l,ops:a,op:c}=t;if(!o)return;const h=o.toString(),p=(e=this.vNodes.get(h))==null?void 0:e.rect;if(!((s=this.serviceWorkShapes)!=null&&s.has(h))){let y={toolsType:r,animationWorkData:c||[],animationIndex:0,type:n,updateNodeOpt:l,ops:a,oldRect:p};r&&i&&(y=this.setNodeKey(h,y,r,i)),this.serviceWorkShapes.set(h,y)}const d=this.serviceWorkShapes.get(h);n&&(d.type=n),a&&(d.animationWorkData=pt(a),d.ops=a),l&&(d.updateNodeOpt=l),c&&(d.animationWorkData=c),d.node&&d.node.getWorkId()!==h&&d.node.setWorkId(h),p&&(d.oldRect=p),r&&i&&(d.toolsType!==r&&r&&i&&this.setNodeKey(h,d,r,i),d.node&&d.node.setWorkOptions(i))}computNextAnimationIndex(t,e){var s;const o=((s=t.node)==null?void 0:s.syncUnitTime)||this.syncUnitTime,i=Math.floor((t.animationWorkData||[]).slice(t.animationIndex).length*32/e/o)*e;return Math.min((t.animationIndex||0)+(i||e),(t.animationWorkData||[]).length)}animationDraw(){var t,e,s,o;this.animationId=void 0;let i=!1;const r=new Map,n=[];for(const[l,a]of this.serviceWorkShapes.entries())switch(a.toolsType){case T.LaserPen:{const c=this.computNextAnimationIndex(a,8),h=Math.max(0,a.animationIndex||0),p=(a.animationWorkData||[]).slice(h,c);if((a.animationIndex||0)<c&&((t=a.node)==null||t.consumeService({op:p,isFullWork:!1}),a.animationIndex=c,p.length&&r.set(l,{workState:h===0?D.Start:c===((e=a.animationWorkData)==null?void 0:e.length)?D.Done:D.Doing,op:p.slice(-2)})),a.isDel){(s=a.node)==null||s.clearTmpPoints(),this.serviceWorkShapes.delete(l);break}a.ops&&a.animationIndex===((o=a.animationWorkData)==null?void 0:o.length)&&!a.isDel&&(this.thread.topLayer.getElementsByName(l.toString())[0]||(a.isDel=!0,this.serviceWorkShapes.set(l,a))),i=!0;break}}for(const[l,a]of this.localWorkShapes.entries()){const{result:c,toolsType:h,isDel:p,workState:d}=a;switch(h){case T.LaserPen:{if(p){a.node.clearTmpPoints(),this.localWorkShapes.delete(l),n.push({removeIds:[l.toString()],type:w.RemoveNode});break}c&&((c.op||c.ops)&&n.push(c),a.result=void 0),!this.thread.topLayer.getElementsByName(l.toString())[0]&&d===D.Done&&(a.isDel=!0,this.localWorkShapes.set(l,a)),i=!0;break}}}i&&this.runAnimation(),r.size&&r.forEach((l,a)=>{n.push({type:w.Cursor,uid:a.split(xt)[0],op:l.op,workState:l.workState,viewId:this.thread.viewId})}),n.length&&this.thread.post({sp:n})}runAnimation(){this.animationId||(this.animationId=requestAnimationFrame(this.animationDraw.bind(this)))}setWorkOptions(t,e){var s;let o=(s=this.localWorkShapes.get(t))==null?void 0:s.node;if(!o&&this.tmpOpt){const{toolsType:i}=this.tmpOpt;this.tmpOpt.toolsOpt=e,o=this.createWorkShapeNode({workId:t,toolsType:i,toolsOpt:e}),o&&this.localWorkShapes.set(t,{node:o,toolsType:i,workState:D.Start}),this.setToolsOpt(this.tmpOpt)}e!=null&&e.syncUnitTime||(e.syncUnitTime=this.syncUnitTime),o&&o.setWorkOptions(e)}consumeDrawAll(t){const{workId:e,dataType:s}=t;if(s===R.Service)this.activeServiceWorkShape(t);else{const o=e==null?void 0:e.toString(),i=o&&this.localWorkShapes.get(o);if(!i)return;const r=i.node.consumeAll({data:t});i.result=r,i.workState=D.Done,o&&this.localWorkShapes.set(o,i)}this.runAnimation()}}class gs{constructor(t){u(this,"vNodes"),u(this,"thread"),u(this,"workShapes",new Map),u(this,"effectSelectNodeData",new Set),u(this,"batchEraserRemoveNodes",new Set),u(this,"batchEraserWorks",new Set),u(this,"tmpOpt"),u(this,"syncUnitTime",ht.syncOpt.interval),u(this,"drawCount",0),u(this,"drawWorkActiveId"),u(this,"batchEraserCombine",Pe(()=>{this.updateBatchEraserCombineNode(this.batchEraserWorks,this.batchEraserRemoveNodes),this.batchEraserWorks.clear(),this.batchEraserRemoveNodes.clear()},100,{leading:!1})),this.vNodes=t.vNodes,this.thread=t.thread}createLocalWork(t){const{workId:e,opt:s,toolsType:o}=t;if(e&&s){const i=e.toString();!this.getToolsOpt()&&o&&this.setToolsOpt({toolsType:o,toolsOpt:s}),this.setWorkOptions(i,s)}}workShapesDone(t,e){for(const s of this.workShapes.keys())this.consumeDrawAll({workId:s,scenePath:t,viewId:this.thread.viewId,msgType:w.DrawWork,dataType:R.Local},e)}async updateSelector(t){var e;const s=this.workShapes.get(B);if(!((e=s==null?void 0:s.selectIds)!=null&&e.length))return;const{callback:o,...i}=t,{updateSelectorOpt:r,willSerializeData:n,scene:l}=i,a=await(s==null?void 0:s.updateSelector({updateSelectorOpt:r,selectIds:ct.cloneDeep(s.selectIds),vNodes:this.vNodes,willSerializeData:n,worker:this,scene:l,isMainThread:!0})),c=new Map;let h;a!=null&&a.selectIds&&(h=ct.xor(s.selectIds,a.selectIds),a.selectIds.forEach(y=>{const m=this.vNodes.get(y);if(m){const{toolsType:S,op:k,opt:N}=m;c.set(y,{opt:N,toolsType:S,ops:(k==null?void 0:k.length)&&Z(k)||void 0})}}),s.selectIds=a.selectIds);const p=[],d=o&&o({res:a,workShapeNode:s,param:i,postData:{sp:p},newServiceStore:c})||{sp:p};h&&d.sp.push({type:w.RemoveNode,removeIds:h,viewId:this.thread.viewId}),d.sp.length&&this.thread.post(d)}destroy(){this.clearAll()}clearAll(){if(this.thread.localLayer.children.length&&(this.thread.topLayer.parent.children.forEach(t=>{t.name!=="viewport"&&t.remove()}),this.thread.localLayer.removeAllChildren()),this.workShapes.get(B)){const t=[];t.push({type:w.Select,dataType:R.Local,selectIds:[],willSyncService:!1}),this.thread.post({sp:t})}this.workShapes.clear(),this.effectSelectNodeData.clear(),this.batchEraserWorks.clear(),this.batchEraserRemoveNodes.clear()}async checkTextActive(t){const{op:e,viewId:s,dataType:o}=t;if(e!=null&&e.length){let i;for(const r of this.vNodes.curNodeMap.values()){const{rect:n,name:l,toolsType:a,opt:c}=r,h=e[0]*this.thread.fullLayer.worldScaling[0]+this.thread.fullLayer.worldPosition[0],p=e[1]*this.thread.fullLayer.worldScaling[1]+this.thread.fullLayer.worldPosition[1];if(a===T.Text&&Ie([h,p],n)&&c.workState===D.Done){i=l;break}}i&&(await this.blurSelector({viewId:s,msgType:w.Select,dataType:o,isSync:!0}),this.thread.post({sp:[{type:w.GetTextActive,toolsType:T.Text,workId:i}]}))}}cursorHover(t){const{opt:e,toolsType:s,point:o}=t,i=this.setFullWork({workId:Rt,toolsType:s,opt:e});i&&o&&i.cursorHover(o)}updateFullSelectWork(t){var e,s,o,i,r;const n=this.workShapes.get(B),{selectIds:l}=t;if(!(l!=null&&l.length)){this.blurSelector(t);return}if(!n){const a=this.setFullWork(t);!a&&t.workId&&this.tmpOpt&&((e=this.tmpOpt)==null?void 0:e.toolsType)===T.Selector&&this.setWorkOptions(t.workId.toString(),t.opt||this.tmpOpt.toolsOpt),a&&this.updateFullSelectWork(t);return}if(n&&l!=null&&l.length){const{selectRect:a}=n.updateSelectIds(l),c=[{...t,selectorColor:((s=t.opt)==null?void 0:s.strokeColor)||n.selectorColor,strokeColor:((o=t.opt)==null?void 0:o.strokeColor)||n.strokeColor,fillColor:((i=t.opt)==null?void 0:i.fillColor)||n.fillColor,textOpt:((r=t.opt)==null?void 0:r.textOpt)||n.textOpt,canTextEdit:n.canTextEdit,canRotate:n.canRotate,scaleType:n.scaleType,type:w.Select,selectRect:a,points:n.getChildrenPoints(),willSyncService:(t==null?void 0:t.willSyncService)||!1,opt:(t==null?void 0:t.willSyncService)&&n.getWorkOptions()||void 0,canLock:n.canLock,isLocked:n.isLocked,toolsTypes:n.toolsTypes,shapeOpt:n.shapeOpt,thickness:n.thickness,useStroke:n.useStroke,strokeType:n.strokeType}];this.thread.post({sp:c})}}commandDeleteText(t){const e=this.vNodes.get(t);if(e&&e.toolsType===T.Text)return{type:w.TextUpdate,toolsType:T.Text,workId:t,dataType:R.Local}}async removeSelector(t){const{willSyncService:e}=t,s=[],o=[],i=this.workShapes.get(B);if(!i)return;const r=i.selectIds&&[...i.selectIds]||[];for(const n of r){if(this.vNodes.get(n)){const l=this.commandDeleteText(n);l&&s.push(l)}this.removeNode(n),o.push(n)}o.length&&s.push({type:w.RemoveNode,removeIds:o}),s.push({type:w.Select,selectIds:[],willSyncService:e}),await this.blurSelector(),s.length&&this.thread.post({sp:s})}removeWork(t){const{workId:e}=t,s=e==null?void 0:e.toString();s&&this.removeNode(s)}removeNode(t){var e;this.vNodes.get(t)&&((e=this.thread.fullLayer)==null||e.getElementsByName(t).forEach(s=>{s.remove()}),this.vNodes.delete(t)),this.workShapes.has(t)&&(this.thread.localLayer.getElementsByName(t).forEach(s=>{s.remove()}),this.clearWorkShapeNodeCache(t))}setFullWork(t){const{workId:e,opt:s,toolsType:o}=t;if(e&&s&&o){const i=e.toString();let r;return e&&this.workShapes.has(i)?(r=this.workShapes.get(i),r==null||r.setWorkOptions(s)):r=this.createWorkShapeNode({toolsOpt:s,toolsType:o,workId:i}),r?(this.workShapes.set(i,r),r):void 0}}async consumeFull(t,e){var s;const o=this.setFullWork(t),i=t.ops&&pt(t.ops);if(o){const r=(s=t.workId)==null?void 0:s.toString();o.toolsType===T.Image&&e?await o.consumeServiceAsync({scene:e,isFullWork:!0,replaceId:r,isMainThread:!0}):o.toolsType===T.Text?await o.consumeServiceAsync({isFullWork:!0,replaceId:r}):o.consumeService({op:i,isFullWork:!0,replaceId:r}),t!=null&&t.updateNodeOpt&&o.updataOptService(t.updateNodeOpt);const n=[];t.workId&&this.workShapes.delete(t.workId.toString()),t.willSyncService&&n.push({opt:t.opt,toolsType:t.toolsType,type:w.FullWork,workId:t.workId,ops:t.ops,updateNodeOpt:t.updateNodeOpt,viewId:this.thread.viewId}),n.length&&this.thread.post({sp:n})}}async colloctEffectSelectWork(t){const e=this.workShapes.get(B),{workId:s,msgType:o}=t;if(e&&s&&e.selectIds&&e.selectIds.includes(s.toString())){o===w.RemoveNode?e.selectIds=e.selectIds.filter(i=>i!==s.toString()):this.effectSelectNodeData.add(t),await new Promise(i=>{setTimeout(()=>{i(!0)},0)}),await this.runEffectSelectWork(!0).then(()=>{var i;(i=this.effectSelectNodeData)==null||i.clear()});return}return t}async runEffectSelectWork(t){var e,s,o;for(const i of this.effectSelectNodeData.values()){const r=this.setFullWork(i);if(r){const n=(e=i.workId)==null?void 0:e.toString();if(r.toolsType===T.Image)await r.consumeServiceAsync({scene:(o=(s=this.thread.localLayer)==null?void 0:s.parent)==null?void 0:o.parent,isFullWork:!0,replaceId:n,isMainThread:!0});else if(r.toolsType===T.Text)await r.consumeServiceAsync({isFullWork:!0,replaceId:n});else{const l=i.ops&&pt(i.ops);r.consumeService({op:l,isFullWork:!0,replaceId:n}),i!=null&&i.updateNodeOpt&&r.updataOptService(i.updateNodeOpt)}i.workId&&this.workShapes.delete(i.workId.toString())}}this.reRenderSelector(t)}hasSelector(){return this.workShapes.has(B)}getSelector(){return this.workShapes.get(B)}reRenderSelector(t=!1){var e;const s=this.workShapes.get(B);if(!s)return;if(s&&!((e=s.selectIds)!=null&&e.length))return this.blurSelector();const o=s.reRenderSelector();o&&this.thread.post({sp:[{type:w.Select,selectIds:s.selectIds,selectRect:o,willSyncService:t,viewId:this.thread.viewId,points:s.getChildrenPoints(),textOpt:s.textOpt,selectorColor:s.selectorColor,strokeColor:s.strokeColor,fillColor:s.fillColor,canTextEdit:s.canTextEdit,canRotate:s.canRotate,scaleType:s.scaleType,opt:s.getWorkOptions()||void 0,canLock:s.canLock,isLocked:s.isLocked,toolsTypes:s.toolsTypes,shapeOpt:s.shapeOpt,thickness:s.thickness,useStroke:s.useStroke,strokeType:s.strokeType}]})}async blurSelector(t){var e;const s=this.workShapes.get(B),o=s==null?void 0:s.blurSelector();if(this.clearWorkShapeNodeCache(B),((e=this.thread.fullLayer)==null?void 0:e.parent).children.forEach(i=>{i.name===B&&i.remove()}),o){const i=[];i.push({...o,isSync:t==null?void 0:t.isSync}),this.thread.post({sp:i})}}clearWorkShapeNodeCache(t){var e;(e=this.getWorkShape(t))==null||e.clearTmpPoints(),this.workShapes.delete(t)}drawEraser(t){var e,s;const o=[];if((e=t.newWorkDatas)!=null&&e.size){for(const i of t.newWorkDatas.values()){const r=i.workId.toString();this.batchEraserWorks.add(r),o.push({type:w.FullWork,workId:r,ops:Z(i.op),opt:i.opt,toolsType:i.toolsType,updateNodeOpt:{useAnimation:!1}})}delete t.newWorkDatas}(s=t.removeIds)==null||s.forEach(i=>{this.batchEraserRemoveNodes.add(i)}),o.push(t),this.thread.post({sp:o}),this.batchEraserCombine()}updateBatchEraserCombineNode(t,e){for(const s of e.keys())this.thread.fullLayer.getElementsByName(s).forEach(o=>{o.remove()});t.forEach(s=>{const o=this.vNodes.get(s);if(o&&o.toolsType===T.Pencil&&!this.thread.fullLayer.getElementsByName(s)[0]){const i=this.setFullWork({...o,workId:s});i&&i.consumeService({op:o.op,isFullWork:!0})}})}getWorkShape(t){return this.workShapes.get(t)}getWorkShapes(){return this.workShapes}consumeDraw(t,e){const{op:s,workId:o,scenePath:i}=t;if(s!=null&&s.length&&o){const r=o.toString(),n=this.workShapes.get(r);if(!n)return;const l=n.toolsType;if(l===T.LaserPen)return;switch(this.drawWorkActiveId&&this.drawWorkActiveId!==r&&(this.consumeDrawAll({workId:this.drawWorkActiveId,scenePath:i,viewId:this.thread.viewId,msgType:w.DrawWork,dataType:R.Local},e),this.drawWorkActiveId=void 0),!this.drawWorkActiveId&&r!==B&&(this.drawWorkActiveId=r),l){case T.Selector:{const a=n.consume({data:t,isFullWork:!0});a.type===w.Select&&(a.selectIds&&e.runReverseSelectWork(a.selectIds),this.thread.post({sp:[a]}))}break;case T.Eraser:{const a=n.consume({data:t,isFullWork:!0});a!=null&&a.rect&&this.drawEraser(a)}break;case T.Arrow:case T.Straight:case T.Ellipse:case T.Rectangle:case T.Star:case T.Polygon:case T.SpeechBalloon:case T.Pencil:{const a=n.consume({data:t,isFullWork:!1,isMainThread:!0});a&&(this.drawCount++,this.thread.post({drawCount:this.drawCount,sp:a.op&&[{...a,scenePath:i}]||void 0}))}break}}}consumeDrawAll(t,e){var s,o,i;const{workId:r,scenePath:n}=t;if(r){const l=r.toString();this.drawWorkActiveId===l&&(this.drawWorkActiveId=void 0);const a=this.workShapes.get(l);if(!a)return;const c=a.toolsType;if(c===T.LaserPen)return;const h=this.workShapes.get(Rt),p=(s=h==null?void 0:h.selectIds)==null?void 0:s[0],d=a.consumeAll({data:t});switch(c){case T.Selector:d.selectIds&&p&&(o=d.selectIds)!=null&&o.includes(p)&&h.cursorBlur(),d.type===w.Select&&(d.selectIds&&e.runReverseSelectWork(d.selectIds),this.thread.post({sp:[{...d,scenePath:n}]})),(i=a.selectIds)!=null&&i.length?a.clearTmpPoints():this.clearWorkShapeNodeCache(l);break;case T.Eraser:d!=null&&d.rect&&this.drawEraser({...d,scenePath:n}),a.clearTmpPoints();break;case T.Arrow:case T.Straight:case T.Ellipse:case T.Rectangle:case T.Star:case T.Polygon:case T.SpeechBalloon:case T.Pencil:d&&(this.drawCount=0,this.thread.post({drawCount:this.drawCount,sp:[d]})),this.clearWorkShapeNodeCache(l);break}}}getToolsOpt(){return this.tmpOpt}setToolsOpt(t){var e;this.tmpOpt=t,(e=t.toolsOpt)!=null&&e.syncUnitTime&&(this.syncUnitTime=t.toolsOpt.syncUnitTime)}setWorkOptions(t,e){let s=this.workShapes.get(t);if(!s&&this.tmpOpt){const{toolsType:o}=this.tmpOpt;this.tmpOpt.toolsOpt=e,s=this.createWorkShapeNode({workId:t,toolsType:o,toolsOpt:e}),s&&this.workShapes.set(t,s),this.setToolsOpt(this.tmpOpt)}e.syncUnitTime||(e.syncUnitTime=this.syncUnitTime),s==null||s.setWorkOptions(e)}createWorkShapeNode(t){return Lt({...t,vNodes:this.vNodes,fullLayer:this.thread.fullLayer,drawLayer:this.thread.localLayer},this.thread.serviceWork)}}class vs{constructor(t){u(this,"vNodes"),u(this,"thread"),u(this,"workShapes",new Map),u(this,"selectorWorkShapes",new Map),u(this,"willRunEffectSelectorIds",new Set),u(this,"runEffectId"),u(this,"animationId"),u(this,"syncUnitTime",ht.syncOpt.interval),this.vNodes=t.vNodes,this.thread=t.thread}destroy(){this.clearAll()}clearAll(){this.thread.serviceLayer.children.length&&(this.thread.serviceLayer.parent.children.forEach(t=>{t.name!=="viewport"&&t.remove()}),this.thread.serviceLayer.removeAllChildren()),this.workShapes.clear(),this.selectorWorkShapes.clear(),this.willRunEffectSelectorIds.clear()}runEffect(){this.runEffectId||(this.runEffectId=setTimeout(this.effectRunSelector.bind(this),0))}effectRunSelector(){this.runEffectId=void 0,this.willRunEffectSelectorIds.forEach(t=>{var e,s;const o=this.selectorWorkShapes.get(t);o&&o.selectIds&&((e=o.node)==null||e.selectServiceNode(t,o,!0)),(s=o==null?void 0:o.selectIds)!=null&&s.length||this.selectorWorkShapes.delete(t)}),this.willRunEffectSelectorIds.clear()}runSelectWork(t){this.activeSelectorShape(t);const{workId:e}=t,s=e==null?void 0:e.toString();s&&this.willRunEffectSelectorIds.add(s),this.runEffect()}removeWork(t){const{workId:e}=t,s=e==null?void 0:e.toString();if(s){if(this.workShapes.get(s)){this.workShapes.delete(s),this.removeNode(s,t);return}this.removeNode(s,t)}}consumeFull(t){this.activeWorkShape(t),this.runAnimation()}runReverseSelectWork(t){t.forEach(e=>{this.selectorWorkShapes.forEach((s,o)=>{var i;if((i=s.selectIds)!=null&&i.length){const r=s.selectIds.indexOf(e);r>-1&&(s.selectIds.splice(r,1),this.willRunEffectSelectorIds.add(o))}})}),this.willRunEffectSelectorIds.size&&this.runEffect()}consumeDraw(t){this.activeWorkShape(t),this.runAnimation()}computNextAnimationIndex(t,e){const s=Math.floor((t.animationWorkData||[]).slice(t.animationIndex).length*32/e/this.syncUnitTime)*e;return Math.min((t.animationIndex||0)+(s||e),(t.animationWorkData||[]).length)}async animationDraw(){var t,e,s,o,i,r,n,l,a,c,h,p,d,y,m,S;this.animationId=void 0;let k=!1;const N=new Map;for(const[v,f]of this.workShapes.entries())switch(f.toolsType){case T.Image:{await((e=f.node)==null?void 0:e.consumeServiceAsync({isFullWork:!0,scene:(t=this.thread.fullLayer.parent)==null?void 0:t.parent,isMainThread:!0})),this.selectorWorkShapes.forEach((P,O)=>{var b;(b=P.selectIds)!=null&&b.includes(v)&&(this.willRunEffectSelectorIds.add(O),this.runEffect())}),this.workShapes.delete(v);break}case T.Text:{f.node&&(await((s=f.node)==null?void 0:s.consumeServiceAsync({isFullWork:!0,replaceId:v})),this.selectorWorkShapes.forEach((P,O)=>{var b;(b=P.selectIds)!=null&&b.includes(v)&&(this.willRunEffectSelectorIds.add(O),this.runEffect())}),(o=f.node)==null||o.clearTmpPoints(),this.workShapes.delete(v));break}case T.Arrow:case T.Straight:case T.Rectangle:case T.Ellipse:case T.Star:case T.Polygon:case T.SpeechBalloon:{const P=!!f.ops;if((i=f.animationWorkData)!=null&&i.length){const O=f.oldRect;(r=f.node)==null||r.consumeService({op:f.animationWorkData,isFullWork:P}),P&&(this.selectorWorkShapes.forEach((b,W)=>{var C;(C=b.selectIds)!=null&&C.includes(v)&&(this.willRunEffectSelectorIds.add(W),this.runEffect())}),(n=f.node)==null||n.clearTmpPoints(),this.workShapes.delete(v)),N.set(v,{workState:O?f.ops?D.Done:D.Doing:D.Start,op:f.animationWorkData.filter((b,W)=>{if(W%3!==2)return!0}).slice(-2)}),f.animationWorkData.length=0}break}case T.Pencil:{if(!f.useAnimation&&f.ops)(l=f.node)==null||l.consumeService({op:f.animationWorkData||[],isFullWork:!0,replaceId:v}),(a=f.node)==null||a.updataOptService(f.updateNodeOpt),this.selectorWorkShapes.forEach((P,O)=>{var b;(b=P.selectIds)!=null&&b.includes(v)&&(this.willRunEffectSelectorIds.add(O),this.runEffect())}),(c=f.node)==null||c.clearTmpPoints(),this.workShapes.delete(v);else if(f.useAnimation){if(f.isDel){(h=f.node)==null||h.clearTmpPoints(),this.workShapes.delete(v);break}const P=3,O=this.computNextAnimationIndex(f,P),b=f.isDiff?0:Math.max(0,(f.animationIndex||0)-P),W=(f.animationWorkData||[]).slice(b,O),C=(d=(p=f.node)==null?void 0:p.getWorkId())==null?void 0:d.toString();if((f.animationIndex||0)<O||f.isDiff){if((y=f.node)==null||y.consumeService({op:W,isFullWork:!1}),f.animationIndex=O,f.isDiff&&(f.isDiff=!1),W.length){const M=W.filter((Q,tt)=>{if(tt%P!==P-1)return!0}).slice(-2);N.set(v,{workState:b===0?D.Start:O===((m=f.animationWorkData)==null?void 0:m.length)?D.Done:D.Doing,op:M})}}else f.ops&&((S=f.node)==null||S.consumeService({op:f.animationWorkData||[],isFullWork:!0,replaceId:C}),f.isDel=!0,N.set(v,{workState:D.Done,op:W.filter((M,Q)=>{if(Q%P!==P-1)return!0}).slice(-2)}));k=!0;break}break}}if(k&&this.runAnimation(),N.size){const v=[];N.forEach((f,P)=>{v.push({type:w.Cursor,uid:P.split(xt)[0],op:f.op,workState:f.workState,viewId:this.thread.viewId})}),this.thread.post({sp:v})}}runAnimation(){this.animationId||(this.animationId=requestAnimationFrame(this.animationDraw.bind(this)))}hasDiffData(t,e,s){const o=t.length;if(e.length<o)return!0;switch(s){case T.Pencil:{for(let i=0;i<o;i+=3)if(e[i]!==t[i]||e[i+1]!==t[i+1])return!0;break}case T.LaserPen:{for(let i=0;i<o;i+=2)if(e[i]!==t[i]||e[i+1]!==t[i+1])return!0;break}}return!1}activeWorkShape(t){var e,s,o,i;const{workId:r,opt:n,toolsType:l,type:a,updateNodeOpt:c,ops:h,op:p,useAnimation:d}=t;if(!r)return;const y=r.toString(),m=(e=this.vNodes.get(y))==null?void 0:e.rect;if(!((s=this.workShapes)!=null&&s.has(y))){let k={toolsType:l,animationWorkData:p||[],animationIndex:0,type:a,updateNodeOpt:c,ops:h,useAnimation:typeof d<"u"?d:typeof(c==null?void 0:c.useAnimation)<"u"?c==null?void 0:c.useAnimation:!0,oldRect:m,isDiff:!1};l&&n&&(k=this.setNodeKey(y,k,l,n)),(o=this.workShapes)==null||o.set(y,k)}const S=(i=this.workShapes)==null?void 0:i.get(y);a&&(S.type=a),h&&(S.animationWorkData=pt(h),S.ops=h),c&&(S.updateNodeOpt=c),p&&(S.isDiff=this.hasDiffData(S.animationWorkData||[],p,S.toolsType),S.animationWorkData=p),S.node&&S.node.getWorkId()!==y&&S.node.setWorkId(y),m&&(S.oldRect=m),l&&n&&(n.syncUnitTime&&(this.syncUnitTime=n.syncUnitTime),S.toolsType!==l&&l&&n&&this.setNodeKey(y,S,l,n),S.node&&S.node.setWorkOptions(n))}removeNode(t,e){t.indexOf(B)>-1&&this.removeSelectWork(e),this.thread.fullLayer.getElementsByName(t).forEach(s=>{s.remove()}),this.thread.serviceLayer.getElementsByName(t).forEach(s=>{s.remove()}),this.vNodes.delete(t)}removeSelectWork(t){const{workId:e}=t,s=e==null?void 0:e.toString();s&&(this.activeSelectorShape(t),this.willRunEffectSelectorIds.add(s)),this.runEffect()}activeSelectorShape(t){var e,s,o;const{workId:i,opt:r,toolsType:n,type:l,selectIds:a}=t;if(!i)return;const c=i.toString();if(!((e=this.selectorWorkShapes)!=null&&e.has(c))){let p={toolsType:n,selectIds:a,type:l,opt:r};n&&r&&(p=this.setNodeKey(c,p,n,r)),(s=this.selectorWorkShapes)==null||s.set(c,p)}const h=(o=this.selectorWorkShapes)==null?void 0:o.get(c);l&&(h.type=l),h.node&&h.node.getWorkId()!==c&&h.node.setWorkId(c),h.selectIds=a||[]}setNodeKey(t,e,s,o){return e.toolsType=s,e.node=Lt({toolsType:s,toolsOpt:o,vNodes:this.vNodes,fullLayer:this.thread.fullLayer,drawLayer:this.thread.serviceLayer,workId:t},this),e}}class J{constructor(){u(this,"localWork"),u(this,"serviceWork"),u(this,"scene")}registerMainThread(t,e,s){return this.localWork=t,this.serviceWork=e,this.scene=s,this}}class Ts extends J{constructor(){super(...arguments),u(this,"emitEventType",E.CopyNode)}async consume(t){const{msgType:e,dataType:s,emitEventType:o}=t;if(e===w.FullWork&&s===R.Local&&o===this.emitEventType)return this.consumeForLocalWorker(t),!0}async consumeForLocalWorker(t){var e;const{workId:s}=t;s&&await((e=this.localWork)==null?void 0:e.consumeFull(t,this.scene))}}class Ps extends J{constructor(){super(...arguments),u(this,"emitEventType",E.SetColorNode)}async consume(t){const{msgType:e,dataType:s,emitEventType:o}=t;if(e===w.UpdateNode&&s===R.Local&&o===this.emitEventType)return this.consumeForLocalWorker(t),!0}async consumeForLocalWorker(t){var e;const{workId:s,updateNodeOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n,textUpdateForWoker:l}=t;s===B&&o&&await((e=this.localWork)==null?void 0:e.updateSelector({updateSelectorOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(t){const{param:e,postData:s,newServiceStore:o}=t,{willSyncService:i,isSync:r,textUpdateForWoker:n}=e,l=s.sp||[];if(i)for(const[a,c]of o.entries())n&&c.toolsType===T.Text?l.push({...c,workId:a,type:w.TextUpdate,dataType:R.Local,willSyncService:!0}):l.push({...c,workId:a,type:w.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:r});return{sp:l}}}class Is extends J{constructor(){super(...arguments),u(this,"emitEventType",E.ZIndexNode)}async consume(t){const{msgType:e,dataType:s,emitEventType:o}=t;if(e===w.UpdateNode&&s===R.Local&&o===this.emitEventType)return this.consumeForLocalWorker(t),!0}async consumeForLocalWorker(t){var e;const{workId:s,updateNodeOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n}=t;s===B&&o&&await((e=this.localWork)==null?void 0:e.updateSelector({updateSelectorOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n,callback:this.updateSelectorCallback}))}updateSelectorCallback(t){const{param:e,postData:s,newServiceStore:o}=t,{willSyncService:i,isSync:r}=e,n=s.sp||[];if(i&&n)for(const[l,a]of o.entries())n.push({...a,workId:l,type:w.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:r});return{sp:n}}}class Ls extends J{constructor(){super(...arguments),u(this,"emitEventType",E.TranslateNode)}async consume(t){const{msgType:e,dataType:s,emitEventType:o}=t;if(e===w.UpdateNode&&s===R.Local&&o===this.emitEventType)return await this.consumeForLocalWorker(t),!0}async consumeForLocalWorker(t){var e,s;const{workId:o,updateNodeOpt:i,willRefreshSelector:r,willSyncService:n,willSerializeData:l,textUpdateForWoker:a,emitEventType:c}=t;o===B&&i&&(i.workState===D.Done&&i!=null&&i.translate&&(i.translate[0]||i.translate[1])||i.workState!==D.Done?await((e=this.localWork)==null?void 0:e.updateSelector({updateSelectorOpt:i,willRefreshSelector:r,willSyncService:n,willSerializeData:l,isSync:!0,textUpdateForWoker:a,emitEventType:c,scene:this.scene,callback:this.updateSelectorCallback})):i.workState===D.Done&&((s=this.localWork)==null||s.vNodes.deleteLastTarget()))}updateSelectorCallback(t){const{param:e,postData:s,newServiceStore:o,workShapeNode:i,res:r}=t,{willSyncService:n,isSync:l,updateSelectorOpt:a,textUpdateForWoker:c}=e,h=a.workState,p=s.sp||[];if(h===D.Start)return{sp:[],render:[]};const d=r==null?void 0:r.selectRect;if(n){h===D.Doing&&p.push({type:w.Select,selectIds:i.selectIds,selectRect:d,willSyncService:!0,isSync:!0,points:i.getChildrenPoints(),textOpt:i.textOpt});for(const[y,m]of o.entries())c&&m.toolsType===T.Text?p.push({...m,workId:y,type:w.TextUpdate,dataType:R.Local,willSyncService:!0}):p.push({...m,workId:y,type:w.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l})}return{sp:p}}}class Ns extends J{constructor(){super(...arguments),u(this,"emitEventType",E.DeleteNode)}async consume(){return!1}}class Ws extends J{constructor(){super(...arguments),u(this,"emitEventType",E.ScaleNode)}async consume(t){const{msgType:e,dataType:s,emitEventType:o}=t;if(e===w.UpdateNode&&s===R.Local&&o===this.emitEventType)return await this.consumeForLocalWorker(t),!0}async consumeForLocalWorker(t){var e;const{workId:s,updateNodeOpt:o,willSyncService:i,willSerializeData:r}=t;s===B&&o&&await((e=this.localWork)==null?void 0:e.updateSelector({updateSelectorOpt:o,willSyncService:i,willSerializeData:r,isSync:!0,scene:this.scene,callback:this.updateSelectorCallback.bind(this)}))}updateSelectorCallback(t){const{param:e,postData:s,workShapeNode:o,res:i,newServiceStore:r}=t,{updateSelectorOpt:n,willSyncService:l}=e,a=n.workState,c=s.sp||[],h=i==null?void 0:i.selectRect;if(a===D.Start)return{sp:[],render:[]};if(l){c.push({type:w.Select,selectIds:o.selectIds,selectRect:h,willSyncService:!0,isSync:!0,points:a===D.Done&&o.getChildrenPoints()||void 0,textOpt:o.textOpt});for(const[p,d]of r.entries())d.toolsType===T.Text?c.push({...d,workId:p,type:w.TextUpdate,dataType:R.Local,willSyncService:!0}):c.push({...d,workId:p,type:w.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:!0})}return{sp:c}}}class bs extends J{constructor(){super(...arguments),u(this,"emitEventType",E.RotateNode)}async consume(t){const{msgType:e,dataType:s,emitEventType:o}=t;if(e===w.UpdateNode&&s===R.Local&&o===this.emitEventType)return await this.consumeForLocalWorker(t),!0}async consumeForLocalWorker(t){var e;const{workId:s,updateNodeOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n,emitEventType:l}=t;s===B&&o&&await((e=this.localWork)==null?void 0:e.updateSelector({updateSelectorOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n,emitEventType:l,isSync:!0,scene:this.scene,callback:this.updateSelectorCallback}))}updateSelectorCallback(t){const{param:e,postData:s,workShapeNode:o,res:i,newServiceStore:r}=t,{updateSelectorOpt:n,willSyncService:l,willSerializeData:a,isSync:c}=e,h=n.workState,p=s.sp||[],d=i==null?void 0:i.selectRect;if(l){a&&h===D.Done&&p.push({type:w.Select,selectIds:o.selectIds,selectRect:d,willSyncService:!0,isSync:c,points:o.getChildrenPoints()});for(const[y,m]of r.entries())p.push({...m,workId:y,type:w.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:c})}return{sp:p}}}class Rs extends J{constructor(){super(...arguments),u(this,"emitEventType",E.SetFontStyle)}async consume(t){const{msgType:e,dataType:s,emitEventType:o}=t;if(e===w.UpdateNode&&s===R.Local&&o===this.emitEventType)return await this.consumeForLocalWorker(t),!0}async consumeForLocalWorker(t){var e;const{workId:s,updateNodeOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n,textUpdateForWoker:l}=t;s===B&&o&&await((e=this.localWork)==null?void 0:e.updateSelector({updateSelectorOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(t){const{param:e,postData:s,newServiceStore:o,workShapeNode:i,res:r}=t,{willSyncService:n,isSync:l,updateSelectorOpt:a,textUpdateForWoker:c}=e,h=s.sp||[],p=r==null?void 0:r.selectRect;if(n&&h){a.fontSize&&h.push({type:w.Select,selectIds:i.selectIds,selectRect:p,willSyncService:n,isSync:l,points:i.getChildrenPoints()});for(const[d,y]of o.entries())c&&y.toolsType===T.Text?h.push({...y,workId:d,type:w.TextUpdate,dataType:R.Local,willSyncService:!0}):h.push({...y,workId:d,type:w.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l})}return{sp:h}}}class Cs extends J{constructor(){super(...arguments),u(this,"emitEventType",E.SetPoint)}async consume(t){const{msgType:e,dataType:s,emitEventType:o}=t;if(e===w.UpdateNode&&s===R.Local&&o===this.emitEventType)return this.consumeForLocalWorker(t),!0}async consumeForLocalWorker(t){var e;const{workId:s,updateNodeOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n,textUpdateForWoker:l}=t;s===B&&o&&await((e=this.localWork)==null?void 0:e.updateSelector({updateSelectorOpt:o,willRefreshSelector:i,willSyncService:r,emitEventType:this.emitEventType,willSerializeData:n,isSync:!0,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(t){const{param:e,postData:s,newServiceStore:o,workShapeNode:i,res:r}=t,{willSyncService:n,isSync:l}=e,a=s.sp||[],c=r==null?void 0:r.selectRect;if(n&&a){for(const[h,p]of o.entries())a.push({...p,workId:h,type:w.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l});a.push({type:w.Select,selectIds:i.selectIds,selectRect:c,willSyncService:n,isSync:l,points:i.getChildrenPoints()})}return{sp:a}}}class Os extends J{constructor(){super(...arguments),u(this,"emitEventType",E.SetLock)}async consume(t){const{msgType:e,dataType:s,emitEventType:o}=t;if(e===w.UpdateNode&&s===R.Local&&o===this.emitEventType)return this.consumeForLocalWorker(t),!0}async consumeForLocalWorker(t){var e;const{workId:s,updateNodeOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n}=t;s===B&&o&&await((e=this.localWork)==null?void 0:e.updateSelector({updateSelectorOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n,callback:this.updateSelectorCallback}))}updateSelectorCallback(t){const{param:e,postData:s,newServiceStore:o,workShapeNode:i,res:r}=t,{willSyncService:n,isSync:l,updateSelectorOpt:a}=e,c=s.sp||[],h=r==null?void 0:r.selectRect;if(n&&c){for(const[p,d]of o.entries())c.push({...d,workId:p,type:w.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l});c.push({isLocked:a.isLocked,selectorColor:i.selectorColor,scaleType:i.scaleType,canRotate:i.canRotate,type:w.Select,selectIds:i.selectIds,selectRect:h,willSyncService:n,isSync:l})}return{sp:c}}}class xs extends J{constructor(){super(...arguments),u(this,"emitEventType",E.SetShapeOpt)}async consume(t){const{msgType:e,dataType:s,emitEventType:o}=t;if(e===w.UpdateNode&&s===R.Local&&o===this.emitEventType)return this.consumeForLocalWorker(t),!0}async consumeForLocalWorker(t){var e;const{workId:s,updateNodeOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n}=t;s===B&&o&&await((e=this.localWork)==null?void 0:e.updateSelector({updateSelectorOpt:o,willRefreshSelector:i,willSyncService:r,willSerializeData:n,callback:this.updateSelectorCallback}))}updateSelectorCallback(t){const{param:e,postData:s,newServiceStore:o}=t,{willSyncService:i,isSync:r}=e,n=s.sp||[];if(i&&n)for(const[l,a]of o.entries())n.push({...a,workId:l,type:w.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:r});return{sp:n}}}class Ms{constructor(t){u(this,"builders",new Map),this.builders=new Map(t.map(e=>[e,this.build(e)]))}build(t){switch(t){case E.TranslateNode:return new Ls;case E.ZIndexNode:return new Is;case E.CopyNode:return new Ts;case E.SetColorNode:return new Ps;case E.DeleteNode:return new Ns;case E.ScaleNode:return new Ws;case E.RotateNode:return new bs;case E.SetFontStyle:return new Rs;case E.SetPoint:return new Cs;case E.SetLock:return new Os;case E.SetShapeOpt:return new xs}}registerForMainThread(t,e,s){return this.builders.forEach(o=>{o&&o.registerMainThread(t,e,s)}),this}async consumeForMainThread(t){for(const e of this.builders.values())if(await(e==null?void 0:e.consume(t)))return!0;return!1}}class Ds{constructor(t,e){u(this,"viewId"),u(this,"fullLayer"),u(this,"topLayer"),u(this,"localLayer"),u(this,"serviceLayer"),u(this,"snapshotFullLayer"),u(this,"vNodes"),u(this,"master"),u(this,"opt"),u(this,"cameraOpt"),u(this,"scene"),u(this,"localWork"),u(this,"serviceWork"),u(this,"topWork"),u(this,"taskUpdateCameraId"),u(this,"debounceUpdateCameraId"),u(this,"debounceUpdateCache",new Set),u(this,"mainThreadPostId"),u(this,"combinePostMsg",new Set),u(this,"methodBuilder"),this.viewId=t,this.opt=e,this.scene=this.createScene({...e.canvasOpt,container:e.container}),this.master=e.master;const s=ht.bufferSize.full,o=ht.bufferSize.sub;this.fullLayer=this.createLayer("fullLayer",this.scene,{...e.layerOpt,bufferSize:this.viewId===ut?s:o}),this.topLayer=this.createLayer("topLayer",this.scene,{...e.layerOpt,bufferSize:(this.viewId,ut,o)}),this.localLayer=this.createLayer("localLayer",this.scene,{...e.layerOpt,bufferSize:(this.viewId,ut,o)}),this.serviceLayer=this.createLayer("serviceLayer",this.scene,{...e.layerOpt,bufferSize:(this.viewId,ut,o)}),this.vNodes=new ks(t,this.scene);const i={thread:this,vNodes:this.vNodes};this.localWork=new gs(i),this.serviceWork=new vs(i),this.topWork=new Ss(i),this.vNodes.init(this.fullLayer),this.methodBuilder=new Ms([E.CopyNode,E.SetColorNode,E.DeleteNode,E.RotateNode,E.ScaleNode,E.TranslateNode,E.ZIndexNode,E.SetFontStyle,E.SetPoint,E.SetLock,E.SetShapeOpt]).registerForMainThread(this.localWork,this.serviceWork,this.scene)}post(t){this.combinePostMsg.add(t),this.runBatchPostData()}async on(t){if(!await this.methodBuilder.consumeForMainThread(t)){const{msgType:e,toolsType:s,opt:o,dataType:i,workId:r,workState:n}=t,l=r==null?void 0:r.toString();switch(e){case w.Destroy:this.destroy();break;case w.Clear:this.clearAll();break;case w.UpdateCamera:await this.updateCamera(t);break;case w.UpdateTools:if(s&&o){const a={toolsType:s,toolsOpt:o};this.topWork.canUseTopLayer(s)?this.topWork.setToolsOpt(a):this.localWork.setToolsOpt(a)}break;case w.CreateWork:if(l&&o&&s){if(this.topWork.canUseTopLayer(s)){this.topWork.getToolsOpt()||this.topWork.setToolsOpt({toolsType:s,toolsOpt:o}),this.topWork.setWorkOptions(l,o);break}this.localWork.getToolsOpt()||this.localWork.setToolsOpt({toolsType:s,toolsOpt:o}),this.localWork.setWorkOptions(l,o)}break;case w.DrawWork:n===D.Done&&i===R.Local?this.consumeDrawAll(i,t):this.consumeDraw(i,t);break;case w.UpdateNode:case w.FullWork:if(s&&this.topWork.canUseTopLayer(s)){this.consumeDrawAll(i,t);break}this.consumeFull(i,t);break;case w.RemoveNode:await this.removeNode(t);return;case w.Select:i===R.Service&&(r===B?this.localWork.updateFullSelectWork(t):this.serviceWork.runSelectWork(t));break;case w.CursorHover:this.localWork.cursorHover(t);break;case w.GetTextActive:i===R.Local&&this.localWork.checkTextActive(t);break}}}async removeNode(t){const{dataType:e,workId:s,removeIds:o}=t,i=o||[];if(s&&i.push(s.toString()),i.length)for(const r of i){if(r===B){await this.localWork.removeSelector(t);continue}e===R.Local?this.localWork.removeWork(t):e===R.Service&&this.serviceWork.removeWork(t),await this.localWork.colloctEffectSelectWork(t)}}async consumeFull(t,e){const s=await this.localWork.colloctEffectSelectWork(e);s&&t===R.Local&&await this.localWork.consumeFull(s,this.scene),s&&t===R.Service&&this.serviceWork.consumeFull(s)}setCameraOpt(t){this.cameraOpt=t;const{scale:e,centerX:s,centerY:o,width:i,height:r}=t;(i!==this.scene.width||r!==this.scene.height)&&this.updateScene({width:i,height:r}),this.fullLayer.setAttribute("scale",[e,e]),this.fullLayer.setAttribute("translate",[-s,-o]),this.topLayer.setAttribute("scale",[e,e]),this.topLayer.setAttribute("translate",[-s,-o]),this.localLayer.setAttribute("scale",[e,e]),this.localLayer.setAttribute("translate",[-s,-o]),this.serviceLayer.setAttribute("scale",[e,e]),this.serviceLayer.setAttribute("translate",[-s,-o])}runBatchPostData(){this.mainThreadPostId||(this.mainThreadPostId=requestAnimationFrame(this.combinePost.bind(this)))}combinePostData(){var t;this.mainThreadPostId=void 0;const e=[];let s;for(const o of this.combinePostMsg.values()){if((t=o.sp)!=null&&t.length)for(const i of o.sp){let r=!1;for(const n of e)if(ct.isEqual(i,n)){r=!0;break}r||e.push(i)}ct.isNumber(o.drawCount)&&(s=o.drawCount)}return this.combinePostMsg.clear(),{sp:e,drawCount:s}}combinePost(){var t,e;const s=this.combinePostData(),o=(t=s.sp)==null?void 0:t.filter(i=>i.type!==w.None);o!=null&&o.length?s.sp=o.map(i=>i.viewId?i:{...i,viewId:this.viewId}):delete s.sp,s.drawCount===void 0&&delete s.drawCount,(s!=null&&s.drawCount||(e=s.sp)!=null&&e.length)&&this.opt.post(s)}clearAll(){this.fullLayer.children.length&&(this.fullLayer.parent.children.forEach(t=>{t.name!=="viewport"&&t.remove()}),this.fullLayer.removeAllChildren()),this.localWork.clearAll(),this.topWork.clearAll(),this.serviceWork.clearAll(),this.vNodes.clear(),this.post({sp:[{type:w.Clear}]})}consumeDrawAll(t,e){const{toolsType:s,workId:o}=e;if(o){const i=o.toString();if(s&&this.topWork.canUseTopLayer(s)){t===R.Local&&(this.topWork.getLocalWorkShape(o.toString())||this.topWork.createLocalWork(e)),this.topWork.consumeDrawAll(e);return}t===R.Local&&(this.localWork.getWorkShape(i)||this.localWork.createLocalWork(e),this.localWork.consumeDrawAll(e,this.serviceWork))}}consumeDraw(t,e){const{opt:s,workId:o,toolsType:i}=e;if(o&&i&&s){const r=o.toString();if(this.topWork.canUseTopLayer(i)){t===R.Local&&(this.topWork.getLocalWorkShape(r)||this.topWork.createLocalWork(e)),this.topWork.consumeDraw(e);return}t===R.Local?(this.localWork.getWorkShape(r)||this.localWork.createLocalWork(e),this.localWork.consumeDraw(e,this.serviceWork)):t===R.Service&&this.serviceWork.consumeDraw(e);return}}async updateCamera(t){var e;const{cameraOpt:s,scenePath:o}=t;if(s&&!ct.isEqual(this.cameraOpt,s)){if(this.taskUpdateCameraId&&(clearTimeout(this.taskUpdateCameraId),this.taskUpdateCameraId=void 0),o){let a=!1;for(const[c,h]of this.localWork.getWorkShapes().entries())if(h.toolsType!==T.Text&&h.toolsType!==T.Eraser&&h.toolsType!==T.Selector&&h.toolsType!==T.LaserPen&&c!==Rt&&c!==B){a=!0;break}if(a){this.taskUpdateCameraId=setTimeout(()=>{this.taskUpdateCameraId=void 0,this.updateCamera(t)},Ut);return}}const i=new Map;for(const[a,c]of this.vNodes.getNodesByType(T.Text).entries()){const h=c.rect;i.set(a,ct.cloneDeep(h))}const r=new Set(i.keys());let n=!1;if(this.localWork.hasSelector()){const a=(e=this.localWork.getSelector())==null?void 0:e.selectIds;if(a){n=!0;for(const c of a)r.add(c)}}let l=!1;if(this.serviceWork.selectorWorkShapes.size)for(const a of this.serviceWork.selectorWorkShapes.values()){const c=a.selectIds;if(c){l=!0;for(const h of c)r.add(h)}}if(this.setCameraOpt(s),this.vNodes.curNodeMap.size){this.vNodes.clearTarget(),this.vNodes.updateHighLevelNodesRect(r),this.debounceUpdateCameraId&&clearTimeout(this.debounceUpdateCameraId);for(const[a,c]of i.entries()){const h=this.vNodes.get(a);if(h){const p=c,d=h.rect,y=this.getSceneRect(),m=Wt(p,y),S=Wt(d,y);let k=!1;if((m!==S||p.w!==d.w||p.h!==d.h||S===$t.intersect)&&(k=!0),k){const{toolsType:N,opt:v}=h;N===T.Text&&v.workState===D.Done&&this.debounceUpdateCache.add(a)}}}if(n&&this.localWork.reRenderSelector(),l)for(const[a,c]of this.serviceWork.selectorWorkShapes.entries())this.serviceWork.runSelectWork({workId:a,selectIds:c.selectIds,msgType:w.Select,dataType:R.Service,viewId:this.viewId});this.debounceUpdateCameraId=setTimeout(()=>{var a;this.debounceUpdateCameraId=void 0;const c=[];for(const h of this.debounceUpdateCache.values()){if((a=this.fullLayer)!=null&&a.getElementsByName(h)[0]){const p=this.vNodes.get(h);if(p){const{toolsType:d,opt:y,rect:m}=p,S=this.localWork.setFullWork({toolsType:d,opt:y,workId:h});if(S){const k=this.getSceneRect(),N=Wt(m,k);c.push(S.consumeServiceAsync({isFullWork:!0,replaceId:h,isDrawLabel:N!==$t.outside}))}}}this.debounceUpdateCache.delete(h)}this.vNodes.updateLowLevelNodesRect(),this.vNodes.clearHighLevelIds()},Ut)}}}getSceneRect(){const{width:t,height:e}=this.scene;return{x:0,y:0,w:Math.floor(t),h:Math.floor(e)}}createScene(t){return new Jt({displayRatio:this.opt.displayer.dpr,depth:!1,desynchronized:!0,...t,autoRender:!0,id:this.viewId})}createLayer(t,e,s){const{width:o,height:i}=s,r=`canvas-${t}`,n=e.layer(r,{...s,offscreen:!1}),l=new H({anchor:[.5,.5],pos:[o*.5,i*.5],size:[o,i],name:"viewport",id:t});return n.append(l),l}updateScene(t){this.scene.attr({...t});const{width:e,height:s}=t;this.scene.width=e,this.scene.height=s,this.updateLayer({width:e,height:s})}updateLayer(t){const{width:e,height:s}=t;this.fullLayer.parent.setAttribute("width",e),this.fullLayer.parent.setAttribute("height",s),this.fullLayer.setAttribute("size",[e,s]),this.fullLayer.setAttribute("pos",[e*.5,s*.5]),this.topLayer.parent.setAttribute("width",e),this.topLayer.parent.setAttribute("height",s),this.topLayer.setAttribute("size",[e,s]),this.topLayer.setAttribute("pos",[e*.5,s*.5]),this.localLayer.parent.setAttribute("width",e),this.localLayer.parent.setAttribute("height",s),this.localLayer.setAttribute("size",[e,s]),this.localLayer.setAttribute("pos",[e*.5,s*.5]),this.serviceLayer.parent.setAttribute("width",e),this.serviceLayer.parent.setAttribute("height",s),this.serviceLayer.setAttribute("size",[e,s]),this.serviceLayer.setAttribute("pos",[e*.5,s*.5])}destroy(){this.vNodes.clear(),this.fullLayer.remove(),this.topLayer.remove(),this.localLayer.remove(),this.serviceLayer.remove(),this.scene.remove(),this.localWork.destroy(),this.serviceWork.destroy(),this.topWork.destroy()}}class As{constructor(t,e){u(this,"viewId"),u(this,"fullLayer"),u(this,"master"),u(this,"opt"),u(this,"scene"),u(this,"mainThreadPostId"),u(this,"combinePostMsg",new Set),u(this,"workShapes",new Map),this.viewId=t,this.opt=e,this.scene=this.createScene({...e.canvasOpt,container:e.container}),this.master=e.master,this.fullLayer=this.createLayer("fullLayer",this.scene,{...e.layerOpt,bufferSize:this.viewId===ut?6e3:3e3})}post(t){this.combinePostMsg.add(t),this.runBatchPostData()}async on(t){const{msgType:e}=t;switch(e){case w.Snapshot:await this.getSnapshot(t),this.destroy();return;case w.BoundingBox:await this.getBoundingRect(t),this.destroy();return}}createWorkShapeNode(t){return Lt({...t,fullLayer:this.fullLayer,drawLayer:void 0})}setFullWork(t){const{workId:e,opt:s,toolsType:o}=t;if(e&&s&&o){const i=e.toString();let r;return e&&this.workShapes.has(i)?(r=this.workShapes.get(i),r==null||r.setWorkOptions(s)):r=this.createWorkShapeNode({toolsOpt:s,toolsType:o,workId:i}),r?(this.workShapes.set(i,r),r):void 0}}async runFullWork(t){var e,s;const o=this.setFullWork(t),i=t.ops&&pt(t.ops);if(o){let r,n;const l=(e=o.getWorkId())==null?void 0:e.toString();return o.toolsType===T.Image?r=await o.consumeServiceAsync({isFullWork:!0,scene:(s=this.fullLayer.parent)==null?void 0:s.parent,isMainThread:!0}):o.toolsType===T.Text?r=await o.consumeServiceAsync({isFullWork:!0,replaceId:l,isDrawLabel:!0}):(r=o.consumeService({op:i,isFullWork:!0,replaceId:l}),n=(t==null?void 0:t.updateNodeOpt)&&o.updataOptService(t.updateNodeOpt)),z(r,n)}}async getSnapshot(t){const{scenePath:e,scenes:s,cameraOpt:o,w:i,h:r}=t;if(e&&s&&o){this.setCameraOpt(o);let n;for(const[a,c]of Object.entries(s))if(c!=null&&c.type)switch(c==null?void 0:c.type){case w.UpdateNode:case w.FullWork:{const{opt:h}=c,p=await this.runFullWork({...c,opt:h,workId:a,msgType:w.FullWork,dataType:R.Service,viewId:this.viewId});n=z(n,p);break}}let l;i&&r&&(l={resizeWidth:i,resizeHeight:r}),await this.getSnapshotRender({scenePath:e,options:l})}}getSceneRect(){const{width:t,height:e}=this.scene;return{x:0,y:0,w:Math.floor(t),h:Math.floor(e)}}getRectImageBitmap(t,e){const s=Math.floor(t.x*this.opt.displayer.dpr),o=Math.floor(t.y*this.opt.displayer.dpr),i=t.w>0&&Math.floor(t.w*this.opt.displayer.dpr||1)||1,r=t.h>0&&Math.floor(t.h*this.opt.displayer.dpr||1)||1;return createImageBitmap(this.fullLayer.parent.canvas,s,o,i,r,e)}async getSnapshotRender(t){var e,s;const{scenePath:o,options:i}=t;((e=this.fullLayer)==null?void 0:e.parent).render();const r=await this.getRectImageBitmap(this.getSceneRect(),i);r&&(this.post({sp:[{type:w.Snapshot,scenePath:o,imageBitmap:r,viewId:this.viewId}]}),(s=this.fullLayer)==null||s.removeAllChildren())}async getBoundingRect(t){const{scenePath:e,scenes:s,cameraOpt:o}=t;if(e&&s&&o){this.setCameraOpt(o);let i;for(const[r,n]of Object.entries(s))if(n!=null&&n.type)switch(n==null?void 0:n.type){case w.UpdateNode:case w.FullWork:{const l=await this.runFullWork({...n,workId:r,msgType:w.FullWork,dataType:R.Service,viewId:this.viewId});i=z(i,l);break}}i&&this.post({sp:[{type:w.BoundingBox,scenePath:e,rect:i}]})}}setCameraOpt(t){const{scale:e,centerX:s,centerY:o,width:i,height:r}=t;this.updateScene({width:i,height:r}),this.fullLayer.setAttribute("scale",[e,e]),this.fullLayer.setAttribute("translate",[-s,-o])}runBatchPostData(){this.mainThreadPostId||(this.mainThreadPostId=requestAnimationFrame(this.combinePost.bind(this)))}combinePostData(){var t;this.mainThreadPostId=void 0;const e=[];for(const s of this.combinePostMsg.values())if((t=s.sp)!=null&&t.length)for(const o of s.sp){let i=!1;for(const r of e)if(yt(o,r)){i=!0;break}i||e.push(o)}return this.combinePostMsg.clear(),{sp:e}}combinePost(){var t,e;const s=this.combinePostData(),o=(t=s.sp)==null?void 0:t.filter(i=>i.type!==w.None);o!=null&&o.length?s.sp=o.map(i=>i.viewId?i:{...i,viewId:this.viewId}):delete s.sp,(s!=null&&s.drawCount||(e=s.sp)!=null&&e.length)&&this.opt.post(s)}createScene(t){return new Jt({displayRatio:this.opt.displayer.dpr,depth:!1,desynchronized:!0,...t,autoRender:!1})}createLayer(t,e,s){const{width:o,height:i}=s,r=`canvas-${t}`,n=e.layer(r,s),l=new H({anchor:[.5,.5],pos:[o*.5,i*.5],size:[o,i],name:"viewport",id:t});return n.append(l),l}updateScene(t){this.scene.attr({...t});const{width:e,height:s}=t;this.scene.width=e,this.scene.height=s,this.updateLayer({width:e,height:s})}updateLayer(t){const{width:e,height:s}=t;this.fullLayer.parent.setAttribute("width",e),this.fullLayer.parent.setAttribute("height",s),this.fullLayer.setAttribute("size",[e,s]),this.fullLayer.setAttribute("pos",[e*.5,s*.5])}destroy(){this.fullLayer.remove(),this.scene.remove()}}class zs{constructor(t){u(this,"mainThreadMap",new Map),u(this,"snapshotThread"),u(this,"master"),this.master=t}post(t){const{drawCount:e,sp:s,workerTasksqueueCount:o}=t;this.master.isBusy&&K(o)&&this.master.setWorkerTasksqueueCount(o),K(e)&&this.master.setMaxDrawCount(e),s&&this.master.collectorSyncData(s)}destroy(){this.mainThreadMap.clear()}createMainThread(t,e){return new Ds(t,e)}createSnapshotThread(t,e){return new As(t,e)}async consume(t){var e,s,o,i;for(const r of t.values()){const{msgType:n,viewId:l,tasksqueue:a,mainTasksqueueCount:c,layerOpt:h,offscreenCanvasOpt:p,cameraOpt:d}=r;if(n===w.Console){console.log(this);continue}if(n===w.Init){const m=(e=this.master.control.viewContainerManager.getView(l))==null?void 0:e.displayer,S=m==null?void 0:m.canvasContainerRef.current;if(m&&S&&h&&p){const k=this.createMainThread(l,{displayer:m,container:S,layerOpt:h,master:this.master,canvasOpt:p,post:this.post.bind(this)});this.mainThreadMap.set(l,k),k&&d&&k.setCameraOpt(d)}continue}if((n===w.Snapshot||n===w.BoundingBox)&&l===((s=this.master.control.viewContainerManager.mainView)==null?void 0:s.id)){const m=(o=this.master.control.viewContainerManager.getView(l))==null?void 0:o.displayer,S=(i=m.snapshotContainerRef)==null?void 0:i.current;if(m&&S&&d){S.style.width=`${d.width}px`,S.style.height=`${d.height}px`;const k={...Ft.defaultLayerOpt,offscreen:!1,width:d.width,height:d.height},N={...Ft.defaultScreenCanvasOpt,width:d.width,height:d.height};this.snapshotThread=this.createSnapshotThread(l,{displayer:m,container:S,layerOpt:k,master:this.master,canvasOpt:N,post:this.post.bind(this)}),this.snapshotThread.on(r).then(()=>{this.snapshotThread=void 0,S.innerHTML="",S.style.width="",S.style.height=""});continue}}if(n===w.TasksQueue&&a!=null&&a.size){for(const[m,S]of this.mainThreadMap.entries()){const k=a.get(m);k&&(await S.on(k),c&&this.post({workerTasksqueueCount:c}))}continue}if(l===ve){for(const m of this.mainThreadMap.values())m.on(r),n===w.Destroy&&this.mainThreadMap.delete(l);continue}const y=this.mainThreadMap.get(l);y&&(y.on(r),n===w.Destroy&&this.mainThreadMap.delete(l))}}}export{zs as MainThreadManagerImpl};
